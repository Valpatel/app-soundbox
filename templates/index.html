<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sound Box - Valpatel Software</title>
    <meta name="description" content="Generate music & sound effects using AI">
    <meta name="theme-color" content="#1a1a2e">
    <link rel="icon" type="image/png" href="/static/graphlings/favicon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/graphlings/favicon-32.png">
    <link rel="apple-touch-icon" href="/static/graphlings/logo-104.png">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Radio Widget Styles -->
    <link rel="stylesheet" href="/static/css/radio-widget.css">
    <link rel="stylesheet" href="/static/css/radio-widget-sizes.css">
    <link rel="stylesheet" href="/static/css/radio-widget-templates.css">
    <link rel="stylesheet" href="/static/css/radio-widget-fullscreen.css">
    <style>
        /* ========================================
           SOUND BOX - Futuristic Theme
           ======================================== */
        :root {
            --bg-dark: #0a0e17;
            --bg-card: #111827;
            --bg-input: #0d1117;
            --accent: #a855f7;
            --accent-glow: rgba(168, 85, 247, 0.4);
            --accent-light: #c084fc;
            --accent-light-glow: rgba(192, 132, 252, 0.3);
            /* Legacy cyan aliases - now point to accent-light for unified purple theme */
            --cyan: var(--accent-light);
            --cyan-glow: var(--accent-light-glow);
            --secondary: var(--accent-light);
            --text: #f1f5f9;
            --text-dim: #94a3b8;
            --text-muted: #64748b;
            --border: rgba(255, 255, 255, 0.08);
            --border-hover: rgba(255, 255, 255, 0.15);
            --success: #10b981;
            --error: #ef4444;
            --gradient-accent: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
            --gradient-secondary: linear-gradient(135deg, #c084fc 0%, #a855f7 100%);
            /* Legacy alias */
            --gradient-cyan: var(--gradient-secondary);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            background-image:
                radial-gradient(ellipse at top, rgba(168, 85, 247, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(168, 85, 247, 0.06) 0%, transparent 50%);
            color: var(--text);
            min-height: 100vh;
        }

        h1, h2, h3 { font-family: 'Fredoka', sans-serif; }

        /* Page Header */
        .page-header {
            position: relative;
            text-align: center;
            padding: 16px 16px 8px;
            background: transparent;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
            color: var(--text);
            text-shadow: 0 0 30px var(--accent-glow);
        }

        .page-title span {
            background: linear-gradient(135deg, var(--accent), var(--cyan), var(--accent));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: titleGradient 4s ease-in-out infinite;
        }

        /* Global Mute Button - in tab bar */
        .global-mute-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .global-mute-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(168, 85, 247, 0.1);
        }

        .global-mute-btn .icon {
            width: 20px;
            height: 20px;
        }

        .global-mute-btn .icon.muted {
            display: none;
            color: var(--error);
        }

        .global-mute-btn.muted .icon.unmuted {
            display: none;
        }

        .global-mute-btn.muted .icon.muted {
            display: block;
        }

        .global-mute-btn.muted {
            border-color: var(--error);
            color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        @keyframes titleGradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .widget-bar-top {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 8px 16px;
            background: linear-gradient(180deg, rgba(168, 85, 247, 0.08) 0%, transparent 100%);
            border-bottom: 1px solid var(--border);
            margin-bottom: 0;
        }

        .widget-bar-top .header-brand {
            font-size: 0.75rem;
            color: var(--text-muted);
            opacity: 0.7;
        }

        #wallet-widget-container {
            display: block;
            margin: 0 auto;
            width: fit-content;
        }

        /* Sign-in prompt styles are now handled by Graphlings SDK */

        /* Dark themed audio player using filter inversion */
        audio {
            width: 100%;
            height: 36px;
            border-radius: 6px;
            outline: none;
        }

        /* Styled audio wrapper - inverts the default light player to dark */
        .styled-audio {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0 4px;
            margin-bottom: 8px;
        }

        .styled-audio audio {
            filter: invert(1) hue-rotate(180deg) brightness(0.9) contrast(1.1);
            background: transparent;
        }

        /* Override for the now-playing smaller player */
        .now-playing .styled-audio {
            padding: 0 4px;
            margin-bottom: 0;
        }

        .now-playing .styled-audio audio {
            height: 32px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 16px;
        }

        .subtitle {
            text-align: center;
            color: var(--text-dim);
            margin-bottom: 24px;
            font-size: 0.95rem;
        }

        .subtitle a {
            color: var(--cyan);
            text-decoration: none;
            transition: all 0.2s;
        }

        .subtitle a:hover {
            text-shadow: 0 0 10px var(--cyan-glow);
        }

        /* License Notice - Compact inline */
        .license-notice {
            text-align: center;
            color: var(--text-dim);
            font-size: 0.7rem;
            margin-bottom: 12px;
            padding: 6px 12px;
            background: rgba(34, 197, 94, 0.06);
            border: 1px solid rgba(34, 197, 94, 0.15);
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            max-width: 500px;
        }

        .license-notice-wrapper {
            text-align: center;
            margin-bottom: 8px;
        }

        .license-badge {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            font-weight: 700;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
        }

        .license-notice a {
            color: #22c55e;
            text-decoration: none;
            font-weight: 500;
        }

        .license-notice a:hover {
            text-decoration: underline;
        }

        .license-notice .separator {
            color: var(--text-muted);
            opacity: 0.5;
        }

        /* CC0 widget responsive - smaller on mobile */
        @media (max-width: 480px) {
            .license-notice {
                font-size: 0.6rem;
                padding: 4px 8px;
                gap: 4px;
            }
            .license-badge {
                font-size: 0.55rem;
                padding: 1px 4px;
            }
            .attribution-hint {
                display: none;
            }
            .license-notice .separator {
                display: none;
            }
        }

        .attribution-hint {
            color: var(--accent);
            font-size: 0.65rem;
            cursor: pointer;
            transition: color 0.2s;
            white-space: nowrap;
        }

        .attribution-hint:hover {
            color: var(--cyan);
            text-decoration: underline;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid var(--card-border-accent, var(--border));
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
            transition: border-color 0.3s, box-shadow 0.3s, transform 0.3s;
            animation: cardFloat 6s ease-in-out infinite;
        }

        @keyframes cardFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        .card:hover {
            border-color: var(--accent);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 25px var(--accent-glow);
            animation-play-state: paused;
            transform: translateY(-5px);
        }

        /* Labels */
        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-dim);
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Textarea */
        textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-input);
            color: var(--text);
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 90px;
            transition: all 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow), 0 0 15px var(--accent-glow);
        }

        textarea::placeholder {
            color: var(--text-muted);
        }

        /* Model Tabs */
        .model-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            padding-top: 6px;  /* Room for hover lift effect */
        }

        .model-tab {
            flex: 1;
            padding: 16px 12px;
            border: 2px solid var(--border);
            border-radius: 14px;
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.25s;
            text-align: center;
            font-family: inherit;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .model-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .model-tab:hover::before {
            left: 100%;
        }

        .model-tab:hover {
            border-color: var(--accent);
            background: var(--chip-bg, rgba(255, 255, 255, 0.02));
            color: var(--text);
            transform: translateY(-3px);
        }

        .model-tab.active {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--chip-bg, rgba(168, 85, 247, 0.1));
            box-shadow: 0 0 20px var(--accent-glow);
            animation: tabPulse 2s ease-in-out infinite;
        }

        @keyframes tabPulse {
            0%, 100% { box-shadow: 0 0 20px var(--accent-glow); }
            50% { box-shadow: 0 0 30px var(--accent-glow), 0 0 40px var(--accent-glow); }
        }

        .model-tab .icon-lg {
            width: 28px;
            height: 28px;
        }

        .model-tab span {
            font-weight: 700;
            font-size: 0.9rem;
        }

        /* Voice Selector */
        .voice-selector {
            margin: 16px 0;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        .voice-selector-header {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .voice-search-box {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 12px;
            flex: 1;
            min-width: 150px;
        }
        .voice-search-box input {
            border: none;
            background: transparent;
            outline: none;
            color: var(--text);
            flex: 1;
            font-size: 0.9rem;
        }
        .voice-filters {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .voice-filter-btn {
            padding: 6px 12px;
            font-size: 0.8rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }
        .voice-filter-btn:hover {
            border-color: var(--accent);
        }
        .voice-filter-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }
        .voice-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: 250px;
            overflow-y: auto;
        }
        .voice-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .voice-row:hover {
            border-color: var(--border);
            background: var(--bg-tertiary);
        }
        .voice-row.selected {
            border-color: var(--accent);
            background: rgba(var(--accent-rgb), 0.1);
        }
        .voice-row .voice-fav {
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            transition: all 0.2s;
        }
        .voice-row .voice-fav:hover {
            color: gold;
            transform: scale(1.2);
        }
        .voice-row .voice-fav.is-fav {
            color: gold;
        }
        .voice-row .voice-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .voice-row .voice-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        .voice-row .voice-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .voice-row .voice-quality {
            font-size: 0.65rem;
            padding: 2px 6px;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }
        .voice-row .voice-actions {
            display: flex;
            gap: 6px;
        }
        .voice-row .voice-play-btn {
            padding: 4px 10px;
            font-size: 0.75rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .voice-row .voice-play-btn:hover {
            filter: brightness(1.1);
        }
        .voice-row .voice-play-btn.playing {
            background: var(--success);
        }
        /* License badges for voices */
        .voice-license {
            font-size: 0.6rem;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: 600;
            white-space: nowrap;
        }
        .voice-license.license-ok {
            background: rgba(76, 175, 80, 0.15);
            color: #4caf50;
        }
        .voice-license.license-nc {
            background: rgba(255, 152, 0, 0.15);
            color: #ff9800;
        }
        .voice-license a {
            color: inherit;
            text-decoration: none;
        }
        .voice-license a:hover {
            text-decoration: underline;
        }
        .voice-attribution {
            margin-left: 3px;
            opacity: 0.7;
            font-size: 0.7rem;
            text-decoration: none !important;
        }
        .voice-attribution:hover {
            opacity: 1;
        }

        /* Voice info tags for library items */
        .voice-info-tags {
            display: inline-flex;
            gap: 4px;
            margin-left: 8px;
        }
        .voice-gender-tag, .voice-accent-tag, .voice-name-tag {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
            white-space: nowrap;
        }
        .voice-gender-tag.female {
            background: rgba(233, 30, 99, 0.15);
            color: #e91e63;
        }
        .voice-gender-tag.male {
            background: rgba(33, 150, 243, 0.15);
            color: #2196f3;
        }
        .voice-accent-tag {
            background: rgba(156, 39, 176, 0.15);
            color: #9c27b0;
        }
        .voice-name-tag {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-muted);
        }

        /* Controls Row */
        .controls {
            display: flex;
            gap: 12px;
            align-items: stretch;
            margin-top: 20px;
        }

        /* Control Box - shared style for duration, loop, random */
        .control-box {
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s;
            cursor: pointer;
            position: relative;
        }

        .control-box:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .control-box:active {
            transform: translateY(0);
        }

        .control-box label {
            font-size: 0.7rem;
            margin: 0 0 4px 0;
            text-align: center;
        }

        /* Duration Control */
        .duration-control {
            flex-direction: column;
            min-width: 100px;
        }

        .duration-value {
            text-align: center;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 4px;
            font-family: 'Fredoka', sans-serif;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            box-shadow: 0 0 10px var(--accent-glow);
            transition: transform 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        /* Loop Toggle Control */
        .loop-control {
            gap: 10px;
        }

        .loop-control.active {
            border-color: var(--accent);
            background: rgba(168, 85, 247, 0.1);
        }

        .loop-control .loop-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text);
            margin: 0;
            text-transform: none;
        }

        /* Custom Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 40px;
            height: 22px;
            background: var(--border);
            border-radius: 11px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 16px;
            height: 16px;
            background: var(--text-dim);
            border-radius: 50%;
            transition: all 0.3s;
        }

        .loop-control.active .toggle-switch {
            background: var(--accent);
        }

        .loop-control.active .toggle-switch::after {
            left: 21px;
            background: white;
        }

        .loop-control input[type="checkbox"] {
            display: none;
        }

        /* Random Control */
        .random-control {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text);
            min-width: 80px;
        }

        .random-control:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Generate Button */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: 2px solid transparent;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 700;
            font-family: 'Fredoka', sans-serif;
            cursor: pointer;
            transition: all 0.25s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            flex: 1;
            background: var(--gradient-accent);
            color: white;
            box-shadow: 0 4px 15px var(--accent-glow);
            animation: generatePulse 2s ease-in-out infinite;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: btnShine 3s ease-in-out infinite;
        }

        @keyframes generatePulse {
            0%, 100% { box-shadow: 0 4px 15px var(--accent-glow); }
            50% { box-shadow: 0 4px 25px var(--accent-glow), 0 0 40px var(--accent-glow); }
        }

        @keyframes btnShine {
            0% { left: -100%; }
            50%, 100% { left: 100%; }
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 30px var(--accent-glow);
            animation: none;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--border);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            text-transform: none;
        }

        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: var(--accent);
            color: var(--accent);
        }

        .btn-icon .icon {
            width: 20px;
            height: 20px;
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
            animation: none !important;
        }

        .btn:disabled::before {
            animation: none;
        }

        
        /* Disabled inputs */
        textarea:disabled,
        input:disabled,
        select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(0, 0, 0, 0.3) !important;
        }

        textarea:disabled::placeholder {
            color: var(--text-muted);
            font-style: italic;
        }

        /* Status Messages */
        .status {
            text-align: center;
            padding: 16px;
            margin-top: 16px;
            border-radius: 12px;
            display: none;
            font-weight: 600;
        }

        .status.loading {
            display: block;
            background: var(--chip-bg, rgba(168, 85, 247, 0.15));
            color: var(--accent);
            border: 1px solid var(--chip-border, rgba(168, 85, 247, 0.3));
            animation: statusPulse 2s ease-in-out infinite;
        }

        @keyframes statusPulse {
            0%, 100% { box-shadow: 0 0 0 0 var(--accent-glow); }
            50% { box-shadow: 0 0 20px 5px var(--accent-glow); }
        }

        .status.error {
            display: block;
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Player Section */
        .player {
            margin-top: 20px;
            display: none;
        }

        .player.show {
            display: block;
        }

        audio {
            width: 100%;
            margin-top: 12px;
            border-radius: 8px;
        }

        h2 {
            font-size: 1.1rem;
            margin: 0 0 16px 0;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        h2::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--accent);
            border-radius: 2px;
            box-shadow: 0 0 8px var(--accent-glow);
        }
        .download-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 24px;
            border: 1px solid var(--accent);
            border-radius: 8px;
            background: transparent;
            color: var(--accent);
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            text-decoration: none;
            margin-left: auto;
            transition: all 0.2s;
            min-width: 120px;
            justify-content: center;
        }

        .download-btn:hover {
            background: var(--accent);
            color: white;
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .download-btn:hover .icon {
            fill: white;
        }

        .tag-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: 1px solid var(--text-muted);
            border-radius: 8px;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.2s;
            min-width: 80px;
            justify-content: center;
        }

        .tag-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .tag-btn:hover .icon {
            fill: var(--accent);
        }

        .spectrogram {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .spectrogram:hover {
            opacity: 0.85;
            transform: scale(1.01);
        }

        .spectrogram.loading {
            height: 80px;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .quality-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: 8px;
            text-transform: uppercase;
        }

        .quality-badge.good {
            background: var(--chip-bg, rgba(16, 185, 129, 0.2));
            color: var(--accent);
        }

        .quality-badge.medium {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .quality-badge.bad {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        .quality-issues {
            font-size: 0.75rem;
            color: var(--error);
            margin-top: 4px;
        }

        .player-spectrogram {
            margin-top: 16px;
        }

        .player-spectrogram img {
            width: 100%;
            border-radius: 10px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Example Chips */
        .examples {
            margin-top: 16px;
        }

        .examples span {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .example-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .chip {
            padding: 8px 14px;
            background: var(--chip-bg, rgba(168, 85, 247, 0.1));
            border: 1px solid var(--chip-border, rgba(168, 85, 247, 0.3));
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text);
            position: relative;
            overflow: hidden;
        }

        .chip::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--accent-glow);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .chip:active::after {
            width: 200px;
            height: 200px;
            opacity: 0;
        }

        .chip:hover {
            background: var(--chip-bg, rgba(168, 85, 247, 0.2));
            border-color: var(--accent);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .loading-banner {
            display: none; /* Hidden for production - dev only */
            background: rgba(255, 193, 7, 0.15);
            border: 1px solid rgba(255, 193, 7, 0.4);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        .loading-banner.ready {
            background: rgba(40, 167, 69, 0.15);
            border-color: rgba(40, 167, 69, 0.4);
        }
        .loading-banner .title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #ffc107;
        }
        .loading-banner.ready .title {
            color: #28a745;
        }
        .model-status {
            display: flex;
            justify-content: center;
            gap: 30px;
            font-size: 14px;
        }
        .model-status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666;
        }
        .status-dot.pending { background: #666; }
        .status-dot.loading { background: #ffc107; animation: pulse 1s infinite; }
        .status-dot.ready { background: #28a745; }
        .status-dot.error { background: #dc3545; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        /* ========================================
           UNIFIED SERVER STATUS CARD
           ======================================== */
        .server-status-card {
            background: linear-gradient(135deg, rgba(192, 132, 252, 0.08) 0%, rgba(168, 85, 247, 0.05) 100%);
            padding: 0;
            overflow: hidden;
        }

        .server-status-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .server-status-header:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .server-gpu {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            font-size: 13px;
        }

        .gpu-icon {
            color: var(--cyan);
        }

        #gpu-name {
            color: var(--text-muted);
            flex: 0 0 auto;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .gpu-bar {
            flex: 1;
            max-width: 100px;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .gpu-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #ffc107);
            border-radius: 3px;
            transition: width 0.3s;
            width: 0%;
        }

        #gpu-mem {
            color: var(--text-muted);
            font-size: 12px;
            min-width: 35px;
        }

        .gpu-busy {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .gpu-busy.idle {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }

        .gpu-busy.busy {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .server-queue-summary {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-left: 16px;
            border-left: 1px solid var(--border);
        }

        .server-queue-summary .queue-badge {
            background: var(--cyan);
            color: var(--bg-dark);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 700;
            min-width: 20px;
            text-align: center;
        }

        .server-queue-summary .queue-badge.empty {
            background: var(--text-muted);
            opacity: 0.5;
        }

        .server-queue-summary .queue-label {
            color: var(--text-muted);
            font-size: 12px;
        }

        .server-queue-summary .wait-time {
            color: var(--text-muted);
            font-size: 12px;
            opacity: 0.7;
        }

        .server-status-card .collapse-icon {
            color: var(--text-muted);
            font-size: 0.8rem;
            transition: transform 0.3s;
            margin-left: auto;
        }

        .server-status-card.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .server-status-card .queue-explorer-content {
            padding: 0 16px 16px;
            transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
            overflow: hidden;
        }

        .server-status-card.collapsed .queue-explorer-content {
            max-height: 0;
            opacity: 0;
            padding: 0 16px;
        }

        .queue-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px;
            color: var(--text-muted);
            font-size: 13px;
        }

        .queue-empty .icon {
            color: var(--accent);
        }
        .job-progress {
            background: rgba(192, 132, 252, 0.1);
            border: 1px solid rgba(192, 132, 252, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
        }
        .job-progress .position {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        .job-progress .progress-text {
            color: var(--accent-light);
            font-weight: 500;
        }
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #c084fc 0%, #a855f7 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
        .queue-info {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 10px;
        }
        /* Tooltip styles */
        [title] {
            position: relative;
        }
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
            margin-bottom: 5px;
        }
        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }
        .feedback-toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(40, 167, 69, 0.95);
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            z-index: 10000;
            pointer-events: none;
            max-width: 90%;
            text-align: center;
        }
        .feedback-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }
        .feedback-toast.error {
            background: rgba(220, 53, 69, 0.95);
        }
        .feedback-toast.warning {
            background: rgba(255, 193, 7, 0.95);
            color: #000;
        }
        .feedback-toast .toast-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }
        .feedback-toast .copy-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            margin-top: 8px;
            pointer-events: auto !important;
            user-select: none;
            transition: background 0.2s;
        }
        .feedback-toast .copy-btn:hover {
            background: rgba(255,255,255,0.4);
        }
        .feedback-toast .copy-btn:active {
            background: rgba(40, 167, 69, 0.6);
            transform: scale(0.98);
        }

        .queue-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .queue-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            border-radius: 10px;
            transition: all 0.2s;
        }

        .queue-item.processing {
            border-color: var(--cyan);
            background: rgba(192, 132, 252, 0.1);
            animation: processingPulse 2s ease-in-out infinite;
        }

        @keyframes processingPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(192, 132, 252, 0.4); }
            50% { box-shadow: 0 0 20px 0 rgba(192, 132, 252, 0.2); }
        }

        .queue-item.own-job {
            border-left: 3px solid var(--accent);
        }

        .queue-item-position {
            font-family: 'Fredoka', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--cyan);
            min-width: 28px;
            text-align: center;
        }

        .queue-item.processing .queue-item-position {
            animation: positionPulse 1s ease-in-out infinite;
        }

        @keyframes positionPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .queue-item-info {
            flex: 1;
            min-width: 0;
        }

        .queue-item-prompt {
            font-size: 0.9rem;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        .queue-item-meta {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .queue-item-meta .model-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(168, 85, 247, 0.2);
            color: var(--accent);
        }

        .queue-item-meta .model-badge.audio {
            background: rgba(192, 132, 252, 0.2);
            color: var(--cyan);
        }

        .queue-item-meta .model-badge.voice {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .queue-item-meta .duration-badge,
        .queue-item-meta .priority-badge {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .queue-item-meta .priority-badge.admin {
            color: #ff6b6b;
        }

        .queue-item-meta .priority-badge.premium {
            color: #ffd700;
        }

        .queue-item-progress {
            margin-top: 8px;
        }

        .queue-item-progress .progress-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .queue-item-progress .progress-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, var(--cyan), var(--accent));
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .queue-item-progress .progress-text {
            font-size: 0.75rem;
            color: var(--cyan);
        }

        .queue-item .cancel-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .queue-item .cancel-btn:hover {
            background: rgba(239, 68, 68, 0.4);
            transform: scale(1.1);
        }

        .queue-empty {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .queue-empty .icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        /* ========================================
           MAIN TABS
           ======================================== */
        .main-tabs {
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-bottom: 20px;
            padding: 6px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .main-tab {
            flex: 1;
            padding: 10px 12px;
            background: transparent;
            border: none;
            border-radius: 10px;
            color: var(--text-muted);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .main-tab:hover {
            color: var(--text);
            background: rgba(255, 255, 255, 0.05);
        }

        .main-tab.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .main-tab .icon {
            font-size: 1.1rem;
        }

        /* Mobile Tab Dropdown - only visible on smallest screens */
        .mobile-tab-dropdown {
            display: none;
            width: 100%;
            max-width: 280px;
            margin: 0 auto 20px;
        }

        .mobile-tab-select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2394a3b8' viewBox='0 0 16 16'%3E%3Cpath d='M4 6l4 4 4-4'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
        }

        .mobile-tab-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-glow);
        }

        .mobile-tab-select option {
            background: var(--bg-card);
            color: var(--text);
            padding: 8px;
        }

        @media (max-width: 480px) {
            .mobile-tab-dropdown {
                display: block;
            }
            .main-tabs {
                display: none;
            }
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========================================
           PLAYLISTS TAB
           ======================================== */
        .playlists-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 24px;
        }

        .playlists-intro {
            color: var(--text-muted);
            margin: 0;
            flex: 1;
            min-width: 200px;
        }

        .playlists-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .playlist-empty-state,
        .favorites-empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 48px 20px;
            color: var(--text-muted);
        }

        .playlist-empty-state .icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .playlist-empty-state h3 {
            margin: 0 0 8px;
            color: var(--text);
        }

        .playlist-empty-state p,
        .favorites-empty-state p {
            margin: 0;
            font-size: 0.9rem;
        }

        .favorites-section {
            border-top: 1px solid var(--border);
            padding-top: 24px;
        }

        .favorites-section h3 {
            font-size: 1.1rem;
            margin: 0 0 8px;
        }

        .section-hint {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin: 0 0 16px;
        }

        .favorites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
        }

        /* ========================================
           HISTORY TAB
           ======================================== */
        .history-card {
            max-width: 900px;
            margin: 0 auto;
        }

        .history-auth-gate {
            text-align: center;
            padding: 60px 20px;
        }

        .history-auth-gate .auth-gate-content {
            max-width: 400px;
            margin: 0 auto;
        }

        .history-auth-gate .icon-xl {
            font-size: 3rem;
            color: var(--text-muted);
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .history-auth-gate h3 {
            margin: 0 0 8px;
            font-size: 1.2rem;
        }

        .history-auth-gate p {
            color: var(--text-muted);
            margin: 0;
            font-size: 0.9rem;
        }

        .history-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }

        .history-tab {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: none;
            background: none;
            color: var(--text-muted);
            font-size: 0.95rem;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s ease;
        }

        .history-tab:hover {
            color: var(--text);
            background: rgba(255,255,255,0.05);
        }

        .history-tab.active {
            color: var(--accent);
            background: rgba(168, 85, 247, 0.1);
            border-bottom: 2px solid var(--accent);
        }

        .history-tab .icon {
            width: 16px;
            height: 16px;
        }

        .history-section {
            display: none;
        }

        .history-section.active {
            display: block;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .history-loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .history-item:hover {
            border-color: var(--accent);
            background: rgba(168, 85, 247, 0.05);
        }

        .history-item-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            flex-shrink: 0;
        }

        .history-item-icon.play {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }

        .history-item-icon.upvote {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }

        .history-item-icon.downvote {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .history-item-info {
            flex: 1;
            min-width: 0;
        }

        .history-item-prompt {
            font-size: 0.95rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        .history-item-meta {
            display: flex;
            gap: 12px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .history-item-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .history-item-actions {
            display: flex;
            gap: 8px;
        }

        .history-item-actions button {
            padding: 6px 12px;
            border: 1px solid var(--border);
            background: none;
            color: var(--text-muted);
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-item-actions button:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .history-empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .history-empty-state .icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            opacity: 0.3;
        }

        .load-more-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-top: 16px;
            border: 1px solid var(--border);
            background: none;
            color: var(--text);
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .load-more-btn:hover {
            border-color: var(--accent);
            background: rgba(168, 85, 247, 0.05);
        }

        /* ========================================
           API DOCUMENTATION TAB
           ======================================== */
        .api-docs-card {
            max-width: 900px;
            margin: 0 auto;
        }

        .api-intro {
            font-size: 1.05rem;
            color: var(--text);
            margin-bottom: 32px;
            padding: 16px;
            background: rgba(168, 85, 247, 0.1);
            border-radius: 12px;
            border-left: 4px solid var(--accent);
        }

        .api-intro strong {
            color: #22c55e;
        }

        .api-section {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }

        .api-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .api-section h3 {
            font-size: 1.2rem;
            margin: 0 0 12px;
            color: var(--text);
        }

        .api-section > p {
            color: var(--text-muted);
            margin: 0 0 16px;
        }

        /* Widget Size Previews */
        .widget-sizes-preview {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }

        .widget-size-option {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .widget-size-option span {
            font-size: 0.9rem;
            color: var(--text);
            font-weight: 500;
        }

        .widget-size-option small {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        /* Demo widget containers with proper dimensions */
        .widget-demo-container {
            width: 100%;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            min-height: 48px;
            padding: 10px;
        }

        /* Size-specific container dimensions */
        .widget-size-option[data-size="minimal"] .widget-demo-container {
            min-width: 340px;
            max-width: 360px;
            min-height: 80px;
            padding: 12px;
        }

        .widget-size-option[data-size="small"] .widget-demo-container {
            min-width: 320px;
            max-width: 400px;
            min-height: 80px;
        }

        .widget-size-option[data-size="medium"] .widget-demo-container {
            min-width: 400px;
            max-width: 480px;
            min-height: 140px;
        }

        .widget-size-option[data-size="large"] .widget-demo-container {
            min-width: 100%;
            max-width: 100%;
            min-height: 200px;
        }

        @media (max-width: 500px) {
            .widget-size-option[data-size="minimal"] .widget-demo-container,
            .widget-size-option[data-size="small"] .widget-demo-container,
            .widget-size-option[data-size="medium"] .widget-demo-container,
            .widget-size-option[data-size="large"] .widget-demo-container {
                min-width: 100%;
                max-width: 100%;
            }
        }

        /* Code Blocks */
        .code-block {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            overflow: hidden;
            margin: 16px 0;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid var(--border);
        }

        .code-header span {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .copy-btn {
            padding: 4px 12px;
            font-size: 0.75rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            background: var(--accent-hover);
        }

        .code-block pre {
            margin: 0;
            padding: 16px;
            overflow-x: auto;
        }

        .code-block code {
            font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;
            font-size: 0.85rem;
            color: #e2e8f0;
            line-height: 1.6;
        }

        /* API Endpoints */
        .api-endpoint {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }

        .api-endpoint:last-child {
            margin-bottom: 0;
        }

        .endpoint-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .endpoint-header code {
            font-family: 'Fira Code', 'Monaco', monospace;
            font-size: 1rem;
            color: var(--cyan);
        }

        .method {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .method.get {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .method.post {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .api-endpoint > p {
            color: var(--text);
            margin: 0 0 12px;
        }

        .endpoint-params {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px 16px;
            border-radius: 8px;
            margin-top: 12px;
        }

        .endpoint-params strong {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .endpoint-params ul {
            margin: 8px 0 0;
            padding-left: 20px;
        }

        .endpoint-params li {
            color: var(--text-dim);
            font-size: 0.9rem;
            margin: 4px 0;
        }

        .endpoint-params code {
            background: rgba(168, 85, 247, 0.2);
            color: var(--accent);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .api-limits {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .api-limits li {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            color: var(--text);
        }

        .api-limits li:last-child {
            border-bottom: none;
        }

        .api-limits strong {
            color: var(--accent);
        }

        .attribution-block {
            border: 2px dashed rgba(34, 197, 94, 0.3);
        }

        /* ========================================
           MINI PLAYER (Header)
           ======================================== */
        .mini-player {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: var(--gradient-accent);
            border-radius: 24px;
            margin-left: auto;
            max-width: 420px;
            min-width: 320px;
            overflow: hidden;
            animation: miniSlideIn 0.3s ease;
        }

        @keyframes miniSlideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .mini-player.hidden {
            display: none;
        }

        .mini-eq {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 16px;
        }

        .mini-eq-bar {
            width: 3px;
            background: white;
            border-radius: 2px;
            animation: miniEqBounce 0.4s ease-in-out infinite alternate;
        }

        .mini-eq-bar:nth-child(1) { height: 40%; animation-delay: 0s; }
        .mini-eq-bar:nth-child(2) { height: 80%; animation-delay: 0.1s; }
        .mini-eq-bar:nth-child(3) { height: 60%; animation-delay: 0.2s; }

        @keyframes miniEqBounce {
            0% { transform: scaleY(0.4); }
            100% { transform: scaleY(1); }
        }

        .mini-player.paused .mini-eq-bar {
            animation: none;
            height: 30%;
        }

        .mini-title {
            flex: 1;
            color: white;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .mini-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            transition: all 0.2s;
            padding: 0;
        }

        .mini-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .mini-btn svg {
            width: 14px;
            height: 14px;
        }

        .mini-play {
            width: 32px;
            height: 32px;
            background: white;
            color: var(--accent);
        }

        .mini-play:hover {
            background: white;
            transform: scale(1.1);
        }

        .mini-play .pause-icon {
            display: none;
        }

        .mini-player.playing .mini-play .play-icon {
            display: none;
        }

        .mini-player.playing .mini-play .pause-icon {
            display: block;
        }

        /* ========================================
           FAVORITES BUTTON
           ======================================== */
        .favorite-btn {
            background: transparent;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 8px;
            transition: all 0.2s;
            color: var(--text-muted);
        }

        .favorite-btn:hover {
            transform: scale(1.1);
            color: #ff6b6b;
        }

        .favorite-btn.favorited {
            color: #ff6b6b;
        }

        .favorite-btn.favorited .heart {
            animation: heartPop 0.3s ease-out;
        }

        @keyframes heartPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        /* Play Favorites button in radio controls */
        .favorites-btn {
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.2) 0%, rgba(255, 107, 107, 0.1) 100%);
            border: 2px solid rgba(255, 107, 107, 0.4);
            border-radius: 10px;
            color: #ff6b6b;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .favorites-btn:hover {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.3) 0%, rgba(255, 107, 107, 0.2) 100%);
            border-color: #ff6b6b;
            transform: translateY(-2px);
        }

        .favorites-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ========================================
           RADIO STATION - REDESIGNED
           ======================================== */
        .radio-card {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.12) 0%, rgba(192, 132, 252, 0.08) 100%);
            border: 1px solid var(--border);
            padding: 20px;
        }

        .radio-card h2 {
            display: none; /* Hidden - station presets replace header */
        }

        /* Station Presets - Horizontal Scroll */
        .station-presets {
            margin-bottom: 20px;
        }

        .station-presets-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .station-presets-label::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--border), transparent);
        }

        .station-scroll {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 8px 0 16px;
        }

        .station-card {
            aspect-ratio: 1.3;
            min-height: 70px;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            animation: stationPulse 3s ease-in-out infinite;
            animation-delay: calc(var(--i, 0) * 0.2s);
        }

        .station-card:nth-child(1) { --i: 0; }
        .station-card:nth-child(2) { --i: 1; }
        .station-card:nth-child(3) { --i: 2; }
        .station-card:nth-child(4) { --i: 3; }
        .station-card:nth-child(5) { --i: 4; }
        .station-card:nth-child(6) { --i: 5; }
        .station-card:nth-child(7) { --i: 6; }
        .station-card:nth-child(8) { --i: 7; }

        @keyframes stationPulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
            50% { box-shadow: 0 6px 25px var(--station-glow, rgba(168, 85, 247, 0.3)); }
        }

        .station-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.15) 0%, transparent 50%);
            pointer-events: none;
        }

        .station-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 40%,
                rgba(255,255,255,0.1) 50%,
                transparent 60%
            );
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .station-card:hover::after {
            transform: translateX(100%);
        }

        .station-card:hover {
            transform: translateY(-6px) scale(1.05);
            border-color: rgba(255,255,255,0.4);
            box-shadow: 0 12px 40px var(--station-glow, rgba(168, 85, 247, 0.5));
            animation-play-state: paused;
        }

        .station-card.active {
            border-color: white;
            box-shadow: 0 0 40px var(--station-glow, var(--accent-glow)), inset 0 0 20px rgba(255,255,255,0.1);
            transform: translateY(-3px) scale(1.02);
            animation: activeGlow 1.5s ease-in-out infinite;
        }

        @keyframes activeGlow {
            0%, 100% { box-shadow: 0 0 30px var(--station-glow, var(--accent-glow)), inset 0 0 15px rgba(255,255,255,0.1); }
            50% { box-shadow: 0 0 50px var(--station-glow, var(--accent-glow)), inset 0 0 25px rgba(255,255,255,0.15); }
        }

        .station-card .station-icon {
            width: 2.8rem;
            height: 2.8rem;
            filter: drop-shadow(0 3px 6px rgba(0,0,0,0.4));
            transition: transform 0.3s ease;
            fill: currentColor;
        }

        .station-card:hover .station-icon {
            transform: scale(1.15);
        }

        .station-card .station-name {
            font-size: 1rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.6);
            text-align: center;
            padding: 0 6px;
            letter-spacing: 0.3px;
        }

        /* Station color themes with animated gradients */
        .station-ambient {
            background: linear-gradient(135deg, #1e3a5f 0%, #0d1f3c 50%, #1e3a5f 100%);
            background-size: 200% 200%;
            animation: stationPulse 3s ease-in-out infinite, gradientShift 8s ease infinite;
            --station-glow: rgba(30, 100, 150, 0.6);
        }
        .station-retro {
            background: linear-gradient(135deg, #9333ea 0%, #4f1d8a 50%, #9333ea 100%);
            background-size: 200% 200%;
            animation: stationPulse 3s ease-in-out infinite 0.2s, gradientShift 6s ease infinite;
            --station-glow: rgba(147, 51, 234, 0.6);
        }
        .station-piano {
            background: linear-gradient(135deg, #d97706 0%, #92400e 50%, #d97706 100%);
            background-size: 200% 200%;
            animation: stationPulse 3s ease-in-out infinite 0.4s, gradientShift 7s ease infinite;
            --station-glow: rgba(217, 119, 6, 0.6);
        }
        .station-happy {
            background: linear-gradient(135deg, #f59e0b 0%, #ea580c 50%, #f59e0b 100%);
            background-size: 200% 200%;
            animation: stationPulse 3s ease-in-out infinite 0.6s, gradientShift 5s ease infinite;
            --station-glow: rgba(245, 158, 11, 0.6);
        }
        .station-dreamy {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 50%, #8b5cf6 100%);
            background-size: 200% 200%;
            animation: stationPulse 3s ease-in-out infinite 0.8s, gradientShift 9s ease infinite;
            --station-glow: rgba(139, 92, 246, 0.6);
        }
        .station-lofi {
            background: linear-gradient(135deg, #059669 0%, #047857 50%, #059669 100%);
            background-size: 200% 200%;
            animation: stationPulse 3s ease-in-out infinite 1s, gradientShift 7s ease infinite;
            --station-glow: rgba(5, 150, 105, 0.6);
        }
        .station-favorites {
            background: linear-gradient(135deg, #e11d48 0%, #be123c 50%, #e11d48 100%);
            background-size: 200% 200%;
            animation: stationPulse 3s ease-in-out infinite 1.2s, gradientShift 6s ease infinite;
            --station-glow: rgba(225, 29, 72, 0.6);
        }
        .station-all {
            background: linear-gradient(135deg, var(--accent) 0%, #6366f1 50%, var(--accent) 100%);
            background-size: 200% 200%;
            animation: stationPulse 3s ease-in-out infinite 1.4s, gradientShift 8s ease infinite;
            --station-glow: var(--accent-glow);
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Responsive - 2 rows of 4 on desktop, 4 rows of 2 on mobile */
        @media (max-width: 500px) {
            .station-scroll {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }
            .station-card {
                min-height: 60px;
            }
            .station-card .station-icon {
                width: 1.8rem;
                height: 1.8rem;
            }
            .station-card .station-name {
                font-size: 0.75rem;
            }
        }

        @media (max-width: 360px) {
            .station-scroll {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
            }
            .station-card {
                min-height: 55px;
            }
            .station-card .station-icon {
                width: 1.5rem;
                height: 1.5rem;
            }
            .station-card .station-name {
                font-size: 0.7rem;
            }
        }

        /* Start Playing Banner */
        .start-playing-banner {
            margin: 20px 0;
            animation: bannerFadeIn 0.5s ease;
        }

        @keyframes bannerFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .start-playing-banner.fading {
            animation: bannerFadeOut 0.3s ease forwards;
        }

        @keyframes bannerFadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }

        .start-banner-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 20px 28px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2) 0%, rgba(192, 132, 252, 0.2) 100%);
            border: 2px solid rgba(168, 85, 247, 0.4);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .start-banner-content::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(135deg, var(--accent), var(--cyan), var(--accent));
            background-size: 200% 200%;
            animation: borderGlow 3s ease-in-out infinite;
            z-index: -1;
            border-radius: 18px;
            opacity: 0.5;
        }

        .start-banner-content:hover {
            transform: translateY(-3px);
            border-color: var(--accent);
            box-shadow: 0 8px 30px rgba(168, 85, 247, 0.3), 0 0 40px rgba(168, 85, 247, 0.2);
        }

        .start-banner-content:hover .start-icon {
            transform: scale(1.1);
        }

        .start-icon {
            width: 48px;
            height: 48px;
            color: var(--accent);
            filter: drop-shadow(0 0 10px var(--accent-glow));
            transition: transform 0.3s ease;
        }

        .start-text h3 {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.2rem;
            color: var(--text);
            margin: 0 0 4px;
        }

        .start-text p {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin: 0;
        }

        /* Featured Row */
        .featured-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        .featured-btn {
            flex: 1 1 auto;
            min-width: 0;
            padding: 10px 14px;
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            position: relative;
            overflow: hidden;
            white-space: nowrap;
        }

        .featured-btn span:first-child {
            font-size: 1.1rem;
            transition: transform 0.3s ease;
        }

        .featured-btn:hover span:first-child {
            transform: scale(1.2) rotate(5deg);
        }

        .featured-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent 0%, rgba(255,255,255,0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .featured-btn:hover::before {
            opacity: 1;
        }

        .featured-btn:hover {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(168, 85, 247, 0.05) 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(168, 85, 247, 0.2);
        }

        .featured-btn.active {
            border-color: var(--accent);
            background: var(--gradient-accent);
            color: white;
            box-shadow: 0 8px 30px var(--accent-glow);
        }

        /* Hide text on small screens, show only icons */
        @media (max-width: 600px) {
            .featured-btn {
                padding: 12px;
                min-width: 48px;
                flex: 0 0 auto;
            }
            .featured-btn .icon ~ *:not(.icon) {
                display: none;
            }
        }

        /* Now Playing - Enhanced with EQ */
        .now-playing {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 24px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.08) 0%, rgba(0,0,0,0.3) 50%, rgba(192, 132, 252, 0.05) 100%);
            border-radius: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(168, 85, 247, 0.3);
            position: relative;
            overflow: hidden;
            animation: nowPlayingGlow 4s ease-in-out infinite;
        }

        @keyframes nowPlayingGlow {
            0%, 100% { box-shadow: 0 4px 30px rgba(168, 85, 247, 0.15), inset 0 0 60px rgba(168, 85, 247, 0.03); }
            50% { box-shadow: 0 8px 40px rgba(168, 85, 247, 0.25), inset 0 0 80px rgba(168, 85, 247, 0.05); }
        }

        .now-playing::before {
            content: 'NOW PLAYING';
            position: absolute;
            top: 10px;
            left: 20px;
            font-size: 0.6rem;
            color: var(--accent);
            letter-spacing: 3px;
            font-weight: 700;
            animation: nowPlayingLabel 2s ease-in-out infinite;
        }

        @keyframes nowPlayingLabel {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        /* Ambient background animation */
        .now-playing::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(168, 85, 247, 0.1) 0%, transparent 50%);
            animation: ambientRotate 20s linear infinite;
            pointer-events: none;
        }

        @keyframes ambientRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .now-playing.hidden {
            display: none;
        }

        .now-playing .hero-section {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-top: 12px;
            position: relative;
            z-index: 1;
        }

        /* Animated EQ Visualizer - Bigger and more dramatic */
        .eq-visualizer {
            width: 110px;
            height: 80px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 4px;
            background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0.4) 100%);
            border-radius: 14px;
            padding: 12px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3), inset 0 0 20px rgba(168, 85, 247, 0.1);
        }

        .eq-visualizer::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, transparent 0%, rgba(168, 85, 247, 0.15) 100%);
            pointer-events: none;
        }

        .eq-bar {
            width: 8px;
            background: linear-gradient(180deg, #ff6b6b 0%, var(--accent) 40%, var(--cyan) 100%);
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.5);
        }

        @keyframes eqBounce1 { 0%, 100% { height: 15%; } 25% { height: 70%; } 50% { height: 90%; } 75% { height: 45%; } }
        @keyframes eqBounce2 { 0%, 100% { height: 40%; } 25% { height: 20%; } 50% { height: 65%; } 75% { height: 85%; } }
        @keyframes eqBounce3 { 0%, 100% { height: 25%; } 25% { height: 100%; } 50% { height: 50%; } 75% { height: 75%; } }
        @keyframes eqBounce4 { 0%, 100% { height: 55%; } 25% { height: 30%; } 50% { height: 35%; } 75% { height: 90%; } }
        @keyframes eqBounce5 { 0%, 100% { height: 30%; } 25% { height: 80%; } 50% { height: 60%; } 75% { height: 20%; } }
        @keyframes eqBounce6 { 0%, 100% { height: 45%; } 25% { height: 65%; } 50% { height: 20%; } 75% { height: 55%; } }
        @keyframes eqBounce7 { 0%, 100% { height: 20%; } 25% { height: 50%; } 50% { height: 70%; } 75% { height: 35%; } }

        .eq-bar:nth-child(1) { animation: eqBounce1 0.9s ease-in-out infinite; }
        .eq-bar:nth-child(2) { animation: eqBounce2 0.7s ease-in-out infinite 0.05s; }
        .eq-bar:nth-child(3) { animation: eqBounce3 0.8s ease-in-out infinite 0.1s; }
        .eq-bar:nth-child(4) { animation: eqBounce4 0.6s ease-in-out infinite 0.15s; }
        .eq-bar:nth-child(5) { animation: eqBounce5 0.75s ease-in-out infinite 0.2s; }
        .eq-bar:nth-child(6) { animation: eqBounce6 0.65s ease-in-out infinite 0.1s; }
        .eq-bar:nth-child(7) { animation: eqBounce7 0.85s ease-in-out infinite 0.25s; }

        .eq-visualizer.paused .eq-bar {
            animation: none;
            height: 6px;
            opacity: 0.5;
        }

        .now-playing .track-info {
            flex: 1;
            min-width: 0;
        }

        .now-playing .track-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .now-playing .track-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .now-playing .track-meta .duration {
            background: var(--bg-card);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        /* Controls Section */
        .now-playing .controls-section {
            display: flex;
            flex-direction: column;
            gap: 14px;
            position: relative;
            z-index: 1;
        }

        .now-playing .audio-row {
            display: flex;
            align-items: center;
            position: relative;
        }

        .now-playing .styled-audio {
            flex: 1;
        }

        .now-playing .styled-audio audio {
            width: 100%;
            height: 40px;
        }

        /* Start playing overlay */
        .audio-start-overlay {
            position: absolute;
            inset: 0;
            background: rgba(10, 14, 23, 0.95);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            color: var(--accent);
            font-weight: 500;
            transition: all 0.2s;
            border: 1px solid var(--accent);
        }

        .audio-start-overlay:hover {
            background: rgba(168, 85, 247, 0.2);
            transform: scale(1.02);
        }

        .audio-start-overlay .icon {
            animation: pulse 2s ease-in-out infinite;
        }

        .audio-start-overlay.hidden {
            display: none;
        }

        /* Unified control bar */
        .now-playing .control-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 10px 14px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        /* Playback controls group (prev, next) */
        .playback-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .control-btn:hover {
            background: rgba(168, 85, 247, 0.2);
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .control-btn.primary {
            width: 48px;
            height: 48px;
            background: var(--gradient-accent);
            border: none;
            font-size: 1.3rem;
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .control-btn.primary:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 25px var(--accent-glow);
        }

        .control-btn:disabled,
        .control-btn[disabled] {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Rating controls group */
        .rating-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .rating-btn {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .rating-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--text-muted);
        }

        .rating-btn.voted-up {
            background: rgba(16, 185, 129, 0.25);
            border-color: var(--success);
            color: var(--success);
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.3);
        }

        .rating-btn.voted-up .icon {
            color: var(--success);
        }

        .rating-btn.voted-down {
            background: rgba(239, 68, 68, 0.25);
            border-color: var(--error);
            color: var(--error);
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.3);
        }

        .rating-btn.voted-down .icon {
            color: var(--error);
        }

        /* Voting animation - glow pulse */
        .rating-btn.voting {
            animation: ratingGlow 0.6s ease-out;
        }

        @keyframes ratingGlow {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.5);
            }
            50% {
                transform: scale(1.1);
                box-shadow: 0 0 20px 5px rgba(168, 85, 247, 0.6);
                background: rgba(168, 85, 247, 0.3);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 10px 2px rgba(168, 85, 247, 0.3);
            }
        }

        .rating-btn .count {
            font-weight: 600;
            min-width: 16px;
            text-align: center;
        }

        .rating-btn:disabled,
        .rating-btn[disabled] {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Favorite button in control bar */
        .control-bar .favorite-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .control-bar .favorite-btn:hover {
            background: rgba(225, 29, 72, 0.2);
            border-color: #e11d48;
            transform: scale(1.1);
        }

        .control-bar .favorite-btn.favorited {
            background: rgba(225, 29, 72, 0.25);
            border-color: #e11d48;
        }

        .control-bar .favorite-btn:disabled,
        .control-bar .favorite-btn[disabled] {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Separator */
        .control-separator {
            width: 1px;
            height: 28px;
            background: var(--border);
            margin: 0 4px;
        }

        /* SVG Icon styling */
        .icon {
            width: 20px;
            height: 20px;
            display: inline-block;
            vertical-align: middle;
        }

        .icon-sm { width: 16px; height: 16px; }
        .icon-md { width: 20px; height: 20px; }
        .icon-lg { width: 24px; height: 24px; }
        .icon-xl { width: 28px; height: 28px; }

        .control-btn .icon {
            width: 22px;
            height: 22px;
        }

        .control-btn.primary .icon {
            width: 26px;
            height: 26px;
        }

        .rating-btn .icon {
            width: 18px;
            height: 18px;
        }

        .control-bar .favorite-btn .icon {
            width: 22px;
            height: 22px;
            transition: transform 0.2s ease;
        }

        .control-bar .favorite-btn:hover .icon {
            transform: scale(1.15);
        }

        .control-bar .favorite-btn.favorited .icon {
            color: #e11d48;
        }

        /* Up Next Queue - Enhanced */
        .radio-queue {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border);
        }

        .radio-queue.hidden {
            display: none;
        }

        .queue-header {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .queue-count {
            background: var(--accent);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        .queue-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .queue-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .queue-item:hover {
            background: rgba(255,255,255,0.06);
        }

        .queue-num {
            width: 24px;
            height: 24px;
            background: var(--bg-card);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        .queue-prompt {
            flex: 1;
            font-size: 0.85rem;
            color: var(--text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .queue-duration {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--bg-card);
            padding: 3px 8px;
            border-radius: 4px;
        }

        .queue-remove {
            width: 24px;
            height: 24px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            opacity: 0;
        }

        .queue-item:hover .queue-remove {
            opacity: 1;
        }

        .queue-remove:hover {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        /* Legacy hidden controls for model select */
        .radio-controls-hidden {
            display: none;
        }

        .feedback-menu {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .feedback-menu.hidden {
            display: none;
        }

        .feedback-header {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 12px;
            font-size: 0.95rem;
        }

        .feedback-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .feedback-tag {
            padding: 8px 14px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: transparent;
            color: var(--text-dim);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .feedback-tag:hover {
            border-color: var(--error);
            color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .feedback-tag.positive:hover {
            border-color: var(--success);
            color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .feedback-cancel {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .feedback-cancel:hover {
            border-color: var(--text-dim);
            color: var(--text);
        }

        /* Selected state for multi-select feedback tags */
        .feedback-tag.selected {
            border-color: var(--error);
            color: var(--error);
            background: rgba(239, 68, 68, 0.15);
        }

        .feedback-tag.positive.selected {
            border-color: var(--success);
            color: var(--success);
            background: rgba(16, 185, 129, 0.15);
        }

        /* Feedback action buttons container */
        .feedback-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .feedback-submit {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: var(--gradient-accent);
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
        }

        .feedback-submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--accent-glow);
        }

        .feedback-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .feedback-submit.positive {
            background: var(--success);
        }

        .feedback-submit.positive:hover {
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        /* Reclassification section */
        .feedback-reclassify {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .feedback-reclassify-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: block;
        }

        .feedback-reclassify-options {
            display: flex;
            gap: 8px;
        }

        .reclassify-option {
            padding: 8px 14px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: transparent;
            color: var(--text-dim);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reclassify-option:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(168, 85, 247, 0.1);
        }

        .reclassify-option.selected {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(168, 85, 247, 0.15);
        }

        /* Feedback Modal - Enhanced with Particles & Glow */
        .feedback-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 1;
            transition: opacity 0.3s ease;
            overflow: hidden;
        }

        .feedback-modal-overlay.hidden {
            display: none;
        }

        /* Particle container */
        .feedback-particles {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .feedback-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: floatParticle 4s ease-in-out infinite;
        }

        @keyframes floatParticle {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.6; }
            25% { transform: translateY(-30px) rotate(90deg); opacity: 1; }
            50% { transform: translateY(-60px) rotate(180deg); opacity: 0.8; }
            75% { transform: translateY(-30px) rotate(270deg); opacity: 1; }
        }

        .feedback-modal {
            background: linear-gradient(145deg, rgba(17, 24, 39, 0.98) 0%, rgba(10, 14, 23, 0.98) 100%);
            border: 2px solid transparent;
            border-radius: 24px;
            padding: 24px;
            max-width: 420px;
            width: 92%;
            max-height: calc(100vh - 40px);
            max-height: calc(100dvh - 40px);  /* Dynamic viewport height for mobile */
            overflow: visible;
            position: relative;
            z-index: 1;
            animation: modalGlowIn 0.4s ease-out;
        }

        .feedback-modal::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 26px;
            background: linear-gradient(135deg, var(--accent), var(--cyan), var(--accent));
            background-size: 200% 200%;
            z-index: -1;
            animation: borderGlow 3s ease-in-out infinite;
        }

        .feedback-modal::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 24px;
            background: linear-gradient(145deg, rgba(17, 24, 39, 0.98) 0%, rgba(10, 14, 23, 0.98) 100%);
            z-index: -1;
        }

        .feedback-modal.positive::before {
            background: linear-gradient(135deg, var(--success), #34d399, var(--success));
            background-size: 200% 200%;
        }

        .feedback-modal.negative::before {
            background: linear-gradient(135deg, var(--error), #ec4899, var(--error));
            background-size: 200% 200%;
        }

        @keyframes borderGlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes modalGlowIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.9);
                filter: blur(4px);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
                filter: blur(0);
            }
        }

        .feedback-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }

        .feedback-modal-title {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feedback-modal-title::before {
            content: '';
            display: inline-block;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            animation: iconPulse 2s ease-in-out infinite;
        }

        .feedback-modal-title.positive {
            color: var(--success);
            text-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }

        .feedback-modal-title.positive::before {
            background: radial-gradient(circle, var(--success) 30%, transparent 70%);
            box-shadow: 0 0 20px var(--success), 0 0 40px rgba(16, 185, 129, 0.5);
        }

        .feedback-modal-title.negative {
            color: var(--error);
            text-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }

        .feedback-modal-title.negative::before {
            background: radial-gradient(circle, var(--error) 30%, transparent 70%);
            box-shadow: 0 0 20px var(--error), 0 0 40px rgba(239, 68, 68, 0.5);
        }

        @keyframes iconPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }

        .feedback-modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 50%;
            color: var(--text-muted);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .feedback-modal-close:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--error);
            color: var(--error);
            transform: rotate(90deg);
        }

        .feedback-modal-track {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(192, 132, 252, 0.1) 100%);
            border: 1px solid var(--border);
            border-radius: 14px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .feedback-modal-track::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.05), transparent);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        .feedback-modal-prompt {
            font-size: 0.95rem;
            color: var(--text);
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        .feedback-modal-section {
            margin-bottom: 16px;
        }

        .feedback-modal-label {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feedback-modal-label::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--border), transparent);
        }

        .feedback-modal-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .feedback-modal-options .feedback-tag {
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-dim);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .feedback-modal-options .feedback-tag::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, rgba(168, 85, 247, 0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .feedback-modal-options .feedback-tag:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(168, 85, 247, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(168, 85, 247, 0.25);
        }

        .feedback-modal-options .feedback-tag:hover::before {
            opacity: 1;
        }

        .feedback-modal-options .feedback-tag.selected {
            border-color: var(--accent);
            color: white;
            background: linear-gradient(135deg, var(--accent), #7c3aed);
            box-shadow: 0 4px 20px rgba(168, 85, 247, 0.4), inset 0 1px 0 rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .feedback-modal-options .feedback-tag.positive:hover {
            border-color: var(--success);
            color: var(--success);
            background: rgba(16, 185, 129, 0.15);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.25);
        }

        .feedback-modal-options .feedback-tag.positive:hover::before {
            background: radial-gradient(circle at center, rgba(16, 185, 129, 0.3) 0%, transparent 70%);
        }

        .feedback-modal-options .feedback-tag.positive.selected {
            border-color: var(--success);
            color: white;
            background: linear-gradient(135deg, var(--success), #059669);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4), inset 0 1px 0 rgba(255,255,255,0.2);
        }

        .feedback-modal-reclassify {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .feedback-modal-reclassify .reclassify-option {
            padding: 12px 18px;
            border: 2px solid var(--border);
            border-radius: 24px;
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-dim);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feedback-modal-reclassify .reclassify-option:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(168, 85, 247, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--accent-glow);
        }

        .feedback-modal-reclassify .reclassify-option.selected {
            border-color: var(--accent);
            color: white;
            background: var(--gradient-accent);
            box-shadow: 0 4px 20px var(--accent-glow), inset 0 1px 0 rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .feedback-modal-actions {
            display: flex;
            gap: 14px;
            margin-top: 28px;
            padding-top: 24px;
            border-top: 2px solid var(--border);
        }

        .feedback-modal-cancel {
            flex: 1;
            padding: 14px 24px;
            border: 2px solid var(--border);
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-muted);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .feedback-modal-cancel:hover {
            border-color: var(--text-dim);
            color: var(--text);
            background: rgba(255, 255, 255, 0.08);
        }

        .feedback-modal-submit {
            flex: 2;
            padding: 16px 28px;
            border: none;
            border-radius: 14px;
            background: linear-gradient(135deg, var(--accent), #7c3aed);
            color: white;
            font-size: 1.05rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .feedback-modal-submit::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .feedback-modal-submit:hover:not(:disabled)::before {
            transform: translateX(100%);
        }

        .feedback-modal-submit:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 30px rgba(168, 85, 247, 0.5), 0 0 40px rgba(168, 85, 247, 0.3);
        }

        .feedback-modal-submit:active:not(:disabled) {
            transform: translateY(-1px) scale(0.99);
        }

        .feedback-modal-submit:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            filter: grayscale(0.5);
        }

        .feedback-modal-submit.positive {
            background: linear-gradient(135deg, var(--success), #059669);
        }

        .feedback-modal-submit.positive:hover:not(:disabled) {
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.5), 0 0 40px rgba(16, 185, 129, 0.3);
        }

        /* Success celebration animation */
        @keyframes celebrationBurst {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        .feedback-celebration {
            position: absolute;
            inset: 0;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .celebration-ring {
            position: absolute;
            border: 3px solid var(--success);
            border-radius: 50%;
            width: 100px;
            height: 100px;
            animation: celebrationBurst 0.6s ease-out forwards;
        }

        .radio-queue {
            border-top: 1px solid var(--border);
            padding-top: 12px;
        }

        .radio-queue.hidden {
            display: none;
        }

        .queue-header {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .queue-items {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 150px;
            overflow-y: auto;
        }

        .queue-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-card);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .queue-item .queue-num {
            color: var(--text-muted);
            font-size: 0.75rem;
            min-width: 20px;
        }

        .queue-item .queue-prompt {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ========================================
           LIBRARY VIEW
           ======================================== */
        /* ========================================
           LIBRARY - REDESIGNED
           ======================================== */
        .library-card {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.12) 0%, rgba(168, 85, 247, 0.05) 100%);
            border: 1px solid var(--border);
        }

        .library-card h2 {
            font-size: 1.3rem;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .library-card h2 .icon {
            width: 24px;
            height: 24px;
            vertical-align: -4px;
        }

        .library-card h2 span {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: normal;
            margin-left: 8px;
        }

        /* Search Bar with Icon */
        .library-search-wrapper {
            position: relative;
            flex: 1;
            min-width: 200px;
        }

        .library-search-wrapper .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            color: var(--text-muted);
            pointer-events: none;
        }

        .library-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .library-controls .search-input {
            width: 100%;
            padding: 12px 16px 12px 42px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-input);
            color: var(--text);
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.2s;
        }

        .library-controls .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .library-controls .search-input::placeholder {
            color: var(--text-muted);
        }

        .library-controls select {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-input);
            color: var(--text);
            font-size: 0.9rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .library-controls select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Category Filter Pills */
        .library-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .filter-pill {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: transparent;
            color: var(--text-dim);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-pill:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .filter-pill.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .filter-pill .icon {
            width: 14px;
            height: 14px;
        }

        /* Category Browser - Redesigned */
        .library-layout {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 16px;
        }

        @media (max-width: 900px) {
            .library-layout {
                grid-template-columns: 1fr;
            }
            .category-sidebar {
                display: none;
            }
            .category-sidebar.mobile-open {
                display: block;
                position: fixed;
                top: 60px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 320px;
                max-height: calc(100vh - 100px);
                z-index: 100;
                background: var(--bg-card);
                border: 1px solid var(--border);
                border-radius: 16px;
                overflow-y: auto;
                padding: 16px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            }
            .category-overlay-backdrop {
                display: none;
            }
            .category-overlay-backdrop.active {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                z-index: 99;
            }
            .category-close-header {
                display: none;
                position: sticky;
                top: 0;
                margin: -16px -16px 12px -16px;
                padding: 12px 16px;
                width: calc(100% + 32px);
                background: var(--bg-card);
                border-bottom: 1px solid var(--border);
                border-radius: 16px 16px 0 0;
                z-index: 101;
                align-items: center;
                justify-content: space-between;
                font-size: 0.95rem;
                font-weight: 600;
                color: var(--text);
            }
            .category-sidebar.mobile-open .category-close-header {
                display: flex;
            }
            .category-close-btn {
                width: 32px;
                height: 32px;
                border: none;
                background: #ef4444;
                border-radius: 8px;
                color: white;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s;
            }
            .category-close-btn:hover {
                background: #dc2626;
                transform: scale(1.05);
            }
            .category-close-btn .icon {
                width: 18px;
                height: 18px;
            }
        }

        .category-sidebar {
            background: transparent;
            padding: 0;
        }

        /* Close header/button - hidden by default on desktop */
        .category-close-header {
            display: none;
        }

        /* Type Tabs - Vertical layout to save horizontal space */
        .category-type-tabs {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 16px;
            background: var(--bg-input);
            border-radius: 12px;
            padding: 4px;
            border: 1px solid var(--border);
        }

        .type-tab {
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 8px;
        }

        .type-tab:hover {
            color: var(--text);
            background: rgba(255, 255, 255, 0.05);
        }

        .type-tab.active {
            background: var(--accent);
            color: white;
        }

        .type-tab .icon {
            width: 16px;
            height: 16px;
        }

        .type-tab .tab-count {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* Quick Filters */
        .quick-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .quick-filter-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: transparent;
            color: var(--text-dim);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .quick-filter-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .quick-filter-btn.active {
            border-color: var(--accent);
            background: rgba(168, 85, 247, 0.1);
            color: var(--accent);
        }

        .quick-filter-btn .icon {
            width: 20px;
            height: 20px;
        }

        /* Genre List */
        .genre-section {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .genre-section-header {
            padding: 10px 14px;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            transition: all 0.2s;
        }

        .genre-section-header:hover {
            background: rgba(0, 0, 0, 0.3);
            color: var(--text);
        }

        .genre-section-header .chevron {
            width: 14px;
            height: 14px;
            transition: transform 0.2s;
            opacity: 0.5;
        }

        .genre-group.collapsed .genre-section-header .chevron {
            transform: rotate(-90deg);
        }

        .genre-group {
            margin-bottom: 2px;
        }

        .genre-group.collapsed .genre-list {
            display: none;
        }

        .genre-group:not(.collapsed) .genre-section-header {
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent);
        }

        .genre-list {
            padding: 6px;
        }

        .genre-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .genre-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
        }

        .genre-item.active {
            background: var(--accent);
            color: white;
        }

        .genre-item .icon {
            width: 16px;
            height: 16px;
            opacity: 0.7;
        }

        .genre-item.active .icon {
            opacity: 1;
        }

        .genre-item .genre-name {
            flex: 1;
        }

        .genre-count {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: rgba(255, 255, 255, 0.05);
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 24px;
            text-align: center;
        }

        .genre-item.active .genre-count {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* Genre sections visibility based on type tab */
        .category-sidebar[data-type="music"] .sfx-genres,
        .category-sidebar[data-type="music"] .speech-genres,
        .category-sidebar[data-type="music"] .graphlings-genres {
            display: none;
        }

        .category-sidebar[data-type="audio"] .music-genres,
        .category-sidebar[data-type="audio"] .speech-genres,
        .category-sidebar[data-type="audio"] .graphlings-genres {
            display: none;
        }

        .category-sidebar[data-type="voice"] .music-genres,
        .category-sidebar[data-type="voice"] .sfx-genres,
        .category-sidebar[data-type="voice"] .graphlings-genres {
            display: none;
        }

        .category-sidebar[data-type="graphlings"] .music-genres,
        .category-sidebar[data-type="graphlings"] .sfx-genres,
        .category-sidebar[data-type="graphlings"] .speech-genres {
            display: none;
        }

        /* Graphlings section styles */
        .graphlings-loading {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .graphlings-source {
            margin-bottom: 8px;
            overflow: hidden;
            border-radius: 10px;
        }

        .graphlings-source-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(139, 92, 246, 0.1));
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .graphlings-source-header:hover {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.25), rgba(139, 92, 246, 0.15));
        }

        .graphlings-source-header .source-icon {
            width: 24px;
            height: 24px;
            color: var(--primary);
        }

        .graphlings-source-header .source-name {
            flex: 1;
            font-weight: 600;
            color: var(--text);
        }

        .graphlings-source-header .source-count {
            background: rgba(168, 85, 247, 0.2);
            color: var(--primary);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .graphlings-source-types {
            display: none;
            padding: 8px 0 0 16px;
        }

        .graphlings-source.expanded .graphlings-source-types {
            display: block;
        }

        .graphlings-type-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            color: var(--text-muted);
        }

        .graphlings-type-item:hover {
            background: var(--hover);
            color: var(--text);
        }

        .graphlings-type-item.active {
            background: var(--primary);
            color: white;
        }

        .graphlings-type-item .type-icon {
            width: 16px;
            height: 16px;
        }

        .graphlings-type-item .type-name {
            flex: 1;
            font-size: 0.9rem;
        }

        .graphlings-type-item .type-count {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        /* Genre section spacing */
        .genre-section {
            margin-bottom: 16px;
        }

        .genre-section:last-of-type {
            margin-bottom: 0;
        }

        /* Clear Filter Button */
        .clear-filter-btn {
            width: 100%;
            padding: 12px;
            margin-top: 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .clear-filter-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--error);
        }

        .clear-filter-btn .icon {
            width: 16px;
            height: 16px;
        }

        .mobile-category-toggle {
            display: none;
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--bg-input);
            color: var(--text);
            font-size: 0.9rem;
            cursor: pointer;
            margin-bottom: 16px;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        @media (max-width: 900px) {
            .mobile-category-toggle {
                display: flex;
            }
        }

        .mobile-category-toggle .icon {
            width: 18px;
            height: 18px;
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 4px;
            margin-left: auto;
            background: var(--bg-input);
            border-radius: 8px;
            padding: 4px;
            border: 1px solid var(--border);
        }

        .view-toggle-btn {
            padding: 8px 10px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .view-toggle-btn:hover {
            color: var(--text);
        }

        .view-toggle-btn.active {
            background: var(--cyan);
            color: white;
        }

        .view-toggle-btn .icon {
            width: 18px;
            height: 18px;
        }

        /* Library Items - List View */
        .library-items {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .library-items.grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        /* Library Item Card - Enhanced */
        .library-item {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .library-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), #ec4899);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .library-item:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--accent-glow);
        }

        .library-item:hover::before {
            opacity: 1;
        }

        .library-item[data-model="music"]::before {
            background: linear-gradient(90deg, var(--accent), #ec4899);
        }

        .library-item[data-model="audio"]::before {
            background: linear-gradient(90deg, var(--cyan), #10b981);
        }

        /* Item Header */
        .item-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
        }

        .model-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--bg-card);
            flex-shrink: 0;
        }

        .model-badge .icon {
            width: 20px;
            height: 20px;
        }

        .model-badge.music {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(236, 72, 153, 0.2));
            color: var(--accent);
        }

        .model-badge.audio {
            background: linear-gradient(135deg, rgba(192, 132, 252, 0.2), rgba(16, 185, 129, 0.2));
            color: var(--cyan);
        }

        .model-badge.voice {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(251, 191, 36, 0.2));
            color: #f59e0b;
        }

        /* Item Info */
        .item-info {
            flex: 1;
            min-width: 0;
        }

        .item-info .prompt {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text);
            line-height: 1.4;
            margin-bottom: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .item-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .item-meta .duration {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .item-meta .icon {
            width: 14px;
            height: 14px;
        }

        /* Item Favorite Button */
        .item-favorite {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 5;
        }

        .item-favorite:hover {
            background: rgba(225, 29, 72, 0.2);
            color: #e11d48;
            transform: scale(1.1);
        }

        .item-favorite.favorited {
            background: rgba(225, 29, 72, 0.2);
            color: #e11d48;
        }

        .item-favorite .icon {
            width: 18px;
            height: 18px;
        }

        /* Styled Audio Player */
        .styled-audio {
            margin: 12px 0;
        }

        .styled-audio audio {
            width: 100%;
            height: 40px;
            border-radius: 8px;
        }

        /* Library Player Controls - Unified Player */
        .library-player-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
            margin: 8px 0;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }

        .play-now-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid var(--accent);
            background: rgba(168, 85, 247, 0.15);
            color: var(--accent);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .play-now-btn:hover {
            background: var(--accent);
            color: white;
            transform: scale(1.05);
        }

        .play-now-btn .icon {
            width: 24px;
            height: 24px;
        }

        .add-queue-btn {
            padding: 8px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .add-queue-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            border-color: var(--accent);
        }

        .add-queue-btn .icon {
            width: 16px;
            height: 16px;
        }

        .library-item-playing {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--accent);
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: auto;
        }

        .library-item-playing.hidden {
            display: none;
        }

        .mini-eq {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 16px;
        }

        .mini-eq-bar {
            width: 3px;
            background: var(--accent);
            border-radius: 1px;
            animation: miniEqBounce 0.5s ease-in-out infinite;
        }

        .mini-eq-bar:nth-child(1) { height: 8px; animation-delay: 0s; }
        .mini-eq-bar:nth-child(2) { height: 14px; animation-delay: 0.15s; }
        .mini-eq-bar:nth-child(3) { height: 10px; animation-delay: 0.3s; }

        @keyframes miniEqBounce {
            0%, 100% { transform: scaleY(0.5); }
            50% { transform: scaleY(1); }
        }

        /* Inline player for library items */
        .library-player-inline {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .library-player-inline.hidden {
            display: none;
        }

        .inline-progress {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            cursor: pointer;
            overflow: hidden;
        }

        .inline-progress-bar {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .inline-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            min-width: 35px;
        }

        .skip-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .skip-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .skip-btn.hidden {
            display: none;
        }

        .skip-btn .icon {
            width: 16px;
            height: 16px;
        }

        /* Playing state for library item */
        .library-player-controls.playing .play-now-btn {
            background: var(--accent);
            color: white;
        }

        /* Item Actions */
        .item-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text-dim);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .action-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(168, 85, 247, 0.1);
        }

        .action-btn .icon {
            width: 16px;
            height: 16px;
        }

        .action-btn.favorite-btn {
            padding: 6px 8px;
        }

        .action-btn.copy-id-btn {
            border-color: rgba(59, 130, 246, 0.5);
            color: #3b82f6;
        }
        .action-btn.copy-id-btn:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.15);
        }

        .action-btn.favorite-btn:hover,
        .action-btn.favorite-btn.favorited {
            border-color: #ef4444;
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .action-btn.favorite-btn.favorited .icon {
            fill: #ef4444;
        }

        .action-btn.vote-up:hover,
        .action-btn.vote-up.voted {
            border-color: var(--success);
            color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .action-btn.vote-down:hover,
        .action-btn.vote-down.voted {
            border-color: var(--error);
            color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .action-btn.download {
            margin-left: auto;
            border-color: var(--accent);
            color: var(--accent);
        }

        .action-btn.download:hover {
            background: rgba(168, 85, 247, 0.1);
            border-color: var(--accent);
            color: var(--accent);
        }

        .action-btn.suggest-tag {
            border-color: var(--text-muted);
            color: var(--text-muted);
        }

        .action-btn.suggest-tag:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(168, 85, 247, 0.1);
        }

        .action-btn .vote-count {
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Comments/Feedback Button */
        .comments-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text-dim);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .comments-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(168, 85, 247, 0.1);
        }

        .comments-btn .icon {
            width: 16px;
            height: 16px;
        }

        /* Feedback View */
        .feedback-view {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .feedback-view.hidden {
            display: none;
        }

        /* Library Empty State */
        .library-empty {
            text-align: center;
            padding: 60px 20px;
        }

        .library-empty .empty-icon {
            width: 64px;
            height: 64px;
            color: var(--text-muted);
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .library-empty h3 {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.3rem;
            color: var(--text);
            margin: 0 0 8px;
        }

        .library-empty p {
            color: var(--text-muted);
            margin: 0;
        }

        .library-item audio {
            width: 100%;
        }

        .action-btn.play-radio {
            border-color: var(--accent);
            color: var(--accent);
        }

        .action-btn.play-radio:hover {
            background: rgba(168, 85, 247, 0.1);
        }

        /* Pagination - Enhanced */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .page-btn {
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: transparent;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
            min-width: 44px;
            text-align: center;
            font-weight: 500;
        }

        .page-btn:hover:not(:disabled):not(.active) {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(168, 85, 247, 0.05);
        }

        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .page-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .page-numbers {
            display: flex;
            gap: 4px;
        }

        .page-ellipsis {
            color: var(--text-muted);
            padding: 10px 6px;
        }

        .page-info {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-left: 8px;
        }

        @media (max-width: 640px) {
            .library-items.grid-view {
                grid-template-columns: 1fr;
            }
            .library-filters {
                justify-content: center;
            }
            .item-actions {
                justify-content: center;
            }
            .action-btn.download {
                margin-left: 0;
                width: 100%;
                justify-content: center;
                margin-top: 8px;
            }
        }

        @media (max-width: 480px) {
            .page-numbers {
                display: none;
            }
            .pagination {
                gap: 16px;
            }
        }

        /* ========================================
           COLLAPSIBLE GENERATOR
           ======================================== */
        .generator-card h2 {
            cursor: pointer;
            user-select: none;
        }

        .generator-card h2 .collapse-icon {
            margin-left: auto;
            transition: transform 0.3s;
            font-size: 0.8rem;
        }

        .generator-card.collapsed h2 .collapse-icon {
            transform: rotate(-90deg);
        }

        .generator-content {
            transition: max-height 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
        }

        .generator-card.collapsed .generator-content {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
        }

        /* ========================================
           RESPONSIVE - LARGE MONITORS (1200px+)
           ======================================== */
        @media (min-width: 1200px) {
            .container {
                max-width: 1100px;
            }

            .page-header {
                padding: 24px 24px 12px;
            }

            .page-title {
                font-size: 2.25rem;
            }

            .widget-bar-top {
                padding: 10px 24px;
            }

            .card {
                padding: 32px;
                border-radius: 20px;
                margin-bottom: 28px;
            }

            .card h2 {
                font-size: 1.4rem;
            }

            /* Generator tabs bigger */
            .model-tab {
                padding: 20px 16px;
                border-radius: 16px;
            }

            .model-tab .icon-lg {
                width: 32px;
                height: 32px;
            }

            .model-tab span {
                font-size: 1rem;
            }

            /* Larger buttons */
            .btn {
                padding: 14px 28px;
                font-size: 1rem;
            }

            /* Radio stations grid */
            .station-scroll {
                gap: 12px;
            }

            .station-card {
                min-height: 90px;
                border-radius: 14px;
            }

            .station-card .station-icon {
                width: 2.4rem;
                height: 2.4rem;
            }

            .station-card .station-name {
                font-size: 0.95rem;
            }

            /* Library layout expands */
            .library-layout {
                grid-template-columns: 260px 1fr;
                gap: 28px;
            }

            .library-items.grid-view {
                grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
                gap: 20px;
            }

            .library-item {
                padding: 20px;
                border-radius: 16px;
            }

            /* Category sidebar improvements */
            .category-type-tabs {
                padding: 6px;
                border-radius: 14px;
            }

            .type-tab {
                padding: 12px 14px;
                font-size: 0.9rem;
            }

            .genre-section {
                border-radius: 14px;
            }

            .genre-item {
                padding: 12px 14px;
            }
        }

        /* ========================================
           RESPONSIVE - EXTRA LARGE MONITORS (1600px+)
           ======================================== */
        @media (min-width: 1600px) {
            .container {
                max-width: 1400px;
            }

            .page-header {
                padding: 32px 32px 16px;
            }

            .page-title {
                font-size: 2.5rem;
            }

            .widget-bar-top {
                padding: 10px 32px;
            }

            .card {
                padding: 40px;
                border-radius: 24px;
            }

            .card h2 {
                font-size: 1.5rem;
                margin-bottom: 24px;
            }

            /* Textarea bigger */
            textarea {
                min-height: 110px;
                font-size: 1.05rem;
                padding: 16px 20px;
            }

            /* Model tabs even bigger */
            .model-tab {
                padding: 24px 20px;
            }

            .model-tab .icon-lg {
                width: 36px;
                height: 36px;
            }

            /* Library 3 columns */
            .library-layout {
                grid-template-columns: 300px 1fr;
                gap: 36px;
            }

            .library-items.grid-view {
                grid-template-columns: repeat(3, 1fr);
                gap: 24px;
            }

            .library-item {
                padding: 24px;
            }

            /* Radio 8 stations in single row */
            .station-scroll {
                grid-template-columns: repeat(8, 1fr);
            }

            /* Category sidebar */
            .category-type-tabs {
                padding: 8px;
            }

            .type-tab {
                padding: 14px 16px;
                font-size: 0.95rem;
            }

            .genre-section-header {
                padding: 14px 16px;
            }

            .genre-item {
                padding: 14px 16px;
                font-size: 0.95rem;
            }
        }

        /* ========================================
           RESPONSIVE - ULTRA WIDE MONITORS (2000px+)
           ======================================== */
        @media (min-width: 2000px) {
            .container {
                max-width: 1800px;
            }

            body {
                font-size: 18px;
            }

            .page-header {
                padding: 40px 40px 20px;
            }

            .page-title {
                font-size: 3rem;
            }

            .widget-bar-top {
                padding: 12px 40px;
            }

            .card {
                padding: 48px;
                border-radius: 28px;
                margin-bottom: 36px;
            }

            .card h2 {
                font-size: 1.75rem;
                margin-bottom: 28px;
            }

            /* Controls and buttons scale up */
            .model-tab {
                padding: 28px 24px;
                border-radius: 20px;
            }

            .model-tab .icon-lg {
                width: 42px;
                height: 42px;
            }

            .model-tab span {
                font-size: 1.1rem;
            }

            .btn {
                padding: 18px 36px;
                font-size: 1.1rem;
                border-radius: 16px;
            }

            /* Radio stations */
            .station-card {
                min-height: 100px;
                border-radius: 16px;
            }

            .station-card .station-icon {
                width: 3rem;
                height: 3rem;
            }

            .station-card .station-name {
                font-size: 1.1rem;
            }

            /* Library 4 columns on ultra wide */
            .library-items.grid-view {
                grid-template-columns: repeat(4, 1fr);
                gap: 28px;
            }

            .library-layout {
                grid-template-columns: 340px 1fr;
                gap: 44px;
            }

            .library-item {
                padding: 28px;
                border-radius: 20px;
            }

            /* Category sidebar */
            .type-tab {
                padding: 16px 18px;
                font-size: 1rem;
                border-radius: 12px;
            }

            .genre-item {
                padding: 16px 18px;
                font-size: 1rem;
                border-radius: 10px;
            }

            .quick-filter-btn {
                padding: 14px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- SVG Icon Sprite Sheet -->
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <!-- Playback Icons -->
        <symbol id="icon-play" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8 5.14v14l11-7-11-7z"/>
        </symbol>
        <symbol id="icon-pause" viewBox="0 0 24 24" fill="currentColor">
            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
        </symbol>
        <symbol id="icon-skip-next" viewBox="0 0 24 24" fill="currentColor">
            <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
        </symbol>
        <symbol id="icon-skip-prev" viewBox="0 0 24 24" fill="currentColor">
            <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
        </symbol>
        <symbol id="icon-shuffle" viewBox="0 0 24 24" fill="currentColor">
            <path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/>
        </symbol>

        <!-- Rating Icons -->
        <symbol id="icon-thumb-up" viewBox="0 0 24 24" fill="currentColor">
            <path d="M2 20h2c.55 0 1-.45 1-1v-9c0-.55-.45-1-1-1H2v11zm19.83-7.12c.11-.25.17-.52.17-.8V11c0-1.1-.9-2-2-2h-5.5l.92-4.65c.05-.22.02-.46-.08-.66-.23-.45-.52-.86-.88-1.22L14 2 7.59 8.41C7.21 8.79 7 9.3 7 9.83v7.84C7 18.95 8.05 20 9.34 20h8.11c.7 0 1.36-.37 1.72-.97l2.66-6.15z"/>
        </symbol>
        <symbol id="icon-thumb-down" viewBox="0 0 24 24" fill="currentColor">
            <path d="M22 4h-2c-.55 0-1 .45-1 1v9c0 .55.45 1 1 1h2V4zM2.17 11.12c-.11.25-.17.52-.17.8V13c0 1.1.9 2 2 2h5.5l-.92 4.65c-.05.22-.02.46.08.66.23.45.52.86.88 1.22L10 22l6.41-6.41c.38-.38.59-.89.59-1.42V6.34C17 5.05 15.95 4 14.66 4H6.55c-.7 0-1.36.37-1.72.97l-2.66 6.15z"/>
        </symbol>

        <!-- Heart Icons -->
        <symbol id="icon-heart" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
        </symbol>
        <symbol id="icon-heart-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
        </symbol>

        <!-- Code/API Icon -->
        <symbol id="icon-code" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/>
        </symbol>

        <!-- Plus Icon -->
        <symbol id="icon-plus" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        </symbol>

        <!-- Expand/Fullscreen Icon -->
        <symbol id="icon-expand" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
        </symbol>

        <!-- More Options Icon -->
        <symbol id="icon-more-vertical" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
        </symbol>

        <!-- User Icon -->
        <symbol id="icon-user" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </symbol>

        <!-- Music Icons -->
        <symbol id="icon-music" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
        </symbol>
        <symbol id="icon-radio" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3.24 6.15C2.51 6.43 2 7.17 2 8v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2H8.3l8.26-3.34L15.88 1 3.24 6.15zM7 20c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm13-8h-2v-2h-2v2H4V8h16v4z"/>
        </symbol>
        <symbol id="icon-library" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 5h-3v5.5c0 1.38-1.12 2.5-2.5 2.5S10 13.88 10 12.5s1.12-2.5 2.5-2.5c.57 0 1.08.19 1.5.51V5h4v2zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6z"/>
        </symbol>
        <symbol id="icon-tag" viewBox="0 0 24 24" fill="currentColor">
            <path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58s1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41s-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/>
        </symbol>
        <symbol id="icon-chevron" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
        </symbol>
        <symbol id="icon-chevron-up" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6 1.41 1.41z"/>
        </symbol>
        <symbol id="icon-chevron-down" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
        </symbol>
        <symbol id="icon-sparkles" viewBox="0 0 24 24" fill="currentColor">
            <path d="M14.5 2L16 5.5 19.5 7 16 8.5 14.5 12 13 8.5 9.5 7 13 5.5zM4.5 8L6 11.5 9.5 13 6 14.5 4.5 18 3 14.5 -0.5 13 3 11.5zM11.5 14L13 17.5 16.5 19 13 20.5 11.5 24 10 20.5 6.5 19 10 17.5z"/>
        </symbol>

        <!-- UI Icons -->
        <symbol id="icon-fire" viewBox="0 0 24 24" fill="currentColor">
            <path d="M13.5.67s.74 2.65.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l.03-.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5.67zM11.71 19c-1.78 0-3.22-1.4-3.22-3.14 0-1.62 1.05-2.76 2.81-3.12 1.77-.36 3.6-1.21 4.62-2.58.39 1.29.59 2.65.59 4.04 0 2.65-2.15 4.8-4.8 4.8z"/>
        </symbol>
        <symbol id="icon-trending" viewBox="0 0 24 24" fill="currentColor">
            <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/>
        </symbol>
        <symbol id="icon-dice" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM7.5 18c-.83 0-1.5-.67-1.5-1.5S6.67 15 7.5 15s1.5.67 1.5 1.5S8.33 18 7.5 18zm0-9C6.67 9 6 8.33 6 7.5S6.67 6 7.5 6 9 6.67 9 7.5 8.33 9 7.5 9zm4.5 4.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4.5 4.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm0-9c-.83 0-1.5-.67-1.5-1.5S15.67 6 16.5 6s1.5.67 1.5 1.5S17.33 9 16.5 9z"/>
        </symbol>
        <symbol id="icon-close" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </symbol>
        <symbol id="icon-settings" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
        </symbol>

        <!-- Station Icons -->
        <symbol id="icon-waves" viewBox="0 0 24 24" fill="currentColor">
            <path d="M17 16.99c-1.35 0-2.2.42-2.95.8-.65.33-1.18.6-2.05.6-.9 0-1.4-.25-2.05-.6-.75-.38-1.57-.8-2.95-.8s-2.2.42-2.95.8c-.65.33-1.17.6-2.05.6v1.95c1.35 0 2.2-.42 2.95-.8.65-.33 1.17-.6 2.05-.6s1.4.25 2.05.6c.75.38 1.57.8 2.95.8s2.2-.42 2.95-.8c.65-.33 1.18-.6 2.05-.6.9 0 1.4.25 2.05.6.75.38 1.58.8 2.95.8v-1.95c-.9 0-1.4-.25-2.05-.6-.75-.38-1.6-.8-2.95-.8zm0-4.45c-1.35 0-2.2.43-2.95.8-.65.32-1.18.6-2.05.6-.9 0-1.4-.25-2.05-.6-.75-.38-1.57-.8-2.95-.8s-2.2.43-2.95.8c-.65.32-1.17.6-2.05.6v1.95c1.35 0 2.2-.43 2.95-.8.65-.35 1.15-.6 2.05-.6s1.4.25 2.05.6c.75.38 1.57.8 2.95.8s2.2-.43 2.95-.8c.65-.35 1.15-.6 2.05-.6s1.4.25 2.05.6c.75.38 1.58.8 2.95.8v-1.95c-.9 0-1.4-.25-2.05-.6-.75-.38-1.6-.8-2.95-.8zm2.95-8.08c-.75-.38-1.58-.8-2.95-.8s-2.2.42-2.95.8c-.65.32-1.18.6-2.05.6-.9 0-1.4-.25-2.05-.6-.75-.37-1.57-.8-2.95-.8s-2.2.42-2.95.8c-.65.33-1.17.6-2.05.6v1.93c1.35 0 2.2-.43 2.95-.8.65-.33 1.17-.6 2.05-.6s1.4.25 2.05.6c.75.38 1.57.8 2.95.8s2.2-.43 2.95-.8c.65-.32 1.18-.6 2.05-.6.9 0 1.4.25 2.05.6.75.38 1.58.8 2.95.8V5.04c-.9 0-1.4-.25-2.05-.58zM17 8.09c-1.35 0-2.2.43-2.95.8-.65.35-1.15.6-2.05.6s-1.4-.25-2.05-.6c-.75-.38-1.57-.8-2.95-.8s-2.2.43-2.95.8c-.65.35-1.15.6-2.05.6v1.95c1.35 0 2.2-.43 2.95-.8.65-.32 1.18-.6 2.05-.6s1.4.25 2.05.6c.75.38 1.57.8 2.95.8s2.2-.43 2.95-.8c.65-.32 1.18-.6 2.05-.6.9 0 1.4.25 2.05.6.75.38 1.58.8 2.95.8V8.49c-.9 0-1.4-.25-2.05-.6-.75-.38-1.6-.8-2.95-.8z"/>
        </symbol>
        <symbol id="icon-gamepad" viewBox="0 0 24 24" fill="currentColor">
            <path d="M15 7.5V2H9v5.5l3 3 3-3zM7.5 9H2v6h5.5l3-3-3-3zM9 16.5V22h6v-5.5l-3-3-3 3zM16.5 9l-3 3 3 3H22V9h-5.5z"/>
        </symbol>
        <symbol id="icon-piano" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-6 16h-2v-5H9v5H7V5h2v6h2V5h2v6h2V5h2v14h-2v-5h-2v5z"/>
        </symbol>
        <symbol id="icon-smile" viewBox="0 0 24 24" fill="currentColor">
            <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/>
        </symbol>
        <symbol id="icon-stars" viewBox="0 0 24 24" fill="currentColor">
            <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zm4.24 16L12 15.45 7.77 18l1.12-4.81-3.73-3.23 4.92-.42L12 5l1.92 4.53 4.92.42-3.73 3.23L16.23 18z"/>
        </symbol>
        <symbol id="icon-headphones" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 1c-4.97 0-9 4.03-9 9v7c0 1.66 1.34 3 3 3h3v-8H5v-2c0-3.87 3.13-7 7-7s7 3.13 7 7v2h-4v8h3c1.66 0 3-1.34 3-3v-7c0-4.97-4.03-9-9-9z"/>
        </symbol>
        <symbol id="icon-search" viewBox="0 0 24 24" fill="currentColor">
            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </symbol>
        <symbol id="icon-copy" viewBox="0 0 24 24" fill="currentColor">
            <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
        </symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24" fill="currentColor">
            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
        </symbol>
        <symbol id="icon-grip-vertical" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 5h2v2H9zm0 6h2v2H9zm0 6h2v2H9zm4-12h2v2h-2zm0 6h2v2h-2zm0 6h2v2h-2z"/>
        </symbol>
        <symbol id="icon-lock" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
        </symbol>
        <symbol id="icon-chevron" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
        </symbol>

        <!-- Category Icons -->
        <symbol id="icon-ambient" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
        </symbol>
        <symbol id="icon-electronic" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7 5h10v2h2V3H5v4h2V5zm4 14H9v2H5v-4h2v-2H3v6h8v-2zm8-4v2h2v4h-4v-2h-2v2H7v-2h2v-2H5v6h14v-6h-4zm1-6h-2v6h2v-6zm-4 0h-2v6h2v-6zm-4 0H10v6h2v-6zM6 9h2v6H6V9z"/>
        </symbol>
        <symbol id="icon-cinematic" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/>
        </symbol>
        <symbol id="icon-upbeat" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
        </symbol>
        <symbol id="icon-retro" viewBox="0 0 24 24" fill="currentColor">
            <path d="M21 6H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-10 7H8v3H6v-3H3v-2h3V8h2v3h3v2zm4.5 2c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4-3c-.83 0-1.5-.67-1.5-1.5S18.67 9 19.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
        </symbol>
        <symbol id="icon-nature" viewBox="0 0 24 24" fill="currentColor">
            <path d="M6.05 8.05c-2.73 2.73-2.73 7.15-.02 9.88a7.02 7.02 0 009.88 0l6.05-6.05c-.33-.18-.64-.39-.92-.63L14 18.29a5.02 5.02 0 01-7.07 0c-1.95-1.95-1.95-5.12 0-7.07L12 6.15a1.5 1.5 0 112.12 2.12l-5.07 5.07c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l5.07-5.07a3.5 3.5 0 00-4.95-4.95L6.05 8.05z"/>
        </symbol>
        <symbol id="icon-mechanical" viewBox="0 0 24 24" fill="currentColor">
            <path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/>
        </symbol>
        <symbol id="icon-human" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </symbol>
        <symbol id="icon-fantasy" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7.5 5.6L10 7 8.6 4.5 10 2 7.5 3.4 5 2l1.4 2.5L5 7zm12 9.8L17 14l1.4 2.5L17 19l2.5-1.4L22 19l-1.4-2.5L22 14zM22 2l-2.5 1.4L17 2l1.4 2.5L17 7l2.5-1.4L22 7l-1.4-2.5zm-7.63 5.29c-.39-.39-1.02-.39-1.41 0L1.29 18.96c-.39.39-.39 1.02 0 1.41l2.34 2.34c.39.39 1.02.39 1.41 0L16.71 11.04c.39-.39.39-1.02 0-1.41l-2.34-2.34zM5.71 21.29L2.71 18.29l1-1L6.71 20.29l-1 1zM19 12l2 2-2 2-2-2 2-2z"/>
        </symbol>
        <symbol id="icon-game" viewBox="0 0 24 24" fill="currentColor">
            <path d="M21 6H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-10 7H8v3H6v-3H3v-2h3V8h2v3h3v2zm4.5 2c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4-3c-.83 0-1.5-.67-1.5-1.5S18.67 9 19.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
        </symbol>
        <symbol id="icon-impact" viewBox="0 0 24 24" fill="currentColor">
            <path d="M11 21h-1l1-7H7.5c-.58 0-.57-.32-.38-.66.19-.34.05-.08.07-.12C8.48 10.94 10.42 7.54 13 3h1l-1 7h3.5c.49 0 .56.33.47.51l-.07.15C12.96 17.55 11 21 11 21z"/>
        </symbol>
        <symbol id="icon-whoosh" viewBox="0 0 24 24" fill="currentColor">
            <path d="M14.5 17c0 1.65-1.35 3-3 3s-3-1.35-3-3h2c0 .55.45 1 1 1s1-.45 1-1-.45-1-1-1H2v-2h9.5c1.65 0 3 1.35 3 3zM19 6.5C19 4.57 17.43 3 15.5 3S12 4.57 12 6.5h2c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5S16.33 8 15.5 8H2v2h13.5c1.93 0 3.5-1.57 3.5-3.5zm-.5 4.5H2v2h16.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5v2c1.93 0 3.5-1.57 3.5-3.5S20.43 11 18.5 11z"/>
        </symbol>
        <symbol id="icon-wand" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7.5 5.6L10 7 8.6 4.5 10 2 7.5 3.4 5 2l1.4 2.5L5 7zm12 9.8L17 14l1.4 2.5L17 19l2.5-1.4L22 19l-1.4-2.5L22 14zM22 2l-2.5 1.4L17 2l1.4 2.5L17 7l2.5-1.4L22 7l-1.4-2.5zm-7.63 5.29c-.39-.39-1.02-.39-1.41 0L1.29 18.96c-.39.39-.39 1.02 0 1.41l2.34 2.34c.39.39 1.02.39 1.41 0L16.7 11.05c.39-.39.39-1.02 0-1.41l-2.33-2.35zm-1.03 5.49l-2.12-2.12 2.44-2.44 2.12 2.12-2.44 2.44z"/>
        </symbol>
        <symbol id="icon-volume" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
        </symbol>
        <symbol id="icon-download" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
        </symbol>
        <symbol id="icon-share" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/>
        </symbol>
        <symbol id="icon-grid" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 3v8h8V3H3zm6 6H5V5h4v4zm-6 4v8h8v-8H3zm6 6H5v-4h4v4zm4-16v8h8V3h-8zm6 6h-4V5h4v4zm-6 4v8h8v-8h-8zm6 6h-4v-4h4v4z"/>
        </symbol>
        <symbol id="icon-list" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
        </symbol>
        <symbol id="icon-filter" viewBox="0 0 24 24" fill="currentColor">
            <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/>
        </symbol>
        <symbol id="icon-clock" viewBox="0 0 24 24" fill="currentColor">
            <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
        </symbol>
        <symbol id="icon-play-circle" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/>
        </symbol>
        <symbol id="icon-add-queue" viewBox="0 0 24 24" fill="currentColor">
            <path d="M15 6H3v2h12V6zm0 4H3v2h12v-2zM3 16h8v-2H3v2zM17 6v8h-4v2h4v4h2v-4h4v-2h-4V6h-2z"/>
        </symbol>
        <symbol id="icon-gpu" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 3H4c-1.1 0-2 .9-2 2v11c0 1.1.9 2 2 2h3l-1 1v2h12v-2l-1-1h3c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 13H4V5h16v11z"/>
        </symbol>
        <symbol id="icon-queue" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 10.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm0-6c-.83 0-1.5.67-1.5 1.5S3.17 7.5 4 7.5 5.5 6.83 5.5 6 4.83 4.5 4 4.5zm0 12c-.83 0-1.5.68-1.5 1.5s.68 1.5 1.5 1.5 1.5-.68 1.5-1.5-.67-1.5-1.5-1.5zM7 19h14v-2H7v2zm0-6h14v-2H7v2zm0-8v2h14V5H7z"/>
        </symbol>
        <symbol id="icon-volume-off" viewBox="0 0 24 24" fill="currentColor">
            <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
        </symbol>
        <symbol id="icon-mic" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/>
        </symbol>
        <symbol id="icon-star" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
        </symbol>
        <symbol id="icon-star-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
        </symbol>
    </svg>

    <div class="widget-bar-top">
        <div id="wallet-widget-container"></div>
        <span class="header-brand">&copy; 2026 Valpatel Software LLC</span>
    </div>
    <div class="page-header">
        <h1 class="page-title">Sound <span>Box</span></h1>
    </div>

    <div class="container" style="padding: 0 20px 20px;">
        <p class="subtitle">Free sounds and music  AI-powered generator</p>
        <div class="license-notice-wrapper">
            <p class="license-notice">
                <span class="license-badge">CC0</span>
                <a href="https://creativecommons.org/publicdomain/zero/1.0/" target="_blank" rel="noopener" title="Creative Commons Zero - Public Domain">All audio is CC0  Free to use</a>
            </p>
        </div>

        <!-- MOBILE TAB DROPDOWN - only visible on smallest screens -->
        <div class="mobile-tab-dropdown">
            <div style="display: flex; gap: 8px; align-items: center; justify-content: center;">
                <button class="global-mute-btn" id="global-mute-btn-mobile" onclick="toggleGlobalMute()" title="Mute/Unmute all audio">
                    <svg class="icon unmuted"><use href="#icon-volume"/></svg>
                    <svg class="icon muted"><use href="#icon-volume-off"/></svg>
                </button>
                <select class="mobile-tab-select" id="mobile-tab-select" onchange="switchTab(this.value)">
                    <option value="radio">Radio</option>
                    <option value="library">Library</option>
                    <option value="generate">Generate</option>
                    <option value="playlists">Playlists</option>
                </select>
            </div>
        </div>

        <!-- MAIN TABS -->
        <div class="main-tabs">
            <button class="global-mute-btn" id="global-mute-btn" onclick="toggleGlobalMute()" title="Mute/Unmute all audio">
                <svg class="icon unmuted"><use href="#icon-volume"/></svg>
                <svg class="icon muted"><use href="#icon-volume-off"/></svg>
            </button>
            <button class="main-tab active" onclick="switchTab('radio')" id="tab-radio" title="Listen to shuffled music stations">
                <svg class="icon icon-md"><use href="#icon-radio"/></svg>
                <span>Radio</span>
            </button>
            <button class="main-tab" onclick="switchTab('library')" id="tab-library" title="Browse and search your audio library">
                <svg class="icon icon-md"><use href="#icon-search"/></svg>
                <span>Library</span>
            </button>
            <button class="main-tab" onclick="switchTab('generate')" id="tab-generate" title="Create new music and sound effects with AI">
                <svg class="icon icon-md"><use href="#icon-wand"/></svg>
                <span>Generate</span>
            </button>
            <button class="main-tab" onclick="switchTab('playlists')" id="tab-playlists" title="Manage your saved playlists and favorites">
                <svg class="icon icon-md"><use href="#icon-music"/></svg>
                <span>Playlists</span>
            </button>
            <!-- History tab hidden to reduce UI clutter - functionality still available via direct URL -->
            <button class="main-tab hidden" onclick="switchTab('history')" id="tab-history" title="View your play and vote history" style="display: none;">
                <svg class="icon icon-md"><use href="#icon-clock"/></svg>
                <span>History</span>
            </button>
            <button class="main-tab hidden" onclick="switchTab('api')" id="tab-api" title="Developer API and embed documentation" style="display: none;">
                <svg class="icon icon-md"><use href="#icon-code"/></svg>
                <span>API</span>
            </button>

        </div>

        <!-- RADIO TAB -->
        <div class="tab-content active" id="content-radio">
        <!-- RADIO STATION - REDESIGNED -->
        <div class="card radio-card">
            <h2><svg class="icon icon-lg" style="vertical-align: -4px; margin-right: 6px;"><use href="#icon-radio"/></svg>Radio Station</h2>

            <!-- Hidden controls for model selection (used by JS) -->
            <div class="radio-controls-hidden">
                <select id="radio-model">
                    <option value="music">Music</option>
                    <option value="audio">Sound Effects</option>
                </select>
                <input type="text" id="radio-keywords" placeholder="Keywords (optional)..." maxlength="100">
            </div>

            <!-- Station Presets -->
            <div class="station-presets">
                <div class="station-presets-label">Station Presets</div>
                <div class="station-scroll">
                    <div class="station-card station-ambient" tabindex="0" onclick="startStation('ambient', this)" onkeydown="if(event.key==='Enter')this.click()" data-keywords="ambient soundscape" title="Play ambient and soundscape tracks">
                        <svg class="station-icon"><use href="#icon-waves"/></svg>
                        <span class="station-name">Ambient</span>
                    </div>
                    <div class="station-card station-retro" tabindex="0" onclick="startStation('retro', this)" onkeydown="if(event.key==='Enter')this.click()" data-keywords="chiptune 8-bit retro" title="Play chiptune and 8-bit retro tracks">
                        <svg class="station-icon"><use href="#icon-gamepad"/></svg>
                        <span class="station-name">Retro</span>
                    </div>
                    <div class="station-card station-piano" tabindex="0" onclick="startStation('piano', this)" onkeydown="if(event.key==='Enter')this.click()" data-keywords="piano gentle keys" title="Play piano and gentle keyboard tracks">
                        <svg class="station-icon"><use href="#icon-piano"/></svg>
                        <span class="station-name">Piano</span>
                    </div>
                    <div class="station-card station-happy" tabindex="0" onclick="startStation('happy', this)" onkeydown="if(event.key==='Enter')this.click()" data-keywords="happy bouncy cute" title="Play happy, bouncy, and upbeat tracks">
                        <svg class="station-icon"><use href="#icon-smile"/></svg>
                        <span class="station-name">Happy</span>
                    </div>
                    <div class="station-card station-dreamy" tabindex="0" onclick="startStation('dreamy', this)" onkeydown="if(event.key==='Enter')this.click()" data-keywords="dreamy warm ethereal" title="Play dreamy and ethereal tracks">
                        <svg class="station-icon"><use href="#icon-stars"/></svg>
                        <span class="station-name">Dreamy</span>
                    </div>
                    <div class="station-card station-lofi" tabindex="0" onclick="startStation('lofi', this)" onkeydown="if(event.key==='Enter')this.click()" data-keywords="lo-fi hip hop" title="Play lo-fi hip hop and chill beats">
                        <svg class="station-icon"><use href="#icon-headphones"/></svg>
                        <span class="station-name">Lo-Fi</span>
                    </div>
                    <div class="station-card station-favorites" tabindex="0" onclick="startStation('favorites', this)" onkeydown="if(event.key==='Enter')this.click()" data-keywords="" title="Play your favorited tracks">
                        <svg class="station-icon"><use href="#icon-heart"/></svg>
                        <span class="station-name">Favorites</span>
                    </div>
                    <div class="station-card station-all" tabindex="0" onclick="startStation('all', this)" onkeydown="if(event.key==='Enter')this.click()" data-keywords="" title="Shuffle all music in the library">
                        <svg class="station-icon"><use href="#icon-music"/></svg>
                        <span class="station-name">All Music</span>
                    </div>
                </div>
            </div>

            <!-- Featured Row -->
            <div class="featured-row">
                <button class="featured-btn" onclick="playTrending(this)" title="Play trending tracks (most played in last 24h)">
                    <svg class="icon icon-sm"><use href="#icon-trending"/></svg> Trending
                </button>
                <button class="featured-btn" onclick="playTopRated(this)" title="Play highest rated tracks by the community">
                    <svg class="icon icon-sm"><use href="#icon-fire"/></svg> Top Rated
                </button>
                <button class="featured-btn" onclick="playNewArrivals(this)" title="Play recently generated tracks">
                    <svg class="icon icon-sm"><use href="#icon-sparkles"/></svg> New Arrivals
                </button>
                <button class="featured-btn" onclick="playSurpriseMe(this)" title="Play random tracks from the library">
                    <svg class="icon icon-sm"><use href="#icon-dice"/></svg> Surprise Me
                </button>
            </div>

            <!-- Now Playing - Enhanced -->
            <div class="now-playing hidden" id="now-playing">
                <div class="hero-section">
                    <!-- Animated EQ Visualizer -->
                    <div class="eq-visualizer" id="eq-visualizer">
                        <div class="eq-bar"></div>
                        <div class="eq-bar"></div>
                        <div class="eq-bar"></div>
                        <div class="eq-bar"></div>
                        <div class="eq-bar"></div>
                        <div class="eq-bar"></div>
                        <div class="eq-bar"></div>
                    </div>
                    <div class="track-info">
                        <div id="radio-prompt" class="track-title">Pick a station to start</div>
                        <div class="track-meta">
                            <span class="duration" id="radio-duration">0s</span>
                            <span class="voice-info-tags" id="radio-voice-info" style="display: none;"></span>
                        </div>
                    </div>
                </div>

                <div class="controls-section">
                    <!-- Audio Player -->
                    <div class="audio-row" id="audio-row">
                        <div class="styled-audio">
                            <audio id="radio-player" controls></audio>
                        </div>
                        <!-- Overlay shown when no track loaded -->
                        <div class="audio-start-overlay" id="audio-start-overlay" onclick="startStation('ambient')">
                            <svg class="icon icon-lg"><use href="#icon-play"/></svg>
                            <span>Click to start playing</span>
                        </div>
                    </div>

                    <!-- Unified Control Bar -->
                    <div class="control-bar">
                        <!-- Playback Controls -->
                        <div class="playback-controls">
                            <button class="control-btn" id="radio-prev-btn" onclick="playPreviousTrack()" title="Play previous track" disabled>
                                <svg class="icon"><use href="#icon-skip-prev"/></svg>
                            </button>
                            <button class="control-btn" id="radio-skip-btn" onclick="skipTrack()" title="Skip to next track" disabled>
                                <svg class="icon"><use href="#icon-skip-next"/></svg>
                            </button>
                        </div>

                        <div class="control-separator"></div>

                        <!-- Favorite -->
                        <button class="favorite-btn" id="radio-favorite-btn" onclick="toggleRadioFavorite()" title="Add to favorites for quick access">
                            <svg class="icon heart-icon"><use href="#icon-heart-outline"/></svg>
                        </button>

                        <!-- Review/Tag -->
                        <button class="control-btn" id="radio-tag-btn" onclick="tagCurrentTrack()" title="Review and categorize this track">
                            <svg class="icon"><use href="#icon-tag"/></svg>
                        </button>

                        <!-- Download -->
                        <button class="control-btn" id="radio-download-btn" onclick="downloadCurrentTrack()" title="Download this track">
                            <svg class="icon"><use href="#icon-download"/></svg>
                        </button>

                        <!-- Fullscreen -->
                        <button class="control-btn" id="radio-fullscreen-btn" onclick="enterRadioFullscreen()" title="Enter fullscreen immersive mode" disabled>
                            <svg class="icon"><use href="#icon-expand"/></svg>
                        </button>

                        <div class="control-separator"></div>

                        <!-- Rating Controls -->
                        <div class="rating-controls">
                            <button class="rating-btn" id="radio-vote-up" onclick="showPositiveFeedbackMenu()" title="Like this track - helps improve recommendations">
                                <svg class="icon"><use href="#icon-thumb-up"/></svg>
                                <span class="count" id="radio-upvotes">0</span>
                            </button>
                            <button class="rating-btn" id="radio-vote-down" onclick="showFeedbackMenu()" title="Dislike this track - skip similar content">
                                <svg class="icon"><use href="#icon-thumb-down"/></svg>
                                <span class="count" id="radio-downvotes">0</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Up Next Queue - Enhanced -->
            <div class="radio-queue hidden" id="radio-queue">
                <div class="queue-header">
                    <span>Up Next</span>
                    <span class="queue-count" id="queue-count-badge">0</span>
                </div>
                <div class="queue-items" id="queue-items"></div>
            </div>
        </div>
        </div> <!-- /content-radio -->

        <!-- LIBRARY TAB -->
        <div class="tab-content" id="content-library">
        <!-- LIBRARY (Browse & Search) - REDESIGNED -->
        <div class="card library-card">
            <h2>
                <svg class="icon"><use href="#icon-library"/></svg>
                Library <span id="library-total"></span>
            </h2>

            <!-- Search and Controls Row -->
            <div class="library-controls">
                <div class="library-search-wrapper">
                    <svg class="search-icon"><use href="#icon-search"/></svg>
                    <input type="text" class="search-input" id="library-search" placeholder="Search music, sound effects, prompts..." title="Search by prompt keywords" maxlength="200">
                </div>
                <select id="library-model" title="Filter by content type" style="display: none;">
                    <option value="">All Types</option>
                    <option value="music">Music</option>
                    <option value="audio">Sound Effects</option>
                    <option value="voice">Speech</option>
                    <option value="favorites">My Favorites</option>
                </select>
                <select id="library-sort" title="Sort order">
                    <option value="recent">Most Recent</option>
                    <option value="popular">Most Popular</option>
                    <option value="rating">Highest Rated</option>
                </select>
                <div class="view-toggle" title="Toggle view mode">
                    <button class="view-toggle-btn active" onclick="setLibraryView('list')" title="List view">
                        <svg class="icon"><use href="#icon-list"/></svg>
                    </button>
                    <button class="view-toggle-btn" onclick="setLibraryView('grid')" title="Grid view">
                        <svg class="icon"><use href="#icon-grid"/></svg>
                    </button>
                </div>
            </div>

            <!-- Mobile Category Toggle -->
            <button class="mobile-category-toggle" onclick="toggleMobileCategories()" title="Show category filters">
                <svg class="icon"><use href="#icon-filter"/></svg>
                Browse Categories
            </button>

            <!-- Backdrop for mobile category overlay -->
            <div class="category-overlay-backdrop" id="category-backdrop" onclick="toggleMobileCategories()"></div>

            <!-- Library Layout with Sidebar -->
            <div class="library-layout">
                <!-- Category Sidebar -->
                <div class="category-sidebar" id="category-sidebar" data-type="music">
                    <!-- Close button header for mobile -->
                    <div class="category-close-header">
                        <span>Browse Categories</span>
                        <button class="category-close-btn" onclick="toggleMobileCategories()" title="Close">
                            <svg class="icon" width="18" height="18"><use href="#icon-close"/></svg>
                        </button>
                    </div>
                    <!-- Type Tabs: Music, SFX, Speech, Graphlings -->
                    <div class="category-type-tabs">
                        <button class="type-tab active" data-type="music" onclick="selectTypeTab('music')" title="Browse generated music">
                            <svg class="icon"><use href="#icon-music"/></svg>
                            Music
                            <span class="tab-count" id="music-count">0</span>
                        </button>
                        <button class="type-tab" data-type="audio" onclick="selectTypeTab('audio')" title="Browse sound effects">
                            <svg class="icon"><use href="#icon-volume"/></svg>
                            SFX
                            <span class="tab-count" id="sfx-count">0</span>
                        </button>
                        <button class="type-tab" data-type="voice" onclick="selectTypeTab('voice')" title="Browse speech/narration">
                            <svg class="icon"><use href="#icon-mic"/></svg>
                            Speech
                            <span class="tab-count" id="voice-count">0</span>
                        </button>
                        <button class="type-tab" data-type="graphlings" onclick="selectTypeTab('graphlings')" title="Browse Graphlings game audio">
                            <svg class="icon"><use href="#icon-game"/></svg>
                            Graphlings
                            <span class="tab-count" id="graphlings-count">0</span>
                        </button>
                    </div>

                    <!-- Quick Filters -->
                    <div class="quick-filters">
                        <button class="quick-filter-btn" onclick="selectQuickFilter('favorites')" data-filter="favorites" title="Show only favorited tracks">
                            <svg class="icon"><use href="#icon-heart"/></svg>
                            <span>Favorites</span>
                        </button>
                        <button class="quick-filter-btn" onclick="selectQuickFilter('recent')" data-filter="recent" title="Show recently played tracks">
                            <svg class="icon"><use href="#icon-clock"/></svg>
                            <span>Recent</span>
                        </button>
                    </div>

                    <!-- Music Genres - Collapsible Groups -->
                    <div class="genre-section music-genres" id="music-genres">
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Electronic & Dance</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('electronic')" data-genre="electronic"><span class="genre-name">Electronic</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('edm')" data-genre="edm"><span class="genre-name">EDM</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('house')" data-genre="house"><span class="genre-name">House</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('techno')" data-genre="techno"><span class="genre-name">Techno</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('synthwave')" data-genre="synthwave"><span class="genre-name">Synthwave</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Ambient & Chill</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('ambient')" data-genre="ambient"><span class="genre-name">Ambient</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('lofi')" data-genre="lofi"><span class="genre-name">Lo-Fi</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('chill')" data-genre="chill"><span class="genre-name">Chill</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('meditation')" data-genre="meditation"><span class="genre-name">Meditation</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('study')" data-genre="study"><span class="genre-name">Study/Focus</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Cinematic & Epic</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('cinematic')" data-genre="cinematic"><span class="genre-name">Cinematic</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('epic')" data-genre="epic"><span class="genre-name">Epic</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('orchestral')" data-genre="orchestral"><span class="genre-name">Orchestral</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('trailer')" data-genre="trailer"><span class="genre-name">Trailer</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('suspense')" data-genre="suspense"><span class="genre-name">Suspense</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Acoustic & Classical</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('acoustic')" data-genre="acoustic"><span class="genre-name">Acoustic</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('piano')" data-genre="piano"><span class="genre-name">Piano</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('guitar')" data-genre="guitar"><span class="genre-name">Guitar</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('classical')" data-genre="classical"><span class="genre-name">Classical</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('jazz')" data-genre="jazz"><span class="genre-name">Jazz</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Hip Hop & Urban</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('hiphop')" data-genre="hiphop"><span class="genre-name">Hip Hop</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('trap')" data-genre="trap"><span class="genre-name">Trap</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('funk')" data-genre="funk"><span class="genre-name">Funk</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('soul')" data-genre="soul"><span class="genre-name">Soul</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Rock & Alternative</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('rock')" data-genre="rock"><span class="genre-name">Rock</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('indie')" data-genre="indie"><span class="genre-name">Indie</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('metal')" data-genre="metal"><span class="genre-name">Metal</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('punk')" data-genre="punk"><span class="genre-name">Punk</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Moods & Energy</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('upbeat')" data-genre="upbeat"><span class="genre-name">Upbeat</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('happy')" data-genre="happy"><span class="genre-name">Happy</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('sad')" data-genre="sad"><span class="genre-name">Sad</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('relaxing')" data-genre="relaxing"><span class="genre-name">Relaxing</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('scary')" data-genre="scary"><span class="genre-name">Scary</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Retro & Gaming</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('retro')" data-genre="retro"><span class="genre-name">Retro</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('chiptune')" data-genre="chiptune"><span class="genre-name">Chiptune/8-bit</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('arcade')" data-genre="arcade"><span class="genre-name">Arcade</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('game_music')" data-genre="game_music"><span class="genre-name">Game Music</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>World & Cultural</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('world')" data-genre="world"><span class="genre-name">World</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('latin')" data-genre="latin"><span class="genre-name">Latin</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('asian')" data-genre="asian"><span class="genre-name">Asian</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('celtic')" data-genre="celtic"><span class="genre-name">Celtic</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Use Cases</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('corporate')" data-genre="corporate"><span class="genre-name">Corporate</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('youtube')" data-genre="youtube"><span class="genre-name">YouTube</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('podcast')" data-genre="podcast"><span class="genre-name">Podcast</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('workout')" data-genre="workout"><span class="genre-name">Workout</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('kids')" data-genre="kids"><span class="genre-name">Kids</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- SFX Categories - Collapsible Groups -->
                    <div class="genre-section sfx-genres" id="sfx-genres">
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Trailer & Cinematic</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('hit')" data-genre="hit"><span class="genre-name">Hit/Slam</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('transition')" data-genre="transition"><span class="genre-name">Transition</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('riser')" data-genre="riser"><span class="genre-name">Riser</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('boom')" data-genre="boom"><span class="genre-name">Boom</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('stinger')" data-genre="stinger"><span class="genre-name">Stinger</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('swell')" data-genre="swell"><span class="genre-name">Swell</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('buildup')" data-genre="buildup"><span class="genre-name">Buildup</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('drop')" data-genre="drop"><span class="genre-name">Drop</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('drone')" data-genre="drone"><span class="genre-name">Drone</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('sub_bass')" data-genre="sub_bass"><span class="genre-name">Sub Bass</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>UI & Interface</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('notification')" data-genre="notification"><span class="genre-name">Notification</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('button')" data-genre="button"><span class="genre-name">Button/Click</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('menu')" data-genre="menu"><span class="genre-name">Menu</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('success')" data-genre="success"><span class="genre-name">Success/Win</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('error')" data-genre="error"><span class="genre-name">Error/Fail</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('typing')" data-genre="typing"><span class="genre-name">Typing</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Actions & Movement</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('whoosh')" data-genre="whoosh"><span class="genre-name">Whoosh</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('impact')" data-genre="impact"><span class="genre-name">Impact/Hit</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('explosion')" data-genre="explosion"><span class="genre-name">Explosion</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('crash')" data-genre="crash"><span class="genre-name">Crash</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('jump')" data-genre="jump"><span class="genre-name">Jump</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('footstep')" data-genre="footstep"><span class="genre-name">Footsteps</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Nature & Weather</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('rain')" data-genre="rain"><span class="genre-name">Rain</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('wind')" data-genre="wind"><span class="genre-name">Wind</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('thunder')" data-genre="thunder"><span class="genre-name">Thunder</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('water')" data-genre="water"><span class="genre-name">Water</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('ocean')" data-genre="ocean"><span class="genre-name">Ocean</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('fire')" data-genre="fire"><span class="genre-name">Fire</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('forest')" data-genre="forest"><span class="genre-name">Forest</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Animals & Creatures</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('creature')" data-genre="creature"><span class="genre-name">Creature</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('monster')" data-genre="monster"><span class="genre-name">Monster</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('bird')" data-genre="bird"><span class="genre-name">Birds</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('dog')" data-genre="dog"><span class="genre-name">Dog</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('cat')" data-genre="cat"><span class="genre-name">Cat</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('insect')" data-genre="insect"><span class="genre-name">Insects</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Human Sounds</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('voice')" data-genre="voice"><span class="genre-name">Voice</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('crowd')" data-genre="crowd"><span class="genre-name">Crowd</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('scream')" data-genre="scream"><span class="genre-name">Scream</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('breathing')" data-genre="breathing"><span class="genre-name">Breathing</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('laugh')" data-genre="laugh"><span class="genre-name">Laugh</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Objects & Materials</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('door')" data-genre="door"><span class="genre-name">Door</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('bell')" data-genre="bell"><span class="genre-name">Bell</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('glass')" data-genre="glass"><span class="genre-name">Glass</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('metal')" data-genre="metal"><span class="genre-name">Metal</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('wood')" data-genre="wood"><span class="genre-name">Wood</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('paper')" data-genre="paper"><span class="genre-name">Paper</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Vehicles & Machines</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('car')" data-genre="car"><span class="genre-name">Car</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('engine')" data-genre="engine"><span class="genre-name">Engine</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('machine')" data-genre="machine"><span class="genre-name">Machine</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('robot')" data-genre="robot"><span class="genre-name">Robot</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('electricity')" data-genre="electricity"><span class="genre-name">Electricity</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('helicopter')" data-genre="helicopter"><span class="genre-name">Helicopter</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Sci-Fi & Fantasy</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('laser')" data-genre="laser"><span class="genre-name">Laser</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('magic')" data-genre="magic"><span class="genre-name">Magic/Spell</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('sparkle')" data-genre="sparkle"><span class="genre-name">Sparkle</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('alien')" data-genre="alien"><span class="genre-name">Alien</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('teleport')" data-genre="teleport"><span class="genre-name">Teleport</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('futuristic')" data-genre="futuristic"><span class="genre-name">Futuristic</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('power_up')" data-genre="power_up"><span class="genre-name">Power Up</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Weapons & Combat</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('gun')" data-genre="gun"><span class="genre-name">Gun/Shoot</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('sword')" data-genre="sword"><span class="genre-name">Sword</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('punch')" data-genre="punch"><span class="genre-name">Punch</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('fight')" data-genre="fight"><span class="genre-name">Fight</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Horror & Tension</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('horror')" data-genre="horror"><span class="genre-name">Horror</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('tension')" data-genre="tension"><span class="genre-name">Tension</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('creepy')" data-genre="creepy"><span class="genre-name">Creepy</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('ghost')" data-genre="ghost"><span class="genre-name">Ghost</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('jumpscare')" data-genre="jumpscare"><span class="genre-name">Jump Scare</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Cartoon & Comedy</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('cartoon')" data-genre="cartoon"><span class="genre-name">Cartoon</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('boing')" data-genre="boing"><span class="genre-name">Boing</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('funny')" data-genre="funny"><span class="genre-name">Funny</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('slide_whistle')" data-genre="slide_whistle"><span class="genre-name">Slide Whistle</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Speech Categories - Collapsible Groups -->
                    <div class="genre-section speech-genres" id="speech-genres">
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Voice Gender</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('male')" data-genre="male"><span class="genre-name">Male</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('female')" data-genre="female"><span class="genre-name">Female</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Voice Style</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('natural')" data-genre="natural"><span class="genre-name">Natural</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('professional')" data-genre="professional"><span class="genre-name">Professional</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('dramatic')" data-genre="dramatic"><span class="genre-name">Dramatic</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('whisper')" data-genre="whisper"><span class="genre-name">Whisper</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('announcer')" data-genre="announcer"><span class="genre-name">Announcer</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Content Type</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('announcement')" data-genre="announcement"><span class="genre-name">Announcement</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('narration')" data-genre="narration"><span class="genre-name">Narration</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('dialogue')" data-genre="dialogue"><span class="genre-name">Dialogue</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('monologue')" data-genre="monologue"><span class="genre-name">Monologue</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('voiceover')" data-genre="voiceover"><span class="genre-name">Voiceover</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('audiobook')" data-genre="audiobook"><span class="genre-name">Audiobook</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Numbers & Data</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('numbers')" data-genre="numbers"><span class="genre-name">Numbers</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('counting')" data-genre="counting"><span class="genre-name">Counting</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('time')" data-genre="time"><span class="genre-name">Time</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('date')" data-genre="date"><span class="genre-name">Date</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('currency')" data-genre="currency"><span class="genre-name">Currency</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('phone_number')" data-genre="phone_number"><span class="genre-name">Phone Number</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('address')" data-genre="address"><span class="genre-name">Address</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Common Phrases</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('greeting')" data-genre="greeting"><span class="genre-name">Greeting</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('farewell')" data-genre="farewell"><span class="genre-name">Farewell</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('thanks')" data-genre="thanks"><span class="genre-name">Thanks</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('confirmation')" data-genre="confirmation"><span class="genre-name">Confirmation</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('denial')" data-genre="denial"><span class="genre-name">Denial</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('question')" data-genre="question"><span class="genre-name">Question</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Instructions</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('directions')" data-genre="directions"><span class="genre-name">Directions</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('tutorial')" data-genre="tutorial"><span class="genre-name">Tutorial</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('warning')" data-genre="warning"><span class="genre-name">Warning</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('alert')" data-genre="alert"><span class="genre-name">Alert</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('reminder')" data-genre="reminder"><span class="genre-name">Reminder</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('prompt')" data-genre="prompt"><span class="genre-name">Prompt</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Media & Entertainment</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('commercial')" data-genre="commercial"><span class="genre-name">Commercial</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('trailer_voice')" data-genre="trailer_voice"><span class="genre-name">Trailer Voice</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('podcast')" data-genre="podcast"><span class="genre-name">Podcast</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('radio')" data-genre="radio"><span class="genre-name">Radio</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('game_voice')" data-genre="game_voice"><span class="genre-name">Game Voice</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('character')" data-genre="character"><span class="genre-name">Character</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Informational</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('news')" data-genre="news"><span class="genre-name">News</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('weather')" data-genre="weather"><span class="genre-name">Weather</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('sports')" data-genre="sports"><span class="genre-name">Sports</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('traffic')" data-genre="traffic"><span class="genre-name">Traffic</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('stock_market')" data-genre="stock_market"><span class="genre-name">Financial</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Alphabet & Spelling</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('alphabet')" data-genre="alphabet"><span class="genre-name">Alphabet</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('spelling')" data-genre="spelling"><span class="genre-name">Spelling</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('phonetic')" data-genre="phonetic"><span class="genre-name">NATO Phonetic</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Graphlings Games/Apps - Dynamic from API -->
                    <div class="genre-section graphlings-genres" id="graphlings-genres">
                        <div class="graphlings-loading">Loading games...</div>
                        <!-- Dynamically populated by loadGraphlingsSources() -->
                    </div>

                    <!-- Clear Filter Button -->
                    <button class="clear-filter-btn" id="clear-filter-btn" onclick="clearAllFilters()" style="display: none;" title="Clear all active filters">
                        <svg class="icon"><use href="#icon-close"/></svg>
                        Clear Filters
                    </button>
                </div>

                <!-- Main Content Area -->
                <div class="library-main">
                    <!-- Library Items Container -->
                    <div id="library-items" class="library-items">
                        <div class="library-empty">
                            <svg class="empty-icon"><use href="#icon-music"/></svg>
                            <h3>Loading library...</h3>
                            <p>Fetching your audio collection</p>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination" id="pagination">
                        <button class="page-btn" id="prev-page" onclick="prevPage()" title="Previous page">
                            <svg class="icon icon-sm"><use href="#icon-skip-prev"/></svg>
                        </button>
                        <div class="page-numbers" id="page-numbers"></div>
                        <span class="page-info" id="page-info">Page 1 of 1</span>
                        <button class="page-btn" id="next-page" onclick="nextPage()" title="Next page">
                            <svg class="icon icon-sm"><use href="#icon-skip-next"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        </div> <!-- /content-library -->

        <!-- GENERATE TAB -->
        <div class="tab-content" id="content-generate">

        <div id="loading-banner" class="loading-banner">
            <div class="title">Loading AI Models...</div>
            <div class="model-status">
                <div class="model-status-item">
                    <span class="status-dot" id="music-status-dot"></span>
                    <span>Music</span>
                </div>
                <div class="model-status-item">
                    <span class="status-dot" id="audio-status-dot"></span>
                    <span>SFX</span>
                </div>
                <div class="model-status-item">
                    <span class="status-dot" id="tts-status-dot"></span>
                    <span>Speech</span>
                </div>
            </div>
        </div>

        <!-- UNIFIED SERVER STATUS -->
        <div class="card server-status-card collapsed" id="server-status-card">
            <div class="server-status-header" onclick="toggleQueueExplorer()">
                <!-- GPU Info -->
                <div class="server-gpu" title="GPU memory usage and status">
                    <span class="gpu-icon"><svg class="icon icon-sm"><use href="#icon-gpu"/></svg></span>
                    <span id="gpu-name">GPU</span>
                    <div class="gpu-bar">
                        <div class="gpu-bar-fill" id="gpu-bar-fill"></div>
                    </div>
                    <span id="gpu-mem">0%</span>
                    <span class="gpu-busy" id="gpu-busy">IDLE</span>
                </div>

                <!-- Queue Summary -->
                <div class="server-queue-summary">
                    <span class="queue-badge" id="queue-explorer-badge">0</span>
                    <span class="queue-label">in queue</span>
                    <span class="wait-time" id="estimated-wait">Ready</span>
                </div>

                <!-- Expand Toggle -->
                <span class="collapse-icon"></span>
            </div>

            <!-- Collapsible Queue List -->
            <div class="queue-explorer-content" id="queue-explorer-content">
                <div class="queue-list" id="queue-explorer-list"></div>
                <div class="queue-empty" id="queue-empty">
                    <svg class="icon icon-lg"><use href="#icon-sparkles"/></svg>
                    <span>Ready to generate!</span>
                </div>
            </div>
        </div>

        <!-- GENERATOR -->
        <div class="card generator-card" id="generator-card">
            <h2><svg class="icon icon-lg" style="vertical-align: -4px; margin-right: 6px;"><use href="#icon-wand"/></svg>Generate New</h2>
            <div class="generator-content">
            <div class="model-tabs">
                <div class="model-tab active" data-model="music" onclick="selectModel('music')" title="Generate music with AI">
                    <svg class="icon icon-lg"><use href="#icon-music"/></svg>
                    <span>Music</span>
                </div>
                <div class="model-tab" data-model="audio" onclick="selectModel('audio')" title="Generate sound effects with AI">
                    <svg class="icon icon-lg"><use href="#icon-volume"/></svg>
                    <span>SFX</span>
                </div>
                <div class="model-tab" data-model="voice" onclick="selectModel('voice')" title="Generate speech with AI">
                    <svg class="icon icon-lg"><use href="#icon-mic"/></svg>
                    <span>Speech</span>
                </div>
            </div>

            <!-- Voice selector (shown only for voice model) -->
            <div class="voice-selector" id="voice-selector" style="display: none;">
                <div class="voice-selector-header">
                    <div class="voice-search-box">
                        <svg class="icon" width="16" height="16"><use href="#icon-search"/></svg>
                        <input type="text" id="voice-search" placeholder="Search voices..." oninput="filterVoices()" maxlength="100">
                    </div>
                    <div class="voice-filters">
                        <button class="voice-filter-btn active" data-filter="all" onclick="setVoiceFilter('all')" title="Show all voices">All</button>
                        <button class="voice-filter-btn" data-filter="favorites" onclick="setVoiceFilter('favorites')" title="Show favorite voices">
                            <svg class="icon" width="14" height="14"><use href="#icon-star"/></svg> Favorites
                        </button>
                        <button class="voice-filter-btn" data-filter="en_US" onclick="setVoiceFilter('en_US')" title="American English voices">US</button>
                        <button class="voice-filter-btn" data-filter="en_GB" onclick="setVoiceFilter('en_GB')" title="British English voices">UK</button>
                    </div>
                </div>
                <div class="voice-list" id="voice-list">
                    <!-- Voices loaded dynamically -->
                </div>
            </div>

            <label for="prompt">Describe what you want to generate:</label>
            <textarea id="prompt" placeholder="e.g., upbeat electronic dance music with heavy bass and synth leads" maxlength="2000"></textarea>

            <div class="examples" id="music-examples">
                <span>Try these:</span>
                <div class="example-chips">
                    <span class="chip" onclick="setPrompt('lo-fi hip hop beat with jazzy piano')">Lo-fi Hip Hop</span>
                    <span class="chip" onclick="setPrompt('epic orchestral music with dramatic strings')">Epic Orchestral</span>
                    <span class="chip" onclick="setPrompt('chill acoustic guitar with soft drums')">Chill Acoustic</span>
                    <span class="chip" onclick="setPrompt('80s synthwave with retro synths and drums')">80s Synthwave</span>
                </div>
            </div>

            <div class="examples" id="audio-examples" style="display: none;">
                <span>Try these:</span>
                <div class="example-chips">
                    <span class="chip" onclick="setPrompt('dog barking in the distance')">Dog Barking</span>
                    <span class="chip" onclick="setPrompt('thunder and heavy rain')">Thunder Storm</span>
                    <span class="chip" onclick="setPrompt('footsteps on wooden floor')">Footsteps</span>
                    <span class="chip" onclick="setPrompt('car engine starting and revving')">Car Engine</span>
                    <span class="chip" onclick="setPrompt('crowd cheering at a sports event')">Crowd Cheering</span>
                    <span class="chip" onclick="setPrompt('glass breaking and shattering')">Glass Breaking</span>
                </div>
            </div>

            <div class="examples" id="voice-examples" style="display: none;">
                <span>Try these:</span>
                <div class="example-chips">
                    <span class="chip" onclick="setPrompt('Welcome to the game! Press start to begin.')">Game Welcome</span>
                    <span class="chip" onclick="setPrompt('Level complete! You earned 100 points.')">Level Complete</span>
                    <span class="chip" onclick="setPrompt('Game over. Would you like to play again?')">Game Over</span>
                    <span class="chip" onclick="setPrompt('Three. Two. One. Go!')">Countdown</span>
                    <span class="chip" onclick="setPrompt('Achievement unlocked! You are a champion.')">Achievement</span>
                    <span class="chip" onclick="setPrompt('Warning! Enemy approaching from the north.')">Warning</span>
                </div>
            </div>

            <div class="controls">
                <div class="control-box duration-control">
                    <label for="duration">Duration</label>
                    <div class="duration-value"><span id="duration-display">8</span>s</div>
                    <input type="range" id="duration" min="3" max="120" value="8">
                </div>
                <div class="control-box loop-control" id="loop-control" onclick="toggleLoop()" title="Apply crossfade to make the audio loop seamlessly">
                    <span class="toggle-switch"></span>
                    <span class="loop-label">Loop</span>
                    <input type="checkbox" id="loop-checkbox">
                </div>
                <div class="control-box random-control" id="random-btn" onclick="randomPrompt()" title="Generate a random creative prompt">Random</div>
                <button id="generate-btn" class="btn btn-primary" onclick="generate()" title="Generate audio from your prompt">
                    <span>Generate</span>
                </button>
            </div>

            <div id="status" class="status"></div>

            <div id="player" class="player">
                <h2>Generated Audio <span id="quality-badge" class="quality-badge"></span></h2>
                <div class="styled-audio">
                    <audio id="audio" controls></audio>
                </div>
                <div id="player-spectrogram" class="player-spectrogram"></div>
            </div>
            </div> <!-- /generator-content -->
        </div>
        </div> <!-- /content-generate -->

        <!-- PLAYLISTS TAB -->
        <div class="tab-content" id="content-playlists">
            <div class="card">
                <h2><svg class="icon icon-lg" style="vertical-align: -4px; margin-right: 6px;"><use href="#icon-music"/></svg>Your Playlists</h2>

                <div class="playlists-header">
                    <p class="playlists-intro">Create and manage your own playlists. Save your favorite tracks and share them with others.</p>
                    <button class="btn btn-primary" onclick="createNewPlaylist()" title="Create a new playlist">
                        <svg class="icon"><use href="#icon-plus"/></svg>
                        New Playlist
                    </button>
                </div>

                <div class="playlists-grid" id="playlists-grid">
                    <!-- Playlists will be loaded here -->
                    <div class="playlist-empty-state">
                        <svg class="icon icon-xl"><use href="#icon-music"/></svg>
                        <h3>No playlists yet</h3>
                        <p>Create your first playlist to start organizing your tracks!</p>
                    </div>
                </div>

                <div class="favorites-section">
                    <h3><svg class="icon" style="vertical-align: -2px; margin-right: 4px;"><use href="#icon-heart"/></svg>Favorited Tracks</h3>
                    <p class="section-hint">Tracks you've favorited appear here. Add them to playlists or play them directly.</p>
                    <div class="favorites-grid" id="favorites-grid">
                        <!-- Favorited tracks will be loaded here -->
                        <div class="favorites-empty-state">
                            <p>No favorites yet. Heart tracks in the Radio or Library to save them here!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- /content-playlists -->

        <!-- HISTORY TAB -->
        <div class="tab-content" id="content-history">
            <div class="card history-card">
                <h2><svg class="icon icon-lg" style="vertical-align: -4px; margin-right: 6px;"><use href="#icon-clock"/></svg>Your History</h2>

                <!-- Auth gate for history -->
                <div class="history-auth-gate" id="history-auth-gate">
                    <div class="auth-gate-content">
                        <svg class="icon icon-xl"><use href="#icon-lock"/></svg>
                        <h3>Sign in to view your history</h3>
                        <p>Your play history and votes are saved when you're logged in via Graphlings.</p>
                    </div>
                </div>

                <!-- History content (shown when authenticated) -->
                <div class="history-content hidden" id="history-content">
                    <!-- History sub-tabs -->
                    <div class="history-tabs">
                        <button class="history-tab active" data-tab="plays" onclick="switchHistoryTab('plays')" title="View your play history">
                            <svg class="icon"><use href="#icon-play"/></svg>
                            Play History
                        </button>
                        <button class="history-tab" data-tab="votes" onclick="switchHistoryTab('votes')" title="View your vote history">
                            <svg class="icon"><use href="#icon-thumb-up"/></svg>
                            Vote History
                        </button>
                    </div>

                    <!-- Play History Section -->
                    <div class="history-section active" id="history-plays">
                        <div class="history-list" id="play-history-list">
                            <div class="history-loading">
                                <div class="loading-spinner"></div>
                                <p>Loading play history...</p>
                            </div>
                        </div>
                        <button class="load-more-btn hidden" id="load-more-plays" onclick="loadMorePlayHistory()" title="Load more play history">
                            Load More
                        </button>
                    </div>

                    <!-- Vote History Section -->
                    <div class="history-section" id="history-votes">
                        <div class="history-list" id="vote-history-list">
                            <div class="history-loading">
                                <div class="loading-spinner"></div>
                                <p>Loading vote history...</p>
                            </div>
                        </div>
                        <button class="load-more-btn hidden" id="load-more-votes" onclick="loadMoreVoteHistory()" title="Load more vote history">
                            Load More
                        </button>
                    </div>
                </div>
            </div>
        </div> <!-- /content-history -->

        <!-- API TAB -->
        <div class="tab-content" id="content-api">
            <div class="card api-docs-card">
                <h2><svg class="icon icon-lg" style="vertical-align: -4px; margin-right: 6px;"><use href="#icon-code"/></svg>Developer API</h2>

                <div class="api-intro">
                    <p>Integrate Sound Box into your games, apps, and websites. All content is <strong>CC0 Public Domain</strong> - use it freely for any purpose!</p>
                </div>

                <!-- Widget Embed Section -->
                <div class="api-section">
                    <h3>Embeddable Radio Widget</h3>
                    <p>Add our radio player to your website with a simple script tag. Multiple sizes available:</p>

                    <div class="widget-sizes-preview" id="api-widget-demos">
                        <div class="widget-size-option" data-size="minimal">
                            <div class="widget-demo-container" id="demo-minimal"></div>
                            <span>Minimal<br><small>28048px</small></span>
                        </div>
                        <div class="widget-size-option" data-size="small">
                            <div class="widget-demo-container" id="demo-small"></div>
                            <span>Small<br><small>32080px</small></span>
                        </div>
                        <div class="widget-size-option" data-size="medium">
                            <div class="widget-demo-container" id="demo-medium"></div>
                            <span>Medium<br><small>400140px</small></span>
                        </div>
                        <div class="widget-size-option" data-size="large">
                            <div class="widget-demo-container" id="demo-large"></div>
                            <span>Large<br><small>600200px</small></span>
                        </div>
                    </div>

                    <div class="code-block">
                        <div class="code-header">
                            <span>Embed Code</span>
                            <button class="copy-btn" title="Copy to clipboard" onclick="copyApiCode('widget-embed')">Copy</button>
                        </div>
                        <pre id="widget-embed"><code>&lt;!-- Sound Box Radio Widget --&gt;
&lt;!-- Load the widget scripts --&gt;
&lt;script src="https://soundbox.graphlings.net/static/js/radio-widget-core.js"&gt;&lt;/script&gt;
&lt;script src="https://soundbox.graphlings.net/static/js/radio-widget.js"&gt;&lt;/script&gt;
&lt;link rel="stylesheet" href="https://soundbox.graphlings.net/static/css/radio-widget.css"&gt;
&lt;link rel="stylesheet" href="https://soundbox.graphlings.net/static/css/radio-widget-sizes.css"&gt;

&lt;!-- Container for the widget --&gt;
&lt;div id="my-radio"&gt;&lt;/div&gt;

&lt;script&gt;
  // Create a radio widget
  const widget = RadioWidget.create('#my-radio', {
    size: 'medium',       // minimal, small, medium, large
    template: 'default',  // default, neon, minimal-dark
    autoPlay: false       // Start playing automatically
  });
&lt;/script&gt;</code></pre>
                    </div>
                </div>

                <!-- REST API Section -->
                <div class="api-section">
                    <h3>REST API Endpoints</h3>
                    <p>Access our track library programmatically:</p>

                    <div class="api-endpoint">
                        <div class="endpoint-header">
                            <span class="method get">GET</span>
                            <code>/api/radio</code>
                        </div>
                        <p>Get tracks for radio playback. Returns queue of tracks with metadata.</p>
                        <div class="endpoint-params">
                            <strong>Query Parameters:</strong>
                            <ul>
                                <li><code>station</code> - shuffle, trending, top-rated, recent (default: shuffle)</li>
                                <li><code>model</code> - music or audio (default: music)</li>
                                <li><code>limit</code> - Number of tracks (default: 10, max: 50)</li>
                                <li><code>search</code> - Filter by keyword</li>
                            </ul>
                        </div>
                        <div class="code-block">
                            <div class="code-header">
                                <span>Example Request</span>
                                <button class="copy-btn" title="Copy to clipboard" onclick="copyApiCode('api-radio-example')">Copy</button>
                            </div>
                            <pre id="api-radio-example"><code># Get random tracks (shuffle station)
curl "https://soundbox.graphlings.net/api/radio?station=shuffle&amp;limit=5"

# Get trending tracks
curl "https://soundbox.graphlings.net/api/radio?station=trending&amp;model=music"

# Search for specific tracks
curl "https://soundbox.graphlings.net/api/library?search=epic+battle&amp;limit=10"</code></pre>
                        </div>
                    </div>

                    <div class="api-endpoint">
                        <div class="endpoint-header">
                            <span class="method get">GET</span>
                            <code>/api/library</code>
                        </div>
                        <p>Search and browse the full track library with filtering and pagination.</p>
                        <div class="endpoint-params">
                            <strong>Query Parameters:</strong>
                            <ul>
                                <li><code>search</code> - Search prompts/descriptions</li>
                                <li><code>model</code> - music or audio</li>
                                <li><code>category</code> - Filter by category (electronic, ambient, etc.)</li>
                                <li><code>sort</code> - recent, rating, plays (default: recent)</li>
                                <li><code>page</code> - Page number (default: 1)</li>
                                <li><code>limit</code> - Items per page (default: 20, max: 100)</li>
                            </ul>
                        </div>
                    </div>

                    <div class="api-endpoint">
                        <div class="endpoint-header">
                            <span class="method get">GET</span>
                            <code>/api/categories/{model}</code>
                        </div>
                        <p>Get available categories for music or audio with usage counts.</p>
                    </div>

                    <div class="api-endpoint">
                        <div class="endpoint-header">
                            <span class="method get">GET</span>
                            <code>/audio/{filename}</code>
                        </div>
                        <p>Stream or download audio files. Supports Range headers for streaming. CORS enabled.</p>
                    </div>
                </div>

                <!-- Response Format Section -->
                <div class="api-section">
                    <h3>Response Format</h3>
                    <p>All API responses return JSON. Track objects include:</p>
                    <div class="code-block">
                        <div class="code-header">
                            <span>Track Object</span>
                        </div>
                        <pre><code>{
  "id": "abc123...",
  "prompt": "epic orchestral battle music",
  "model": "music",
  "duration": 30,
  "filename": "abc123.wav",
  "category": ["epic", "orchestral", "cinematic"],
  "upvotes": 42,
  "downvotes": 3,
  "play_count": 156,
  "created_at": "2025-12-26T10:30:00Z",
  "license_type": "cc0"
}</code></pre>
                    </div>
                </div>

                <!-- Attribution Section -->
                <div class="api-section">
                    <h3>Attribution (Optional)</h3>
                    <p>All content is CC0 Public Domain - no attribution required! But if you'd like to credit us:</p>
                    <div class="code-block attribution-block">
                        <div class="code-header">
                            <span>Suggested Credit</span>
                            <button class="copy-btn" title="Copy to clipboard" onclick="copyApiCode('attribution-text')">Copy</button>
                        </div>
                        <pre id="attribution-text"><code>Music from Sound Box (soundbox.graphlings.net) - CC0 Public Domain</code></pre>
                    </div>
                </div>

                <!-- Rate Limits Section -->
                <div class="api-section">
                    <h3>Rate Limits & Usage</h3>
                    <ul class="api-limits">
                        <li><strong>No API key required</strong> - Open access for everyone</li>
                        <li><strong>Rate limit:</strong> 60 requests/minute per IP</li>
                        <li><strong>CORS enabled:</strong> Use directly from browser JavaScript</li>
                        <li><strong>No commercial restrictions:</strong> Use in games, apps, videos, anything!</li>
                    </ul>
                </div>
            </div>
        </div> <!-- /content-api -->

    </div>

    <script>
        // Shared track ID passed from /track/<id> route (for shareable links)
        const sharedTrackId = {{ shared_track_id|default(None)|tojson }};

        const promptEl = document.getElementById('prompt');
        const durationEl = document.getElementById('duration');
        const durationDisplay = document.getElementById('duration-display');
        const statusEl = document.getElementById('status');
        const playerEl = document.getElementById('player');
        const audioEl = document.getElementById('audio');
        const generateBtn = document.getElementById('generate-btn');
        const musicExamples = document.getElementById('music-examples');
        const audioExamples = document.getElementById('audio-examples');
        const loadingBanner = document.getElementById('loading-banner');
        const musicStatusDot = document.getElementById('music-status-dot');
        const audioStatusDot = document.getElementById('audio-status-dot');
        const ttsStatusDot = document.getElementById('tts-status-dot');
        const qualityBadge = document.getElementById('quality-badge');
        const playerSpectrogram = document.getElementById('player-spectrogram');

        let currentModel = 'music';
        let modelStatus = { music: 'pending', audio: 'pending', tts: 'ready' };
        let currentTab = 'radio';

        // ========================================
        // SHARED CATEGORY DEFINITIONS
        // Used by both library sidebar and tag modal
        // ========================================
        const MUSIC_CATEGORY_GROUPS = {
            'Electronic & Dance': ['electronic', 'edm', 'house', 'techno', 'trance', 'dubstep', 'drum_and_bass', 'synthwave'],
            'Ambient & Atmospheric': ['ambient', 'drone', 'meditation', 'nature_music', 'space', 'dark_ambient'],
            'Cinematic': ['cinematic', 'epic', 'orchestral', 'trailer', 'dramatic', 'suspense', 'heroic', 'romantic'],
            'Classical & Acoustic': ['classical', 'piano', 'guitar', 'strings', 'orchestra_section', 'acoustic'],
            'Lo-Fi & Chill': ['lofi', 'chillhop', 'chill', 'study', 'cafe'],
            'Hip Hop': ['hiphop', 'trap', 'boom_bap', 'instrumental_hiphop'],
            'Rock & Alternative': ['rock', 'indie', 'metal', 'punk', 'grunge'],
            'Jazz & Blues': ['jazz', 'blues', 'soul', 'funk'],
            'World & Ethnic': ['world', 'asian', 'latin', 'african', 'celtic', 'middle_eastern'],
            'Moods & Emotions': ['happy', 'sad', 'angry', 'peaceful', 'mysterious', 'scary', 'inspirational'],
            'Energy Levels': ['upbeat', 'relaxing', 'intense', 'gentle'],
            'Retro & Vintage': ['retro', 'chiptune', 'arcade', '80s', '70s', '60s'],
            'Use Cases': ['corporate', 'advertising', 'youtube', 'podcast', 'game_music', 'holiday', 'workout', 'kids']
        };

        const SPEECH_CATEGORY_GROUPS = {
            'Voice Gender': ['male', 'female', 'child', 'neutral'],
            'Voice Style': ['natural', 'professional', 'casual', 'dramatic', 'whisper', 'robotic', 'announcer'],
            'Content Type': ['announcement', 'narration', 'dialogue', 'monologue', 'voiceover', 'audiobook'],
            'Numbers & Data': ['numbers', 'counting', 'time', 'date', 'currency', 'phone_number', 'address', 'coordinates'],
            'Common Phrases': ['greeting', 'farewell', 'thanks', 'apology', 'confirmation', 'denial', 'question', 'exclamation'],
            'Instructions': ['directions', 'tutorial', 'warning', 'alert', 'reminder', 'prompt'],
            'Media & Entertainment': ['commercial', 'trailer_voice', 'podcast', 'radio', 'game_voice', 'character'],
            'Informational': ['news', 'weather', 'sports', 'traffic', 'stock_market'],
            'Alphabet & Spelling': ['alphabet', 'spelling', 'phonetic'],
            'Languages': ['english', 'spanish', 'french', 'german', 'accent']
        };

        // Display names for speech categories
        const SPEECH_DISPLAY_NAMES = {
            // Voice Gender
            'male': 'Male', 'female': 'Female', 'child': 'Child', 'neutral': 'Neutral/Androgynous',
            // Voice Style
            'natural': 'Natural', 'professional': 'Professional', 'casual': 'Casual/Conversational',
            'dramatic': 'Dramatic', 'whisper': 'Whisper', 'robotic': 'Robotic/AI', 'announcer': 'Announcer',
            // Content Type
            'announcement': 'Announcement', 'narration': 'Narration', 'dialogue': 'Dialogue',
            'monologue': 'Monologue', 'voiceover': 'Voiceover', 'audiobook': 'Audiobook',
            // Numbers & Data
            'numbers': 'Numbers', 'counting': 'Counting', 'time': 'Time', 'date': 'Date',
            'currency': 'Currency/Money', 'phone_number': 'Phone Number', 'address': 'Address', 'coordinates': 'Coordinates',
            // Common Phrases
            'greeting': 'Greeting', 'farewell': 'Farewell/Goodbye', 'thanks': 'Thanks/Gratitude',
            'apology': 'Apology', 'confirmation': 'Confirmation/Yes', 'denial': 'Denial/No',
            'question': 'Question', 'exclamation': 'Exclamation',
            // Instructions
            'directions': 'Directions', 'tutorial': 'Tutorial/How-To', 'warning': 'Warning',
            'alert': 'Alert', 'reminder': 'Reminder', 'prompt': 'Prompt/Call to Action',
            // Media & Entertainment
            'commercial': 'Commercial/Ad', 'trailer_voice': 'Trailer Voice', 'podcast': 'Podcast',
            'radio': 'Radio', 'game_voice': 'Game Voice', 'character': 'Character Voice',
            // Informational
            'news': 'News', 'weather': 'Weather Report', 'sports': 'Sports Commentary',
            'traffic': 'Traffic Report', 'stock_market': 'Stock/Financial',
            // Alphabet & Spelling
            'alphabet': 'Alphabet', 'spelling': 'Spelling', 'phonetic': 'Phonetic/NATO',
            // Languages
            'english': 'English', 'spanish': 'Spanish', 'french': 'French', 'german': 'German', 'accent': 'Accented'
        };

        const SFX_CATEGORY_GROUPS = {
            'Trailer & Cinematic': ['hit', 'transition', 'riser', 'boom', 'stinger', 'swell', 'buildup', 'drop', 'drone', 'sub_bass'],
            'UI & Interface': ['notification', 'button', 'success', 'error', 'typing', 'menu'],
            'Actions & Movement': ['whoosh', 'impact', 'explosion', 'crash', 'jump', 'footstep'],
            'Nature & Weather': ['rain', 'wind', 'thunder', 'water', 'ocean', 'fire', 'forest'],
            'Animals & Creatures': ['creature', 'monster', 'bird', 'dog', 'cat', 'insect'],
            'Human Sounds': ['voice', 'crowd', 'scream', 'breathing', 'laugh'],
            'Objects & Materials': ['door', 'bell', 'glass', 'metal', 'wood', 'paper'],
            'Vehicles & Machines': ['car', 'engine', 'machine', 'robot', 'electricity', 'helicopter'],
            'Sci-Fi & Fantasy': ['laser', 'magic', 'sparkle', 'alien', 'teleport', 'futuristic', 'power_up'],
            'Weapons & Combat': ['gun', 'sword', 'punch', 'fight'],
            'Horror & Tension': ['horror', 'tension', 'creepy', 'ghost', 'jumpscare'],
            'Cartoon & Comedy': ['cartoon', 'boing', 'funny', 'slide_whistle']
        };

        // Display names for categories (for UI rendering)
        const CATEGORY_DISPLAY_NAMES = {
            // Trailer & Cinematic
            'riser': 'Riser', 'hit': 'Hit/Slam', 'boom': 'Boom', 'stinger': 'Stinger',
            'swell': 'Swell', 'transition': 'Transition', 'buildup': 'Buildup', 'drop': 'Drop',
            'drone': 'Drone', 'sub_bass': 'Sub Bass',
            // UI & Interface
            'notification': 'Notification', 'button': 'Button/Click', 'menu': 'Menu', 'success': 'Success/Win',
            'error': 'Error/Fail', 'typing': 'Typing',
            // Actions & Movement
            'whoosh': 'Whoosh', 'impact': 'Impact/Hit', 'explosion': 'Explosion', 'crash': 'Crash',
            'jump': 'Jump', 'footstep': 'Footsteps',
            // Nature & Weather
            'rain': 'Rain', 'wind': 'Wind', 'thunder': 'Thunder', 'water': 'Water', 'ocean': 'Ocean',
            'fire': 'Fire', 'forest': 'Forest',
            // Animals & Creatures
            'bird': 'Birds', 'dog': 'Dog', 'cat': 'Cat', 'insect': 'Insects',
            'creature': 'Creature', 'monster': 'Monster',
            // Human Sounds
            'voice': 'Voice', 'crowd': 'Crowd', 'laugh': 'Laugh', 'scream': 'Scream', 'breathing': 'Breathing',
            // Objects & Materials
            'door': 'Door', 'bell': 'Bell', 'glass': 'Glass', 'metal': 'Metal', 'wood': 'Wood', 'paper': 'Paper',
            // Vehicles & Machines
            'car': 'Car', 'engine': 'Engine', 'machine': 'Machine', 'electricity': 'Electricity',
            'robot': 'Robot', 'helicopter': 'Helicopter',
            // Sci-Fi & Fantasy
            'laser': 'Laser', 'magic': 'Magic/Spell', 'sparkle': 'Sparkle', 'teleport': 'Teleport',
            'alien': 'Alien', 'futuristic': 'Futuristic', 'power_up': 'Power Up',
            // Weapons & Combat
            'gun': 'Gun/Shoot', 'sword': 'Sword', 'punch': 'Punch', 'fight': 'Fight',
            // Horror & Tension
            'horror': 'Horror', 'tension': 'Tension', 'creepy': 'Creepy', 'ghost': 'Ghost', 'jumpscare': 'Jump Scare',
            // Cartoon & Comedy
            'cartoon': 'Cartoon', 'funny': 'Funny', 'boing': 'Boing', 'slide_whistle': 'Slide Whistle'
        };

        // ========================================
        // TAB SWITCHING
        // ========================================
        function switchTab(tabName) {
            currentTab = tabName;

            // Update tab buttons
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.classList.toggle('active', tab.id === `tab-${tabName}`);
            });

            // Sync mobile dropdown
            const mobileSelect = document.getElementById('mobile-tab-select');
            if (mobileSelect) mobileSelect.value = tabName;

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `content-${tabName}`);
            });

            // Save preference
            localStorage.setItem('soundbox_tab', tabName);

            // Load library if switching to library tab
            if (tabName === 'library') {
                loadTypeCounts();  // Update Music/SFX counts
                loadLibrary();
            }

            // Load playlists if switching to playlists tab
            if (tabName === 'playlists') {
                loadPlaylists();
                loadFavorites();
            }

            // Show/hide mini-player based on tab and playback state
            updateMiniPlayer();

            // Initialize API demo widgets when switching to API tab
            if (tabName === 'api') {
                initApiDemoWidgets();
            }

            // Load history if switching to history tab
            if (tabName === 'history') {
                updateHistoryAuthState();
            }
        }

        // ========================================
        // PLAYLISTS TAB & MODAL
        // ========================================
        let currentPlaylistModalTrackId = null;
        let userPlaylists = []; // Loaded from API (requires Graphlings auth)

        function isUserAuthenticated() {
            // In open access mode, everyone is "authenticated" with device ID
            if (OPEN_ACCESS_MODE) return true;
            // User is authenticated if we have their ID from Graphlings SDK
            // Token check removed - SDK doesn't expose token but does provide user ID
            return currentUserId !== null;
        }

        function showLoginPrompt(action) {
            // In open access mode, no login needed - just proceed
            if (OPEN_ACCESS_MODE) return;
            // Use SDK's built-in sign-in prompt
            if (window.graphlings && window.graphlings.promptSignIn) {
                window.graphlings.promptSignIn({
                    message: 'Sign in to unlock everything!',
                    description: 'Create playlists, save favorites, generate custom sounds, and more. All audio is free to download and use!'
                });
            } else {
                // Fallback: scroll to top where widget is
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Update UI elements based on authentication state
        function updateAuthUI(isLoggedIn) {
            const promptInput = document.getElementById('prompt');
            const generateBtn = document.getElementById('generate-btn');
            const durationSlider = document.getElementById('duration');
            const randomBtn = document.querySelector('.random-prompt-btn');

            if (isLoggedIn) {
                // Enable all controls for logged-in users
                if (promptInput) {
                    promptInput.disabled = false;
                    promptInput.placeholder = 'e.g., upbeat electronic dance music with heavy bass and synth leads';
                }
                if (generateBtn) generateBtn.disabled = false;
                if (durationSlider) durationSlider.disabled = false;
                if (randomBtn) randomBtn.disabled = false;
            } else {
                // Disable generation controls for guests
                // Note: Vote/favorite buttons are NOT disabled - they show login prompt when clicked
                if (promptInput) {
                    promptInput.disabled = true;
                    promptInput.placeholder = 'Sign in to generate audio...';
                }
                if (generateBtn) generateBtn.disabled = true;
                if (durationSlider) durationSlider.disabled = true;
                if (randomBtn) randomBtn.disabled = true;
            }
        }

        // Initialize auth UI on page load (will be called again when SDK is ready)
        document.addEventListener('DOMContentLoaded', function() {
            if (OPEN_ACCESS_MODE) {
                // Open access: enable everything immediately
                updateAuthUI(true);
            } else {
                // Start with controls disabled until we know auth state
                updateAuthUI(false);
            }
        });

        async function loadPlaylists() {
            const grid = document.getElementById('playlists-grid');
            if (!grid) return;

            // Check if user is authenticated
            if (!isUserAuthenticated()) {
                grid.innerHTML = `
                    <div class="playlist-empty-state">
                        <svg class="icon icon-xl"><use href="#icon-user"/></svg>
                        <h3>Sign in to use Playlists</h3>
                        <p>Log in with your Graphlings account to create and manage playlists.</p>
                    </div>
                `;
                userPlaylists = [];
                return;
            }

            // Load playlists from API (uses auth token)
            try {
                const res = await authFetch('/api/playlists');
                const data = await res.json();

                if (data.error) {
                    console.error('Failed to load playlists:', data.error);
                    userPlaylists = [];
                } else {
                    userPlaylists = data.playlists || [];
                }
            } catch (e) {
                console.error('Failed to load playlists:', e);
                userPlaylists = [];
            }

            // Render playlists grid
            if (userPlaylists.length === 0) {
                grid.innerHTML = `
                    <div class="playlist-empty-state">
                        <svg class="icon icon-xl"><use href="#icon-music"/></svg>
                        <h3>No playlists yet</h3>
                        <p>Create your first playlist to start organizing your tracks!</p>
                    </div>
                `;
            } else {
                grid.innerHTML = userPlaylists.map(pl => `
                    <div class="playlist-card" onclick="viewPlaylist('${escapeJsString(pl.id)}')">
                        <div class="playlist-card-icon">
                            <svg class="icon"><use href="#icon-music"/></svg>
                        </div>
                        <div class="playlist-card-name">${escapeHtml(pl.name)}</div>
                        <div class="playlist-card-count">${pl.track_count || 0} tracks</div>
                    </div>
                `).join('');
            }
        }

        async function loadFavorites() {
            const grid = document.getElementById('favorites-grid');
            if (!grid) return;

            // Check if authenticated (use isUserAuthenticated - only requires userId, not token)
            if (!isUserAuthenticated()) {
                grid.innerHTML = `
                    <div class="playlist-empty-state">
                        <svg class="icon icon-xl"><use href="#icon-user"/></svg>
                        <h3>Sign in to see Favorites</h3>
                        <p>Log in with your Graphlings account to view your favorites.</p>
                    </div>
                `;
                return;
            }

            try {
                const res = await authFetch('/api/favorites?limit=20');
                const data = await res.json();

                if (data.favorites && data.favorites.length > 0) {
                    grid.innerHTML = data.favorites.map(item => `
                        <div class="favorite-item" data-id="${escapeHtml(item.id)}">
                            <div class="favorite-info">
                                <span class="favorite-prompt">${escapeHtml(item.prompt || 'Untitled')}</span>
                                <span class="favorite-duration">${Number(item.duration || 30).toFixed(1)}s</span>
                            </div>
                            <div class="favorite-actions">
                                <button class="btn btn-sm" onclick="playFavorite('${escapeJsString(item.id)}')">
                                    <svg class="icon"><use href="#icon-play"/></svg>
                                </button>
                                <button class="btn btn-sm" onclick="showAddToPlaylistModal('${escapeJsString(item.id)}')">
                                    <svg class="icon"><use href="#icon-plus"/></svg>
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = `
                        <div class="favorites-empty-state">
                            <p>No favorites yet. Heart tracks in the Radio or Library to save them here!</p>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Failed to load favorites:', err);
            }
        }

        // ========================================
        // HISTORY TAB
        // ========================================
        let playHistoryOffset = 0;
        let voteHistoryOffset = 0;
        const historyLimit = 20;

        function switchHistoryTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.history-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });

            // Update tab sections
            document.querySelectorAll('.history-section').forEach(section => {
                section.classList.toggle('active', section.id === `history-${tabName}`);
            });

            // Load data if not already loaded
            if (tabName === 'plays') {
                const list = document.getElementById('play-history-list');
                if (list && list.querySelector('.history-loading')) {
                    loadPlayHistory();
                }
            } else if (tabName === 'votes') {
                const list = document.getElementById('vote-history-list');
                if (list && list.querySelector('.history-loading')) {
                    loadVoteHistory();
                }
            }
        }

        async function loadPlayHistory(append = false) {
            const userId = getEffectiveUserId();
            if (!userId) return;

            const list = document.getElementById('play-history-list');
            const loadMoreBtn = document.getElementById('load-more-plays');

            if (!append) {
                playHistoryOffset = 0;
                list.innerHTML = '<div class="history-loading"><div class="loading-spinner"></div><p>Loading play history...</p></div>';
            }

            try {
                const res = await authFetch(`/api/history/plays?limit=${historyLimit}&offset=${playHistoryOffset}`);
                const data = await res.json();

                if (data.error) {
                    list.innerHTML = '<div class="history-empty-state"><p>Failed to load history</p></div>';
                    return;
                }

                if (!append) {
                    list.innerHTML = '';
                }

                if (data.history.length === 0 && !append) {
                    list.innerHTML = `
                        <div class="history-empty-state">
                            <svg class="icon"><use href="#icon-play"/></svg>
                            <h3>No play history yet</h3>
                            <p>Tracks you play will appear here</p>
                        </div>
                    `;
                    loadMoreBtn.classList.add('hidden');
                    return;
                }

                data.history.forEach(item => {
                    const date = new Date(item.played_at);
                    const timeAgo = formatTimeAgo(date);

                    list.insertAdjacentHTML('beforeend', `
                        <div class="history-item" data-id="${item.generation_id}">
                            <div class="history-item-icon play">
                                <svg class="icon"><use href="#icon-play"/></svg>
                            </div>
                            <div class="history-item-info">
                                <div class="history-item-prompt">${escapeHtml(item.prompt || 'Untitled')}</div>
                                <div class="history-item-meta">
                                    <span><svg class="icon" style="width:12px;height:12px;"><use href="#icon-clock"/></svg> ${timeAgo}</span>
                                    <span>${item.category || item.model_type}</span>
                                    <span>${Number(item.duration || 30).toFixed(1)}s</span>
                                </div>
                            </div>
                            <div class="history-item-actions">
                                <button onclick="playHistoryItem('${escapeJsString(item.generation_id)}')" title="Play">Play</button>
                                <button onclick="copyLibraryItemId('${escapeJsString(item.generation_id)}')" title="Copy unique ID to clipboard" class="btn-icon-sm copy-id-btn" style="color:#3b82f6;">
                                    <svg class="icon" style="width:14px;height:14px;"><use href="#icon-copy"/></svg>
                                    <span style="font-size:11px;margin-left:2px;">ID</span>
                                </button>
                            </div>
                        </div>
                    `);
                });

                playHistoryOffset += data.history.length;
                loadMoreBtn.classList.toggle('hidden', !data.has_more);

            } catch (err) {
                console.error('Failed to load play history:', err);
                if (!append) {
                    list.innerHTML = '<div class="history-empty-state"><p>Failed to load history</p></div>';
                }
            }
        }

        async function loadVoteHistory(append = false) {
            const userId = getEffectiveUserId();
            if (!userId) return;

            const list = document.getElementById('vote-history-list');
            const loadMoreBtn = document.getElementById('load-more-votes');

            if (!append) {
                voteHistoryOffset = 0;
                list.innerHTML = '<div class="history-loading"><div class="loading-spinner"></div><p>Loading vote history...</p></div>';
            }

            try {
                const res = await authFetch(`/api/history/votes?limit=${historyLimit}&offset=${voteHistoryOffset}`);
                const data = await res.json();

                if (data.error) {
                    list.innerHTML = '<div class="history-empty-state"><p>Failed to load history</p></div>';
                    return;
                }

                if (!append) {
                    list.innerHTML = '';
                }

                if (data.history.length === 0 && !append) {
                    list.innerHTML = `
                        <div class="history-empty-state">
                            <svg class="icon"><use href="#icon-thumb-up"/></svg>
                            <h3>No votes yet</h3>
                            <p>Tracks you vote on will appear here</p>
                        </div>
                    `;
                    loadMoreBtn.classList.add('hidden');
                    return;
                }

                data.history.forEach(item => {
                    const date = new Date(item.created_at);
                    const timeAgo = formatTimeAgo(date);
                    const isUpvote = item.vote > 0;

                    list.insertAdjacentHTML('beforeend', `
                        <div class="history-item" data-id="${item.generation_id}">
                            <div class="history-item-icon ${isUpvote ? 'upvote' : 'downvote'}">
                                <svg class="icon"><use href="#icon-thumb-${isUpvote ? 'up' : 'down'}"/></svg>
                            </div>
                            <div class="history-item-info">
                                <div class="history-item-prompt">${escapeHtml(item.prompt || 'Untitled')}</div>
                                <div class="history-item-meta">
                                    <span><svg class="icon" style="width:12px;height:12px;"><use href="#icon-clock"/></svg> ${timeAgo}</span>
                                    <span>${item.category || item.model_type}</span>
                                    <span>${Number(item.duration || 30).toFixed(1)}s</span>
                                </div>
                            </div>
                            <div class="history-item-actions">
                                <button onclick="playHistoryItem('${escapeJsString(item.generation_id)}')" title="Play">Play</button>
                                <button onclick="copyLibraryItemId('${escapeJsString(item.generation_id)}')" title="Copy unique ID to clipboard" class="btn-icon-sm copy-id-btn" style="color:#3b82f6;">
                                    <svg class="icon" style="width:14px;height:14px;"><use href="#icon-copy"/></svg>
                                    <span style="font-size:11px;margin-left:2px;">ID</span>
                                </button>
                            </div>
                        </div>
                    `);
                });

                voteHistoryOffset += data.history.length;
                loadMoreBtn.classList.toggle('hidden', !data.has_more);

            } catch (err) {
                console.error('Failed to load vote history:', err);
                if (!append) {
                    list.innerHTML = '<div class="history-empty-state"><p>Failed to load history</p></div>';
                }
            }
        }

        function loadMorePlayHistory() {
            loadPlayHistory(true);
        }

        function loadMoreVoteHistory() {
            loadVoteHistory(true);
        }

        async function playHistoryItem(generationId) {
            // Find the track and play it
            try {
                const res = await fetch(`/api/generation/${generationId}`);
                if (!res.ok) {
                    showErrorToast('Track not found');
                    return;
                }
                const track = await res.json();
                // Use the radio widget to play
                if (window.radioWidget && window.radioWidget.core) {
                    await window.radioWidget.core.playTrack(track);
                } else {
                    // Fallback: play directly
                    playLibraryItem(track.id, 'history');
                }
            } catch (err) {
                console.error('Failed to play track:', err);
                showErrorToast('Failed to play track');
            }
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return 'just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
            return date.toLocaleDateString();
        }

        function updateHistoryAuthState() {
            const userId = getEffectiveUserId();
            const authGate = document.getElementById('history-auth-gate');
            const content = document.getElementById('history-content');

            if (userId) {
                authGate.classList.add('hidden');
                content.classList.remove('hidden');
                // Load initial data
                loadPlayHistory();
            } else {
                authGate.classList.remove('hidden');
                content.classList.add('hidden');
            }
        }

        // ========================================
        // API DEMO WIDGETS
        // ========================================
        let apiDemoWidgetsInitialized = false;
        const apiDemoWidgets = {};

        function initApiDemoWidgets() {
            // Only initialize once
            if (apiDemoWidgetsInitialized) return;
            if (!window.RadioWidget) {
                console.warn('[API Demos] RadioWidget not loaded yet');
                return;
            }

            const sizes = [
                { id: 'demo-minimal', size: 'minimal' },
                { id: 'demo-small', size: 'small' },
                { id: 'demo-medium', size: 'medium' },
                { id: 'demo-large', size: 'large' }
            ];

            sizes.forEach(({ id, size }) => {
                const container = document.getElementById(id);
                if (container && !apiDemoWidgets[id]) {
                    try {
                        // Create demo widget - they share core state with main widget
                        apiDemoWidgets[id] = RadioWidget.create(container, {
                            size: size,
                            template: 'default',
                            connectToExisting: true  // Connect to main widget's audio
                        });
                    } catch (err) {
                        console.error(`[API Demos] Failed to create ${size} widget:`, err);
                    }
                }
            });

            apiDemoWidgetsInitialized = true;
        }

        function createNewPlaylist() {
            // Require authentication to use playlists
            if (!isUserAuthenticated()) {
                showLoginPrompt('create playlists');
                return;
            }

            // Open modal without a track pre-selected
            currentPlaylistModalTrackId = null;
            document.getElementById('playlist-modal-overlay').classList.remove('hidden');
            document.getElementById('playlist-modal-track').style.display = 'none';
            renderPlaylistList();
        }

        // Add to Playlist Modal Functions
        function showAddToPlaylistModal(trackId) {
            // Require authentication to use playlists
            if (!isUserAuthenticated()) {
                showLoginPrompt('use playlists');
                return;
            }

            currentPlaylistModalTrackId = trackId;
            const item = libraryItemsData[trackId] || currentRadioTrack;

            document.getElementById('playlist-modal-overlay').classList.remove('hidden');
            document.getElementById('playlist-modal-track').style.display = 'flex';

            if (item) {
                const model = item.model || 'music';
                document.getElementById('playlist-modal-badge').innerHTML =
                    `<svg class="icon icon-sm" style="vertical-align: -2px;"><use href="${model === 'music' ? '#icon-music' : '#icon-volume'}"/></svg>`;
                document.getElementById('playlist-modal-prompt').textContent = item.prompt || 'Untitled track';
            }

            // Clear input
            document.getElementById('new-playlist-name').value = '';
            document.getElementById('playlist-modal-status').textContent = '';
            document.getElementById('playlist-modal-status').className = 'playlist-modal-status';

            renderPlaylistList();
        }

        let playlistModalSubmitting = false;  // Prevent double-submit

        function closePlaylistModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('playlist-modal-overlay').classList.add('hidden');
            currentPlaylistModalTrackId = null;
            playlistModalSubmitting = false;  // Reset submit guard
        }

        async function renderPlaylistList() {
            const listEl = document.getElementById('playlist-modal-list');

            // Check auth
            if (!isUserAuthenticated()) {
                listEl.innerHTML = '<div class="playlist-empty">Sign in with Graphlings to use playlists.</div>';
                return;
            }

            // Fetch playlists if not already loaded
            if (userPlaylists.length === 0) {
                try {
                    const res = await authFetch('/api/playlists');
                    const data = await res.json();
                    userPlaylists = data.playlists || [];
                } catch (e) {
                    console.error('Failed to load playlists:', e);
                }
            }

            if (userPlaylists.length === 0) {
                listEl.innerHTML = '<div class="playlist-empty">No playlists yet. Create one below!</div>';
            } else {
                listEl.innerHTML = userPlaylists.map(pl => `
                    <div class="playlist-option" onclick="addTrackToPlaylist('${escapeJsString(pl.id)}')">
                        <div class="playlist-icon">
                            <svg class="icon"><use href="#icon-music"/></svg>
                        </div>
                        <div class="playlist-details">
                            <div class="playlist-name">${escapeHtml(pl.name)}</div>
                            <div class="playlist-count">${pl.track_count || 0} tracks</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        async function addTrackToPlaylist(playlistId) {
            if (!isUserAuthenticated()) {
                showLoginPrompt('add to playlists');
                return;
            }

            if (!currentPlaylistModalTrackId) {
                showErrorToast('No track selected');
                return;
            }

            // Prevent double-submit
            if (playlistModalSubmitting) return;
            playlistModalSubmitting = true;

            const playlist = userPlaylists.find(p => p.id === playlistId);
            if (!playlist) {
                playlistModalSubmitting = false;
                showErrorToast('Playlist not found');
                return;
            }

            const statusEl = document.getElementById('playlist-modal-status');
            statusEl.className = 'playlist-modal-status';
            statusEl.textContent = 'Adding...';

            try {
                const res = await authFetch(`/api/playlists/${playlistId}/tracks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        generation_id: currentPlaylistModalTrackId
                    })
                });

                const data = await res.json();

                if (data.success) {
                    statusEl.className = 'playlist-modal-status success';
                    statusEl.textContent = `Added to "${playlist.name}"`;
                    showFeedbackToast(`Added to ${playlist.name}`);

                    // Refresh playlists to update track counts
                    loadPlaylists();

                    setTimeout(() => closePlaylistModal(), 1000);
                } else {
                    statusEl.className = 'playlist-modal-status error';
                    statusEl.textContent = data.error || 'Failed to add track';
                    if (data.error?.includes('already')) {
                        showWarningToast('Track already in playlist');
                    } else {
                        showErrorToast(data.error || 'Failed to add track');
                    }
                }
            } catch (err) {
                console.error('Failed to add track:', err);
                statusEl.className = 'playlist-modal-status error';
                statusEl.textContent = 'Failed to add track';
                showErrorToast('Failed to add track');
            } finally {
                playlistModalSubmitting = false;
            }
        }

        async function createPlaylistAndAdd() {
            if (!isUserAuthenticated()) {
                showLoginPrompt('create playlists');
                return;
            }

            // Prevent double-submit
            if (playlistModalSubmitting) return;
            playlistModalSubmitting = true;

            const nameInput = document.getElementById('new-playlist-name');
            const name = nameInput.value.trim();

            if (!name) {
                playlistModalSubmitting = false;
                showErrorToast('Please enter a playlist name');
                nameInput.focus();
                return;
            }

            const statusEl = document.getElementById('playlist-modal-status');
            statusEl.className = 'playlist-modal-status';
            statusEl.textContent = 'Creating...';

            try {
                // Create playlist via API
                const res = await authFetch('/api/playlists', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name
                    })
                });

                const data = await res.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // If we have a track to add, add it now
                if (currentPlaylistModalTrackId) {
                    const addRes = await authFetch(`/api/playlists/${data.id}/tracks`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            generation_id: currentPlaylistModalTrackId
                        })
                    });

                    if (!addRes.ok) {
                        const addErr = await addRes.json().catch(() => ({}));
                        throw new Error(addErr.error || 'Failed to add track to playlist');
                    }

                    statusEl.className = 'playlist-modal-status success';
                    statusEl.textContent = `Created "${name}" and added track`;
                    showFeedbackToast(`Created "${name}" and added track`);
                } else {
                    statusEl.className = 'playlist-modal-status success';
                    statusEl.textContent = `Created playlist "${name}"`;
                    showFeedbackToast(`Created playlist "${name}"`);
                }

                // Refresh playlists tab if on it
                if (currentTab === 'playlists') {
                    loadPlaylists();
                }

                setTimeout(() => closePlaylistModal(), 1000);

            } catch (err) {
                console.error('Failed to create playlist:', err);
                statusEl.className = 'playlist-modal-status error';
                statusEl.textContent = 'Failed to create playlist';
                showErrorToast('Failed to create playlist');
            } finally {
                playlistModalSubmitting = false;
            }
        }

        let currentViewingPlaylistId = null;

        async function viewPlaylist(playlistId) {
            currentViewingPlaylistId = playlistId;

            try {
                const res = await authFetch(`/api/playlists/${playlistId}`);
                const playlist = await res.json();

                if (playlist.error) {
                    showErrorToast('Playlist not found');
                    return;
                }

                // Show playlist detail overlay
                document.getElementById('playlist-detail-name').textContent = playlist.name;
                document.getElementById('playlist-detail-count').textContent =
                    `${playlist.tracks?.length || 0} tracks`;

                // Calculate total duration
                const totalDuration = (playlist.tracks || []).reduce(
                    (sum, t) => sum + (t.duration || 0), 0
                );
                document.getElementById('playlist-detail-duration').textContent =
                    `${Math.ceil(totalDuration / 60)} min`;

                // Render tracks
                renderPlaylistTracks(playlist.tracks || []);

                // Show overlay
                document.getElementById('playlist-detail-overlay').classList.remove('hidden');

            } catch (err) {
                console.error('Failed to load playlist:', err);
                showErrorToast('Failed to load playlist');
            }
        }

        function renderPlaylistTracks(tracks) {
            const container = document.getElementById('playlist-tracks-list');

            if (!tracks || tracks.length === 0) {
                container.innerHTML = `
                    <div class="playlist-tracks-empty">
                        <svg class="icon icon-lg"><use href="#icon-music"/></svg>
                        <p>No tracks yet. Add some from the Library or Radio!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = tracks.map((track, index) => `
                <div class="playlist-track-item" data-id="${track.id}" data-index="${index}" draggable="true">
                    <span class="track-drag-handle">
                        <svg class="icon icon-sm"><use href="#icon-grip-vertical"/></svg>
                    </span>
                    <span class="track-number">${index + 1}</span>
                    <div class="track-info">
                        <span class="track-prompt">${escapeHtml(track.prompt || 'Untitled')}</span>
                        <span class="track-duration">${Number(track.duration || 30).toFixed(1)}s</span>
                    </div>
                    <div class="track-actions">
                        <button class="btn btn-icon btn-sm" onclick="playTrackFromPlaylist('${escapeJsString(track.id)}', ${index})" title="Play">
                            <svg class="icon"><use href="#icon-play"/></svg>
                        </button>
                        <button class="btn btn-icon btn-sm copy-id-btn" onclick="copyLibraryItemId('${escapeJsString(track.id)}')" title="Copy unique ID to clipboard" style="color:#3b82f6;">
                            <svg class="icon"><use href="#icon-copy"/></svg>
                        </button>
                        <button class="btn btn-icon btn-sm" onclick="removeFromPlaylist('${escapeJsString(track.id)}')" title="Remove">
                            <svg class="icon"><use href="#icon-trash"/></svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function closePlaylistDetail(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('playlist-detail-overlay').classList.add('hidden');
            currentViewingPlaylistId = null;
        }

        async function playPlaylist() {
            if (!currentViewingPlaylistId) return;

            // Use RadioWidgetCore to play the playlist
            if (window.radioWidgetInstance?.core) {
                try {
                    await window.radioWidgetInstance.core.loadStation('playlist', {
                        playlistId: currentViewingPlaylistId,
                        shuffle: false
                    });
                    showFeedbackToast('Playing playlist');
                    closePlaylistDetail();
                } catch (err) {
                    console.error('Failed to play playlist:', err);
                    showErrorToast('Failed to play playlist');
                }
            } else {
                showErrorToast('Player not ready');
            }
        }

        async function shufflePlayPlaylist() {
            if (!currentViewingPlaylistId) return;

            if (window.radioWidgetInstance?.core) {
                try {
                    await window.radioWidgetInstance.core.loadStation('playlist', {
                        playlistId: currentViewingPlaylistId,
                        shuffle: true
                    });
                    showFeedbackToast('Shuffle playing playlist');
                    closePlaylistDetail();
                } catch (err) {
                    console.error('Failed to shuffle play:', err);
                    showErrorToast('Failed to play playlist');
                }
            }
        }

        async function playTrackFromPlaylist(trackId, startIndex) {
            if (!currentViewingPlaylistId) return;

            try {
                // Fetch playlist tracks
                const res = await authFetch(`/api/playlists/${currentViewingPlaylistId}`);
                const playlist = await res.json();
                const tracks = playlist.tracks || [];

                if (tracks.length === 0) {
                    showErrorToast('Playlist is empty');
                    return;
                }

                // Reorder: put selected track first, rest follow
                const reorderedTracks = [
                    ...tracks.slice(startIndex),
                    ...tracks.slice(0, startIndex)
                ];

                if (window.radioWidgetInstance?.core) {
                    const core = window.radioWidgetInstance.core;
                    core.queue = reorderedTracks;
                    core._events.emit('queueUpdate', core.queue);
                    core.next();
                    showFeedbackToast('Playing from playlist');
                    closePlaylistDetail();
                }
            } catch (err) {
                console.error('Failed to play track:', err);
                showErrorToast('Failed to play track');
            }
        }

        async function removeFromPlaylist(trackId) {
            if (!currentViewingPlaylistId || !isUserAuthenticated()) return;

            try {
                const res = await authFetch(
                    `/api/playlists/${currentViewingPlaylistId}/tracks/${trackId}`,
                    {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    }
                );

                const data = await res.json();

                if (data.success) {
                    showFeedbackToast('Track removed');
                    // Refresh the playlist view
                    viewPlaylist(currentViewingPlaylistId);
                    // Also refresh the main playlists grid
                    loadPlaylists();
                } else {
                    showErrorToast(data.error || 'Failed to remove track');
                }
            } catch (err) {
                console.error('Failed to remove track:', err);
                showErrorToast('Failed to remove track');
            }
        }

        // Playlist Options Modal Functions
        function showPlaylistOptionsModal() {
            if (!currentViewingPlaylistId) return;

            const playlist = userPlaylists.find(p => p.id === currentViewingPlaylistId);
            if (!playlist) return;

            document.getElementById('playlist-options-name').value = playlist.name;
            document.getElementById('playlist-options-overlay').classList.remove('hidden');
        }

        function closePlaylistOptions(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('playlist-options-overlay').classList.add('hidden');
        }

        async function renamePlaylist() {
            if (!currentViewingPlaylistId || !isUserAuthenticated()) return;

            const newName = document.getElementById('playlist-options-name').value.trim();
            if (!newName) {
                showErrorToast('Name is required');
                return;
            }

            try {
                const res = await authFetch(`/api/playlists/${currentViewingPlaylistId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: newName
                    })
                });

                const data = await res.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                showFeedbackToast('Playlist renamed');
                document.getElementById('playlist-detail-name').textContent = newName;
                closePlaylistOptions();
                loadPlaylists();

            } catch (err) {
                console.error('Failed to rename:', err);
                showErrorToast('Failed to rename playlist');
            }
        }

        async function deletePlaylist() {
            if (!currentViewingPlaylistId || !isUserAuthenticated()) return;

            if (!confirm('Delete this playlist? This cannot be undone.')) return;

            try {
                const res = await authFetch(`/api/playlists/${currentViewingPlaylistId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await res.json();

                if (data.success) {
                    showFeedbackToast('Playlist deleted');
                    closePlaylistDetail();
                    closePlaylistOptions();
                    loadPlaylists();
                } else {
                    showErrorToast(data.error || 'Failed to delete');
                }
            } catch (err) {
                console.error('Failed to delete:', err);
                showErrorToast('Failed to delete playlist');
            }
        }

        // Drag and Drop for Playlist Reordering
        let playlistDragDropInitialized = false;  // Prevent duplicate listeners

        function initPlaylistDragDrop() {
            const container = document.getElementById('playlist-tracks-list');
            if (!container) return;

            // Prevent adding duplicate listeners
            if (container.dataset.dragInitialized === 'true') return;
            container.dataset.dragInitialized = 'true';

            let draggedElement = null;

            container.addEventListener('dragstart', (e) => {
                const item = e.target.closest('.playlist-track-item');
                if (!item) return;

                draggedElement = item;
                item.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (!draggedElement) return;

                const afterElement = getDragAfterElement(container, e.clientY);
                if (afterElement) {
                    container.insertBefore(draggedElement, afterElement);
                } else {
                    container.appendChild(draggedElement);
                }
            });

            container.addEventListener('dragend', async (e) => {
                if (!draggedElement) return;

                draggedElement.classList.remove('dragging');

                // Get new order
                const items = container.querySelectorAll('.playlist-track-item');
                const newOrder = Array.from(items).map(item => item.dataset.id);

                // Save to API
                await savePlaylistOrder(newOrder);
                draggedElement = null;
            });
        }

        function getDragAfterElement(container, y) {
            const elements = [...container.querySelectorAll('.playlist-track-item:not(.dragging)')];

            return elements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset, element: child };
                }
                return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        async function savePlaylistOrder(trackOrder) {
            if (!currentViewingPlaylistId || !isUserAuthenticated()) return;

            try {
                const response = await authFetch(`/api/playlists/${currentViewingPlaylistId}/reorder`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        track_order: trackOrder
                    })
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error || 'Failed to save order');
                }
            } catch (err) {
                console.error('Failed to save playlist order:', err);
                showErrorToast('Failed to save playlist order');
            }
        }

        // Initialize drag-drop when playlist detail opens
        const originalViewPlaylist = viewPlaylist;
        viewPlaylist = async function(playlistId) {
            await originalViewPlaylist(playlistId);
            initPlaylistDragDrop();
        };

        function playFavorite(trackId) {
            // Add to queue and play
            addToRadioQueue(trackId);
        }

        // ========================================
        // API TAB
        // ========================================
        async function copyApiCode(elementId) {
            const codeEl = document.getElementById(elementId);
            if (!codeEl) return;

            // Get the code text (strip HTML tags for clean copy)
            let text = codeEl.textContent || codeEl.innerText;
            text = text.trim();

            try {
                await navigator.clipboard.writeText(text);
                showFeedbackToast('Copied to clipboard!');
            } catch (err) {
                console.error('Failed to copy:', err);
                showErrorToast('Failed to copy');
            }
        }

        // Mini-player management
        function updateMiniPlayer() {
            const miniPlayer = document.getElementById('mini-player');
            if (!miniPlayer) return; // Element not in DOM yet

            const miniTrack = document.getElementById('mini-player-track');
            const miniPlayBtn = document.getElementById('mini-player-play');
            const miniEq = miniPlayer.querySelector('.mini-eq');
            const miniProgress = document.getElementById('mini-progress-bar');
            const miniDuration = document.getElementById('mini-duration');
            const miniQueueCount = document.getElementById('mini-queue-count');
            const isPlaying = radioPlayer && !radioPlayer.paused && radioPlayer.src;
            const showMini = currentTab !== 'radio' && currentRadioTrack;

            if (showMini) {
                miniPlayer.classList.remove('hidden');
                if (currentRadioTrack && miniTrack) {
                    miniTrack.textContent = currentRadioTrack.prompt || 'Now Playing';
                }
                // Update play/pause button icon
                if (miniPlayBtn) {
                    const icon = miniPlayBtn.querySelector('use');
                    if (icon) {
                        icon.setAttribute('href', isPlaying ? '#icon-pause' : '#icon-play');
                    }
                }
                // Update EQ animation
                if (miniEq) {
                    miniEq.classList.toggle('paused', !isPlaying);
                }
                // Update queue count
                if (miniQueueCount) {
                    miniQueueCount.textContent = `${radioQueue.length} in queue`;
                }
            } else {
                miniPlayer.classList.add('hidden');
            }
        }

        // Toggle mini player expanded state
        function toggleMiniPlayerExpanded() {
            const miniPlayer = document.getElementById('mini-player');
            if (miniPlayer) {
                miniPlayer.classList.toggle('expanded');
            }
        }

        // Update mini player progress bar
        function updateMiniPlayerProgress() {
            const miniProgress = document.getElementById('mini-progress-bar');
            const miniDuration = document.getElementById('mini-duration');
            if (radioPlayer && radioPlayer.duration && miniProgress) {
                const percent = (radioPlayer.currentTime / radioPlayer.duration) * 100;
                miniProgress.style.width = percent + '%';
            }
            if (miniDuration && radioPlayer) {
                const current = Math.floor(radioPlayer.currentTime);
                const mins = Math.floor(current / 60);
                const secs = current % 60;
                miniDuration.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }

        function toggleRadioPlayPause() {
            if (!radioPlayer) return;
            if (radioPlayer.paused) {
                radioPlayer.play().catch(e => console.warn('Play interrupted:', e.message));
            } else {
                radioPlayer.pause();
            }
            updateMiniPlayer();
        }

        // Restore saved tab on load
        (function() {
            const savedTab = localStorage.getItem('soundbox_tab');
            if (savedTab && ['radio', 'library', 'generate'].includes(savedTab)) {
                // Use setTimeout to ensure DOM is ready
                setTimeout(() => switchTab(savedTab), 0);
            }
        })();
        let currentJobId = null;
        let modelsReady = false;

        // Separate prompts for each model
        let modelPrompts = {
            music: '',
            audio: ''
        };

        // User ID - use Graphlings login OR generate anonymous device ID
        // In open access mode, everyone gets a device-based identity automatically
        var OPEN_ACCESS_MODE = {{ 'true' if open_access_mode else 'false' }};  // var for cross-script-block access
        let currentUserId = null;
        let isAdultAccount = OPEN_ACCESS_MODE;  // In open access, treat as adult (no content restrictions on UI)

        // Generate anonymous device ID for voting without login
        function getDeviceId() {
            let deviceId = localStorage.getItem('soundbox_device_id');
            if (!deviceId) {
                deviceId = 'anon_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
                localStorage.setItem('soundbox_device_id', deviceId);
            }
            return deviceId;
        }

        // In open access mode, set currentUserId immediately from device ID
        if (OPEN_ACCESS_MODE) {
            currentUserId = getDeviceId();
        }

        // Get effective user ID (logged in user OR device ID)
        function getEffectiveUserId() {
            return currentUserId || getDeviceId();
        }

        // Get auth token from Graphlings SDK (returns null in open access mode)
        function getAuthToken() {
            if (OPEN_ACCESS_MODE) return null;  // No tokens needed
            // Try multiple sources for the token
            // 1. Check if SDK has a getToken method
            if (window.graphlings && typeof window.graphlings.getToken === 'function') {
                const sdkToken = window.graphlings.getToken();
                if (sdkToken) return sdkToken;
            }
            // 2. Check SDK's token property
            if (window.graphlings && window.graphlings.token) {
                return window.graphlings.token;
            }
            // 3. Try localStorage with app-specific key
            const stored = localStorage.getItem('graphlings_sfx-music_token');
            if (stored) return stored;
            // 4. Try generic graphlings token key
            const generic = localStorage.getItem('graphlings_token');
            if (generic) return generic;
            // 5. Search localStorage for any graphlings-related token
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.toLowerCase().includes('token')) {
                    const value = localStorage.getItem(key);
                    // JWT tokens start with 'eyJ'
                    if (value && value.startsWith('eyJ')) {
                        return value;
                    }
                }
            }
            return null;
        }

        // Make authenticated API request
        async function authFetch(url, options = {}) {
            options.headers = options.headers || {};

            const token = getAuthToken();
            if (token) {
                // Preferred: Use verified token
                options.headers['Authorization'] = `Bearer ${token}`;
            } else if (currentUserId) {
                // Fallback: Send user ID header (backend creates anonymous user from IP in open access mode)
                options.headers['X-User-ID'] = currentUserId;
            }
            return fetch(url, options);
        }

        // Check if user is authenticated with Graphlings (or always true in open access)
        function isAuthenticated() {
            if (OPEN_ACCESS_MODE) return true;
            return !!getAuthToken() && !!currentUserId;
        }

        const gpuName = document.getElementById('gpu-name');
        const gpuBarFill = document.getElementById('gpu-bar-fill');
        const gpuMem = document.getElementById('gpu-mem');
        const gpuBusy = document.getElementById('gpu-busy');

        const queueCountEl = document.getElementById('queue-explorer-badge');
        const estimatedWaitEl = document.getElementById('estimated-wait');

        async function checkStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                modelStatus = data.models;

                // Update model status dots
                musicStatusDot.className = 'status-dot ' + (modelStatus.music.startsWith?.('error') ? 'error' : modelStatus.music);
                audioStatusDot.className = 'status-dot ' + (modelStatus.audio.startsWith?.('error') ? 'error' : modelStatus.audio);
                if (ttsStatusDot) {
                    const ttsStatus = modelStatus.tts || 'ready';
                    ttsStatusDot.className = 'status-dot ' + (ttsStatus.startsWith?.('error') ? 'error' : ttsStatus);
                }

                // Update GPU status
                if (data.gpu && data.gpu.available) {
                    gpuName.textContent = data.gpu.name?.replace('NVIDIA GeForce ', '') || 'GPU';
                    gpuBarFill.style.width = data.gpu.memory_percent + '%';
                    gpuMem.textContent = data.gpu.memory_percent + '%';
                    gpuBusy.textContent = data.gpu.busy ? 'BUSY' : 'IDLE';
                    gpuBusy.className = 'gpu-busy ' + (data.gpu.busy ? 'busy' : 'idle');
                }

                // Check if all ready
                const ttsReady = (modelStatus.tts || 'ready') === 'ready';
                const allReady = modelStatus.music === 'ready' && modelStatus.audio === 'ready' && ttsReady;
                if (allReady && !modelsReady) {
                    modelsReady = true;
                    loadingBanner.classList.add('ready');
                    loadingBanner.querySelector('.title').textContent = 'Models Ready!';
                    setTimeout(() => {
                        loadingBanner.style.display = 'none';
                    }, 2000);
                }

                // Update queue status
                queueCountEl.textContent = data.queue_length;
                queueCountEl.classList.toggle('empty', data.queue_length === 0);
                if (data.queue_length > 0) {
                    const waitSeconds = data.estimated_wait || 0;
                    if (waitSeconds > 60) {
                        estimatedWaitEl.textContent = `~${Math.ceil(waitSeconds / 60)} min wait`;
                    } else if (waitSeconds > 0) {
                        estimatedWaitEl.textContent = `~${Math.ceil(waitSeconds)}s wait`;
                    } else {
                        estimatedWaitEl.textContent = 'Processing...';
                    }
                } else {
                    estimatedWaitEl.textContent = 'Ready';
                }

                updateGenerateButton();
            } catch (err) {
                console.error('Status check failed:', err);
            }

            // Keep polling - but slow down when tab is hidden to save resources
            const pollInterval = document.hidden ? 10000 : 2000;  // 10s when hidden, 2s when visible
            setTimeout(checkStatus, pollInterval);
        }

        function updateGenerateButton() {
            if (currentJobId) {
                generateBtn.disabled = true;
                return;
            }
            const ready = modelStatus[currentModel] === 'ready';
            generateBtn.disabled = !ready;
            if (!ready && modelStatus[currentModel] === 'loading') {
                generateBtn.textContent = 'Loading Model...';
            } else {
                generateBtn.textContent = 'Generate';
            }
        }

        durationEl.addEventListener('input', () => {
            durationDisplay.textContent = durationEl.value;
        });

        function selectModel(model) {
            // Save current prompt before switching
            modelPrompts[currentModel] = promptEl.value;

            currentModel = model;
            document.querySelectorAll('.model-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.model === model);
            });

            const voiceSelector = document.getElementById('voice-selector');
            const voiceExamples = document.getElementById('voice-examples');
            const durationControl = document.querySelector('.duration-control');
            const loopControl = document.getElementById('loop-control');

            if (model === 'music') {
                musicExamples.style.display = 'block';
                audioExamples.style.display = 'none';
                voiceExamples.style.display = 'none';
                voiceSelector.style.display = 'none';
                durationControl.style.display = 'flex';
                loopControl.style.display = 'flex';
                promptEl.placeholder = 'e.g., upbeat electronic dance music with heavy bass and synth leads';
            } else if (model === 'audio') {
                musicExamples.style.display = 'none';
                audioExamples.style.display = 'block';
                voiceExamples.style.display = 'none';
                voiceSelector.style.display = 'none';
                durationControl.style.display = 'flex';
                loopControl.style.display = 'flex';
                promptEl.placeholder = 'e.g., dog barking loudly, thunder in the background';
            } else if (model === 'voice') {
                musicExamples.style.display = 'none';
                audioExamples.style.display = 'none';
                voiceExamples.style.display = 'block';
                voiceSelector.style.display = 'block';
                durationControl.style.display = 'none';
                loopControl.style.display = 'none';
                promptEl.placeholder = 'Type the text you want the voice to say...';
                loadVoices();
            }

            // Restore saved prompt for this model
            promptEl.value = modelPrompts[model] || '';

            updateGenerateButton();

        }

        // Voice/TTS handling
        let availableVoices = [];
        let selectedVoice = 'en_US-lessac-medium';
        let voicesLoaded = false;
        let favoriteVoices = [];
        try {
            favoriteVoices = JSON.parse(localStorage.getItem('favoriteVoices') || '[]');
        } catch (e) {
            console.warn('Failed to parse favoriteVoices from localStorage:', e);
            favoriteVoices = [];
        }
        let currentVoiceFilter = 'all';
        let voiceSearchQuery = '';

        async function loadVoices() {
            if (voicesLoaded) return;

            try {
                const resp = await fetch('/api/voices');
                const data = await resp.json();
                availableVoices = data.voices || [];
                voicesLoaded = true;
                renderVoiceList();
            } catch (err) {
                console.error('Failed to load voices:', err);
            }
        }

        function filterVoices() {
            voiceSearchQuery = document.getElementById('voice-search').value.toLowerCase();
            renderVoiceList();
        }

        function setVoiceFilter(filter) {
            currentVoiceFilter = filter;
            document.querySelectorAll('.voice-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            renderVoiceList();
        }

        function getFilteredVoices() {
            return availableVoices.filter(voice => {
                // Search filter
                if (voiceSearchQuery) {
                    const searchIn = `${voice.name} ${voice.locale} ${voice.quality}`.toLowerCase();
                    if (!searchIn.includes(voiceSearchQuery)) return false;
                }
                // Category filter
                if (currentVoiceFilter === 'favorites') {
                    return favoriteVoices.includes(voice.id);
                } else if (currentVoiceFilter !== 'all') {
                    return voice.locale.startsWith(currentVoiceFilter);
                }
                return true;
            });
        }

        function renderVoiceList() {
            const list = document.getElementById('voice-list');
            list.innerHTML = '';

            let filtered = getFilteredVoices();

            if (filtered.length === 0) {
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No voices found</div>';
                return;
            }

            // Sort favorites first, then alphabetically by name
            filtered = filtered.sort((a, b) => {
                const aFav = favoriteVoices.includes(a.id);
                const bFav = favoriteVoices.includes(b.id);
                if (aFav && !bFav) return -1;
                if (!aFav && bFav) return 1;
                return a.name.localeCompare(b.name);
            });

            filtered.forEach(voice => {
                const row = document.createElement('div');
                row.className = 'voice-row' + (voice.id === selectedVoice ? ' selected' : '');
                row.onclick = (e) => {
                    if (!e.target.closest('.voice-fav') && !e.target.closest('.voice-play-btn')) {
                        selectVoice(voice.id);
                    }
                };

                const isFav = favoriteVoices.includes(voice.id);
                const localeParts = (voice.locale || 'en_US').split('_');
                const flag = localeParts[1] === 'US' ? '' : localeParts[1] === 'GB' ? '' : '';

                // Escape all user-provided data to prevent XSS
                const safeId = escapeHtml(voice.id);  // For HTML attributes
                const safeJsId = escapeJsString(voice.id);  // For onclick handlers
                const safeName = escapeHtml(voice.name || 'Unknown');
                const safeQuality = escapeHtml(voice.quality || 'medium');
                const safeLocale = escapeHtml(localeParts[1] || voice.locale || 'US');

                // License badge with attribution link
                const isCommercial = voice.commercial_ok !== false;
                const licenseShort = escapeHtml(voice.license_short || 'MIT');
                const licenseUrl = voice.license_url || '';
                const attributionUrl = voice.attribution_url || '';
                const attribution = voice.attribution || '';
                const licenseClass = isCommercial ? 'license-ok' : 'license-nc';
                const licenseTitle = isCommercial
                    ? `${voice.license || 'MIT'} - Commercial use OK`
                    : `${voice.license || 'Non-Commercial'} - Research/non-commercial only`;

                // License badge links to license, attribution link is separate
                let licenseBadgeHtml = licenseUrl
                    ? `<a href="${escapeHtml(licenseUrl)}" target="_blank" rel="noopener" title="${escapeHtml(licenseTitle)}">${licenseShort}</a>`
                    : `<span title="${escapeHtml(licenseTitle)}">${licenseShort}</span>`;

                // Add attribution link if available
                const attributionLink = attributionUrl
                    ? `<a href="${escapeHtml(attributionUrl)}" target="_blank" rel="noopener" class="voice-attribution" title="Attribution: ${escapeHtml(attribution)}"></a>`
                    : '';

                row.innerHTML = `
                    <div class="voice-fav ${isFav ? 'is-fav' : ''}" onclick="toggleFavorite('${safeJsId}')">
                        <svg class="icon" width="16" height="16"><use href="#icon-star${isFav ? '' : '-outline'}"/></svg>
                    </div>
                    <div class="voice-info" onclick="selectVoice('${safeJsId}')">
                        <span class="voice-name">${safeName}</span>
                        <span class="voice-meta">${flag} ${safeLocale}</span>
                        <span class="voice-quality">${safeQuality}</span>
                        <span class="voice-license ${licenseClass}">${licenseBadgeHtml}${attributionLink}</span>
                    </div>
                    <div class="voice-actions">
                        <button class="voice-play-btn" id="play-${safeId}" onclick="playSample('${safeJsId}')">
                            <svg class="icon" width="12" height="12"><use href="#icon-play"/></svg>
                        </button>
                    </div>
                `;
                list.appendChild(row);
            });
        }

        function selectVoice(voiceId) {
            selectedVoice = voiceId;
            renderVoiceList();
        }

        function toggleFavorite(voiceId) {
            const idx = favoriteVoices.indexOf(voiceId);
            if (idx >= 0) {
                favoriteVoices.splice(idx, 1);
            } else {
                favoriteVoices.push(voiceId);
            }
            localStorage.setItem('favoriteVoices', JSON.stringify(favoriteVoices));
            renderVoiceList();
        }

        let sampleAudio = null;
        let playingVoiceId = null;

        function playSample(voiceId) {
            // Stop current playback
            if (sampleAudio) {
                sampleAudio.pause();
                if (playingVoiceId) {
                    const oldBtn = document.getElementById(`play-${playingVoiceId}`);
                    if (oldBtn) oldBtn.classList.remove('playing');
                }
            }

            // If clicking same voice, just stop
            if (playingVoiceId === voiceId) {
                playingVoiceId = null;
                return;
            }

            // Play new sample
            const btn = document.getElementById(`play-${voiceId}`);
            if (btn) btn.classList.add('playing');
            playingVoiceId = voiceId;

            sampleAudio = new Audio(`/api/tts/sample/${voiceId}`);
            sampleAudio.onended = () => {
                if (btn) btn.classList.remove('playing');
                playingVoiceId = null;
            };
            sampleAudio.play().catch(e => {
                console.error('Sample playback failed:', e);
                if (btn) btn.classList.remove('playing');
                playingVoiceId = null;
            });
        }

        async function generateTTS() {
            const text = promptEl.value.trim();
            if (!text) {
                showToast('Please enter text to speak', 'warning');
                return;
            }

            const statusEl = document.getElementById('status');
            const generateBtn = document.getElementById('generate-btn');

            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span>Generating...</span>';
            statusEl.innerHTML = '<div class="status-message">Generating speech...</div>';
            statusEl.style.display = 'block';

            try {
                const resp = await fetch('/api/tts/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        voice: selectedVoice
                        // Note: save_to_library=false by default (local-only, not saved to server)
                    })
                });

                const data = await resp.json();

                if (data.success) {
                    statusEl.innerHTML = '<div class="status-success">Speech generated!</div>';
                    const audioEl = document.getElementById('audio');

                    // Handle base64 audio (local-only mode) vs saved file
                    if (data.audio_base64) {
                        // Local-only: play from base64 data URL (not saved to server)
                        audioEl.src = `data:audio/wav;base64,${data.audio_base64}`;
                    } else if (data.filename) {
                        // Saved to library: play from server
                        audioEl.src = `/generated/${encodeURIComponent(data.filename)}`;
                    }

                    audioEl.play().catch(e => console.warn('TTS play failed:', e.message));
                    document.getElementById('player').style.display = 'block';
                    showToast('Speech generated!', 'success');
                } else {
                    statusEl.innerHTML = `<div class="status-error">Error: ${escapeHtml(data.error || 'Unknown error')}</div>`;
                    showToast('TTS generation failed', 'error');
                }
            } catch (err) {
                statusEl.innerHTML = '<div class="status-error">Generation failed</div>';
                showToast('TTS generation failed', 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<span>Generate</span>';
            }
        }

        function setPrompt(text) {
            promptEl.value = text;
            promptEl.focus();
        }

        function toggleLoop() {
            const loopControl = document.getElementById('loop-control');
            const checkbox = document.getElementById('loop-checkbox');
            checkbox.checked = !checkbox.checked;
            loopControl.classList.toggle('active', checkbox.checked);
        }

        async function randomPrompt() {
            const randomBtn = document.getElementById('random-btn');
            randomBtn.style.opacity = '0.5';
            randomBtn.style.pointerEvents = 'none';

            try {
                const response = await fetch('/random-prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: currentModel })
                });
                const data = await response.json();

                if (data.success && data.prompt) {
                    promptEl.value = data.prompt;
                    promptEl.focus();
                } else {
                    console.error('Random prompt failed:', data.error);
                }
            } catch (err) {
                console.error('Random prompt error:', err);
            } finally {
                randomBtn.style.opacity = '1';
                randomBtn.style.pointerEvents = 'auto';
            }
        }

        async function generate() {
            // Handle voice model separately
            if (currentModel === 'voice') {
                generateTTS();
                return;
            }

            // Require authentication to generate (skipped in open access mode)
            if (!isUserAuthenticated()) {
                showLoginPrompt('generate audio');
                return;
            }

            const prompt = promptEl.value.trim();
            if (!prompt) {
                statusEl.className = 'status error';
                statusEl.textContent = 'Please enter a description';
                return;
            }

            generateBtn.disabled = true;
            statusEl.className = 'status loading';
            statusEl.innerHTML = `<span class="spinner"></span>Submitting to queue...`;
            playerEl.classList.remove('show');

            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        duration: parseInt(durationEl.value),
                        model: currentModel,
                        loop: document.getElementById('loop-checkbox').checked,
                        priority: 'standard',
                        user_id: currentUserId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    currentJobId = data.job_id;
                    statusEl.innerHTML = `
                        <div class="job-progress">
                            <div class="position">Position in queue: ${data.position}</div>
                            <div class="progress-text"><span class="spinner"></span>Waiting...</div>
                        </div>
                    `;
                    pollJobStatus();
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = 'Error: ' + data.error;
                    generateBtn.disabled = false;
                }
            } catch (err) {
                statusEl.className = 'status error';
                statusEl.textContent = 'Error: ' + err.message;
                generateBtn.disabled = false;
            }
        }

        let pollTimeoutId = null;  // Track poll timeout to prevent duplicates

        async function pollJobStatus() {
            // Clear any pending poll to prevent duplicates
            if (pollTimeoutId) {
                clearTimeout(pollTimeoutId);
                pollTimeoutId = null;
            }

            if (!currentJobId) return;

            try {
                const response = await fetch(`/job/${currentJobId}`);
                const job = await response.json();

                if (job.status === 'completed') {
                    statusEl.style.display = 'none';
                    audioEl.src = `/audio/${encodeURIComponent(job.filename)}`;

                    // Show quality badge
                    if (job.quality) {
                        const score = job.quality.score;
                        qualityBadge.textContent = `${score}%`;
                        qualityBadge.className = 'quality-badge ' +
                            (score >= 80 ? 'good' : score >= 60 ? 'medium' : 'bad');
                    } else {
                        qualityBadge.textContent = '';
                    }

                    // Show spectrogram (escape filename to prevent XSS)
                    if (job.spectrogram) {
                        playerSpectrogram.innerHTML = `<img src="/spectrogram/${escapeHtml(job.spectrogram)}" alt="Spectrogram">`;
                    }

                    playerEl.classList.add('show');
                    loadLibrary();  // Refresh library with new generation
                    currentJobId = null;
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'Generate';
                } else if (job.status === 'failed') {
                    statusEl.className = 'status error';
                    statusEl.textContent = 'Error: ' + (job.error || 'Generation failed');
                    currentJobId = null;
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'Generate';
                } else {
                    // Still processing
                    const posText = job.position > 1 ? `Position in queue: ${job.position}` : '';
                    const pct = job.progress_pct || 0;
                    const showBar = job.status === 'processing' && pct > 0;
                    statusEl.innerHTML = `
                        <div class="job-progress">
                            ${posText ? `<div class="position">${posText}</div>` : ''}
                            ${showBar ? `
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill" style="width: ${pct}%"></div>
                                </div>
                            ` : ''}
                            <div class="progress-text">${!showBar ? '<span class="spinner"></span>' : ''}${job.progress || 'Processing...'}</div>
                        </div>
                    `;
                    pollTimeoutId = setTimeout(pollJobStatus, 300);
                }
            } catch (err) {
                console.error('Job poll failed:', err);
                pollTimeoutId = setTimeout(pollJobStatus, 1000);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Escape string for safe use in JavaScript string literals (e.g., onclick handlers)
        function escapeJsString(str) {
            if (typeof str !== 'string') return '';
            return str
                .replace(/\\/g, '\\\\')     // Backslash first
                .replace(/'/g, "\\'")        // Single quotes
                .replace(/"/g, '\\"')        // Double quotes
                .replace(/\n/g, '\\n')       // Newlines
                .replace(/\r/g, '\\r')       // Carriage returns
                .replace(/\t/g, '\\t')       // Tabs
                .replace(/</g, '\\x3c')      // Prevent script tag injection
                .replace(/>/g, '\\x3e');     // Prevent HTML context breakout
        }

        function showFeedbackToast(message, type = 'success') {
            // type can be: 'success', 'error', 'warning'
            // Remove existing toast if any
            const existingToast = document.querySelector('.feedback-toast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.className = 'feedback-toast' + (type !== 'success' ? ' ' + type : '');
            const isError = (type === 'error');

            if (isError) {
                // Error toast with copy button
                const content = document.createElement('div');
                content.className = 'toast-content';

                const msgDiv = document.createElement('div');
                msgDiv.className = 'toast-message';
                msgDiv.textContent = message;
                content.appendChild(msgDiv);

                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.textContent = 'Copy Error';
                copyBtn.type = 'button';
                copyBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    // Try modern clipboard API first
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(message).then(() => {
                            copyBtn.textContent = 'Copied!';
                            copyBtn.style.background = 'rgba(40, 167, 69, 0.6)';
                        }).catch(() => {
                            fallbackCopy();
                        });
                    } else {
                        fallbackCopy();
                    }

                    function fallbackCopy() {
                        const textArea = document.createElement('textarea');
                        textArea.value = message;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-9999px';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        try {
                            const success = document.execCommand('copy');
                            if (success) {
                                copyBtn.textContent = 'Copied!';
                                copyBtn.style.background = 'rgba(40, 167, 69, 0.6)';
                            } else {
                                copyBtn.textContent = 'Failed';
                            }
                        } catch (err) {
                            copyBtn.textContent = 'Failed';
                        }
                        document.body.removeChild(textArea);
                    }

                    // Reset button after delay
                    setTimeout(() => {
                        copyBtn.textContent = 'Copy Error';
                        copyBtn.style.background = '';
                    }, 2500);
                });
                content.appendChild(copyBtn);
                toast.appendChild(content);

                // Log error to backend
                logErrorToBackend(message);
            } else {
                toast.textContent = message;
            }

            document.body.appendChild(toast);

            // Trigger animation
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            // Remove after delay (longer for errors)
            const delay = isError ? 10000 : 2500;
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, delay);
        }

        async function logErrorToBackend(message) {
            try {
                await fetch('/api/log-error', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        url: window.location.href,
                        userAgent: navigator.userAgent,
                        timestamp: new Date().toISOString()
                    })
                });
            } catch (e) {
                console.error('Failed to log error to backend:', e);
            }
        }

        function showErrorToast(message) {
            showFeedbackToast(message, 'error');
        }

        function showWarningToast(message) {
            showFeedbackToast(message, 'warning');
        }

        // ========================================
        // RADIO STATION
        // ========================================
        let radioQueue = [];
        let currentRadioTrack = null;
        let currentPlayingLibraryItemId = null;  // Track which library item is currently playing
        let playHistory = [];  // Track IDs that have been played (to avoid repeats)
        let recentlyPlayed = [];  // Full track objects for "previous" functionality
        const MAX_HISTORY = 50;  // Keep last 50 played tracks
        const MIN_QUEUE_SIZE = 3;  // Auto-fetch when queue drops below this
        let isFetchingMore = false;  // Prevent duplicate fetches
        const radioPlayer = document.getElementById('radio-player');
        const nowPlayingEl = document.getElementById('now-playing');
        const radioQueueEl = document.getElementById('radio-queue');
        const queueItemsEl = document.getElementById('queue-items');

        // Update radio control button states based on whether a track is loaded
        function updateRadioControlsState() {
            const hasTrack = !!currentRadioTrack;

            // These controls require a track to be loaded
            const trackRequiredControls = [
                'radio-prev-btn',
                'radio-skip-btn',
                'radio-fullscreen-btn'
            ];
            trackRequiredControls.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = !hasTrack;
            });

            // These controls require a track AND show login prompt if not authenticated
            // They should be enabled when a track is loaded (login check happens on click)
            const authControls = [
                'radio-favorite-btn',
                'radio-tag-btn',
                'radio-download-btn',
                'radio-vote-up',
                'radio-vote-down'
            ];
            authControls.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = !hasTrack;
            });
        }

        // Auto-play next track when current ends
        radioPlayer.addEventListener('ended', () => {
            playNextTrack();
        });

        // Update progress bars on time update
        radioPlayer.addEventListener('timeupdate', () => {
            if (typeof updateMiniPlayerProgress === 'function') updateMiniPlayerProgress();
            if (typeof updateLibraryItemProgress === 'function') updateLibraryItemProgress();
        });

        async function shuffleRadio() {
            const model = document.getElementById('radio-model').value;
            const keywords = document.getElementById('radio-keywords').value.trim();

            // Save radio preferences
            localStorage.setItem('soundbox_radio_model', model);
            const shuffleBtn = document.getElementById('shuffle-btn');

            shuffleBtn.disabled = true;
            shuffleBtn.textContent = 'Loading...';

            // Clear history when starting fresh shuffle
            playHistory = [];

            try {
                const params = new URLSearchParams({ model, count: 10 });
                if (keywords) params.set('search', keywords);

                const response = await fetch('/api/radio/shuffle?' + params.toString());
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                if (data.tracks && data.tracks.length > 0) {
                    radioQueue = data.tracks;
                    playNextTrack();
                    updateRadioQueue();
                } else {
                    const radioKeywords = document.getElementById('radio-keywords')?.value;
                    if (radioKeywords) {
                        showWarningToast('No tracks found for "' + radioKeywords + '" (try different keywords)');
                    } else {
                        showWarningToast('No tracks found. Generate some music first!');
                    }
                }
            } catch (err) {
                console.error('Radio shuffle failed:', err);
                showErrorToast('Failed to load tracks: ' + err.message);
            } finally {
                shuffleBtn.disabled = false;
                shuffleBtn.innerHTML = '<svg class="icon icon-sm" style="vertical-align: -2px; margin-right: 4px;"><use href="#icon-shuffle"/></svg>Shuffle Play';
            }
        }

        function playNextTrack() {
            // Use loop instead of recursion to avoid stack overflow with many invalid tracks
            let skippedCount = 0;
            const maxSkips = 50;  // Safety limit

            while (true) {
                if (radioQueue.length === 0) {
                    nowPlayingEl.classList.add('hidden');
                    radioQueueEl.classList.add('hidden');
                    currentRadioTrack = null;
                    updateRadioControlsState();
                    return;
                }

                // Save current track to recently played (for "previous" button)
                if (currentRadioTrack) {
                    recentlyPlayed.push(currentRadioTrack);
                    // Keep only last 20 for previous functionality
                    if (recentlyPlayed.length > 20) {
                        recentlyPlayed = recentlyPlayed.slice(-20);
                    }
                }

                currentRadioTrack = radioQueue.shift();

                // Skip tracks with missing data (defensive null check)
                if (!currentRadioTrack || !currentRadioTrack.filename || !currentRadioTrack.prompt) {
                    console.warn('Skipping invalid track:', currentRadioTrack);
                    skippedCount++;
                    if (skippedCount >= maxSkips) {
                        console.error('Too many invalid tracks, stopping playback');
                        showErrorToast('Queue contains too many invalid tracks');
                        currentRadioTrack = null;
                        updateRadioControlsState();
                        return;
                    }
                    continue;  // Loop instead of recursive call
                }

                break;  // Valid track found, exit loop
            }

            // Add to play history (avoid repeats when fetching more)
            if (currentRadioTrack.id && !playHistory.includes(currentRadioTrack.id)) {
                playHistory.push(currentRadioTrack.id);
                // Trim history if too long
                if (playHistory.length > MAX_HISTORY) {
                    playHistory = playHistory.slice(-MAX_HISTORY);
                }
            }

            nowPlayingEl.classList.remove('hidden');

            // Hide the "click to start" overlay
            const startOverlay = document.getElementById('audio-start-overlay');
            if (startOverlay) startOverlay.classList.add('hidden');

            // Update now playing display
            document.getElementById('radio-prompt').textContent = currentRadioTrack.prompt;
            document.getElementById('radio-duration').textContent = Number(currentRadioTrack.duration).toFixed(1) + 's';
            document.getElementById('radio-upvotes').textContent = currentRadioTrack.upvotes || 0;
            document.getElementById('radio-downvotes').textContent = currentRadioTrack.downvotes || 0;
            updateRadioVoiceInfo(currentRadioTrack);

            // Reset vote button states
            document.getElementById('radio-vote-up').classList.remove('voted-up');
            document.getElementById('radio-vote-down').classList.remove('voted-down');

            // Load user's vote and favorite status for this track
            loadRadioTrackVote();
            checkRadioTrackFavorite();

            // Enable radio controls now that we have a track
            updateRadioControlsState();

            // Spectrogram element removed in redesign - EQ visualizer used instead
            const specImg = document.getElementById('radio-spectrogram');
            if (specImg) {
                if (currentRadioTrack.spectrogram) {
                    specImg.src = '/spectrogram/' + currentRadioTrack.spectrogram;
                    specImg.style.display = 'block';
                } else {
                    specImg.style.display = 'none';
                }
            }

            // Play the audio (auto-unmute if user had muted)
            autoUnmuteOnPlay();
            radioPlayer.src = '/audio/' + encodeURIComponent(currentRadioTrack.filename);
            radioPlayer.play().catch(e => console.warn('Radio play failed:', e.message));

            updateRadioQueue();

            // Update mini-player and library playing indicators
            updateMiniPlayer();
            if (typeof updateLibraryItemPlayerUI === 'function') {
                currentPlayingLibraryItemId = currentRadioTrack.id;
                updateLibraryItemPlayerUI(currentRadioTrack.id, true);
            }

            // Auto-fetch more tracks if queue is running low
            if (radioQueue.length < MIN_QUEUE_SIZE) {
                fetchMoreTracks();
            }
        }

        async function fetchMoreTracks() {
            if (isFetchingMore) return;  // Already fetching
            isFetchingMore = true;

            try {
                const model = document.getElementById('radio-model').value;
                const keywords = document.getElementById('radio-keywords').value.trim();

                // Build exclude list from history + current queue
                const excludeIds = [
                    ...playHistory,
                    ...radioQueue.map(t => t.id).filter(Boolean)
                ];

                const params = new URLSearchParams({ model, count: 5 });
                if (keywords) params.set('search', keywords);
                if (excludeIds.length > 0) {
                    params.set('exclude', excludeIds.join(','));
                }

                const response = await fetch('/api/radio/next?' + params.toString());
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                if (data.tracks && data.tracks.length > 0) {
                    // Add new tracks to queue
                    radioQueue.push(...data.tracks);
                    updateRadioQueue();
                }
            } catch (err) {
                console.error('Failed to fetch more tracks:', err);
            } finally {
                isFetchingMore = false;
            }
        }

        let currentRadioVote = 0;

        // Update voice info display for now playing track
        function updateRadioVoiceInfo(track) {
            const voiceInfoEl = document.getElementById('radio-voice-info');
            if (!voiceInfoEl) return;

            if (track && track.model === 'voice') {
                // Parse categories
                let categories = [];
                try {
                    categories = typeof track.category === 'string' ? JSON.parse(track.category) : (track.category || []);
                } catch (e) { categories = []; }

                const isFemale = categories.includes('female');
                const isMale = categories.includes('male');
                const isBritish = categories.includes('british');
                const isAmerican = categories.includes('american');

                // Extract voice name
                let voiceName = '';
                if (track.voice_id) {
                    const parts = track.voice_id.split('-');
                    if (parts.length >= 2) {
                        voiceName = parts[1].toUpperCase();
                    }
                }

                let html = '';
                if (isFemale) html += '<span class="voice-gender-tag female">Female</span>';
                else if (isMale) html += '<span class="voice-gender-tag male">Male</span>';
                if (isBritish) html += '<span class="voice-accent-tag">UK</span>';
                else if (isAmerican) html += '<span class="voice-accent-tag">US</span>';
                if (voiceName) html += `<span class="voice-name-tag">${voiceName}</span>`;

                voiceInfoEl.innerHTML = html;
                voiceInfoEl.style.display = html ? 'inline-flex' : 'none';
            } else {
                voiceInfoEl.innerHTML = '';
                voiceInfoEl.style.display = 'none';
            }
        }

        async function loadRadioTrackVote() {
            if (!currentRadioTrack) return;
            if (!isAuthenticated()) return;  // Votes require auth
            try {
                const response = await authFetch('/api/library/votes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ generation_ids: [currentRadioTrack.id] })
                });
                const data = await response.json();
                currentRadioVote = data.votes?.[currentRadioTrack.id] || 0;
                document.getElementById('radio-vote-up').classList.toggle('voted-up', currentRadioVote === 1);
                document.getElementById('radio-vote-down').classList.toggle('voted-down', currentRadioVote === -1);
            } catch (err) {
                console.error('Failed to load radio track vote:', err);
            }
        }

        async function voteRadioTrack(voteValue) {
            if (!currentRadioTrack) return;

            // Require authentication to vote
            if (!isUserAuthenticated()) {
                showLoginPrompt('vote on tracks');
                return;
            }

            // Toggle vote if clicking same button
            const newVote = currentRadioVote === voteValue ? 0 : voteValue;

            try {
                const response = await authFetch(`/api/library/${currentRadioTrack.id}/vote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vote: newVote })
                });
                const data = await response.json();

                currentRadioVote = data.user_vote;
                document.getElementById('radio-upvotes').textContent = data.upvotes;
                document.getElementById('radio-downvotes').textContent = data.downvotes;
                document.getElementById('radio-vote-up').classList.toggle('voted-up', data.user_vote === 1);
                document.getElementById('radio-vote-down').classList.toggle('voted-down', data.user_vote === -1);

                // If downvoted, skip to next track after a moment
                if (newVote === -1) {
                    showFeedbackToast('Skipping...');
                    setTimeout(() => skipTrack(), 800);
                }
            } catch (err) {
                console.error('Radio vote failed:', err);
            }
        }

        // Quick vote from mini-player (no modal)
        async function quickVote(voteValue) {
            if (!currentRadioTrack) return;

            // Require authentication to vote
            if (!isUserAuthenticated()) {
                showLoginPrompt('vote on tracks');
                return;
            }

            const newVote = currentRadioVote === voteValue ? 0 : voteValue;

            // Visual feedback on mini-player buttons
            const upBtn = document.getElementById('mini-vote-up');
            const downBtn = document.getElementById('mini-vote-down');

            try {
                const response = await authFetch(`/api/library/${currentRadioTrack.id}/vote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vote: newVote })
                });
                const data = await response.json();

                currentRadioVote = data.user_vote;

                // Update mini-player button states
                if (upBtn) upBtn.classList.toggle('voted', data.user_vote === 1);
                if (downBtn) downBtn.classList.toggle('voted', data.user_vote === -1);

                // Also update main radio buttons if visible
                const radioUpBtn = document.getElementById('radio-vote-up');
                const radioDownBtn = document.getElementById('radio-vote-down');
                if (radioUpBtn) {
                    radioUpBtn.classList.toggle('voted-up', data.user_vote === 1);
                    document.getElementById('radio-upvotes').textContent = data.upvotes;
                }
                if (radioDownBtn) {
                    radioDownBtn.classList.toggle('voted-down', data.user_vote === -1);
                    document.getElementById('radio-downvotes').textContent = data.downvotes;
                }

                // Quick feedback
                if (newVote === 1) {
                    showFeedbackToast('Liked! Thanks for voting.');
                } else if (newVote === -1) {
                    showFeedbackToast('Noted. Skipping...');
                    setTimeout(() => skipTrack(), 600);
                }
            } catch (err) {
                console.error('Quick vote failed:', err);
            }
        }

        // ========================================
        // DOWNLOAD
        // ========================================
        function downloadCurrentTrack() {
            if (!currentRadioTrack) return;
            // Require authentication to download
            if (!isUserAuthenticated()) {
                showLoginPrompt('download tracks');
                return;
            }
            const filename = currentRadioTrack.filename;
            const a = document.createElement('a');
            a.href = `/download/${encodeURIComponent(filename)}`;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showFeedbackToast('Downloading...');
        }

        // Fullscreen mode instance
        let fullscreenWidget = null;

        function enterRadioFullscreen() {
            if (!currentRadioTrack) return;

            // Create fullscreen container if it doesn't exist
            let container = document.getElementById('fullscreen-radio-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'fullscreen-radio-container';
                container.setAttribute('data-branding', 'false'); // Hide branding for internal use
                document.body.appendChild(container);
            }

            // Destroy existing widget if any (preserve audio since it's shared)
            if (fullscreenWidget) {
                fullscreenWidget.destroy({ preserveAudio: true });
            }

            // Get main player's audio element
            const mainAudio = document.getElementById('radio-player');

            // Create new fullscreen widget with main audio element
            fullscreenWidget = RadioWidget.create(container, {
                size: 'fullscreen',
                template: 'default',
                showBranding: false,
                connectToExisting: false,
                audioElement: mainAudio
            });

            // Sync current state from main player to widget
            if (fullscreenWidget && fullscreenWidget.core) {
                fullscreenWidget.core.audioElement = mainAudio;
                fullscreenWidget.core.currentTrack = currentRadioTrack;
                fullscreenWidget.core.queue = [...radioQueue];
                fullscreenWidget.core.isPlaying = !mainAudio.paused;
                fullscreenWidget.core._events.emit('trackChange', currentRadioTrack);
                fullscreenWidget.core._events.emit('playStateChange', !mainAudio.paused);
            }

            // Initialize visualizer AFTER fullscreen transition completes
            const initVisualizerAfterFullscreen = () => {
                // Wait a frame for layout to settle, then init visualizer
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        if (fullscreenWidget && fullscreenWidget._initVisualizer) {
                            fullscreenWidget._initVisualizer();
                        }
                    });
                });
            };

            // Move modals inside fullscreen container so they appear above it
            // (Native fullscreen creates a top-layer that hides elements outside it)
            const modalsToMove = [
                'feedback-modal-overlay',
                'tag-modal-overlay',
                'playlist-modal-overlay',
                'playlist-options-overlay'
            ];
            const movedModals = [];
            modalsToMove.forEach(id => {
                const modal = document.getElementById(id);
                if (modal) {
                    movedModals.push({ element: modal, parent: modal.parentNode });
                    container.appendChild(modal);
                }
            });

            // Enter native fullscreen FIRST, then initialize visualizer
            if (container.requestFullscreen) {
                container.requestFullscreen().then(initVisualizerAfterFullscreen);
            } else if (container.webkitRequestFullscreen) {
                container.webkitRequestFullscreen();
                // Webkit doesn't return a promise, use timeout
                setTimeout(initVisualizerAfterFullscreen, 100);
            }

            // Clean up when exiting fullscreen
            document.addEventListener('fullscreenchange', function onFsChange() {
                if (!document.fullscreenElement && fullscreenWidget) {
                    // Move modals back to their original parents (body)
                    movedModals.forEach(({ element, parent }) => {
                        if (element && parent) {
                            parent.appendChild(element);
                        }
                    });

                    // Preserve audio - shared element with main player
                    fullscreenWidget.destroy({ preserveAudio: true });
                    fullscreenWidget = null;
                    container.remove();
                    document.removeEventListener('fullscreenchange', onFsChange);

                    // Sync state back to main UI
                    updateMiniPlayer();
                    updateEqVisualizer(!radioPlayer.paused);
                }
            });
        }

        function tagCurrentTrack() {
            if (!currentRadioTrack) return;
            showTagSuggestionModal(currentRadioTrack);
        }

        function downloadTrack(filename) {
            // Require authentication to download
            if (!isUserAuthenticated()) {
                showLoginPrompt('download tracks');
                return;
            }
            const a = document.createElement('a');
            a.href = `/download/${encodeURIComponent(filename)}`;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showFeedbackToast('Downloading...');
        }

        // Copy library item ID to clipboard
        function copyLibraryItemId(itemId) {
            if (!itemId) {
                showFeedbackToast('No ID to copy', 'error');
                return;
            }

            // Try modern clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(itemId).then(() => {
                    showFeedbackToast(`Copied: ${itemId}`);
                }).catch(err => {
                    console.error('Clipboard API failed:', err);
                    fallbackCopy(itemId);
                });
            } else {
                fallbackCopy(itemId);
            }

            function fallbackCopy(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                textArea.style.top = '0';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showFeedbackToast(`Copied: ${text}`);
                } catch (err) {
                    showFeedbackToast('Failed to copy ID', 'error');
                }
                document.body.removeChild(textArea);
            }
        }

        function copyShareLink(itemId) {
            if (!itemId) {
                showFeedbackToast('No track to share', 'error');
                return;
            }

            // Build shareable URL
            const url = `${window.location.origin}/track/${itemId}`;

            // Try modern clipboard API first
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    showFeedbackToast('Link copied!');
                }).catch(err => {
                    console.error('Clipboard API failed:', err);
                    fallbackCopyLink(url);
                });
            } else {
                fallbackCopyLink(url);
            }

            function fallbackCopyLink(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                textArea.style.top = '0';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showFeedbackToast('Link copied!');
                } catch (err) {
                    showFeedbackToast('Failed to copy link', 'error');
                }
                document.body.removeChild(textArea);
            }
        }

        // ========================================
        // FAVORITES
        // ========================================
        let isCurrentTrackFavorited = false;

        async function toggleRadioFavorite() {
            if (!currentRadioTrack) return;

            // Require authentication to favorite
            if (!isUserAuthenticated()) {
                showLoginPrompt('favorite tracks');
                return;
            }

            const btn = document.getElementById('radio-favorite-btn');

            try {
                const method = isCurrentTrackFavorited ? 'DELETE' : 'POST';
                // Use authFetch - user_id is derived from verified auth token on server
                const response = await authFetch(`/api/favorites/${currentRadioTrack.id}`, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();

                if (data.success) {
                    isCurrentTrackFavorited = data.favorited;
                    updateFavoriteButton();
                    showFeedbackToast(data.favorited ? 'Added to favorites' : 'Removed from favorites');
                }
            } catch (err) {
                console.error('Favorite toggle failed:', err);
                showFeedbackToast('Failed to update favorites', 'error');
            }
        }

        function updateFavoriteButton() {
            const btn = document.getElementById('radio-favorite-btn');
            const iconUse = btn.querySelector('use');
            btn.classList.toggle('favorited', isCurrentTrackFavorited);
            if (iconUse) {
                iconUse.setAttribute('href', isCurrentTrackFavorited ? '#icon-heart' : '#icon-heart-outline');
            }
            btn.title = isCurrentTrackFavorited ? 'Remove from favorites' : 'Add to favorites';
        }

        async function checkRadioTrackFavorite() {
            if (!currentRadioTrack) return;
            const userId = getEffectiveUserId();

            try {
                const response = await fetch('/api/favorites/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        generation_ids: [currentRadioTrack.id]
                    })
                });
                const data = await response.json();
                isCurrentTrackFavorited = data.favorites?.includes(currentRadioTrack.id) || false;
                updateFavoriteButton();
            } catch (err) {
                console.error('Favorite check failed:', err);
            }
        }

        async function playFavorites() {
            const model = document.getElementById('radio-model').value;
            const userId = getEffectiveUserId();

            try {
                const params = new URLSearchParams({
                    user_id: userId,
                    model: model,
                    count: 10
                });

                const response = await fetch('/api/radio/favorites?' + params.toString());
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                if (data.tracks && data.tracks.length > 0) {
                    // Only clear history and start playing if we have tracks
                    playHistory = [];
                    radioQueue = data.tracks;
                    playNextTrack();
                    updateRadioQueue();
                    showFeedbackToast('Playing your favorites');
                } else {
                    // Don't modify anything - just show a message
                    showWarningToast('No favorites yet! Use the heart button to save tracks.');
                }
            } catch (err) {
                console.error('Play favorites failed:', err);
                showFeedbackToast('Failed to load favorites: ' + err.message, 'error');
            }
        }

        // Current active station
        let currentStation = null;

        // Station preset handler
        async function startStation(stationId, element) {
            const model = document.getElementById('radio-model').value;
            const userId = getEffectiveUserId();

            // Update active state
            document.querySelectorAll('.station-card').forEach(card => card.classList.remove('active'));
            if (element) element.classList.add('active');
            currentStation = stationId;

            // Clear featured button states
            document.querySelectorAll('.featured-btn').forEach(btn => btn.classList.remove('active'));

            playHistory = [];

            try {
                let response;

                if (stationId === 'favorites') {
                    // Play favorites
                    const params = new URLSearchParams({
                        user_id: userId,
                        model: model,
                        count: 10
                    });
                    response = await fetch('/api/radio/favorites?' + params.toString());
                } else {
                    // Regular station - use keywords from data attribute
                    const keywords = element ? element.dataset.keywords : '';
                    const params = new URLSearchParams({ model, count: 10 });
                    if (keywords) params.set('search', keywords);

                    // Also update the hidden keywords input
                    document.getElementById('radio-keywords').value = keywords;

                    response = await fetch('/api/radio/shuffle?' + params.toString());
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                if (data.tracks && data.tracks.length > 0) {
                    radioQueue = data.tracks;
                    playNextTrack();
                    updateRadioQueue();
                } else {
                    if (stationId === 'favorites') {
                        showWarningToast('No favorites yet! Use the heart button to save tracks.');
                    } else {
                        showWarningToast('No tracks found for this station');
                    }
                }
            } catch (err) {
                console.error('Station start failed:', err);
                showErrorToast('Failed to load station: ' + err.message);
            }
        }

        // Play top rated tracks
        async function playTrending(btn) {
            const model = document.getElementById('radio-model').value;

            // Update button states
            document.querySelectorAll('.featured-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.station-card').forEach(card => card.classList.remove('active'));
            if (btn) btn.classList.add('active');
            currentStation = 'trending';

            playHistory = [];

            try {
                const params = new URLSearchParams({ limit: 20 });
                if (model) params.set('model', model);

                const response = await fetch('/api/trending?' + params.toString());

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                if (data.tracks && data.tracks.length > 0) {
                    radioQueue = data.tracks;
                    playNextTrack();
                    updateRadioQueue();
                    showFeedbackToast('Playing trending tracks');
                } else {
                    showWarningToast('No trending tracks yet. Play some music to build trends!');
                }
            } catch (err) {
                console.error('Trending failed:', err);
                showErrorToast('Failed to load trending: ' + err.message);
            }
        }

        async function playTopRated(btn) {
            const model = document.getElementById('radio-model').value;

            // Update button states
            document.querySelectorAll('.featured-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.station-card').forEach(card => card.classList.remove('active'));
            if (btn) btn.classList.add('active');
            currentStation = 'top-rated';

            playHistory = [];

            try {
                const params = new URLSearchParams({ model, count: 10 });
                const response = await fetch('/api/radio/top-rated?' + params.toString());

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                if (data.tracks && data.tracks.length > 0) {
                    radioQueue = data.tracks;
                    playNextTrack();
                    updateRadioQueue();
                    showFeedbackToast('Playing top rated tracks');
                } else {
                    showWarningToast('No rated tracks yet. Vote on some tracks first!');
                }
            } catch (err) {
                console.error('Top rated failed:', err);
                showErrorToast('Failed to load top rated: ' + err.message);
            }
        }

        // Play new arrivals
        async function playNewArrivals(btn) {
            const model = document.getElementById('radio-model').value;

            // Update button states
            document.querySelectorAll('.featured-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.station-card').forEach(card => card.classList.remove('active'));
            if (btn) btn.classList.add('active');
            currentStation = 'new';

            playHistory = [];

            try {
                const params = new URLSearchParams({ model, count: 10, hours: 168 }); // Last week
                const response = await fetch('/api/radio/new?' + params.toString());

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                if (data.tracks && data.tracks.length > 0) {
                    radioQueue = data.tracks;
                    playNextTrack();
                    updateRadioQueue();
                    showFeedbackToast('Playing new arrivals');
                } else {
                    showWarningToast('No new tracks this week. Generate some!');
                }
            } catch (err) {
                console.error('New arrivals failed:', err);
                showErrorToast('Failed to load new arrivals: ' + err.message);
            }
        }

        // Surprise me - random shuffle
        async function playSurpriseMe(btn) {
            const model = document.getElementById('radio-model').value;

            // Update button states
            document.querySelectorAll('.featured-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.station-card').forEach(card => card.classList.remove('active'));
            if (btn) btn.classList.add('active');
            currentStation = 'surprise';

            // Clear keywords for true random
            document.getElementById('radio-keywords').value = '';
            playHistory = [];

            try {
                const params = new URLSearchParams({ model, count: 10 });
                const response = await fetch('/api/radio/shuffle?' + params.toString());

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                if (data.tracks && data.tracks.length > 0) {
                    radioQueue = data.tracks;
                    playNextTrack();
                    updateRadioQueue();
                    showFeedbackToast('Surprise!');
                } else {
                    showWarningToast('No tracks found. Generate some music first!');
                }
            } catch (err) {
                console.error('Surprise me failed:', err);
                showErrorToast('Failed to load tracks: ' + err.message);
            }
        }

        // Remove track from queue
        function removeFromQueue(index) {
            if (index >= 0 && index < radioQueue.length) {
                radioQueue.splice(index, 1);
                updateRadioQueue();
            }
        }

        // Model-specific feedback categories
        const FEEDBACK_CATEGORIES = {
            music: {
                positive: [
                    { id: 'catchy', label: 'Catchy/memorable' },
                    { id: 'quality', label: 'Great quality' },
                    { id: 'creative', label: 'Creative/unique' },
                    { id: 'matches', label: 'Matches prompt' },
                    { id: 'mood', label: 'Great vibe' },
                    { id: 'relaxing', label: 'Relaxing/calming' },
                    { id: 'loops_well', label: 'Loops perfectly' },
                    { id: 'useful', label: 'Perfect for games' }
                ],
                negative: [
                    { id: 'wrong_mood', label: 'Wrong mood/tone' },
                    { id: 'too_repetitive', label: 'Too repetitive' },
                    { id: 'bad_loop', label: 'Bad loop point' },
                    { id: 'too_busy', label: 'Too busy/complex' },
                    { id: 'too_simple', label: 'Too simple/boring' },
                    { id: 'jarring', label: 'Jarring transitions' },
                    { id: 'low_quality', label: 'Low quality' },
                    { id: 'inappropriate', label: 'Inappropriate content' }
                ]
            },
            audio: {
                positive: [
                    { id: 'clear', label: 'Clear/crisp' },
                    { id: 'quality', label: 'Great quality' },
                    { id: 'creative', label: 'Creative/unique' },
                    { id: 'matches', label: 'Matches prompt' },
                    { id: 'satisfying', label: 'Satisfying' },
                    { id: 'cute', label: 'Cute/charming' },
                    { id: 'useful', label: 'Perfect for games' }
                ],
                negative: [
                    { id: 'wrong_type', label: 'Wrong sound type' },
                    { id: 'too_long', label: 'Too long' },
                    { id: 'too_short', label: 'Too short' },
                    { id: 'distorted', label: 'Distorted/glitchy' },
                    { id: 'bad_volume', label: 'Too quiet/loud' },
                    { id: 'annoying', label: 'Annoying' },
                    { id: 'low_quality', label: 'Low quality' },
                    { id: 'inappropriate', label: 'Inappropriate content' }
                ]
            },
            voice: {
                positive: [
                    { id: 'clear', label: 'Clear/crisp' },
                    { id: 'natural', label: 'Natural sounding' },
                    { id: 'expressive', label: 'Good expression' },
                    { id: 'matches', label: 'Matches text' },
                    { id: 'useful', label: 'Perfect for games' }
                ],
                negative: [
                    { id: 'robotic', label: 'Too robotic' },
                    { id: 'pronunciation', label: 'Bad pronunciation' },
                    { id: 'pacing', label: 'Wrong pacing' },
                    { id: 'distorted', label: 'Distorted/glitchy' },
                    { id: 'low_quality', label: 'Low quality' },
                    { id: 'inappropriate', label: 'Inappropriate content' }
                ]
            }
        };

        // ========================================
        // FEEDBACK MODAL SYSTEM
        // ========================================
        let feedbackModalState = {
            track: null,          // { id, prompt, model }
            isPositive: true,
            selectedReasons: [],
            suggestedModel: null,
            source: 'radio'       // 'radio' or 'library'
        };

        function openFeedbackModal(track, isPositive, source = 'radio') {
            // Require authentication to provide feedback
            if (!isUserAuthenticated()) {
                showLoginPrompt('rate tracks');
                return;
            }

            feedbackModalState = {
                track,
                isPositive,
                selectedReasons: [],
                suggestedModel: null,
                source
            };

            const model = track.model || 'music';
            const categories = FEEDBACK_CATEGORIES[model] || FEEDBACK_CATEGORIES.music;
            const options = isPositive ? categories.positive : categories.negative;

            // Update modal container class for positive/negative styling
            const modalContainer = document.getElementById('feedback-modal-container');
            modalContainer.classList.remove('positive', 'negative');
            modalContainer.classList.add(isPositive ? 'positive' : 'negative');

            // Generate floating particles
            generateFeedbackParticles(isPositive);

            // Update modal title
            const titleEl = document.getElementById('feedback-modal-title');
            titleEl.innerHTML = isPositive
                ? '<svg class="icon icon-sm" style="vertical-align: -2px; margin-right: 4px;"><use href="#icon-thumb-up"/></svg>What do you like?'
                : '<svg class="icon icon-sm" style="vertical-align: -2px; margin-right: 4px;"><use href="#icon-thumb-down"/></svg>What\'s wrong?';
            titleEl.className = 'feedback-modal-title ' + (isPositive ? 'positive' : 'negative');

            // Update track info
            const badgeIcon = model === 'music' ? '#icon-music' : model === 'voice' ? '#icon-mic' : '#icon-volume';
            document.getElementById('feedback-modal-badge').innerHTML = `<svg class="icon icon-sm" style="vertical-align: -2px;"><use href="${badgeIcon}"/></svg>`;
            document.getElementById('feedback-modal-prompt').textContent = track.prompt;

            // Update label
            document.getElementById('feedback-modal-label').textContent = isPositive
                ? 'Select what you like (can pick multiple):'
                : 'Select issues (can pick multiple):';

            // Populate feedback options
            const optionsContainer = document.getElementById('feedback-modal-options');
            optionsContainer.innerHTML = options.map(opt =>
                `<button class="feedback-tag ${isPositive ? 'positive' : ''}" data-id="${opt.id}" onclick="toggleModalFeedbackTag('${opt.id}')">${opt.label}</button>`
            ).join('');

            // Populate reclassify option (only for music/audio, not voice)
            const reclassifyContainer = document.getElementById('feedback-modal-reclassify');
            if (model === 'voice') {
                // Voice clips can't be reclassified to other types
                reclassifyContainer.innerHTML = '';
                reclassifyContainer.style.display = 'none';
            } else {
                reclassifyContainer.style.display = '';
                const oppositeModel = model === 'music' ? 'audio' : 'music';
                const oppositeIcon = model === 'music' ? '#icon-volume' : '#icon-music';
                const oppositeLabel = `<svg class="icon icon-sm" style="vertical-align: -2px; margin-right: 4px;"><use href="${oppositeIcon}"/></svg>${model === 'music' ? 'This is actually a sound effect' : 'This is actually music'}`;
                reclassifyContainer.innerHTML =
                    `<button class="reclassify-option" data-model="${oppositeModel}" onclick="toggleModalReclassify('${oppositeModel}')">${oppositeLabel}</button>`;
            }

            // Update submit button
            const submitBtn = document.getElementById('feedback-modal-submit');
            submitBtn.className = 'feedback-modal-submit' + (isPositive ? ' positive' : '');
            submitBtn.disabled = true;

            // Show modal
            document.getElementById('feedback-modal-overlay').classList.remove('hidden');
        }

        function generateFeedbackParticles(isPositive) {
            const container = document.getElementById('feedback-particles');
            container.innerHTML = '';

            const colors = isPositive
                ? ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0']
                : ['#ef4444', '#f87171', '#ec4899', '#f472b6'];

            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'feedback-particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.animationDelay = (Math.random() * 4) + 's';
                particle.style.animationDuration = (3 + Math.random() * 3) + 's';
                particle.style.width = (4 + Math.random() * 8) + 'px';
                particle.style.height = particle.style.width;
                particle.style.opacity = 0.4 + Math.random() * 0.4;
                container.appendChild(particle);
            }
        }

        function closeFeedbackModal(event) {
            // If event is passed and it's from overlay click, only close if clicking the overlay itself
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('feedback-modal-overlay').classList.add('hidden');
            feedbackModalState = { track: null, isPositive: true, selectedReasons: [], suggestedModel: null, source: 'radio' };
        }

        function toggleModalFeedbackTag(tagId) {
            const idx = feedbackModalState.selectedReasons.indexOf(tagId);
            if (idx === -1) {
                feedbackModalState.selectedReasons.push(tagId);
            } else {
                feedbackModalState.selectedReasons.splice(idx, 1);
            }

            // Update visual state
            document.querySelectorAll('#feedback-modal-options .feedback-tag').forEach(tag => {
                tag.classList.toggle('selected', feedbackModalState.selectedReasons.includes(tag.dataset.id));
            });

            updateModalSubmitButton();
        }

        function toggleModalReclassify(model) {
            feedbackModalState.suggestedModel = feedbackModalState.suggestedModel === model ? null : model;

            // Update visual state
            document.querySelectorAll('#feedback-modal-reclassify .reclassify-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.model === feedbackModalState.suggestedModel);
            });

            updateModalSubmitButton();
        }

        function updateModalSubmitButton() {
            const hasSelection = feedbackModalState.selectedReasons.length > 0 || feedbackModalState.suggestedModel;
            document.getElementById('feedback-modal-submit').disabled = !hasSelection;
        }

        async function submitFeedbackModal() {
            if (!feedbackModalState.track) return;

            // Prevent double-submit
            const submitBtn = document.getElementById('feedback-modal-submit');
            if (submitBtn.disabled) return;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            const voteValue = feedbackModalState.isPositive ? 1 : -1;
            const genId = feedbackModalState.track.id;

            try {
                const response = await authFetch(`/api/library/${genId}/vote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        vote: voteValue,
                        feedback_reasons: feedbackModalState.selectedReasons.length > 0 ? feedbackModalState.selectedReasons : null,
                        suggested_model: feedbackModalState.suggestedModel
                    })
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error || 'Failed to submit feedback');
                }

                const data = await response.json();

                // Update UI based on source
                if (feedbackModalState.source === 'radio') {
                    currentRadioVote = voteValue;
                    document.getElementById('radio-upvotes').textContent = data.upvotes;
                    document.getElementById('radio-downvotes').textContent = data.downvotes;
                    document.getElementById('radio-vote-up').classList.toggle('voted-up', voteValue === 1);
                    document.getElementById('radio-vote-down').classList.toggle('voted-down', voteValue === -1);
                } else {
                    // Library item
                    userVotes[genId] = voteValue;
                    const item = document.querySelector(`.library-item[data-id="${genId}"]`);
                    if (item) {
                        const upBtn = item.querySelector('.action-btn.vote-up');
                        const downBtn = item.querySelector('.action-btn.vote-down');
                        if (upBtn) {
                            upBtn.classList.toggle('voted', voteValue === 1);
                            const upCount = upBtn.querySelector('.vote-count');
                            if (upCount) upCount.textContent = data.upvotes;
                        }
                        if (downBtn) {
                            downBtn.classList.toggle('voted', voteValue === -1);
                            const downCount = downBtn.querySelector('.vote-count');
                            if (downCount) downCount.textContent = data.downvotes;
                        }
                    }
                }

                // Show toast
                const reasonCount = feedbackModalState.selectedReasons.length;
                const reclassifyMsg = feedbackModalState.suggestedModel ? ' + reclassify' : '';
                showFeedbackToast(`Thanks for the feedback! (${reasonCount} tag${reasonCount !== 1 ? 's' : ''}${reclassifyMsg})`);

                // Close modal
                closeFeedbackModal();

                // Skip track if downvoted in radio
                if (feedbackModalState.source === 'radio' && !feedbackModalState.isPositive) {
                    setTimeout(() => skipTrack(), 500);
                }

            } catch (err) {
                console.error('Feedback failed:', err);
                showErrorToast('Failed to submit feedback: ' + err.message);
            } finally {
                // Re-enable button (in case modal wasn't closed)
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Feedback';
                }
            }
        }

        // Radio feedback shortcuts
        function showPositiveFeedbackMenu() {
            if (!currentRadioTrack) return;

            const upBtn = document.getElementById('radio-vote-up');

            // If already liked, clicking again clears the vote
            if (currentRadioVote === 1) {
                clearRadioVote();
                return;
            }

            // Add voting animation
            upBtn.classList.add('voting');
            setTimeout(() => upBtn.classList.remove('voting'), 600);

            openFeedbackModal(currentRadioTrack, true, 'radio');
        }

        function showFeedbackMenu() {
            if (!currentRadioTrack) return;

            const downBtn = document.getElementById('radio-vote-down');

            // If already disliked, clicking again clears the vote
            if (currentRadioVote === -1) {
                clearRadioVote();
                return;
            }

            // Add voting animation
            downBtn.classList.add('voting');
            setTimeout(() => downBtn.classList.remove('voting'), 600);

            openFeedbackModal(currentRadioTrack, false, 'radio');
        }

        // Clear radio vote (toggle off)
        async function clearRadioVote() {
            if (!currentRadioTrack) return;

            const voterId = getEffectiveUserId();
            try {
                const response = await fetch('/api/library/vote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        generation_id: currentRadioTrack.id,
                        vote: 0,
                        user_id: voterId
                    })
                });
                const data = await response.json();

                currentRadioVote = 0;
                document.getElementById('radio-upvotes').textContent = data.upvotes || 0;
                document.getElementById('radio-downvotes').textContent = data.downvotes || 0;
                document.getElementById('radio-vote-up').classList.remove('voted-up');
                document.getElementById('radio-vote-down').classList.remove('voted-down');

                showFeedbackToast('Vote removed');
            } catch (err) {
                console.error('Failed to clear radio vote:', err);
                showErrorToast('Failed to remove vote');
            }
        }

        function skipTrack() {
            playNextTrack();
        }

        function playPreviousTrack() {
            // Need at least one track in history to go back
            if (recentlyPlayed.length === 0) {
                showWarningToast('No previous tracks');
                return;
            }

            // If we have a current track, put it back at the front of the queue
            if (currentRadioTrack) {
                radioQueue.unshift(currentRadioTrack);
            }

            // Get the previous track from history
            const previousTrack = recentlyPlayed.pop();

            // Play it
            currentRadioTrack = previousTrack;

            // Update UI
            document.getElementById('radio-prompt').textContent = currentRadioTrack.prompt;
            document.getElementById('radio-duration').textContent = Number(currentRadioTrack.duration).toFixed(1) + 's';
            document.getElementById('radio-upvotes').textContent = currentRadioTrack.upvotes || 0;
            document.getElementById('radio-downvotes').textContent = currentRadioTrack.downvotes || 0;
            updateRadioVoiceInfo(currentRadioTrack);

            // Reset vote button states
            document.getElementById('radio-vote-up').classList.remove('voted-up');
            document.getElementById('radio-vote-down').classList.remove('voted-down');

            nowPlayingEl.classList.remove('hidden');

            // Load vote and favorite status
            loadRadioTrackVote();
            checkRadioTrackFavorite();

            // Enable radio controls
            updateRadioControlsState();

            // Play the audio (auto-unmute if user had muted)
            autoUnmuteOnPlay();
            radioPlayer.src = '/audio/' + encodeURIComponent(currentRadioTrack.filename);
            radioPlayer.play().catch(e => console.warn('Radio play failed:', e.message));

            updateRadioQueue();
        }

        function setRadioFilter(keywords, btn) {
            document.getElementById('radio-keywords').value = keywords;
            // Update active state on chips
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            if (btn) btn.classList.add('active');
            // Auto-shuffle when filter is clicked
            shuffleRadio();
        }

        function updateRadioQueue() {
            const queueCountBadge = document.getElementById('queue-count-badge');

            if (radioQueue.length === 0) {
                radioQueueEl.classList.add('hidden');
                if (queueCountBadge) queueCountBadge.textContent = '0';
                return;
            }

            radioQueueEl.classList.remove('hidden');
            if (queueCountBadge) queueCountBadge.textContent = radioQueue.length;

            queueItemsEl.innerHTML = radioQueue.slice(0, 5).map((track, i) => `
                <div class="queue-item">
                    <span class="queue-num">${i + 1}</span>
                    <span class="queue-prompt">${escapeHtml(track.prompt)}</span>
                    <span class="queue-duration">${Number(track.duration).toFixed(1)}s</span>
                    <button class="queue-remove" onclick="removeFromQueue(${i})" title="Remove from queue">&times;</button>
                </div>
            `).join('');
        }

        // EQ Visualizer play/pause handler
        function updateEqVisualizer(isPlaying) {
            const eq = document.getElementById('eq-visualizer');
            if (eq) {
                if (isPlaying) {
                    eq.classList.remove('paused');
                } else {
                    eq.classList.add('paused');
                }
            }
        }

        // NOTE: 'ended' -> playNextTrack listener is already set at line 9164
        // Do NOT add duplicate here - it causes tracks to skip twice!
        if (radioPlayer) {
            // EQ visualizer responds to play/pause
            radioPlayer.addEventListener('play', () => {
                updateEqVisualizer(true);
                updateMiniPlayer();
                // Track play event for analytics
                if (currentRadioTrack && currentRadioTrack.id) {
                    trackPlayEvent(currentRadioTrack.id);
                }
                // If play was clicked but no track is loaded, auto-start shuffle
                if (!currentRadioTrack) {
                    radioPlayer.pause();
                    radioPlayer.src = '';  // Clear any cached src
                    startStation('all');
                }
            });
            radioPlayer.addEventListener('pause', () => {
                updateEqVisualizer(false);
                updateMiniPlayer();
            });
            radioPlayer.addEventListener('ended', () => {
                updateEqVisualizer(false);
                updateMiniPlayer();
            });
            radioPlayer.addEventListener('error', (e) => {
                console.error('Audio playback error:', e);
                showErrorToast('Failed to load audio. Skipping to next track...');
                // Skip to next track on error
                setTimeout(() => playNextTrack(), 1000);
            });
        }

        // Track play events for analytics
        let lastTrackedPlayId = null;
        async function trackPlayEvent(trackId) {
            // Only track once per track (not on resume)
            if (lastTrackedPlayId === trackId) return;
            lastTrackedPlayId = trackId;

            try {
                const sessionId = getOrCreateSessionId();
                const userId = getEffectiveUserId();

                await fetch(`/api/track/${trackId}/play`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        user_id: userId,
                        source: currentStation || 'radio'
                    })
                });
            } catch (err) {
                console.error('[Analytics] Failed to track play:', err);
            }
        }

        function getOrCreateSessionId() {
            let sessionId = sessionStorage.getItem('soundbox_session');
            if (!sessionId) {
                sessionId = 'sess_' + Math.random().toString(36).substr(2, 12);
                sessionStorage.setItem('soundbox_session', sessionId);
            }
            return sessionId;
        }

        // ========================================
        // LIBRARY VIEW
        // ========================================
        let libraryPage = 1;
        let libraryTotal = 0;
        let libraryPages = 1;
        let userVotes = {};
        let userFavorites = new Set();
        let searchDebounceTimer = null;

        const libraryItemsEl = document.getElementById('library-items');
        const librarySearchEl = document.getElementById('library-search');
        const libraryModelEl = document.getElementById('library-model');
        const librarySortEl = document.getElementById('library-sort');
        const paginationEl = document.getElementById('pagination');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const pageInfoEl = document.getElementById('page-info');
        const pageNumbersEl = document.getElementById('page-numbers');
        const libraryTotalEl = document.getElementById('library-total');

        // Stop all other audio when one starts playing (exclusive playback)
        function stopOtherAudio(currentAudio) {
            // Stop all library audio elements except the current one
            document.querySelectorAll('.library-item audio').forEach(audio => {
                if (audio !== currentAudio && !audio.paused) {
                    audio.pause();
                    audio.currentTime = 0;
                }
            });
            // Also pause the main radio player if library audio starts
            if (radioPlayer && !radioPlayer.paused) {
                radioPlayer.pause();
            }
        }

        function renderPageNumbers(currentPage, totalPages) {
            if (!pageNumbersEl || totalPages <= 1) {
                if (pageNumbersEl) pageNumbersEl.innerHTML = '';
                return;
            }

            const pages = [];
            const maxVisible = 5;

            // Always show first page
            pages.push(1);

            // Calculate range around current page
            let start = Math.max(2, currentPage - 1);
            let end = Math.min(totalPages - 1, currentPage + 1);

            // Adjust range if at edges
            if (currentPage <= 3) {
                end = Math.min(totalPages - 1, maxVisible - 1);
            } else if (currentPage >= totalPages - 2) {
                start = Math.max(2, totalPages - maxVisible + 2);
            }

            // Add ellipsis before middle pages if needed
            if (start > 2) pages.push('...');

            // Add middle pages
            for (let i = start; i <= end; i++) {
                pages.push(i);
            }

            // Add ellipsis after middle pages if needed
            if (end < totalPages - 1) pages.push('...');

            // Always show last page if more than 1 page
            if (totalPages > 1) pages.push(totalPages);

            // Render
            pageNumbersEl.innerHTML = pages.map(p => {
                if (p === '...') {
                    return '<span class="page-ellipsis">...</span>';
                }
                const activeClass = p === currentPage ? ' active' : '';
                return `<button class="page-btn${activeClass}" onclick="goToPage(${p})">${p}</button>`;
            }).join('');
        }

        function goToPage(page) {
            libraryPage = page;
            loadLibrary();
            document.querySelector('.library-card')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Load and update type counts (Music/SFX/Voice/Graphlings)
        async function loadTypeCounts() {
            try {
                const response = await fetch('/api/library/counts');
                const counts = await response.json();

                // Update the Music, SFX, and Speech count badges
                const musicCountEl = document.getElementById('music-count');
                const sfxCountEl = document.getElementById('sfx-count');
                const voiceCountEl = document.getElementById('voice-count');

                if (musicCountEl) {
                    musicCountEl.textContent = counts.music || 0;
                }
                if (sfxCountEl) {
                    sfxCountEl.textContent = counts.audio || 0;
                }
                if (voiceCountEl) {
                    voiceCountEl.textContent = counts.voice || 0;
                }

                // Load Graphlings count separately
                loadGraphlingsCount();
            } catch (error) {
                console.error('Error loading type counts:', error);
            }
        }

        // Graphlings sources state
        let graphlingsSources = {};
        let graphlingsCounts = {};
        let currentGraphlingsSource = '';
        let currentGraphlingsModel = '';

        async function loadGraphlingsCount() {
            try {
                const response = await fetch('/api/graphlings/sources');
                const data = await response.json();

                graphlingsSources = data.sources || {};
                graphlingsCounts = data.counts || {};

                // Calculate total Graphlings count
                let totalCount = 0;
                for (const sourceId in graphlingsCounts) {
                    totalCount += graphlingsCounts[sourceId].total || 0;
                }

                const graphlingsCountEl = document.getElementById('graphlings-count');
                if (graphlingsCountEl) {
                    graphlingsCountEl.textContent = totalCount;
                }

                // Render Graphlings sources in sidebar
                renderGraphlingsSources();
            } catch (error) {
                console.error('Error loading Graphlings sources:', error);
            }
        }

        function renderGraphlingsSources() {
            const container = document.getElementById('graphlings-genres');
            if (!container) return;

            if (Object.keys(graphlingsSources).length === 0) {
                container.innerHTML = `
                    <div class="graphlings-empty" style="text-align: center; padding: 20px; color: var(--text-muted);">
                        <svg class="icon" style="width: 32px; height: 32px; opacity: 0.5;"><use href="#icon-game"/></svg>
                        <p style="margin-top: 8px; font-size: 0.9rem;">No game audio tagged yet</p>
                    </div>
                `;
                return;
            }

            let html = '';
            for (const sourceId in graphlingsSources) {
                const source = graphlingsSources[sourceId];
                const counts = graphlingsCounts[sourceId] || { music: 0, audio: 0, voice: 0, total: 0 };

                html += `
                    <div class="graphlings-source" data-source="${sourceId}">
                        <div class="graphlings-source-header" onclick="toggleGraphlingsSource('${sourceId}')">
                            <svg class="source-icon"><use href="#icon-game"/></svg>
                            <span class="source-name">${escapeHtml(source.name)}</span>
                            <span class="source-count">${counts.total}</span>
                        </div>
                        <div class="graphlings-source-types">
                            <div class="graphlings-type-item" data-source="${sourceId}" data-model="" onclick="selectGraphlingsFilter('${sourceId}', '')">
                                <svg class="type-icon"><use href="#icon-grid"/></svg>
                                <span class="type-name">All Audio</span>
                                <span class="type-count">${counts.total}</span>
                            </div>
                            <div class="graphlings-type-item" data-source="${sourceId}" data-model="music" onclick="selectGraphlingsFilter('${sourceId}', 'music')">
                                <svg class="type-icon"><use href="#icon-music"/></svg>
                                <span class="type-name">Music</span>
                                <span class="type-count">${counts.music || 0}</span>
                            </div>
                            <div class="graphlings-type-item" data-source="${sourceId}" data-model="audio" onclick="selectGraphlingsFilter('${sourceId}', 'audio')">
                                <svg class="type-icon"><use href="#icon-volume"/></svg>
                                <span class="type-name">SFX</span>
                                <span class="type-count">${counts.audio || 0}</span>
                            </div>
                            <div class="graphlings-type-item" data-source="${sourceId}" data-model="voice" onclick="selectGraphlingsFilter('${sourceId}', 'voice')">
                                <svg class="type-icon"><use href="#icon-mic"/></svg>
                                <span class="type-name">Speech</span>
                                <span class="type-count">${counts.voice || 0}</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function toggleGraphlingsSource(sourceId) {
            const sourceEl = document.querySelector(`.graphlings-source[data-source="${sourceId}"]`);
            if (sourceEl) {
                sourceEl.classList.toggle('expanded');
            }
        }

        function selectGraphlingsFilter(sourceId, model) {
            currentGraphlingsSource = sourceId;
            currentGraphlingsModel = model;

            // Update active states
            document.querySelectorAll('.graphlings-type-item').forEach(item => {
                const isActive = item.dataset.source === sourceId && item.dataset.model === model;
                item.classList.toggle('active', isActive);
            });

            // Expand the source group
            document.querySelectorAll('.graphlings-source').forEach(source => {
                source.classList.toggle('expanded', source.dataset.source === sourceId);
            });

            updateClearFilterButton();

            // Reload library with graphlings filter
            libraryPage = 1;
            loadLibrary();
        }

        async function loadLibrary() {
            const model = libraryModelEl.value;
            const search = librarySearchEl.value.trim();

            // Handle favorites view separately
            if (model === 'favorites' || currentQuickFilter === 'favorites') {
                await loadFavoritesLibrary();
                return;
            }

            const params = new URLSearchParams({
                page: libraryPage,
                per_page: 10,
                sort: librarySortEl.value
            });

            // Handle Graphlings source filtering
            if (currentGraphlingsSource) {
                params.set('source', currentGraphlingsSource);
                if (currentGraphlingsModel) {
                    params.set('model', currentGraphlingsModel);
                }
            } else {
                // Use currentCategory if set by type tabs, otherwise use model dropdown
                const effectiveModel = currentCategory || model;
                if (effectiveModel && effectiveModel !== 'graphlings') {
                    params.set('model', effectiveModel);
                }
            }

            if (search) params.set('search', search);

            // Add category filter if a genre is selected
            if (currentSubcategory) {
                params.set('category', currentSubcategory);
            }

            try {
                const response = await fetch('/api/library?' + params.toString());
                const data = await response.json();

                libraryTotal = data.total;
                libraryPages = data.pages;

                libraryTotalEl.textContent = `(${libraryTotal} total)`;
                pageInfoEl.textContent = `Page ${data.page} of ${libraryPages || 1}`;
                prevPageBtn.disabled = data.page <= 1;
                nextPageBtn.disabled = data.page >= libraryPages;
                renderPageNumbers(data.page, libraryPages);

                if (data.items.length === 0) {
                    let emptyMessage = '';
                    // Check if any filters are active
                    const hasActiveFilters = search || model || currentCategory || currentSubcategory || currentGraphlingsSource || currentQuickFilter;

                    if (search) {
                        emptyMessage = `
                            <div class="library-empty">
                                <svg class="empty-icon"><use href="#icon-search"/></svg>
                                <h3>No tracks found</h3>
                                <p>No results for "<strong>${escapeHtml(search)}</strong>". Try different keywords.</p>
                            </div>
                        `;
                    } else if (hasActiveFilters) {
                        emptyMessage = `
                            <div class="library-empty">
                                <svg class="empty-icon"><use href="#icon-filter"/></svg>
                                <h3>No matching tracks</h3>
                                <p>Try adjusting the filters in the sidebar, or use the "Clear Filters" button.</p>
                            </div>
                        `;
                    } else {
                        // No filters active and truly empty library
                        emptyMessage = `
                            <div class="library-empty">
                                <svg class="empty-icon"><use href="#icon-wand"/></svg>
                                <h3>Welcome to Sound Box!</h3>
                                <p>Generate your first track using the Generate tab</p>
                            </div>
                        `;
                    }
                    libraryItemsEl.innerHTML = `
                        <div style="text-align: center; color: var(--text-muted); padding: 40px;">
                            ${emptyMessage}
                        </div>
                    `;
                    return;
                }

                // Get user votes and favorites for these items
                const ids = data.items.map(item => item.id);
                await Promise.all([loadUserVotes(ids), loadUserFavorites(ids)]);

                libraryItemsEl.innerHTML = data.items.map(item => renderLibraryItem(item)).join('');

            } catch (err) {
                console.error('Library load failed:', err);
                libraryItemsEl.innerHTML = `
                    <div style="text-align: center; color: var(--error); padding: 20px;">
                        Failed to load library
                    </div>
                `;
            }
        }

        async function loadFavoritesLibrary() {
            const userId = getEffectiveUserId();
            const params = new URLSearchParams({
                user_id: userId,
                page: libraryPage,
                per_page: 10
            });

            try {
                const response = await fetch('/api/favorites?' + params.toString());
                const data = await response.json();

                libraryTotal = data.total;
                libraryPages = data.pages;

                libraryTotalEl.textContent = `(${libraryTotal} favorites)`;
                pageInfoEl.textContent = `Page ${data.page} of ${libraryPages || 1}`;
                prevPageBtn.disabled = data.page <= 1;
                nextPageBtn.disabled = data.page >= libraryPages;
                renderPageNumbers(data.page, libraryPages);

                if (data.items.length === 0) {
                    libraryItemsEl.innerHTML = `
                        <div class="library-empty">
                            <svg class="empty-icon"><use href="#icon-heart"/></svg>
                            <h3>No favorites yet</h3>
                            <p>Use the heart button on tracks to save them here</p>
                        </div>
                    `;
                    return;
                }

                // Get user votes for these items
                const ids = data.items.map(item => item.id);
                await loadUserVotes(ids);

                // Mark all items as favorited (since they're from favorites)
                libraryItemsEl.innerHTML = data.items.map(item => renderLibraryItem(item, true)).join('');

            } catch (err) {
                console.error('Favorites load failed:', err);
                libraryItemsEl.innerHTML = `
                    <div style="text-align: center; color: var(--error); padding: 20px;">
                        Failed to load favorites
                    </div>
                `;
            }
        }

        async function loadUserVotes(generationIds) {
            if (!isAuthenticated()) return;  // Votes require auth
            try {
                const response = await authFetch('/api/library/votes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ generation_ids: generationIds })
                });
                const data = await response.json();
                userVotes = data.votes || {};
            } catch (err) {
                console.error('Failed to load votes:', err);
            }
        }

        async function loadUserFavorites(generationIds) {
            if (!isAuthenticated()) return;  // Favorites require auth
            try {
                const response = await authFetch('/api/favorites/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ generation_ids: generationIds })
                });
                if (response.ok) {
                    const data = await response.json();
                    userFavorites = new Set(data.favorites || []);
                }
            } catch (err) {
                console.error('Failed to load favorites:', err);
            }
        }

        // Store library items data for modal access
        let libraryItemsData = {};

        // Library view mode
        let libraryViewMode = 'list';

        function setLibraryView(mode) {
            libraryViewMode = mode;
            const container = document.getElementById('library-items');
            const toggleBtns = document.querySelectorAll('.view-toggle-btn');

            toggleBtns.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.view-toggle-btn[onclick*="${mode}"]`)?.classList.add('active');

            if (mode === 'grid') {
                container.classList.add('grid-view');
            } else {
                container.classList.remove('grid-view');
            }
        }

        // Category state
        let currentCategory = '';
        let currentSubcategory = '';

        function setLibraryFilter(filter) {
            selectCategory(filter, '');
        }

        function selectCategory(category, subcategory) {
            currentCategory = category;
            currentSubcategory = subcategory;

            // Update hidden dropdown for backend compatibility
            const modelSelect = document.getElementById('library-model');
            modelSelect.value = category === 'favorites' ? 'favorites' : (category || '');

            // Update active states in sidebar
            document.querySelectorAll('.category-item').forEach(item => {
                const cat = item.dataset.category;
                const subcat = item.dataset.subcategory;
                item.classList.toggle('active', cat === category && (!subcategory || subcat === subcategory));
            });

            document.querySelectorAll('.subcategory-item').forEach(item => item.classList.remove('active'));

            // Update search placeholder based on category
            const searchInput = document.getElementById('library-search');
            if (category === 'music') {
                searchInput.placeholder = subcategory
                    ? `Search ${subcategory} music...`
                    : 'Search music tracks...';
            } else if (category === 'audio') {
                searchInput.placeholder = subcategory
                    ? `Search ${subcategory} sound effects...`
                    : 'Search sound effects...';
            } else if (category === 'favorites') {
                searchInput.placeholder = 'Search your favorites...';
            } else {
                searchInput.placeholder = 'Search music, sound effects, prompts...';
            }

            // Close mobile sidebar if open
            document.getElementById('category-sidebar')?.classList.remove('mobile-open');

            // Reload library with new filter
            libraryPage = 1;
            loadLibrary();
        }

        function toggleSubcategories(element, subcatId) {
            const subcat = document.getElementById('sub-' + subcatId);
            const expand = element.querySelector('.category-expand');

            if (subcat) {
                subcat.classList.toggle('expanded');
                expand?.classList.toggle('expanded');
            }
        }

        function toggleMobileCategories() {
            const sidebar = document.getElementById('category-sidebar');
            const backdrop = document.getElementById('category-backdrop');
            sidebar?.classList.toggle('mobile-open');
            backdrop?.classList.toggle('active');
        }

        // Current type filter state
        let currentTypeTab = 'all';
        let currentGenre = '';
        let currentQuickFilter = '';

        function selectTypeTab(type) {
            currentTypeTab = type;
            currentGenre = '';
            currentQuickFilter = '';

            // Clear Graphlings filter when switching tabs
            currentGraphlingsSource = '';
            currentGraphlingsModel = '';
            document.querySelectorAll('.graphlings-type-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.graphlings-source').forEach(source => source.classList.remove('expanded'));

            // Update tab active states
            document.querySelectorAll('.type-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.type === type);
            });

            // Update sidebar data attribute to control genre visibility
            document.getElementById('category-sidebar').dataset.type = type;

            // Clear genre selection
            document.querySelectorAll('.genre-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.quick-filter-btn').forEach(btn => btn.classList.remove('active'));

            // Update category for filtering
            if (type === 'all' || type === 'graphlings') {
                currentCategory = '';
            } else {
                currentCategory = type;
            }
            currentSubcategory = '';

            // Update search placeholder
            updateSearchPlaceholder();
            updateClearFilterButton();

            // Reload library
            libraryPage = 1;
            loadLibrary();
        }

        // Toggle collapsible genre groups
        function toggleGenreGroup(headerEl) {
            const groupEl = headerEl.closest('.genre-group');
            if (groupEl) {
                groupEl.classList.toggle('collapsed');
            }
        }

        function selectGenre(genre) {
            currentGenre = genre;
            currentQuickFilter = '';

            // Update genre active states
            document.querySelectorAll('.genre-item').forEach(item => {
                item.classList.toggle('active', item.dataset.genre === genre);
            });
            document.querySelectorAll('.quick-filter-btn').forEach(btn => btn.classList.remove('active'));

            // Always set the subcategory for filtering
            currentSubcategory = genre;

            // Determine model type based on which section the genre is in
            // Music genres are in .music-genres, SFX genres are in .sfx-genres, Speech in .speech-genres
            const genreEl = document.querySelector(`.genre-item[data-genre="${genre}"]`);
            if (genreEl) {
                if (genreEl.closest('.music-genres')) {
                    currentCategory = 'music';
                } else if (genreEl.closest('.sfx-genres')) {
                    currentCategory = 'audio';
                } else if (genreEl.closest('.speech-genres')) {
                    currentCategory = 'voice';
                }
            }

            updateSearchPlaceholder();
            updateClearFilterButton();

            libraryPage = 1;
            loadLibrary();
        }

        function selectQuickFilter(filter) {
            currentQuickFilter = filter;
            currentGenre = '';

            // Update active states
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            document.querySelectorAll('.genre-item').forEach(item => item.classList.remove('active'));

            if (filter === 'favorites') {
                currentCategory = 'favorites';
                currentSubcategory = '';
            } else if (filter === 'recent') {
                currentCategory = '';
                currentSubcategory = '';
                // Recent sorting would be handled in library load
            }

            updateSearchPlaceholder();
            updateClearFilterButton();

            libraryPage = 1;
            loadLibrary();
        }

        function clearAllFilters() {
            // Keep the current top-level type tab (Music, SFX, Speech, Graphlings)
            // Only clear sub-filters
            currentGenre = '';
            currentQuickFilter = '';
            currentCategory = '';
            currentSubcategory = '';

            // Clear Graphlings filters
            currentGraphlingsSource = '';
            currentGraphlingsModel = '';

            // Clear search box
            const searchInput = document.getElementById('library-search');
            if (searchInput) searchInput.value = '';

            // Reset active states on sub-filters only
            document.querySelectorAll('.genre-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.quick-filter-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.graphlings-type-item').forEach(item => item.classList.remove('active'));

            // Collapse all expanded menus
            document.querySelectorAll('.graphlings-source').forEach(source => source.classList.remove('expanded'));
            document.querySelectorAll('.genre-group').forEach(group => group.classList.add('collapsed'));

            updateSearchPlaceholder();
            updateClearFilterButton();

            libraryPage = 1;
            loadLibrary();
        }

        function updateSearchPlaceholder() {
            const searchInput = document.getElementById('library-search');
            if (currentQuickFilter === 'favorites') {
                searchInput.placeholder = 'Search your favorites...';
            } else if (currentGraphlingsSource) {
                const sourceName = graphlingsSources[currentGraphlingsSource]?.name || currentGraphlingsSource;
                searchInput.placeholder = `Search ${sourceName} audio...`;
            } else if (currentGenre) {
                searchInput.placeholder = `Search ${currentGenre} sounds...`;
            } else if (currentTypeTab === 'music') {
                searchInput.placeholder = 'Search music tracks...';
            } else if (currentTypeTab === 'audio') {
                searchInput.placeholder = 'Search sound effects...';
            } else if (currentTypeTab === 'graphlings') {
                searchInput.placeholder = 'Search Graphlings game audio...';
            } else {
                searchInput.placeholder = 'Search music, sound effects, prompts...';
            }
        }

        function updateClearFilterButton() {
            const btn = document.getElementById('clear-filter-btn');
            const searchInput = document.getElementById('library-search');
            const hasSearch = searchInput && searchInput.value.trim().length > 0;
            const hasFilters = currentGenre || currentQuickFilter || currentGraphlingsSource || hasSearch;
            btn.style.display = hasFilters ? 'flex' : 'none';
        }

        async function loadCategoryCounts() {
            try {

                // Get per-category/genre counts
                const catResponse = await fetch('/api/library/category-counts');
                if (catResponse.ok) {
                    const counts = await catResponse.json();
                    // Update each genre item count badge
                    document.querySelectorAll('.genre-item').forEach(item => {
                        const genre = item.dataset.genre;
                        const countEl = item.querySelector('.genre-count');
                        if (countEl && counts[genre] !== undefined) {
                            countEl.textContent = counts[genre];
                        }
                    });
                }
            } catch (err) {
                console.error('Failed to load category counts:', err);
            }
        }

        function renderLibraryItem(item) {
            // Store item data for modal access
            libraryItemsData[item.id] = item;

            const userVote = userVotes[item.id] || 0;
            const upClass = userVote === 1 ? 'voted' : '';
            const downClass = userVote === -1 ? 'voted' : '';
            const isFavorited = userFavorites && userFavorites.has ? userFavorites.has(item.id) : false;
            const favClass = isFavorited ? 'favorited' : '';
            const favIcon = isFavorited ? '#icon-heart' : '#icon-heart-outline';

            // Only show "View Feedback" button to adult accounts
            const viewFeedbackBtn = isAdultAccount
                ? `<button class="comments-btn" onclick="viewFeedback('${escapeJsString(item.id)}')" title="View feedback">
                    <svg class="icon"><use href="#icon-library"/></svg> Feedback
                   </button>`
                : '';

            const modelIcon = item.model === 'music' ? '#icon-music' : item.model === 'voice' ? '#icon-mic' : '#icon-volume';
            const modelClass = item.model === 'music' ? 'music' : item.model === 'voice' ? 'voice' : 'audio';
            const modelTitle = item.model === 'music' ? 'Music' : item.model === 'voice' ? 'Speech' : 'Sound Effect';

            // Voice-specific info for speech clips
            let voiceInfoHtml = '';
            if (item.model === 'voice') {
                // Parse categories to find gender and accent
                let categories = [];
                try {
                    categories = typeof item.category === 'string' ? JSON.parse(item.category) : (item.category || []);
                } catch (e) { categories = []; }

                const isFemale = categories.includes('female');
                const isMale = categories.includes('male');
                const isBritish = categories.includes('british');
                const isAmerican = categories.includes('american');

                // Extract voice name from voice_id (e.g., 'en_GB-vctk-medium' -> 'VCTK')
                let voiceName = '';
                if (item.voice_id) {
                    const parts = item.voice_id.split('-');
                    if (parts.length >= 2) {
                        voiceName = parts[1].toUpperCase();
                    }
                }

                const genderTag = isFemale ? '<span class="voice-gender-tag female">Female</span>' :
                                  isMale ? '<span class="voice-gender-tag male">Male</span>' : '';
                const accentTag = isBritish ? '<span class="voice-accent-tag">UK</span>' :
                                  isAmerican ? '<span class="voice-accent-tag">US</span>' : '';
                const voiceTag = voiceName ? `<span class="voice-name-tag">${escapeHtml(voiceName)}</span>` : '';

                voiceInfoHtml = `
                    <span class="voice-info-tags">
                        ${genderTag}${accentTag}${voiceTag}
                    </span>
                `;
            }

            return `
                <div class="library-item" data-id="${item.id}" data-model="${item.model || 'music'}">
                    <div class="item-header">
                        <div class="model-badge ${modelClass}" title="${modelTitle}">
                            <svg class="icon"><use href="${modelIcon}"/></svg>
                        </div>
                        <div class="item-info">
                            <div class="prompt" title="${escapeHtml(item.prompt)}">${escapeHtml(item.prompt)}</div>
                            <div class="item-meta">
                                <span class="duration" title="Duration">
                                    <svg class="icon"><use href="#icon-clock"/></svg>
                                    ${Number(item.duration).toFixed(1)}s
                                </span>
                                ${voiceInfoHtml}
                            </div>
                        </div>
                    </div>
                    <div class="styled-audio">
                        <audio controls src="/audio/${encodeURIComponent(item.filename)}" onplay="stopOtherAudio(this)"></audio>
                    </div>
                    <div class="item-actions">
                        <button class="action-btn favorite-btn ${favClass}" onclick="toggleLibraryFavorite('${escapeJsString(item.id)}')" title="${isFavorited ? 'Remove from favorites' : 'Add to favorites'}">
                            <svg class="icon"><use href="${favIcon}"/></svg>
                        </button>
                        <button class="action-btn vote-up ${upClass}" onclick="showLibraryPositiveFeedback('${escapeJsString(item.id)}')" title="Like this track">
                            <svg class="icon"><use href="#icon-thumb-up"/></svg>
                            <span class="vote-count">${item.upvotes || 0}</span>
                        </button>
                        <button class="action-btn vote-down ${downClass}" onclick="showLibraryFeedback('${escapeJsString(item.id)}')" title="Dislike this track">
                            <svg class="icon"><use href="#icon-thumb-down"/></svg>
                            <span class="vote-count">${item.downvotes || 0}</span>
                        </button>
                        <button class="action-btn" onclick="showAddToPlaylistModal('${escapeJsString(item.id)}')" title="Add to playlist">
                            <svg class="icon"><use href="#icon-plus"/></svg>
                        </button>
                        <button class="action-btn" onclick="showTagSuggestionModal('${escapeJsString(item.id)}')" title="Review">
                            <svg class="icon"><use href="#icon-tag"/></svg>
                        </button>
                        <button class="action-btn copy-id-btn" onclick="copyLibraryItemId('${escapeJsString(item.id)}')" title="Copy unique ID to clipboard">
                            <svg class="icon"><use href="#icon-copy"/></svg>
                            <span>ID</span>
                        </button>
                        <button class="action-btn share-btn" onclick="copyShareLink('${escapeJsString(item.id)}')" title="Copy shareable link">
                            <svg class="icon"><use href="#icon-share"/></svg>
                        </button>
                        ${viewFeedbackBtn}
                        <button class="action-btn download" onclick="downloadTrack('${escapeJsString(item.filename)}')" title="Download">
                            <svg class="icon"><use href="#icon-download"/></svg>
                        </button>
                    </div>
                    <div class="feedback-view hidden" id="feedback-view-${item.id}"></div>
                </div>
            `;
        }

        // Toggle play/pause for a library item
        function toggleLibraryItemPlay(genId) {
            const item = libraryItemsData[genId];
            if (!item || !item.filename) return;

            // If this item is already playing, toggle pause
            if (currentPlayingLibraryItemId === genId && currentRadioTrack?.id === genId) {
                if (radioPlayer.paused) {
                    radioPlayer.play().catch(e => console.warn('Library play failed:', e.message));
                } else {
                    radioPlayer.pause();
                }
                updateLibraryItemPlayerUI(genId, !radioPlayer.paused);
                return;
            }

            // Play this item
            playLibraryItemNow(genId);
        }

        // Update the library item player UI
        function updateLibraryItemPlayerUI(genId, isPlaying) {
            // Reset all other items
            document.querySelectorAll('.library-player-controls').forEach(el => {
                el.classList.remove('playing');
            });
            document.querySelectorAll('.library-player-inline').forEach(el => {
                el.classList.add('hidden');
            });
            document.querySelectorAll('.skip-btn').forEach(el => {
                el.classList.add('hidden');
            });
            document.querySelectorAll('.play-now-btn use').forEach(el => {
                el.setAttribute('href', '#icon-play');
            });

            if (genId && isPlaying) {
                const controls = document.getElementById(`player-controls-${genId}`);
                const inlinePlayer = document.getElementById(`inline-player-${genId}`);
                const skipBtn = document.getElementById(`skip-btn-${genId}`);
                const playBtn = document.getElementById(`play-btn-${genId}`);

                if (controls) controls.classList.add('playing');
                if (inlinePlayer) inlinePlayer.classList.remove('hidden');
                if (skipBtn) skipBtn.classList.remove('hidden');
                if (playBtn) {
                    const icon = playBtn.querySelector('use');
                    if (icon) icon.setAttribute('href', '#icon-pause');
                }
            }
        }

        // Update inline progress for the currently playing library item
        function updateLibraryItemProgress() {
            if (!currentPlayingLibraryItemId) return;

            const progressBar = document.getElementById(`progress-${currentPlayingLibraryItemId}`);
            const timeEl = document.getElementById(`time-${currentPlayingLibraryItemId}`);

            if (progressBar && radioPlayer.duration) {
                const percent = (radioPlayer.currentTime / radioPlayer.duration) * 100;
                progressBar.style.width = percent + '%';
            }

            if (timeEl) {
                const current = Math.floor(radioPlayer.currentTime);
                const mins = Math.floor(current / 60);
                const secs = current % 60;
                timeEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }

        // Seek within the currently playing item
        function seekLibraryItem(event, genId) {
            if (currentPlayingLibraryItemId !== genId) return;

            const progressContainer = event.currentTarget;
            const rect = progressContainer.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            radioPlayer.currentTime = percent * radioPlayer.duration;
        }

        // Skip from the library item (same as regular skip)
        function skipFromLibraryItem() {
            skipTrack();
        }

        // Play library item now through the radio player
        function playLibraryItemNow(genId) {
            const item = libraryItemsData[genId];
            if (!item || !item.filename) return;

            // Save current track to recently played
            if (currentRadioTrack) {
                recentlyPlayed.push(currentRadioTrack);
                if (recentlyPlayed.length > 20) {
                    recentlyPlayed = recentlyPlayed.slice(-20);
                }
            }

            // Set as current track
            currentRadioTrack = item;

            // Add to play history
            if (item.id && !playHistory.includes(item.id)) {
                playHistory.push(item.id);
                if (playHistory.length > MAX_HISTORY) {
                    playHistory = playHistory.slice(-MAX_HISTORY);
                }
            }

            // Show now playing section
            nowPlayingEl.classList.remove('hidden');

            // Update now playing display
            document.getElementById('radio-prompt').textContent = item.prompt;
            document.getElementById('radio-duration').textContent = Number(item.duration).toFixed(1) + 's';
            document.getElementById('radio-upvotes').textContent = item.upvotes || 0;
            document.getElementById('radio-downvotes').textContent = item.downvotes || 0;
            updateRadioVoiceInfo(item);

            // Reset vote button states
            document.getElementById('radio-vote-up').classList.remove('voted-up');
            document.getElementById('radio-vote-down').classList.remove('voted-down');

            // Load user's vote and favorite status
            loadRadioTrackVote();
            checkRadioTrackFavorite();

            // Enable radio controls
            updateRadioControlsState();

            // Play the audio
            autoUnmuteOnPlay();
            radioPlayer.src = '/audio/' + encodeURIComponent(item.filename);
            radioPlayer.play().catch(e => console.warn('Library item play failed:', e.message));

            // Update queue display
            updateRadioQueue();

            // Track which library item is playing
            currentPlayingLibraryItemId = genId;

            // Update library item player UI
            updateLibraryItemPlayerUI(genId, true);

            // Update mini-player
            updateMiniPlayer();

            showFeedbackToast('Now playing');
        }

        // Update playing indicators in the library
        function updateLibraryPlayingIndicators(activeId) {
            // Hide all playing indicators
            document.querySelectorAll('.library-item-playing').forEach(el => {
                el.classList.add('hidden');
            });

            // Show the active one
            if (activeId) {
                const indicator = document.getElementById(`playing-indicator-${activeId}`);
                if (indicator) {
                    indicator.classList.remove('hidden');
                }
            }
        }

        // Add item to radio queue
        function addToRadioQueue(genId) {
            const item = libraryItemsData[genId];
            if (item) {
                radioQueue.push(item);
                showFeedbackToast('Added to queue');
                updateQueueDisplay();

                // If nothing is playing, start playing
                if (!currentRadioTrack) {
                    playNextTrack();
                }
            }
        }

        // Toggle library item favorite
        async function toggleLibraryFavorite(genId) {
            // Require authentication to favorite
            if (!isUserAuthenticated()) {
                showLoginPrompt('favorite tracks');
                return;
            }

            if (!userFavorites) userFavorites = new Set();

            const isFavorited = userFavorites.has(genId);
            const actionBtn = document.querySelector(`.library-item[data-id="${genId}"] .action-btn.favorite-btn`);
            const actionIcon = actionBtn?.querySelector('use');
            try {
                // Use authFetch - user_id is derived from verified auth token on server
                if (isFavorited) {
                    await authFetch(`/api/favorites/${genId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    userFavorites.delete(genId);
                    actionBtn?.classList.remove('favorited');
                    if (actionIcon) actionIcon.setAttribute('href', '#icon-heart-outline');
                    showFeedbackToast('Removed from favorites');
                } else {
                    await authFetch(`/api/favorites/${genId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    userFavorites.add(genId);
                    actionBtn?.classList.add('favorited');
                    if (actionIcon) actionIcon.setAttribute('href', '#icon-heart');
                    showFeedbackToast('Added to favorites');
                }
            } catch (err) {
                console.error('Failed to toggle favorite:', err);
            }
        }

        // Library feedback shortcuts - open modal or toggle vote off
        function showLibraryPositiveFeedback(genId) {
            // Require authentication to vote
            if (!isUserAuthenticated()) {
                showLoginPrompt('rate tracks');
                return;
            }

            const item = libraryItemsData[genId];
            if (!item) return;

            const currentVote = userVotes[genId] || 0;

            // If already upvoted, clear the vote (toggle off)
            if (currentVote === 1) {
                clearLibraryVote(genId);
                return;
            }

            // Otherwise open feedback modal
            openFeedbackModal(item, true, 'library');
        }

        function showLibraryFeedback(genId) {
            // Require authentication to vote
            if (!isUserAuthenticated()) {
                showLoginPrompt('rate tracks');
                return;
            }

            const item = libraryItemsData[genId];
            if (!item) return;

            const currentVote = userVotes[genId] || 0;

            // If already downvoted, clear the vote (toggle off)
            if (currentVote === -1) {
                clearLibraryVote(genId);
                return;
            }

            // Otherwise open feedback modal
            openFeedbackModal(item, false, 'library');
        }

        // Clear a library vote (toggle off)
        async function clearLibraryVote(genId) {
            // Require authentication to vote
            if (!isUserAuthenticated()) {
                showLoginPrompt('rate tracks');
                return;
            }

            try {
                const response = await authFetch(`/api/library/${genId}/vote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vote: 0 })
                });
                const data = await response.json();

                // Update local state
                userVotes[genId] = 0;

                // Update UI
                const item = document.querySelector(`[data-id="${genId}"]`);
                if (item) {
                    const upBtn = item.querySelector('.vote-up');
                    const downBtn = item.querySelector('.vote-down');
                    if (upBtn) {
                        upBtn.classList.remove('voted');
                        const upCount = upBtn.querySelector('.vote-count');
                        if (upCount) upCount.textContent = data.upvotes || 0;
                    }
                    if (downBtn) {
                        downBtn.classList.remove('voted');
                        const downCount = downBtn.querySelector('.vote-count');
                        if (downCount) downCount.textContent = data.downvotes || 0;
                    }
                }
                showFeedbackToast('Vote removed');
            } catch (err) {
                console.error('Failed to clear vote:', err);
                showErrorToast('Failed to remove vote');
            }
        }

        // View feedback - only available to adult accounts
        async function viewFeedback(genId) {
            if (!isAdultAccount) {
                showFeedbackToast('Adult account required to view feedback');
                return;
            }

            const viewEl = document.getElementById('feedback-view-' + genId);

            if (!viewEl.classList.contains('hidden')) {
                viewEl.classList.add('hidden');
                return;
            }

            viewEl.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 10px;">Loading feedback...</div>';
            viewEl.classList.remove('hidden');

            try {
                const response = await fetch(`/api/library/${genId}/feedback`);
                const data = await response.json();

                const { positive, negative, reclassify } = data;

                const hasPositive = Object.keys(positive).length > 0;
                const hasNegative = Object.keys(negative).length > 0;
                const hasReclassify = reclassify && (reclassify.music > 0 || reclassify.audio > 0);

                if (!hasPositive && !hasNegative && !hasReclassify) {
                    viewEl.innerHTML = '<div style="color: var(--text-muted); padding: 10px; font-size: 0.85rem;">No feedback yet</div>';
                    return;
                }

                let html = '<div style="padding: 12px; font-size: 0.85rem;">';

                if (hasPositive) {
                    html += '<div style="color: var(--success); margin-bottom: 8px;"><strong>Positive:</strong> ';
                    html += Object.entries(positive).map(([k, v]) => `${k} (${v})`).join(', ');
                    html += '</div>';
                }

                if (hasNegative) {
                    html += '<div style="color: var(--error); margin-bottom: 8px;"><strong>Issues:</strong> ';
                    html += Object.entries(negative).map(([k, v]) => `${k} (${v})`).join(', ');
                    html += '</div>';
                }

                if (hasReclassify) {
                    html += '<div style="color: var(--cyan);"><strong>Reclassify suggestions:</strong> ';
                    const suggestions = [];
                    if (reclassify.music > 0) suggestions.push(`Music (${reclassify.music})`);
                    if (reclassify.audio > 0) suggestions.push(`Sound Effect (${reclassify.audio})`);
                    html += suggestions.join(', ');
                    html += '</div>';
                }

                html += '</div>';
                viewEl.innerHTML = html;

            } catch (err) {
                viewEl.innerHTML = '<div style="color: var(--error); padding: 10px;">Failed to load feedback</div>';
            }
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return 'just now';
            if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
            if (diff < 604800) return Math.floor(diff / 86400) + 'd ago';
            return date.toLocaleDateString();
        }

        function prevPage() {
            if (libraryPage > 1) {
                libraryPage--;
                loadLibrary();
                // Smooth scroll to library section
                document.querySelector('.library-card')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function nextPage() {
            if (libraryPage < libraryPages) {
                libraryPage++;
                loadLibrary();
                // Smooth scroll to library section
                document.querySelector('.library-card')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Search debounce
        if (librarySearchEl) {
            librarySearchEl.addEventListener('input', () => {
                clearTimeout(searchDebounceTimer);
                // Update clear button visibility immediately
                updateClearFilterButton();
                searchDebounceTimer = setTimeout(() => {
                    libraryPage = 1;
                    loadLibrary();
                }, 300);
            });
        }

        // Filter change handlers with localStorage persistence
        if (libraryModelEl) {
            libraryModelEl.addEventListener('change', () => {
                libraryPage = 1;
                localStorage.setItem('soundbox_library_model', libraryModelEl.value);
                loadLibrary();
            });
        }

        if (librarySortEl) {
            librarySortEl.addEventListener('change', () => {
                libraryPage = 1;
                localStorage.setItem('soundbox_library_sort', librarySortEl.value);
                loadLibrary();
            });
        }

        // Restore saved filter preferences
        (function restoreFilters() {
            const savedModel = localStorage.getItem('soundbox_library_model');
            const savedSort = localStorage.getItem('soundbox_library_sort');
            const savedRadioModel = localStorage.getItem('soundbox_radio_model');

            if (savedModel && libraryModelEl) {
                libraryModelEl.value = savedModel;
            }
            if (savedSort && librarySortEl) {
                librarySortEl.value = savedSort;
            }
            if (savedRadioModel) {
                const radioModelEl = document.getElementById('radio-model');
                if (radioModelEl) radioModelEl.value = savedRadioModel;
            }
        })();

        // ========================================
        // COLLAPSIBLE GENERATOR
        // ========================================
        function toggleGenerator() {
            const card = document.getElementById('generator-card');
            card.classList.toggle('collapsed');
            // Save preference
            localStorage.setItem('generator_collapsed', card.classList.contains('collapsed'));
        }

        // Restore generator state
        (function() {
            const collapsed = localStorage.getItem('generator_collapsed') === 'true';
            if (collapsed) {
                document.getElementById('generator-card')?.classList.add('collapsed');
            }
        })();

        // ========================================
        // QUEUE EXPLORER
        // ========================================
        let queueExplorerInterval = null;
        let isLoadingQueueExplorer = false;  // Guard to prevent overlapping fetches

        function toggleQueueExplorer() {
            const card = document.getElementById('server-status-card');
            card.classList.toggle('collapsed');
            const isCollapsed = card.classList.contains('collapsed');
            localStorage.setItem('queue_explorer_collapsed', isCollapsed);

            // Start/stop polling based on visibility
            if (!isCollapsed) {
                loadQueueExplorer();
                startQueuePolling();
            } else {
                stopQueuePolling();
            }
        }

        function startQueuePolling() {
            if (queueExplorerInterval) return;
            queueExplorerInterval = setInterval(loadQueueExplorer, 1500);
        }

        function stopQueuePolling() {
            if (queueExplorerInterval) {
                clearInterval(queueExplorerInterval);
                queueExplorerInterval = null;
            }
        }

        async function loadQueueExplorer() {
            // Prevent overlapping fetches if previous call is still running
            if (isLoadingQueueExplorer) return;
            isLoadingQueueExplorer = true;

            try {
                const response = await fetch('/api/queue');
                const data = await response.json();

                const badge = document.getElementById('queue-explorer-badge');
                const list = document.getElementById('queue-explorer-list');
                const empty = document.getElementById('queue-empty');
                const userId = getEffectiveUserId();

                // Update badge
                badge.textContent = data.total;
                badge.classList.toggle('empty', data.total === 0);

                if (data.jobs.length === 0) {
                    list.innerHTML = '';
                    empty.style.display = 'block';
                    return;
                }

                empty.style.display = 'none';

                // Render queue items
                list.innerHTML = data.jobs.map(job => {
                    const isProcessing = job.status === 'processing';
                    const isOwnJob = job.user_id === userId;
                    const modelBadgeClass = job.model === 'audio' ? 'audio' : '';
                    const priorityClass = job.priority === 'admin' ? 'admin' : job.priority === 'premium' ? 'premium' : '';

                    let progressHtml = '';
                    if (isProcessing && job.progress_pct > 0) {
                        progressHtml = `
                            <div class="queue-item-progress">
                                <div class="progress-bar">
                                    <div class="fill" style="width: ${job.progress_pct}%"></div>
                                </div>
                                <span class="progress-text">${escapeHtml(job.progress || 'Processing...')}</span>
                            </div>
                        `;
                    } else if (isProcessing) {
                        progressHtml = `
                            <div class="queue-item-progress">
                                <span class="progress-text">${escapeHtml(job.progress || 'Starting...')}</span>
                            </div>
                        `;
                    }

                    const cancelBtn = (isOwnJob && !isProcessing) ?
                        `<button class="cancel-btn" onclick="cancelQueueJob('${escapeJsString(job.id)}')" title="Cancel job"></button>` : '';

                    return `
                        <div class="queue-item ${isProcessing ? 'processing' : ''} ${isOwnJob ? 'own-job' : ''}">
                            <div class="queue-item-position">#${job.position}</div>
                            <div class="queue-item-info">
                                <div class="queue-item-prompt">${escapeHtml(job.prompt)}</div>
                                <div class="queue-item-meta">
                                    <span class="model-badge ${modelBadgeClass}"><svg class="icon icon-sm" style="vertical-align: -2px; margin-right: 2px;"><use href="${job.model === 'music' ? '#icon-music' : '#icon-volume'}"/></svg>${job.model === 'music' ? 'Music' : 'SFX'}</span>
                                    <span class="duration-badge">${Number(job.duration).toFixed(1)}s</span>
                                    ${job.priority !== 'standard' ? `<span class="priority-badge ${priorityClass}">${job.priority}</span>` : ''}
                                </div>
                                ${progressHtml}
                            </div>
                            ${cancelBtn}
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error('Failed to load queue:', err);
            } finally {
                isLoadingQueueExplorer = false;
            }
        }

        async function cancelQueueJob(jobId) {
            if (!confirm('Cancel this generation?')) return;

            try {
                // Use authFetch - user_id is now verified from auth token on server
                const response = await authFetch(`/api/queue/${jobId}/cancel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    showFeedbackToast('Job cancelled');
                    loadQueueExplorer();
                } else {
                    showFeedbackToast(data.error || 'Failed to cancel', 'error');
                }
            } catch (err) {
                showFeedbackToast('Failed to cancel job', 'error');
            }
        }

        // Queue explorer always starts collapsed for cleaner UX
        // User can expand it manually if needed
        (function() {
            // Intentionally not restoring from localStorage - always start collapsed
        })();

        // ========================================
        // GLOBAL MUTE FUNCTIONALITY
        // ========================================
        let isGlobalMuted = false;

        function syncMuteButtons(muted) {
            // Sync both desktop and mobile mute buttons
            document.querySelectorAll('.global-mute-btn').forEach(btn => {
                btn.classList.toggle('muted', muted);
            });
        }

        function toggleGlobalMute() {
            isGlobalMuted = !isGlobalMuted;
            syncMuteButtons(isGlobalMuted);

            // Mute/unmute all audio elements on the page
            document.querySelectorAll('audio').forEach(audio => {
                audio.muted = isGlobalMuted;
            });

            // Save preference
            localStorage.setItem('soundbox_muted', isGlobalMuted);
        }

        // Auto-unmute when user explicitly plays audio
        function autoUnmuteOnPlay() {
            if (isGlobalMuted) {
                isGlobalMuted = false;
                syncMuteButtons(false);
                document.querySelectorAll('audio').forEach(audio => {
                    audio.muted = false;
                });
                localStorage.setItem('soundbox_muted', 'false');
            }
        }

        // Restore mute state and apply to new audio elements
        function initMuteState() {
            isGlobalMuted = localStorage.getItem('soundbox_muted') === 'true';
            syncMuteButtons(isGlobalMuted);

            // Watch for new audio elements and apply mute state
            const observer = new MutationObserver(mutations => {
                if (isGlobalMuted) {
                    document.querySelectorAll('audio').forEach(audio => {
                        audio.muted = true;
                    });
                }
            });
            observer.observe(document.body, { childList: true, subtree: true });

            // Auto-unmute when user clicks play on any audio element
            document.addEventListener('play', function(e) {
                if (e.target.tagName === 'AUDIO') {
                    autoUnmuteOnPlay();
                }
            }, true);
        }

        // ========================================
        // AUTO-START RADIO WITH AMBIENT
        // ========================================
        function autoStartRadio() {
            // Pre-select Ambient station visually (always show full UI)
            const ambientCard = document.querySelector('.station-card.station-ambient');
            if (ambientCard) {
                ambientCard.classList.add('active');
                currentStation = 'ambient';
            }

            // Load tracks for queue display (but don't play audio)
            preloadStation('ambient', ambientCard);

            // Show click-to-play banner if we haven't started audio yet
            if (!sessionStorage.getItem('soundbox_started')) {
                setTimeout(() => {
                    showStartPlayingBanner();
                }, 300);
            }
        }

        async function preloadStation(stationId, element) {
            const model = document.getElementById('radio-model').value;
            const keywords = element?.dataset.keywords || '';

            try {
                const params = new URLSearchParams({ model, count: 10 });
                if (keywords) params.set('search', keywords);

                const response = await fetch('/api/radio/shuffle?' + params.toString());
                const data = await response.json();

                if (data.tracks && data.tracks.length > 0) {
                    radioQueue = data.tracks;
                    updateRadioQueue();
                    showNowPlayingPreview(radioQueue[0]);
                }
            } catch (err) {
                console.error('Preload station failed:', err);
            }
        }

        function showNowPlayingPreview(track) {
            // Show now-playing section with track info (but don't play)
            const nowPlaying = document.querySelector('.now-playing');
            const radioQueue = document.getElementById('radio-queue');

            if (nowPlaying) {
                nowPlaying.classList.remove('hidden');

                // Update track info
                const promptEl = document.getElementById('now-prompt');
                if (promptEl) promptEl.textContent = track.prompt || 'Unknown Track';

                // Set audio source but don't play
                const audio = document.getElementById('radio-player');
                if (audio) {
                    audio.src = `/audio/${encodeURIComponent(track.filename)}`;
                }

                // Show paused state for EQ visualizer
                const eq = document.querySelector('.eq-visualizer');
                if (eq) eq.classList.add('paused');
            }

            if (radioQueue) {
                radioQueue.classList.remove('hidden');
            }
        }

        function showStartPlayingBanner() {
            // Create overlay for clicking to start
            const banner = document.createElement('div');
            banner.id = 'start-playing-banner';
            banner.innerHTML = `
                <div class="start-banner-content" onclick="startPlayingFromBanner()">
                    <svg class="start-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    <div class="start-text">
                        <h3>Click to Start Radio</h3>
                        <p>Ambient station ready to play</p>
                    </div>
                </div>
            `;
            banner.className = 'start-playing-banner';

            // Insert after the radio stations grid
            const radioStations = document.querySelector('.radio-stations');
            if (radioStations) {
                radioStations.after(banner);
            }
        }

        function startPlayingFromBanner() {
            // Mark as started
            sessionStorage.setItem('soundbox_started', 'true');

            // Remove banner
            const banner = document.getElementById('start-playing-banner');
            if (banner) {
                banner.classList.add('fading');
                setTimeout(() => banner.remove(), 300);
            }

            // Start the Ambient station
            const ambientCard = document.querySelector('.station-card.station-ambient');
            if (ambientCard) {
                startStation('ambient', ambientCard);
            }
        }

        // Initialize
        initMuteState();
        loadLibrary();
        loadCategoryCounts();
        checkStatus();
        generateBtn.disabled = true;

        // Handle shared track link (/track/<id>)
        async function loadSharedTrack() {
            if (!sharedTrackId) return;

            try {
                const res = await fetch(`/api/library/${sharedTrackId}`);
                if (!res.ok) {
                    showErrorToast('Track not found');
                    return;
                }
                const track = await res.json();

                // Switch to library tab
                switchTab('library');

                // Put track in search box and search for it
                if (librarySearchEl) {
                    librarySearchEl.value = sharedTrackId;
                }

                // Show the track in library results
                await loadLibrary();

                // Auto-play the track in radio
                if (track.filename) {
                    radioQueue.unshift(track);
                    playNextTrack();
                    showSuccessToast(`Now playing: ${track.prompt?.substring(0, 50) || 'Shared track'}...`);
                }
            } catch (e) {
                console.error('Failed to load shared track:', e);
                showErrorToast('Failed to load shared track');
            }
        }

        // Load shared track if present
        if (sharedTrackId) {
            loadSharedTrack();
        } else {
            // Auto-start radio only if not loading a shared track
            autoStartRadio();
        }
    </script>

    <!-- Graphlings Widget Integration (disabled in open access mode) -->
    <script>
        // Auto-detect environment for Graphlings SDK
        (function() {
            // Skip Graphlings SDK entirely in open access mode
            if (typeof OPEN_ACCESS_MODE !== 'undefined' && OPEN_ACCESS_MODE) {
                console.log('[SoundBox] Open access mode - Graphlings SDK disabled');
                return;
            }
            const hostname = window.location.hostname;
            const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
            const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';

            // Check if hostname is a Tailscale IP (100.64.0.0/10 CGNAT range)
            function isTailscaleIP(host) {
                const ipMatch = host.match(/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/);
                if (!ipMatch) return false;
                const [, a, b] = ipMatch.map(Number);
                return a === 100 && b >= 64 && b <= 127;
            }
            const isTailscale = hostname.endsWith('.ts.net') || isTailscaleIP(hostname);

            const SDK_CONFIG = {
                appId: 'sfx-music',
                // Auto-detect: localhost, Tailscale, or production
                accountsUrl: isLocalhost
                    ? 'http://localhost:8002'
                    : isTailscale
                        ? `http://${hostname}:8002`
                        : 'https://accounts.graphlings.net',
                debug: false
            };

            // Set favicon from accounts server
            const faviconLink = document.getElementById('favicon-link');
            if (faviconLink) {
                faviconLink.href = SDK_CONFIG.accountsUrl + '/static/graphlings/logo-104.png';
            }

            // Dynamically load SDK from accounts server
            const sdkScript = document.createElement('script');
            sdkScript.src = SDK_CONFIG.accountsUrl + '/sdk/graphlings.js';
            document.head.appendChild(sdkScript);

            // Wait for SDK to load and initialize (with timeout)
            function waitForSDK(callback, startTime = Date.now()) {
                const timeout = 10000;  // 10 second timeout
                if (typeof Graphlings !== 'undefined') {
                    callback();
                } else if (Date.now() - startTime > timeout) {
                    console.error('SDK failed to load within timeout');
                    // Continue without SDK - user can still use the app
                } else {
                    setTimeout(() => waitForSDK(callback, startTime), 50);
                }
            }

            // Theme definitions - 'default' is the original Sound Box purple/cyan theme
            const THEMES = {
                default: {
                    accent: '#a855f7',
                    accentGlow: 'rgba(168, 85, 247, 0.4)',
                    secondary: '#c084fc',
                    secondaryGlow: 'rgba(192, 132, 252, 0.3)',
                    gradientAccent: 'linear-gradient(135deg, #a855f7 0%, #6366f1 100%)',
                    gradientSecondary: 'linear-gradient(135deg, #c084fc 0%, #a855f7 100%)',
                    success: '#10b981',
                    cardBorder: 'rgba(168, 85, 247, 0.2)',
                    chipBg: 'rgba(168, 85, 247, 0.1)',
                    chipBorder: 'rgba(168, 85, 247, 0.3)'
                },
                graphlings: {
                    accent: '#a855f7',
                    accentGlow: 'rgba(168, 85, 247, 0.4)',
                    secondary: '#c084fc',
                    secondaryGlow: 'rgba(192, 132, 252, 0.3)',
                    gradientAccent: 'linear-gradient(135deg, #a855f7 0%, #6366f1 100%)',
                    gradientSecondary: 'linear-gradient(135deg, #c084fc 0%, #a855f7 100%)',
                    success: '#10b981',
                    cardBorder: 'rgba(168, 85, 247, 0.2)',
                    chipBg: 'rgba(168, 85, 247, 0.1)',
                    chipBorder: 'rgba(168, 85, 247, 0.3)'
                },
                professional: {
                    accent: '#3b82f6',
                    accentGlow: 'rgba(59, 130, 246, 0.4)',
                    secondary: '#60a5fa',
                    secondaryGlow: 'rgba(96, 165, 250, 0.3)',
                    gradientAccent: 'linear-gradient(135deg, #3b82f6 0%, #1e40af 100%)',
                    gradientSecondary: 'linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%)',
                    success: '#3b82f6',
                    cardBorder: 'rgba(59, 130, 246, 0.2)',
                    chipBg: 'rgba(59, 130, 246, 0.1)',
                    chipBorder: 'rgba(59, 130, 246, 0.3)'
                },
                ocean: {
                    accent: '#06b6d4',
                    accentGlow: 'rgba(6, 182, 212, 0.4)',
                    secondary: '#22d3ee',
                    secondaryGlow: 'rgba(34, 211, 238, 0.3)',
                    gradientAccent: 'linear-gradient(135deg, #06b6d4 0%, #0284c7 100%)',
                    gradientSecondary: 'linear-gradient(135deg, #22d3ee 0%, #06b6d4 100%)',
                    success: '#06b6d4',
                    cardBorder: 'rgba(6, 182, 212, 0.2)',
                    chipBg: 'rgba(6, 182, 212, 0.1)',
                    chipBorder: 'rgba(6, 182, 212, 0.3)'
                },
                forest: {
                    accent: '#22c55e',
                    accentGlow: 'rgba(34, 197, 94, 0.4)',
                    secondary: '#4ade80',
                    secondaryGlow: 'rgba(74, 222, 128, 0.3)',
                    gradientAccent: 'linear-gradient(135deg, #22c55e 0%, #15803d 100%)',
                    gradientSecondary: 'linear-gradient(135deg, #4ade80 0%, #22c55e 100%)',
                    success: '#22c55e',
                    cardBorder: 'rgba(34, 197, 94, 0.2)',
                    chipBg: 'rgba(34, 197, 94, 0.1)',
                    chipBorder: 'rgba(34, 197, 94, 0.3)'
                },
                princess: {
                    accent: '#ec4899',
                    accentGlow: 'rgba(236, 72, 153, 0.4)',
                    secondary: '#f472b6',
                    secondaryGlow: 'rgba(244, 114, 182, 0.3)',
                    gradientAccent: 'linear-gradient(135deg, #ec4899 0%, #db2777 100%)',
                    gradientSecondary: 'linear-gradient(135deg, #f472b6 0%, #ec4899 100%)',
                    success: '#ec4899',
                    cardBorder: 'rgba(236, 72, 153, 0.2)',
                    chipBg: 'rgba(236, 72, 153, 0.1)',
                    chipBorder: 'rgba(236, 72, 153, 0.3)'
                }
            };

            // Apply theme colors to CSS variables
            function applyTheme(themeName) {
                const theme = THEMES[themeName] || THEMES.default;
                const root = document.documentElement;

                // Core accent colors
                root.style.setProperty('--accent', theme.accent);
                root.style.setProperty('--accent-glow', theme.accentGlow);
                root.style.setProperty('--cyan', theme.secondary);
                root.style.setProperty('--cyan-glow', theme.secondaryGlow);
                root.style.setProperty('--gradient-accent', theme.gradientAccent);
                root.style.setProperty('--gradient-cyan', theme.gradientSecondary);
                root.style.setProperty('--success', theme.success);

                // Card and UI element colors
                root.style.setProperty('--card-border-accent', theme.cardBorder);
                root.style.setProperty('--chip-bg', theme.chipBg);
                root.style.setProperty('--chip-border', theme.chipBorder);

                // Save to localStorage for persistence
                localStorage.setItem('soundbox_theme', themeName);
            }

            // Load saved theme on page load
            function loadSavedTheme() {
                const savedTheme = localStorage.getItem('soundbox_theme');
                if (savedTheme && THEMES[savedTheme]) {
                    applyTheme(savedTheme);
                }
            }

            // Load theme immediately
            loadSavedTheme();

            waitForSDK(function() {
                window.graphlings = new Graphlings(SDK_CONFIG);
                window.graphlings.createWidget({
                    container: '#wallet-widget-container'
                });

                // Listen for theme changes from the widget
                window.graphlings.on('themeChanged', function(data) {
                    applyTheme(data.theme);
                });

                // Listen for login to get user ID
                window.graphlings.on('login', function(data) {
                    if (data.user && data.user.id) {
                        currentUserId = data.user.id;
                        // Store token if provided in event data
                        if (data.token) {
                            localStorage.setItem('graphlings_sfx-music_token', data.token);
                        }
                        // Also check user object for token
                        if (data.user.token) {
                            localStorage.setItem('graphlings_sfx-music_token', data.user.token);
                        }
                        // Check SDK for getToken method
                        if (typeof window.graphlings.getToken === 'function') {
                            const sdkToken = window.graphlings.getToken();
                            if (sdkToken) {
                                localStorage.setItem('graphlings_sfx-music_token', sdkToken);
                            }
                        }
                        // Check if user is an adult account
                        isAdultAccount = data.user.account_type === 'adult' ||
                                        (data.user.account_type !== 'child' && !data.user.is_child);
                        updateAuthUI(true);
                        loadLibrary();  // Refresh library to show/hide feedback buttons
                        loadPlaylists(); // Load user playlists
                        loadFavorites(); // Load user favorites
                        // Update history if on history tab
                        if (currentTab === 'history') updateHistoryAuthState();
                    }
                });

                // Listen for logout to clear user ID
                window.graphlings.on('logout', function() {
                    currentUserId = null;
                    isAdultAccount = false;
                    updateAuthUI(false);
                    loadLibrary();  // Refresh library to update feedback button visibility
                    loadPlaylists(); // Clear playlists
                    loadFavorites(); // Clear favorites
                    // Update history if on history tab
                    if (currentTab === 'history') updateHistoryAuthState();
                });

                // Check if user is already logged in and apply their theme
                window.graphlings.on('widgetReady', function(data) {
                    // Apply theme from widget (overrides local storage)
                    if (data.theme && THEMES[data.theme]) {
                        applyTheme(data.theme);
                    }

                    if (data.authenticated && data.user && data.user.id) {
                        currentUserId = data.user.id;
                        // Store token if provided (from ready message)
                        if (data.token) {
                            localStorage.setItem('graphlings_sfx-music_token', data.token);
                        }
                        // Check if user is an adult account
                        isAdultAccount = data.user.account_type === 'adult' ||
                                        (data.user.account_type !== 'child' && !data.user.is_child);
                        updateAuthUI(true);
                        loadLibrary();  // Refresh library to show/hide feedback buttons
                        loadPlaylists(); // Load user playlists
                        loadFavorites(); // Load user favorites
                    } else {
                        // No user logged in, ensure controls are disabled
                        updateAuthUI(false);
                    }
                });

                // Listen for token received (sent asynchronously after ready/login)
                window.graphlings.on('tokenReceived', function(data) {
                    if (data.token) {
                        localStorage.setItem('graphlings_sfx-music_token', data.token);
                    }
                });
            });
        })();
    </script>

    <!-- Feedback Modal Overlay -->
    <div class="feedback-modal-overlay hidden" id="feedback-modal-overlay" onclick="closeFeedbackModal(event)" role="dialog" aria-modal="true" aria-labelledby="feedback-modal-title">
        <!-- Floating particles -->
        <div class="feedback-particles" id="feedback-particles"></div>
        <div class="feedback-modal" id="feedback-modal-container" onclick="event.stopPropagation()">
            <div class="feedback-modal-header">
                <span class="feedback-modal-title" id="feedback-modal-title">Rate this track</span>
                <button class="feedback-modal-close" onclick="closeFeedbackModal()" title="Close">&times;</button>
            </div>
            <div class="feedback-modal-track" id="feedback-modal-track">
                <span class="model-badge" id="feedback-modal-badge"><svg class="icon icon-sm" style="vertical-align: -2px;"><use href="#icon-music"/></svg></span>
                <span class="feedback-modal-prompt" id="feedback-modal-prompt">Loading...</span>
            </div>
            <div class="feedback-modal-section">
                <div class="feedback-modal-label" id="feedback-modal-label">What do you like?</div>
                <div class="feedback-modal-options" id="feedback-modal-options"></div>
            </div>
            <div class="feedback-modal-section">
                <div class="feedback-modal-label">Suggest reclassification:</div>
                <div class="feedback-modal-reclassify" id="feedback-modal-reclassify"></div>
            </div>
            <div class="feedback-modal-actions">
                <button class="feedback-modal-cancel" onclick="closeFeedbackModal()" title="Cancel and close">Cancel</button>
                <button class="feedback-modal-submit" id="feedback-modal-submit" onclick="submitFeedbackModal()" disabled title="Submit your feedback">Submit Feedback</button>
            </div>
        </div>
    </div>

    <!-- Tag Suggestion Modal -->
    <div class="tag-modal-overlay hidden" id="tag-modal-overlay" onclick="closeTagModal(event)" role="dialog" aria-modal="true" aria-labelledby="tag-modal-title">
        <div class="tag-modal" onclick="event.stopPropagation()">
            <div class="tag-modal-header">
                <h3 class="tag-modal-title" id="tag-modal-title">
                    <svg class="icon"><use href="#icon-tag"/></svg>
                    Review Track
                </h3>
                <button class="tag-modal-close" onclick="closeTagModal()" title="Close">&times;</button>
            </div>
            <div class="tag-modal-track" id="tag-modal-track">
                <span class="model-badge" id="tag-modal-badge"></span>
                <span class="tag-modal-prompt" id="tag-modal-prompt"></span>
            </div>
            <div class="tag-modal-current">
                <div class="tag-modal-label">Current categories:</div>
                <div class="current-tags" id="tag-modal-current-tags"></div>
            </div>
            <div class="tag-modal-suggestions-row">
                <div class="tag-modal-suggestions">
                    <div class="tag-modal-label">Pending additions:</div>
                    <div class="pending-tags pending-add" id="tag-modal-pending-add"></div>
                </div>
                <div class="tag-modal-suggestions">
                    <div class="tag-modal-label">Pending removals:</div>
                    <div class="pending-tags pending-remove" id="tag-modal-pending-remove"></div>
                </div>
            </div>
            <div class="tag-modal-section">
                <div class="tag-modal-label">Add a category:</div>
                <div class="tag-search-container">
                    <svg class="icon icon-sm tag-search-icon"><use href="#icon-search"/></svg>
                    <input type="text" id="tag-search-input" class="tag-search-input" placeholder="Search categories..." oninput="filterTagCategories(this.value)">
                </div>
                <div class="tag-recently-used hidden" id="tag-recently-used">
                    <div class="tag-modal-sublabel">Recently used:</div>
                    <div class="tag-recent-buttons" id="tag-recent-buttons"></div>
                </div>
                <div class="tag-category-groups" id="tag-category-groups"></div>
            </div>
            <div class="tag-modal-section">
                <div class="tag-modal-label">Add custom tags:</div>
                <div class="custom-tags-container">
                    <div class="current-custom-tags" id="current-custom-tags"></div>
                    <div class="custom-tag-input-container">
                        <input type="text" id="custom-tag-input" class="custom-tag-input" placeholder="Add a tag..." maxlength="30">
                        <button class="btn btn-sm btn-primary" onclick="addCustomTag()" title="Add custom tag">
                            <svg class="icon"><use href="#icon-plus"/></svg>
                            Add
                        </button>
                    </div>
                </div>
            </div>
            <div class="tag-modal-status" id="tag-modal-status"></div>
        </div>
    </div>

    <!-- Add to Playlist Modal -->
    <div class="playlist-modal-overlay hidden" id="playlist-modal-overlay" onclick="closePlaylistModal(event)" role="dialog" aria-modal="true" aria-labelledby="playlist-modal-title">
        <div class="playlist-modal" onclick="event.stopPropagation()">
            <div class="playlist-modal-header">
                <h3 class="playlist-modal-title" id="playlist-modal-title">
                    <svg class="icon"><use href="#icon-plus"/></svg>
                    Add to Playlist
                </h3>
                <button class="playlist-modal-close" onclick="closePlaylistModal()" title="Close">&times;</button>
            </div>
            <div class="playlist-modal-track" id="playlist-modal-track">
                <span class="model-badge" id="playlist-modal-badge"></span>
                <span class="playlist-modal-prompt" id="playlist-modal-prompt"></span>
            </div>
            <div class="playlist-modal-section">
                <div class="playlist-modal-label">Select a playlist:</div>
                <div class="playlist-list" id="playlist-modal-list">
                    <div class="playlist-empty">No playlists yet. Create one below!</div>
                </div>
            </div>
            <div class="playlist-modal-section create-section">
                <div class="playlist-modal-label">Or create a new playlist:</div>
                <div class="create-playlist-form">
                    <input type="text" id="new-playlist-name" class="playlist-name-input" placeholder="Playlist name..." maxlength="100">
                    <button class="btn btn-primary btn-sm" onclick="createPlaylistAndAdd()" title="Create new playlist and add track">
                        <svg class="icon"><use href="#icon-plus"/></svg>
                        Create & Add
                    </button>
                </div>
            </div>
            <div class="playlist-modal-status" id="playlist-modal-status"></div>
        </div>
    </div>

    <!-- Playlist Detail Overlay -->
    <div class="playlist-detail-overlay hidden" id="playlist-detail-overlay" onclick="closePlaylistDetail(event)" role="dialog" aria-modal="true" aria-labelledby="playlist-detail-name">
        <div class="playlist-detail-panel" onclick="event.stopPropagation()">
            <div class="playlist-detail-header">
                <div class="playlist-detail-info">
                    <h2 id="playlist-detail-name">Playlist Name</h2>
                    <span class="playlist-detail-meta">
                        <span id="playlist-detail-count">0 tracks</span>
                        <span class="meta-separator">|</span>
                        <span id="playlist-detail-duration">0 min</span>
                    </span>
                </div>
                <div class="playlist-detail-actions">
                    <button class="btn btn-icon" onclick="shufflePlayPlaylist()" title="Shuffle Play">
                        <svg class="icon"><use href="#icon-shuffle"/></svg>
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="playPlaylist()" title="Play All">
                        <svg class="icon"><use href="#icon-play"/></svg>
                        Play
                    </button>
                    <button class="btn btn-icon" onclick="showPlaylistOptionsModal()" title="Settings">
                        <svg class="icon"><use href="#icon-settings"/></svg>
                    </button>
                </div>
                <button class="playlist-detail-close" onclick="closePlaylistDetail()" title="Close">&times;</button>
            </div>
            <div class="playlist-tracks-list" id="playlist-tracks-list">
                <!-- Tracks rendered dynamically -->
            </div>
        </div>
    </div>

    <!-- Playlist Options Modal (Rename/Delete) -->
    <div class="playlist-options-overlay hidden" id="playlist-options-overlay" onclick="closePlaylistOptions(event)" role="dialog" aria-modal="true" aria-labelledby="playlist-options-title">
        <div class="playlist-options-modal" onclick="event.stopPropagation()">
            <div class="playlist-options-header">
                <h3 id="playlist-options-title">Playlist Settings</h3>
                <button class="btn btn-icon" onclick="closePlaylistOptions()" title="Close">&times;</button>
            </div>
            <div class="playlist-options-content">
                <div class="form-group">
                    <label for="playlist-options-name">Name</label>
                    <input type="text" id="playlist-options-name" class="input" placeholder="Playlist name..." maxlength="100">
                </div>
                <div class="modal-actions">
                    <button class="btn" onclick="closePlaylistOptions()" title="Cancel changes">Cancel</button>
                    <button class="btn btn-primary" onclick="renamePlaylist()" title="Save playlist name">Save</button>
                </div>
                <div class="danger-zone">
                    <button class="btn btn-danger" onclick="deletePlaylist()" title="Permanently delete this playlist">
                        <svg class="icon"><use href="#icon-trash"/></svg>
                        Delete Playlist
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Playlist Modal Styles */
        .playlist-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }

        .playlist-modal-overlay.hidden {
            display: none;
        }

        .playlist-modal {
            background: linear-gradient(145deg, var(--bg-card) 0%, rgba(20, 20, 35, 0.98) 100%);
            border-radius: 20px;
            max-width: 480px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(168, 85, 247, 0.2);
            box-shadow: 0 24px 80px rgba(0, 0, 0, 0.6), 0 0 40px rgba(168, 85, 247, 0.1);
        }

        .playlist-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.12) 0%, rgba(99, 102, 241, 0.08) 100%);
        }

        .playlist-modal-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }

        .playlist-modal-title .icon {
            width: 20px;
            height: 20px;
            color: var(--accent);
        }

        .playlist-modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .playlist-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text);
        }

        .playlist-modal-track {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.15);
            border-bottom: 1px solid var(--border);
        }

        .playlist-modal-prompt {
            font-size: 0.95rem;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-modal-section {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .playlist-modal-section.create-section {
            background: rgba(168, 85, 247, 0.05);
        }

        .playlist-modal-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 12px;
            font-weight: 500;
        }

        .playlist-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .playlist-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .playlist-option:hover {
            border-color: var(--accent);
            background: rgba(168, 85, 247, 0.1);
        }

        .playlist-option .playlist-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--gradient-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .playlist-option .playlist-details {
            flex: 1;
        }

        .playlist-option .playlist-name {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 2px;
        }

        .playlist-option .playlist-count {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .playlist-empty {
            text-align: center;
            padding: 24px;
            color: var(--text-muted);
            font-style: italic;
        }

        .create-playlist-form {
            display: flex;
            gap: 12px;
        }

        .playlist-name-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.2);
            color: var(--text);
            font-size: 0.9rem;
            outline: none;
            transition: all 0.2s;
        }

        .playlist-name-input::placeholder {
            color: var(--text-muted);
        }

        .playlist-name-input:focus {
            border-color: var(--accent);
            background: rgba(0, 0, 0, 0.3);
        }

        .btn-sm {
            padding: 10px 16px;
            font-size: 0.85rem;
        }

        .playlist-modal-status {
            padding: 12px 20px;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .playlist-modal-status.success {
            color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        .playlist-modal-status.error {
            color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        /* Add to Playlist button style */
        .action-btn.add-playlist {
            border-color: rgba(168, 85, 247, 0.3);
            color: var(--accent);
        }

        .action-btn.add-playlist:hover {
            border-color: var(--accent);
            background: rgba(168, 85, 247, 0.1);
        }

        /* Playlist Card Styles */
        .playlist-card {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.25s;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            min-height: 140px;
        }

        .playlist-card:hover {
            border-color: var(--accent);
            background: rgba(168, 85, 247, 0.1);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .playlist-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: var(--gradient-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
        }

        .playlist-card-icon .icon {
            width: 24px;
            height: 24px;
            color: white;
        }

        .playlist-card-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text);
            margin-bottom: 4px;
            word-break: break-word;
        }

        .playlist-card-count {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Favorite Item Styles */
        .favorite-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            transition: all 0.2s;
        }

        .favorite-item:hover {
            border-color: var(--accent);
            background: rgba(168, 85, 247, 0.08);
        }

        .favorite-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            overflow: hidden;
            flex: 1;
        }

        .favorite-prompt {
            font-size: 0.95rem;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .favorite-duration {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .favorite-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        /* Playlist Detail Overlay */
        .playlist-detail-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 9500;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }

        .playlist-detail-overlay.hidden {
            display: none;
        }

        .playlist-detail-panel {
            width: 100%;
            max-width: 550px;
            margin: 0 auto;
            background: linear-gradient(180deg, var(--bg-card) 0%, rgba(15, 15, 25, 0.98) 100%);
            display: flex;
            flex-direction: column;
            max-height: 75vh;
            border-radius: 20px;
            border: 1px solid rgba(168, 85, 247, 0.2);
            box-shadow: 0 24px 80px rgba(0, 0, 0, 0.6), 0 0 40px rgba(168, 85, 247, 0.1);
            overflow: hidden;
        }

        .playlist-detail-header {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(99, 102, 241, 0.1) 100%);
            flex-shrink: 0;
        }

        .playlist-detail-info {
            flex: 1;
            min-width: 0;
        }

        .playlist-detail-info h2 {
            margin: 0 0 2px;
            font-size: 1.15rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-detail-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .meta-separator {
            margin: 0 6px;
            opacity: 0.5;
        }

        .playlist-detail-actions {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-shrink: 0;
        }

        .playlist-detail-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-muted);
            font-size: 1.4rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .playlist-detail-close:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text);
        }

        .playlist-tracks-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 12px;
        }

        .playlist-tracks-empty {
            text-align: center;
            padding: 48px 20px;
            color: var(--text-muted);
        }

        .playlist-tracks-empty .icon {
            margin-bottom: 12px;
            opacity: 0.3;
        }

        .playlist-track-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            transition: all 0.2s ease;
            margin-bottom: 4px;
            border: 1px solid transparent;
            background: rgba(255, 255, 255, 0.02);
        }

        .playlist-track-item:hover {
            background: rgba(168, 85, 247, 0.08);
            border-color: rgba(168, 85, 247, 0.2);
            transform: translateX(4px);
        }

        .playlist-track-item.playing {
            background: linear-gradient(90deg, rgba(168, 85, 247, 0.2) 0%, rgba(99, 102, 241, 0.12) 100%);
            border-color: var(--accent);
            box-shadow: inset 4px 0 0 var(--accent);
        }

        .track-drag-handle {
            cursor: grab;
            color: var(--text-muted);
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .playlist-track-item:hover .track-drag-handle {
            opacity: 1;
        }

        .track-drag-handle:active {
            cursor: grabbing;
        }

        .track-number {
            width: 24px;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .track-info {
            flex: 1;
            overflow: hidden;
        }

        .track-prompt {
            display: block;
            font-size: 0.95rem;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-duration {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .track-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .playlist-track-item:hover .track-actions {
            opacity: 1;
        }

        /* Playlist Options Modal */
        .playlist-options-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }

        .playlist-options-overlay.hidden {
            display: none;
        }

        .playlist-options-modal {
            background: linear-gradient(145deg, var(--bg-card) 0%, rgba(20, 20, 35, 0.98) 100%);
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            border: 1px solid rgba(168, 85, 247, 0.2);
            box-shadow: 0 24px 80px rgba(0, 0, 0, 0.6), 0 0 40px rgba(168, 85, 247, 0.1);
        }

        .playlist-options-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.12) 0%, rgba(99, 102, 241, 0.08) 100%);
        }

        .playlist-options-header h3 {
            margin: 0;
        }

        .playlist-options-content {
            padding: 20px;
        }

        .playlist-options-content .form-group {
            margin-bottom: 16px;
        }

        .playlist-options-content .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-muted);
        }

        .playlist-options-content .input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-input);
            color: var(--text);
            font-size: 0.95rem;
        }

        .playlist-options-content .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-bottom: 20px;
        }

        .danger-zone {
            border-top: 1px solid var(--border);
            padding-top: 16px;
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #ef4444;
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        /* Dragging state */
        .playlist-track-item.dragging {
            opacity: 0.5;
            background: rgba(168, 85, 247, 0.2);
        }
    </style>

    <style>
        /* Tag Suggestion Modal Styles */
        .tag-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }

        .tag-modal-overlay.hidden {
            display: none;
        }

        .tag-modal {
            background: var(--bg-card);
            border-radius: 16px;
            max-width: 550px;
            width: 100%;
            max-height: calc(100vh - 40px);
            max-height: calc(100dvh - 40px);  /* Dynamic viewport height for mobile */
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px solid var(--border);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            scrollbar-width: thin;
            scrollbar-color: var(--accent) transparent;
        }

        .tag-modal::-webkit-scrollbar {
            width: 6px;
        }

        .tag-modal::-webkit-scrollbar-track {
            background: transparent;
        }

        .tag-modal::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 3px;
        }

        .tag-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.2);
        }

        .tag-modal-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }

        .tag-modal-title .icon {
            width: 20px;
            height: 20px;
            color: var(--accent);
        }

        .tag-modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .tag-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text);
        }

        .tag-modal-track {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.15);
            border-bottom: 1px solid var(--border);
        }

        .tag-modal-prompt {
            font-size: 0.95rem;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tag-modal-current,
        .tag-modal-suggestions,
        .tag-modal-section {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .tag-modal-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 10px;
            font-weight: 500;
        }

        .current-tags,
        .pending-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .current-tag,
        .pending-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .current-tag {
            background: var(--accent);
            color: white;
        }

        .pending-tag {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-muted);
            border: 1px dashed var(--border);
        }

        .pending-tag .vote-count {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
        }

        .tag-categories {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Category Groups */
        .tag-category-groups {
            max-height: 280px;
            overflow-y: auto;
        }

        .tag-category-group {
            margin-bottom: 12px;
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .tag-group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: rgba(0, 0, 0, 0.2);
            cursor: pointer;
            user-select: none;
        }

        .tag-group-header:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .tag-group-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text);
        }

        .tag-group-toggle {
            width: 20px;
            height: 20px;
            color: var(--text-muted);
            transition: transform 0.2s;
        }

        .tag-category-group.collapsed .tag-group-toggle {
            transform: rotate(-90deg);
        }

        .tag-group-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 6px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.1);
        }

        .tag-category-group.collapsed .tag-group-items {
            display: none;
        }

        /* Custom Tags Section */
        .custom-tags-container {
            margin-top: 8px;
        }

        .current-custom-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 10px;
        }

        .custom-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: rgba(168, 85, 247, 0.15);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 16px;
            font-size: 0.8rem;
            color: var(--accent);
        }

        .custom-tag-remove {
            width: 14px;
            height: 14px;
            border: none;
            background: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .custom-tag-remove:hover {
            color: var(--error);
        }

        .custom-tag-input-container {
            display: flex;
            gap: 8px;
        }

        .custom-tag-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.03);
            color: var(--text);
            font-size: 0.85rem;
        }

        .custom-tag-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .tag-category-btn {
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-dim);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .tag-category-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            border-color: var(--cyan);
        }

        .tag-category-btn.suggested {
            border-color: var(--accent);
            background: rgba(139, 92, 246, 0.2);
            color: var(--accent);
        }

        .tag-category-btn.already-applied {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        .tag-modal-status {
            padding: 16px 20px;
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .tag-modal-status.success {
            color: var(--accent);
            background: rgba(139, 92, 246, 0.1);
        }

        .tag-modal-status.error {
            color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .tag-modal-status.consensus {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .no-tags {
            color: var(--text-muted);
            font-style: italic;
            font-size: 0.85rem;
        }

        /* Tag hint text */
        .tag-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: normal;
        }

        /* Remove tag button on current tags */
        .current-tag {
            position: relative;
            padding-right: 24px;
        }

        .remove-tag-btn {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: none;
            background: rgba(239, 68, 68, 0.3);
            color: var(--text-muted);
            font-size: 14px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.6;
            transition: all 0.2s;
        }

        .remove-tag-btn:hover {
            opacity: 1;
            background: rgba(239, 68, 68, 0.6);
            color: white;
        }

        .remove-tag-btn.already-voted {
            background: rgba(239, 68, 68, 0.5);
            opacity: 0.8;
        }

        /* Pending tag action indicators */
        .pending-tag .action-indicator {
            font-weight: bold;
            margin-right: 4px;
        }

        .pending-tag.pending-add {
            border-color: rgba(16, 185, 129, 0.5);
            background: rgba(16, 185, 129, 0.1);
        }

        .pending-tag.pending-add .action-indicator {
            color: #10b981;
        }

        .pending-tag.pending-remove {
            border-color: rgba(239, 68, 68, 0.5);
            background: rgba(239, 68, 68, 0.1);
        }

        .pending-tag.pending-remove .action-indicator {
            color: #ef4444;
        }

        /* User's own suggestions - highlight and show cancel */
        .pending-tag.user-suggested {
            border-style: solid;
            border-width: 2px;
        }

        .pending-tag.user-suggested.pending-add {
            border-color: rgba(34, 197, 94, 0.5);
            background: rgba(34, 197, 94, 0.15);
        }

        .pending-tag.user-suggested.pending-remove {
            border-color: rgba(239, 68, 68, 0.5);
            background: rgba(239, 68, 68, 0.15);
        }

        .cancel-suggestion-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0 2px;
            margin-left: 4px;
            font-size: 1rem;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.15s, color 0.15s;
        }

        .cancel-suggestion-btn:hover {
            opacity: 1;
            color: #ef4444;
        }

        /* Suggest Tag Button Style */
        .action-btn.suggest-tag {
            border-color: rgba(139, 92, 246, 0.3);
            color: var(--text-muted);
        }

        .action-btn.suggest-tag:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(139, 92, 246, 0.1);
        }

        /* Suggestions row layout */
        .tag-modal-suggestions-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            border-bottom: 1px solid var(--border);
        }

        .tag-modal-suggestions-row .tag-modal-suggestions {
            border-bottom: none;
            padding: 12px 16px;
        }

        .tag-modal-suggestions-row .tag-modal-suggestions:first-child {
            border-right: 1px solid var(--border);
        }

        /* Search input */
        .tag-search-container {
            position: relative;
            margin-bottom: 12px;
        }

        .tag-search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        .tag-search-input {
            width: 100%;
            padding: 10px 12px 10px 36px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.2);
            color: var(--text);
            font-size: 0.9rem;
            outline: none;
            transition: all 0.2s;
        }

        .tag-search-input::placeholder {
            color: var(--text-muted);
        }

        .tag-search-input:focus {
            border-color: var(--accent);
            background: rgba(0, 0, 0, 0.3);
        }

        /* Recently used section */
        .tag-recently-used {
            margin-bottom: 12px;
            padding: 10px 12px;
            background: rgba(139, 92, 246, 0.08);
            border-radius: 10px;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .tag-recently-used.hidden {
            display: none;
        }

        .tag-modal-sublabel {
            font-size: 0.75rem;
            color: var(--accent);
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tag-recent-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .tag-recent-btn {
            padding: 6px 10px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            background: rgba(139, 92, 246, 0.1);
            color: var(--accent);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tag-recent-btn:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: var(--accent);
        }

        .tag-recent-btn.already-applied {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Category button with usage count */
        .tag-category-btn .usage-count {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-left: 4px;
            opacity: 0.6;
        }

        /* Improved current tag with click-to-remove */
        .current-tag {
            position: relative;
            padding-right: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .current-tag:hover {
            background: rgba(239, 68, 68, 0.8);
            transform: scale(0.98);
        }

        .current-tag:hover::after {
            content: 'click to vote for removal';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 0.65rem;
            color: var(--text-muted);
            background: var(--bg-card);
            padding: 2px 6px;
            border-radius: 4px;
            pointer-events: none;
            z-index: 10;
        }

        .current-tag.voted-remove {
            background: rgba(239, 68, 68, 0.5);
            text-decoration: line-through;
            opacity: 0.7;
        }

        /* Hide the old X button - using click on tag instead */
        .remove-tag-btn {
            display: none;
        }

        /* Category hidden by search */
        .tag-category-btn.filtered-out {
            display: none;
        }

        /* No results message */
        .tag-no-results {
            grid-column: 1 / -1;
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-style: italic;
        }
    </style>

    <script>
        // Tag Suggestion Modal Functions
        let currentTagModalGenId = null;
        let currentTagModalModel = 'music';
        let allCategoriesData = null; // Store for filtering
        // Track user's current suggestions for toggle behavior
        let currentUserAddSuggestions = [];
        let currentUserRemoveSuggestions = [];

        // Recently used tags management (stored in localStorage)
        const RECENT_TAGS_KEY = 'soundbox_recent_tags';
        const MAX_RECENT_TAGS = 8;

        function getRecentTags() {
            try {
                const stored = localStorage.getItem(RECENT_TAGS_KEY);
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                return [];
            }
        }

        function addRecentTag(category) {
            const recent = getRecentTags();
            // Remove if already exists
            const filtered = recent.filter(t => t !== category);
            // Add to front
            filtered.unshift(category);
            // Keep only MAX_RECENT_TAGS
            const trimmed = filtered.slice(0, MAX_RECENT_TAGS);
            try {
                localStorage.setItem(RECENT_TAGS_KEY, JSON.stringify(trimmed));
            } catch (e) {
                console.warn('Could not save recent tags:', e);
            }
        }

        function filterTagCategories(searchTerm) {
            const groupsEl = document.getElementById('tag-category-groups');
            const groups = groupsEl.querySelectorAll('.tag-category-group');
            const buttons = groupsEl.querySelectorAll('.tag-category-btn');
            const term = searchTerm.toLowerCase().trim();

            let visibleCount = 0;
            buttons.forEach(btn => {
                const text = btn.textContent.toLowerCase();
                const key = btn.dataset.category || '';
                if (!term || text.includes(term) || key.includes(term)) {
                    btn.classList.remove('filtered-out');
                    visibleCount++;
                } else {
                    btn.classList.add('filtered-out');
                }
            });

            // Hide groups with no visible buttons
            groups.forEach(group => {
                const visibleBtns = group.querySelectorAll('.tag-category-btn:not(.filtered-out)');
                group.style.display = visibleBtns.length === 0 && term ? 'none' : '';
                // Expand groups when searching
                if (term) {
                    group.classList.remove('collapsed');
                }
            });

            // Show/hide no results message
            let noResultsEl = groupsEl.querySelector('.tag-no-results');
            if (visibleCount === 0 && term) {
                if (!noResultsEl) {
                    noResultsEl = document.createElement('div');
                    noResultsEl.className = 'tag-no-results';
                    noResultsEl.style.cssText = 'padding: 20px; text-align: center; color: var(--text-muted);';
                    groupsEl.appendChild(noResultsEl);
                }
                noResultsEl.textContent = `No categories matching "${searchTerm}"`;
            } else if (noResultsEl) {
                noResultsEl.remove();
            }
        }

        async function showTagSuggestionModal(genIdOrItem) {
            // Require authentication to suggest tags
            if (!isUserAuthenticated()) {
                showLoginPrompt('suggest tags');
                return;
            }

            // Accept either a genId string or an item object
            let item, genId;
            if (typeof genIdOrItem === 'string') {
                genId = genIdOrItem;
                item = libraryItemsData[genId] || currentRadioTrack;
            } else if (typeof genIdOrItem === 'object' && genIdOrItem !== null) {
                item = genIdOrItem;
                genId = item.id;
            }

            if (!item || !genId) {
                showErrorToast('No track selected');
                return;
            }

            currentTagModalGenId = genId;
            currentTagModalModel = item.model || 'music';

            // Show modal
            document.getElementById('tag-modal-overlay').classList.remove('hidden');

            // Clear search input
            const searchInput = document.getElementById('tag-search-input');
            if (searchInput) {
                searchInput.value = '';
            }

            // Set track info
            let tagModalIcon = '#icon-volume';
            if (currentTagModalModel === 'music') tagModalIcon = '#icon-music';
            else if (currentTagModalModel === 'voice') tagModalIcon = '#icon-mic';
            document.getElementById('tag-modal-badge').innerHTML =
                `<svg class="icon icon-sm" style="vertical-align: -2px;"><use href="${tagModalIcon}"/></svg>`;
            document.getElementById('tag-modal-prompt').textContent = item.prompt;

            // Clear status
            const statusEl = document.getElementById('tag-modal-status');
            statusEl.className = 'tag-modal-status';
            statusEl.textContent = 'Loading...';

            try {
                // Fetch current suggestions and categories in parallel
                const [suggestionsRes, categoriesRes] = await Promise.all([
                    fetch(`/api/library/${genId}/tag-suggestions`),
                    fetch(`/api/categories/${currentTagModalModel}`)
                ]);
                const suggestionsData = await suggestionsRes.json();
                const categoriesData = await categoriesRes.json();
                allCategoriesData = categoriesData;

                // Display current categories (click to vote for removal, click again to cancel)
                const currentTagsEl = document.getElementById('tag-modal-current-tags');
                const userRemoveSuggestions = suggestionsData.user_suggestions?.remove || [];
                if (suggestionsData.current_categories && suggestionsData.current_categories.length > 0) {
                    currentTagsEl.innerHTML = suggestionsData.current_categories
                        .map(cat => {
                            const alreadyVotedRemove = userRemoveSuggestions.includes(cat);
                            const votedClass = alreadyVotedRemove ? ' voted-remove' : '';
                            const title = alreadyVotedRemove ? 'Click to cancel removal vote' : 'Click to vote for removal';
                            return `<span class="current-tag${votedClass}" onclick="suggestTagRemoval('${escapeJsString(cat)}')" title="${title}">
                                ${escapeHtml(cat.replace(/_/g, ' '))}
                            </span>`;
                        })
                        .join('');
                } else {
                    currentTagsEl.innerHTML = '<span class="no-tags">No categories yet - be the first to suggest one!</span>';
                }

                // Display pending additions
                const pendingAddEl = document.getElementById('tag-modal-pending-add');
                // Get user's own suggestions and store globally for toggle behavior
                const userAddSuggestionsList = suggestionsData.user_suggestions?.add || [];
                const userRemoveSuggestionsList = suggestionsData.user_suggestions?.remove || [];
                currentUserAddSuggestions = userAddSuggestionsList;
                currentUserRemoveSuggestions = userRemoveSuggestionsList;

                const addSuggestions = suggestionsData.suggestions?.add || suggestionsData.suggestions || {};
                if (Object.keys(addSuggestions).length > 0) {
                    pendingAddEl.innerHTML = Object.entries(addSuggestions)
                        .map(([cat, count]) => {
                            const isUserSuggestion = userAddSuggestionsList.includes(cat);
                            const cancelBtn = isUserSuggestion
                                ? `<button class="cancel-suggestion-btn" onclick="cancelTagSuggestion('${escapeJsString(cat)}', 'add')" title="Cancel your suggestion"></button>`
                                : '';
                            return `
                            <span class="pending-tag pending-add ${isUserSuggestion ? 'user-suggested' : ''}">
                                <span class="action-indicator">+</span>
                                ${escapeHtml(cat.replace(/_/g, ' '))}
                                <span class="vote-count">${count}/${suggestionsData.threshold}</span>
                                ${cancelBtn}
                            </span>`;
                        })
                        .join('');
                } else {
                    pendingAddEl.innerHTML = '<span class="no-tags">None</span>';
                }

                // Display pending removals
                const pendingRemoveEl = document.getElementById('tag-modal-pending-remove');
                const removeSuggestions = suggestionsData.suggestions?.remove || {};
                if (Object.keys(removeSuggestions).length > 0) {
                    pendingRemoveEl.innerHTML = Object.entries(removeSuggestions)
                        .map(([cat, count]) => {
                            const isUserSuggestion = userRemoveSuggestionsList.includes(cat);
                            const cancelBtn = isUserSuggestion
                                ? `<button class="cancel-suggestion-btn" onclick="cancelTagSuggestion('${escapeJsString(cat)}', 'remove')" title="Cancel your suggestion"></button>`
                                : '';
                            return `
                            <span class="pending-tag pending-remove ${isUserSuggestion ? 'user-suggested' : ''}">
                                <span class="action-indicator"></span>
                                ${escapeHtml(cat.replace(/_/g, ' '))}
                                <span class="vote-count">${count}/${suggestionsData.threshold}</span>
                                ${cancelBtn}
                            </span>`;
                        })
                        .join('');
                } else {
                    pendingRemoveEl.innerHTML = '<span class="no-tags">None</span>';
                }

                // Display recently used tags
                const recentlyUsedEl = document.getElementById('tag-recently-used');
                const recentButtonsEl = document.getElementById('tag-recent-buttons');
                const recentTags = getRecentTags();
                const currentCats = suggestionsData.current_categories || [];
                const userAddSuggestions = suggestionsData.user_suggestions?.add || suggestionsData.user_suggestions || [];

                // Filter recent tags to only show valid ones for this model
                const validCategories = Object.keys(categoriesData.categories_with_counts || categoriesData.categories || {});
                const validRecentTags = recentTags.filter(t => validCategories.includes(t));

                if (validRecentTags.length > 0) {
                    recentlyUsedEl.classList.remove('hidden');
                    recentButtonsEl.innerHTML = validRecentTags
                        .map(cat => {
                            const isApplied = currentCats.includes(cat);
                            const isSuggested = Array.isArray(userAddSuggestions) ? userAddSuggestions.includes(cat) : false;
                            let className = 'tag-recent-btn';
                            if (isApplied) className += ' already-applied';
                            else if (isSuggested) className += ' suggested';

                            const displayName = categoriesData.categories[cat] || cat.replace(/_/g, ' ');
                            const title = isApplied ? 'Already applied' : isSuggested ? 'Click to cancel suggestion' : 'Click to suggest adding';
                            return `<button class="${className}" onclick="suggestTag('${escapeJsString(cat)}')" title="${title}" ${isApplied ? 'disabled' : ''}>
                                ${escapeHtml(displayName)}
                            </button>`;
                        })
                        .join('');
                } else {
                    recentlyUsedEl.classList.add('hidden');
                }

                // Display available categories in groups
                const groupsEl = document.getElementById('tag-category-groups');
                const categoriesWithCounts = categoriesData.categories_with_counts || {};

                // Use shared category definitions (defined at top of script)
                let CATEGORY_GROUPS;
                if (currentTagModalModel === 'music') {
                    CATEGORY_GROUPS = MUSIC_CATEGORY_GROUPS;
                } else if (currentTagModalModel === 'voice') {
                    CATEGORY_GROUPS = SPEECH_CATEGORY_GROUPS;
                } else {
                    CATEGORY_GROUPS = SFX_CATEGORY_GROUPS;
                }

                let groupsHtml = '';
                for (const [groupName, groupCategories] of Object.entries(CATEGORY_GROUPS)) {
                    const groupItems = groupCategories
                        .filter(cat => categoriesWithCounts[cat])
                        .map(cat => {
                            const data = categoriesWithCounts[cat];
                            const isApplied = currentCats.includes(cat);
                            const isSuggested = Array.isArray(userAddSuggestions) ? userAddSuggestions.includes(cat) : false;
                            let className = 'tag-category-btn';
                            if (isApplied) className += ' already-applied';
                            else if (isSuggested) className += ' suggested';
                            const countDisplay = data.count > 0 ? `<span class="usage-count">(${data.count})</span>` : '';
                            const title = isApplied ? 'Already applied' : isSuggested ? 'Click to cancel suggestion' : 'Click to suggest adding';
                            return `<button class="${className}" data-category="${escapeHtml(cat)}" onclick="suggestTag('${escapeJsString(cat)}')" title="${title}" ${isApplied ? 'disabled' : ''}>
                                ${escapeHtml(data.display)}${countDisplay}
                            </button>`;
                        });

                    if (groupItems.length > 0) {
                        groupsHtml += `
                            <div class="tag-category-group">
                                <div class="tag-group-header" onclick="this.parentElement.classList.toggle('collapsed')">
                                    <span class="tag-group-name">${escapeHtml(groupName)}</span>
                                    <svg class="tag-group-toggle icon"><use href="#icon-chevron"/></svg>
                                </div>
                                <div class="tag-group-items">${groupItems.join('')}</div>
                            </div>
                        `;
                    }
                }
                groupsEl.innerHTML = groupsHtml;

                // Load current custom tags
                loadCustomTags();

                statusEl.textContent = 'Click a category to add it. Click current tags to vote for removal. 3 votes needed.';

            } catch (err) {
                console.error('Failed to load tag suggestions:', err);
                statusEl.className = 'tag-modal-status error';
                statusEl.textContent = 'Failed to load suggestions';
            }
        }

        let tagSuggestionSubmitting = false;  // Prevent double-submit

        async function suggestTag(category, action = 'add') {
            if (!currentTagModalGenId) return;

            // Prevent double-submit
            if (tagSuggestionSubmitting) return;
            tagSuggestionSubmitting = true;

            // Toggle behavior: if user already suggested this, cancel instead
            const alreadySuggested = action === 'add'
                ? currentUserAddSuggestions.includes(category)
                : currentUserRemoveSuggestions.includes(category);

            if (alreadySuggested) {
                // User clicked again - toggle off (cancel the suggestion)
                await cancelTagSuggestion(category, action);
                tagSuggestionSubmitting = false;
                return;
            }

            const statusEl = document.getElementById('tag-modal-status');
            statusEl.className = 'tag-modal-status';
            statusEl.textContent = 'Submitting...';

            try {
                const response = await fetch(`/api/library/${currentTagModalGenId}/suggest-tag`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category, action })
                });

                const data = await response.json();

                if (data.success) {
                    // Track recently used tag on successful add
                    if (action === 'add') {
                        addRecentTag(category);
                    }

                    if (data.consensus_reached) {
                        statusEl.className = 'tag-modal-status consensus';
                        statusEl.textContent = data.message;
                        const actionMsg = action === 'add' ? 'Category added!' : 'Category removed!';
                        showFeedbackToast(actionMsg + ' Consensus reached.');
                    } else {
                        statusEl.className = 'tag-modal-status success';
                        statusEl.textContent = data.message;
                        const actionMsg = action === 'add' ? 'Addition' : 'Removal';
                        showFeedbackToast(actionMsg + ' suggestion recorded');
                    }

                    // Refresh the modal (capture genId to avoid race condition if modal closes)
                    const refreshGenId = currentTagModalGenId;
                    setTimeout(() => {
                        // Only refresh if modal is still open for the same track
                        if (currentTagModalGenId === refreshGenId) {
                            showTagSuggestionModal(refreshGenId);
                        }
                    }, 500);

                } else {
                    statusEl.className = 'tag-modal-status error';
                    statusEl.textContent = data.message;
                }

            } catch (err) {
                console.error('Failed to suggest tag:', err);
                statusEl.className = 'tag-modal-status error';
                statusEl.textContent = 'Failed to submit suggestion';
            } finally {
                tagSuggestionSubmitting = false;
            }
        }

        async function suggestTagRemoval(category) {
            // This now inherits toggle behavior from suggestTag
            await suggestTag(category, 'remove');
        }

        async function cancelTagSuggestion(category, action = 'add') {
            if (!currentTagModalGenId) return;

            // Capture current state to avoid race conditions
            const genId = currentTagModalGenId;

            const statusEl = document.getElementById('tag-modal-status');
            statusEl.className = 'tag-modal-status';
            statusEl.textContent = 'Canceling...';

            try {
                const response = await fetch(`/api/library/${genId}/cancel-tag`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category, action })
                });
                const data = await response.json();

                if (response.ok) {
                    statusEl.className = 'tag-modal-status success';
                    statusEl.textContent = 'Suggestion canceled';
                    // Refresh the modal to show updated state (only if still open for same track)
                    setTimeout(() => {
                        if (currentTagModalGenId === genId) {
                            showTagSuggestionModal(genId);
                        }
                    }, 500);
                } else {
                    statusEl.className = 'tag-modal-status error';
                    statusEl.textContent = data.message || data.error || 'Failed to cancel';
                }
            } catch (err) {
                console.error('Failed to cancel suggestion:', err);
                statusEl.className = 'tag-modal-status error';
                statusEl.textContent = 'Failed to cancel suggestion';
            }
        }

        // Custom tags functionality
        let currentTrackCustomTags = [];

        function loadCustomTags() {
            if (!currentTagModalGenId) return;

            // Load from localStorage for now (will be API-backed later)
            let allTags = {};
            try {
                allTags = JSON.parse(localStorage.getItem('soundbox_custom_tags') || '{}');
            } catch (e) {
                console.warn('Failed to parse custom tags from localStorage:', e);
                allTags = {};
            }
            currentTrackCustomTags = allTags[currentTagModalGenId] || [];
            renderCustomTags();
        }

        function renderCustomTags() {
            const container = document.getElementById('current-custom-tags');
            if (!container) return;

            if (currentTrackCustomTags.length === 0) {
                container.innerHTML = '<span class="no-tags" style="font-size: 0.8rem; color: var(--text-muted);">No custom tags yet</span>';
            } else {
                container.innerHTML = currentTrackCustomTags.map(tag => `
                    <span class="custom-tag">
                        ${escapeHtml(tag)}
                        <button class="custom-tag-remove" onclick="removeCustomTag('${escapeJsString(tag)}')" title="Remove tag">
                            <svg class="icon"><use href="#icon-close"/></svg>
                        </button>
                    </span>
                `).join('');
            }
        }

        function addCustomTag() {
            const input = document.getElementById('custom-tag-input');
            const tag = input.value.trim().toLowerCase();

            if (!tag) return;
            if (tag.length > 30) {
                showErrorToast('Tag too long (max 30 characters)');
                return;
            }
            if (currentTrackCustomTags.includes(tag)) {
                showFeedbackToast('Tag already exists', 'warning');
                input.value = '';
                return;
            }
            if (currentTrackCustomTags.length >= 10) {
                showErrorToast('Maximum 10 custom tags per track');
                return;
            }

            currentTrackCustomTags.push(tag);
            saveCustomTags();
            renderCustomTags();
            input.value = '';
            showFeedbackToast('Tag added');
        }

        function removeCustomTag(tag) {
            currentTrackCustomTags = currentTrackCustomTags.filter(t => t !== tag);
            saveCustomTags();
            renderCustomTags();
            showFeedbackToast('Tag removed');
        }

        function saveCustomTags() {
            if (!currentTagModalGenId) return;

            let allTags = {};
            try {
                allTags = JSON.parse(localStorage.getItem('soundbox_custom_tags') || '{}');
            } catch (e) {
                console.warn('Failed to parse custom tags from localStorage:', e);
                allTags = {};
            }
            if (currentTrackCustomTags.length > 0) {
                allTags[currentTagModalGenId] = currentTrackCustomTags;
            } else {
                delete allTags[currentTagModalGenId];
            }
            localStorage.setItem('soundbox_custom_tags', JSON.stringify(allTags));
        }

        // Enter key to add tag
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.target.id === 'custom-tag-input') {
                e.preventDefault();
                addCustomTag();
            }
        });

        function closeTagModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('tag-modal-overlay').classList.add('hidden');
            currentTagModalGenId = null;
            currentTrackCustomTags = [];
            // Reset user suggestion state
            currentUserAddSuggestions = [];
            currentUserRemoveSuggestions = [];
        }

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Check feedback modal first
                const feedbackModal = document.getElementById('feedback-modal-overlay');
                if (feedbackModal && !feedbackModal.classList.contains('hidden')) {
                    closeFeedbackModal();
                    return;
                }
                // Check tag modal
                const tagModal = document.getElementById('tag-modal-overlay');
                if (tagModal && !tagModal.classList.contains('hidden')) {
                    closeTagModal();
                    return;
                }
                // Check playlist options modal
                const playlistOptionsModal = document.getElementById('playlist-options-overlay');
                if (playlistOptionsModal && !playlistOptionsModal.classList.contains('hidden')) {
                    closePlaylistOptions();
                    return;
                }
                // Check playlist detail modal
                const playlistDetailModal = document.getElementById('playlist-detail-overlay');
                if (playlistDetailModal && !playlistDetailModal.classList.contains('hidden')) {
                    closePlaylistDetail();
                    return;
                }
                // Check playlist add modal
                const playlistModal = document.getElementById('playlist-modal-overlay');
                if (playlistModal && !playlistModal.classList.contains('hidden')) {
                    closePlaylistModal();
                    return;
                }
            }
        });

        // ========================================
        // 2D GRID NAVIGATION (Keyboard/Gamepad)
        // ========================================

        const GridNavigation = {
            enabled: true,
            currentFocusIndex: 0,
            gamepadIndex: null,
            lastGamepadState: { up: false, down: false, left: false, right: false, a: false, b: false },

            // Get all focusable elements across the page (header tabs + current tab content)
            getFocusableElements() {
                const selector = [
                    'button:not([disabled]):not([tabindex="-1"])',
                    'a[href]:not([tabindex="-1"])',
                    'input:not([disabled]):not([type="hidden"]):not([tabindex="-1"])',
                    'select:not([disabled]):not([tabindex="-1"])',
                    '[tabindex]:not([tabindex="-1"]):not([disabled])',
                    '.station-card',
                    '.library-item',
                    '.genre-item'
                ].join(', ');

                // Get main navigation tabs (always visible)
                const headerElements = Array.from(document.querySelectorAll('.main-tab, .header-controls button'));

                // Get elements from the currently visible tab content
                const activeTab = document.querySelector('.tab-content:not([style*="display: none"])');
                const tabElements = activeTab ? Array.from(activeTab.querySelectorAll(selector)) : [];

                // Combine and filter for visibility
                return [...headerElements, ...tabElements]
                    .filter(el => {
                        const style = window.getComputedStyle(el);
                        const rect = el.getBoundingClientRect();
                        return style.display !== 'none' &&
                               style.visibility !== 'hidden' &&
                               rect.width > 0 && rect.height > 0;
                    });
            },

            // Get elements organized into rows based on their Y positions
            getElementGrid() {
                const elements = this.getFocusableElements();
                if (elements.length === 0) return [];

                const rows = [];
                let currentRow = [];
                let lastY = -Infinity;
                const threshold = 30; // Pixels to consider same row

                elements
                    .map(el => ({ el, rect: el.getBoundingClientRect() }))
                    .sort((a, b) => {
                        if (Math.abs(a.rect.top - b.rect.top) < threshold) {
                            return a.rect.left - b.rect.left;
                        }
                        return a.rect.top - b.rect.top;
                    })
                    .forEach(({ el, rect }) => {
                        if (rect.top - lastY > threshold && currentRow.length > 0) {
                            rows.push(currentRow);
                            currentRow = [];
                        }
                        currentRow.push(el);
                        lastY = rect.top;
                    });

                if (currentRow.length > 0) {
                    rows.push(currentRow);
                }

                return rows;
            },

            // Find current focus position in grid
            getCurrentPosition() {
                const grid = this.getElementGrid();
                const activeEl = document.activeElement;

                for (let row = 0; row < grid.length; row++) {
                    for (let col = 0; col < grid[row].length; col++) {
                        if (grid[row][col] === activeEl || grid[row][col].contains(activeEl)) {
                            return { row, col, grid };
                        }
                    }
                }
                return { row: 0, col: 0, grid };
            },

            // Navigate in a direction
            navigate(direction) {
                const { row, col, grid } = this.getCurrentPosition();
                if (grid.length === 0) return;

                let newRow = row, newCol = col;

                switch (direction) {
                    case 'up':
                        newRow = Math.max(0, row - 1);
                        newCol = Math.min(col, grid[newRow].length - 1);
                        break;
                    case 'down':
                        newRow = Math.min(grid.length - 1, row + 1);
                        newCol = Math.min(col, grid[newRow].length - 1);
                        break;
                    case 'left':
                        if (col > 0) {
                            newCol = col - 1;
                        } else if (row > 0) {
                            newRow = row - 1;
                            newCol = grid[newRow].length - 1;
                        }
                        break;
                    case 'right':
                        if (col < grid[row].length - 1) {
                            newCol = col + 1;
                        } else if (row < grid.length - 1) {
                            newRow = row + 1;
                            newCol = 0;
                        }
                        break;
                }

                const targetEl = grid[newRow]?.[newCol];
                if (targetEl) {
                    // Focus without scrolling first
                    targetEl.focus({ preventScroll: true });

                    // Only scroll for elements outside the fixed radio/now-playing section
                    const isInRadioSection = targetEl.closest('#content-radio');
                    if (!isInRadioSection) {
                        // For library/generate tabs, scroll the element into view
                        targetEl.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
                    }
                }
            },

            // Handle activation (Enter/A button)
            activate() {
                const activeEl = document.activeElement;
                if (activeEl && activeEl !== document.body) {
                    activeEl.click();
                }
            },

            // Handle back/cancel (Escape/B button)
            cancel() {
                // Close any open modal
                const tagModal = document.getElementById('tag-modal-overlay');
                if (tagModal && !tagModal.classList.contains('hidden')) {
                    closeTagModal();
                    return;
                }
                const feedbackModal = document.getElementById('feedback-modal-overlay');
                if (feedbackModal && !feedbackModal.classList.contains('hidden')) {
                    closeFeedbackModal();
                    return;
                }
            },

            // Initialize keyboard navigation
            initKeyboard() {
                document.addEventListener('keydown', (e) => {
                    if (!this.enabled) return;

                    // Don't interfere with text input
                    const activeTag = document.activeElement?.tagName.toLowerCase();
                    if (activeTag === 'input' || activeTag === 'textarea') {
                        if (e.key === 'Escape') {
                            document.activeElement.blur();
                        }
                        return;
                    }

                    switch (e.key) {
                        case 'ArrowUp':
                            e.preventDefault();
                            this.navigate('up');
                            break;
                        case 'ArrowDown':
                            e.preventDefault();
                            this.navigate('down');
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            this.navigate('left');
                            break;
                        case 'ArrowRight':
                            e.preventDefault();
                            this.navigate('right');
                            break;
                        case 'Enter':
                        case ' ':
                            if (e.key === ' ' && activeTag !== 'button') {
                                return; // Only activate on space if it's a button
                            }
                            // Let the default behavior handle it
                            break;
                    }
                });
            },

            // Initialize gamepad polling
            initGamepad() {
                window.addEventListener('gamepadconnected', (e) => {
                    console.log('Gamepad connected:', e.gamepad.id);
                    this.gamepadIndex = e.gamepad.index;
                    showFeedbackToast('Gamepad connected! Use D-pad to navigate, A to select, B to go back.');
                    this.startGamepadPolling();
                });

                window.addEventListener('gamepaddisconnected', (e) => {
                    console.log('Gamepad disconnected');
                    if (this.gamepadIndex === e.gamepad.index) {
                        this.gamepadIndex = null;
                    }
                });
            },

            startGamepadPolling() {
                const poll = () => {
                    if (this.gamepadIndex === null) return;

                    const gamepad = navigator.getGamepads()[this.gamepadIndex];
                    if (!gamepad) return;

                    // D-pad buttons (standard mapping)
                    const dpadUp = gamepad.buttons[12]?.pressed;
                    const dpadDown = gamepad.buttons[13]?.pressed;
                    const dpadLeft = gamepad.buttons[14]?.pressed;
                    const dpadRight = gamepad.buttons[15]?.pressed;

                    // A/B buttons (standard mapping: 0=A/X, 1=B/Circle)
                    const buttonA = gamepad.buttons[0]?.pressed;
                    const buttonB = gamepad.buttons[1]?.pressed;

                    // Left stick as alternative to D-pad
                    const stickThreshold = 0.5;
                    const stickUp = gamepad.axes[1] < -stickThreshold;
                    const stickDown = gamepad.axes[1] > stickThreshold;
                    const stickLeft = gamepad.axes[0] < -stickThreshold;
                    const stickRight = gamepad.axes[0] > stickThreshold;

                    const state = {
                        up: dpadUp || stickUp,
                        down: dpadDown || stickDown,
                        left: dpadLeft || stickLeft,
                        right: dpadRight || stickRight,
                        a: buttonA,
                        b: buttonB
                    };

                    // Trigger on press (not hold)
                    if (state.up && !this.lastGamepadState.up) this.navigate('up');
                    if (state.down && !this.lastGamepadState.down) this.navigate('down');
                    if (state.left && !this.lastGamepadState.left) this.navigate('left');
                    if (state.right && !this.lastGamepadState.right) this.navigate('right');
                    if (state.a && !this.lastGamepadState.a) this.activate();
                    if (state.b && !this.lastGamepadState.b) this.cancel();

                    this.lastGamepadState = state;
                    requestAnimationFrame(poll);
                };

                requestAnimationFrame(poll);
            },

            init() {
                this.initKeyboard();
                this.initGamepad();
            }
        };

        // Initialize grid navigation on load
        document.addEventListener('DOMContentLoaded', () => {
            GridNavigation.init();

            // Attribution copy-to-clipboard
            const attrHint = document.querySelector('.attribution-hint');
            if (attrHint) {
                attrHint.addEventListener('click', async () => {
                    const attribution = 'Music from Sound Box (soundbox.graphlings.net) - CC0 Public Domain';
                    try {
                        await navigator.clipboard.writeText(attribution);
                        const original = attrHint.textContent;
                        attrHint.textContent = 'Copied!';
                        attrHint.style.color = '#22c55e';
                        setTimeout(() => {
                            attrHint.textContent = original;
                            attrHint.style.color = '';
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy:', err);
                    }
                });
            }
        });
    </script>

    <style>
        /* Enhanced focus styles for grid navigation */
        *:focus {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        *:focus:not(:focus-visible) {
            outline: none;
        }

        *:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.3);
        }

        .station-card:focus-visible,
        .library-item:focus-visible,
        .main-tab:focus-visible,
        .genre-item:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px var(--accent-glow);
        }

        /* Make interactive elements focusable */
        .station-card,
        .library-item,
        .genre-item {
            outline: none;
        }

        .station-card:not([tabindex]),
        .library-item:not([tabindex]),
        .genre-item:not([tabindex]) {
            tabindex: 0;
        }
    </style>

    <!-- Persistent Mini Player (shows on non-radio tabs when playing) -->
    <div class="mini-player hidden" id="mini-player">
        <!-- Graphlings Branding -->
        <a href="https://graphlings.net" target="_blank" class="mini-player-brand" title="Powered by Graphlings">
            <img src="/static/graphlings/logo-104.png" alt="Graphlings" class="graphlings-logo" onerror="this.style.display='none'">
            <span class="brand-text">Graphlings</span>
        </a>

        <!-- Track Info -->
        <div class="mini-player-info">
            <div class="mini-eq active">
                <div class="mini-eq-bar"></div>
                <div class="mini-eq-bar"></div>
                <div class="mini-eq-bar"></div>
            </div>
            <div class="mini-player-track" id="mini-player-track">No track</div>
        </div>

        <!-- Rating Buttons - Quick vote without modal -->
        <div class="mini-player-rating">
            <button class="mini-rating-btn" id="mini-vote-up" onclick="quickVote(1)" title="Like this track">
                <svg class="icon"><use href="#icon-thumb-up"/></svg>
            </button>
            <button class="mini-rating-btn" id="mini-vote-down" onclick="quickVote(-1)" title="Dislike & skip">
                <svg class="icon"><use href="#icon-thumb-down"/></svg>
            </button>
        </div>

        <!-- Expanded Content (hidden by default) -->
        <div class="mini-player-expanded" id="mini-player-expanded">
            <div class="mini-player-progress">
                <div class="progress-bar" id="mini-progress-bar"></div>
            </div>
            <div class="mini-player-meta">
                <span class="mini-duration" id="mini-duration">0:00</span>
                <span class="mini-queue-count" id="mini-queue-count">0 in queue</span>
            </div>
        </div>

        <!-- Controls -->
        <div class="mini-player-controls">
            <button class="mini-player-btn primary" onclick="toggleRadioPlayPause()" id="mini-player-play" title="Play/Pause" data-tooltip="Play/Pause">
                <svg class="icon"><use href="#icon-pause"/></svg>
            </button>
            <button class="mini-player-btn" onclick="skipTrack()" title="Next" data-tooltip="Next">
                <svg class="icon"><use href="#icon-skip-next"/></svg>
            </button>
            <button class="mini-player-btn" onclick="toggleMiniPlayerExpanded()" id="mini-expand-btn" title="Expand" data-tooltip="Expand">
                <svg class="icon expand-icon"><use href="#icon-chevron-up"/></svg>
                <svg class="icon collapse-icon"><use href="#icon-chevron-down"/></svg>
            </button>
            <button class="mini-player-btn" onclick="switchTab('radio')" title="Open Radio" data-tooltip="Radio">
                <svg class="icon"><use href="#icon-radio"/></svg>
            </button>
        </div>
    </div>

    <style>
        .mini-player {
            position: fixed;
            bottom: 12px;
            right: 12px;
            left: auto;
            max-width: 480px;
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(168, 85, 247, 0.15) 100%);
            border: 1px solid var(--accent);
            border-radius: 16px;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 9000;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(168, 85, 247, 0.2);
            transition: all 0.3s ease;
        }

        .mini-player.expanded {
            padding: 16px 20px;
            flex-wrap: wrap;
        }

        .mini-player.hidden {
            display: none;
        }

        /* Graphlings Branding - with glow for advertising */
        .mini-player-brand {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: var(--text);
            flex-shrink: 0;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .mini-player-brand:hover {
            color: var(--accent);
            background: rgba(168, 85, 247, 0.15);
        }

        .graphlings-logo {
            width: 24px;
            height: 24px;
            filter: drop-shadow(0 0 4px rgba(168, 85, 247, 0.5));
        }

        .brand-text {
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            color: var(--accent);
            text-shadow: 0 0 10px rgba(168, 85, 247, 0.6);
            animation: brandGlow 2s ease-in-out infinite alternate;
        }

        @keyframes brandGlow {
            from { text-shadow: 0 0 8px rgba(168, 85, 247, 0.4); }
            to { text-shadow: 0 0 16px rgba(168, 85, 247, 0.8), 0 0 24px rgba(168, 85, 247, 0.4); }
        }

        .mini-player-brand:hover .brand-text {
            color: var(--cyan);
            text-shadow: 0 0 16px rgba(192, 132, 252, 0.8);
        }

        .mini-player-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            min-width: 150px;
        }

        .mini-player-track {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        /* Rating buttons */
        .mini-player-rating {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        .mini-rating-btn {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.2s;
        }

        .mini-rating-btn:hover {
            color: var(--accent);
            border-color: var(--accent);
            background: rgba(168, 85, 247, 0.1);
        }

        .mini-rating-btn.voted {
            color: var(--accent);
            border-color: var(--accent);
            background: rgba(168, 85, 247, 0.2);
        }

        #mini-vote-up.voted {
            color: var(--success);
            border-color: var(--success);
            background: rgba(40, 167, 69, 0.2);
        }

        #mini-vote-down.voted {
            color: var(--error);
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.2);
        }

        .mini-rating-btn .icon {
            width: 14px;
            height: 14px;
        }

        /* Expanded content */
        .mini-player-expanded {
            display: none;
            width: 100%;
            order: 10;
            padding-top: 10px;
            border-top: 1px solid var(--border);
            margin-top: 10px;
        }

        .mini-player.expanded .mini-player-expanded {
            display: block;
        }

        .mini-player-progress {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .mini-player-progress .progress-bar {
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .mini-player-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .mini-player-controls {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }

        .mini-player-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .mini-player-btn:hover {
            background: var(--accent);
            border-color: var(--accent);
        }

        .mini-player-btn.primary {
            width: 40px;
            height: 40px;
            background: var(--accent);
            border-color: var(--accent);
        }

        .mini-player-btn.primary .icon {
            width: 20px;
            height: 20px;
        }

        /* Expand/collapse icon toggling */
        .mini-player-btn .collapse-icon {
            display: none;
        }
        .mini-player-btn .expand-icon {
            display: block;
        }
        .mini-player.expanded .mini-player-btn .collapse-icon {
            display: block;
        }
        .mini-player.expanded .mini-player-btn .expand-icon {
            display: none;
        }

        .mini-player-btn .icon {
            width: 16px;
            height: 16px;
        }

        #mini-expand-btn .icon {
            transition: transform 0.3s;
        }

        .mini-player.expanded #mini-expand-btn .icon {
            transform: rotate(180deg);
        }

        .mini-player .mini-eq {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 20px;
        }

        .mini-player .mini-eq.paused .mini-eq-bar {
            animation: none;
            transform: scaleY(0.3);
        }

        /* Mini-player tooltips */
        .mini-player [data-tooltip] {
            position: relative;
        }

        .mini-player [data-tooltip]::before,
        .mini-player [data-tooltip]::after {
            position: absolute;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 10000;
        }

        .mini-player [data-tooltip]::after {
            content: attr(data-tooltip);
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%) translateY(4px);
            padding: 6px 10px;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
        }

        .mini-player [data-tooltip]::before {
            content: '';
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%) translateY(4px);
            border: 6px solid transparent;
            border-top-color: rgba(15, 23, 42, 0.95);
        }

        .mini-player [data-tooltip]:hover::before,
        .mini-player [data-tooltip]:hover::after {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        /* Site Footer */
        .site-footer {
            background: linear-gradient(180deg, transparent 0%, rgba(0, 0, 0, 0.3) 100%);
            border-top: 1px solid var(--border);
            padding: 40px 20px 30px;
            margin-top: 60px;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .footer-content {
            max-width: 600px;
            margin: 0 auto;
        }

        .footer-brand {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .footer-brand a {
            color: var(--primary);
            text-decoration: none;
        }

        .footer-brand a:hover {
            text-decoration: underline;
        }

        .footer-address {
            margin: 12px 0;
            line-height: 1.6;
        }

        .footer-contact {
            margin-top: 12px;
        }

        .footer-contact a {
            color: var(--secondary);
            text-decoration: none;
        }

        .footer-contact a:hover {
            text-decoration: underline;
        }

        .footer-copyright {
            margin-top: 16px;
            font-size: 0.8rem;
            opacity: 0.7;
        }
    </style>

    <!-- Site Footer -->
    <footer class="site-footer">
        <div class="footer-content">
            <div class="footer-brand">Sound Box by Valpatel Software LLC</div>
            <div class="footer-copyright">
                 2026 Valpatel Software LLC. Created by Matthew Valancy. All sounds are free for any use  personal, commercial, no attribution required. <a href="https://creativecommons.org/publicdomain/zero/1.0/" target="_blank" rel="noopener" style="color: inherit;">CC0 License</a>
            </div>
        </div>
    </footer>

    <!-- Radio Widget Scripts -->
    <script src="/static/js/radio-widget-events.js"></script>
    <script src="/static/js/radio-widget-core.js"></script>
    <script src="/static/js/radio-widget-visualizer.js"></script>
    <!-- Visualization modes (extend RadioWidgetVisualizer prototype) -->
    <script src="/static/js/visualizations/bars.js"></script>
    <script src="/static/js/visualizations/wave.js"></script>
    <script src="/static/js/visualizations/circle.js"></script>
    <script src="/static/js/visualizations/particles.js"></script>
    <script src="/static/js/visualizations/lissajous.js"></script>
    <script src="/static/js/visualizations/tempest.js"></script>
    <script src="/static/js/visualizations/pong.js"></script>
    <script src="/static/js/visualizations/breakout.js"></script>
    <script src="/static/js/visualizations/snake.js"></script>
    <script src="/static/js/radio-widget-bridge.js"></script>
    <script src="/static/js/radio-widget.js"></script>
</body>
</html>
