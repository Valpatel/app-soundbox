<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sound Box - Graphlings Apps</title>
    <meta name="description" content="Generate music & sound effects using AI">
    <meta name="theme-color" content="#1a1a2e">
    <link rel="icon" type="image/png" sizes="32x32" id="favicon-link" href="/static/graphlings/logo-104.png">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ========================================
           SOUND BOX - Futuristic Theme
           ======================================== */
        :root {
            --bg-dark: #0a0e17;
            --bg-card: #111827;
            --bg-input: #0d1117;
            --accent: #a855f7;
            --accent-glow: rgba(168, 85, 247, 0.4);
            --cyan: #00d4ff;
            --cyan-glow: rgba(0, 212, 255, 0.3);
            --text: #f1f5f9;
            --text-dim: #94a3b8;
            --text-muted: #64748b;
            --border: rgba(255, 255, 255, 0.08);
            --border-hover: rgba(255, 255, 255, 0.15);
            --success: #10b981;
            --error: #ef4444;
            --gradient-accent: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
            --gradient-cyan: linear-gradient(135deg, #00d4ff 0%, #0ea5e9 100%);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            background-image:
                radial-gradient(ellipse at top, rgba(168, 85, 247, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(0, 212, 255, 0.08) 0%, transparent 50%);
            color: var(--text);
            min-height: 100vh;
        }

        h1, h2, h3 { font-family: 'Fredoka', sans-serif; }

        /* Page Header */
        .page-header {
            text-align: center;
            padding: 16px 16px 8px;
            background: transparent;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
            color: var(--text);
            text-shadow: 0 0 30px var(--accent-glow);
        }

        .page-title span {
            background: linear-gradient(135deg, var(--accent), var(--cyan), var(--accent));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: titleGradient 4s ease-in-out infinite;
        }

        @keyframes titleGradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .widget-bar-top {
            display: flex;
            justify-content: center;
            padding: 20px 16px 12px;
            min-height: 70px;
            background: linear-gradient(180deg, rgba(168, 85, 247, 0.08) 0%, transparent 100%);
            border-bottom: 1px solid var(--border);
            margin-bottom: 8px;
        }

        /* Dark themed audio player using filter inversion */
        audio {
            width: 100%;
            height: 36px;
            border-radius: 6px;
            outline: none;
        }

        /* Styled audio wrapper - inverts the default light player to dark */
        .styled-audio {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0 4px;
            margin-bottom: 8px;
        }

        .styled-audio audio {
            filter: invert(1) hue-rotate(180deg) brightness(0.9) contrast(1.1);
            background: transparent;
        }

        /* Override for the now-playing smaller player */
        .now-playing .styled-audio {
            padding: 0 4px;
            margin-bottom: 0;
        }

        .now-playing .styled-audio audio {
            height: 32px;
        }

        .container {
            max-width: 720px;
            margin: 0 auto;
        }

        .subtitle {
            text-align: center;
            color: var(--text-dim);
            margin-bottom: 24px;
            font-size: 0.95rem;
        }

        .subtitle a {
            color: var(--cyan);
            text-decoration: none;
            transition: all 0.2s;
        }

        .subtitle a:hover {
            text-shadow: 0 0 10px var(--cyan-glow);
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid var(--card-border-accent, var(--border));
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
            transition: border-color 0.3s, box-shadow 0.3s, transform 0.3s;
            animation: cardFloat 6s ease-in-out infinite;
        }

        @keyframes cardFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        .card:hover {
            border-color: var(--accent);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 25px var(--accent-glow);
            animation-play-state: paused;
            transform: translateY(-5px);
        }

        /* Labels */
        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-dim);
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Textarea */
        textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-input);
            color: var(--text);
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 90px;
            transition: all 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow), 0 0 15px var(--accent-glow);
        }

        textarea::placeholder {
            color: var(--text-muted);
        }

        /* Model Tabs */
        .model-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .model-tab {
            flex: 1;
            padding: 16px 12px;
            border: 2px solid var(--border);
            border-radius: 14px;
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.25s;
            text-align: center;
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }

        .model-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .model-tab:hover::before {
            left: 100%;
        }

        .model-tab:hover {
            border-color: var(--accent);
            background: var(--chip-bg, rgba(255, 255, 255, 0.02));
            color: var(--text);
            transform: translateY(-3px);
        }

        .model-tab.active {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--chip-bg, rgba(168, 85, 247, 0.1));
            box-shadow: 0 0 20px var(--accent-glow);
            animation: tabPulse 2s ease-in-out infinite;
        }

        @keyframes tabPulse {
            0%, 100% { box-shadow: 0 0 20px var(--accent-glow); }
            50% { box-shadow: 0 0 30px var(--accent-glow), 0 0 40px var(--accent-glow); }
        }

        .model-tab .icon {
            font-size: 28px;
            margin-bottom: 6px;
            display: block;
        }

        .model-tab .name {
            font-weight: 700;
            font-size: 0.9rem;
        }

        .model-tab .desc {
            font-size: 0.7rem;
            margin-top: 4px;
            opacity: 0.7;
        }

        /* Controls Row */
        .controls {
            display: flex;
            gap: 12px;
            align-items: stretch;
            margin-top: 20px;
        }

        /* Control Box - shared style for duration, loop, random */
        .control-box {
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s;
            cursor: pointer;
            position: relative;
        }

        .control-box:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .control-box:active {
            transform: translateY(0);
        }

        .control-box label {
            font-size: 0.7rem;
            margin: 0 0 4px 0;
            text-align: center;
        }

        /* Duration Control */
        .duration-control {
            flex-direction: column;
            min-width: 100px;
        }

        .duration-value {
            text-align: center;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 4px;
            font-family: 'Fredoka', sans-serif;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            box-shadow: 0 0 10px var(--accent-glow);
            transition: transform 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        /* Loop Toggle Control */
        .loop-control {
            gap: 10px;
        }

        .loop-control.active {
            border-color: var(--accent);
            background: rgba(168, 85, 247, 0.1);
        }

        .loop-control .loop-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text);
            margin: 0;
            text-transform: none;
        }

        /* Custom Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 40px;
            height: 22px;
            background: var(--border);
            border-radius: 11px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 16px;
            height: 16px;
            background: var(--text-dim);
            border-radius: 50%;
            transition: all 0.3s;
        }

        .loop-control.active .toggle-switch {
            background: var(--accent);
        }

        .loop-control.active .toggle-switch::after {
            left: 21px;
            background: white;
        }

        .loop-control input[type="checkbox"] {
            display: none;
        }

        /* Random Control */
        .random-control {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text);
            min-width: 80px;
        }

        .random-control:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Generate Button */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: 2px solid transparent;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 700;
            font-family: 'Fredoka', sans-serif;
            cursor: pointer;
            transition: all 0.25s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            flex: 1;
            background: var(--gradient-accent);
            color: white;
            box-shadow: 0 4px 15px var(--accent-glow);
            animation: generatePulse 2s ease-in-out infinite;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: btnShine 3s ease-in-out infinite;
        }

        @keyframes generatePulse {
            0%, 100% { box-shadow: 0 4px 15px var(--accent-glow); }
            50% { box-shadow: 0 4px 25px var(--accent-glow), 0 0 40px var(--accent-glow); }
        }

        @keyframes btnShine {
            0% { left: -100%; }
            50%, 100% { left: 100%; }
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 30px var(--accent-glow);
            animation: none;
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
            animation: none !important;
        }

        .btn:disabled::before {
            animation: none;
        }

        /* Status Messages */
        .status {
            text-align: center;
            padding: 16px;
            margin-top: 16px;
            border-radius: 12px;
            display: none;
            font-weight: 600;
        }

        .status.loading {
            display: block;
            background: var(--chip-bg, rgba(168, 85, 247, 0.15));
            color: var(--accent);
            border: 1px solid var(--chip-border, rgba(168, 85, 247, 0.3));
            animation: statusPulse 2s ease-in-out infinite;
        }

        @keyframes statusPulse {
            0%, 100% { box-shadow: 0 0 0 0 var(--accent-glow); }
            50% { box-shadow: 0 0 20px 5px var(--accent-glow); }
        }

        .status.error {
            display: block;
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Player Section */
        .player {
            margin-top: 20px;
            display: none;
        }

        .player.show {
            display: block;
        }

        audio {
            width: 100%;
            margin-top: 12px;
            border-radius: 8px;
        }

        h2 {
            font-size: 1.1rem;
            margin: 0 0 16px 0;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        h2::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--accent);
            border-radius: 2px;
            box-shadow: 0 0 8px var(--accent-glow);
        }
        /* History List */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .history-item {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: border-color 0.2s;
        }

        .history-item:hover {
            border-color: var(--border-hover);
        }

        .history-header {
            padding: 14px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
        }

        .history-header:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .history-expand {
            color: var(--text-muted);
            font-size: 12px;
            transition: transform 0.2s;
        }

        .history-item.expanded .history-expand {
            transform: rotate(90deg);
            color: var(--accent);
        }

        .history-item.expanded {
            border-color: var(--card-border-accent, var(--border));
        }

        .history-header .prompt {
            flex: 1;
            font-size: 0.9rem;
            color: var(--text);
            word-break: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-header .meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .history-content {
            display: none;
            padding: 0 16px 16px 16px;
            border-top: 1px solid var(--border);
        }

        .history-item.expanded .history-content {
            display: block;
        }

        .history-content .prompt-full {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin: 12px 0;
            word-break: break-word;
        }

        .history-item audio {
            width: 100%;
            margin-bottom: 12px;
        }

        .history-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .rating-btn {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .rating-btn:hover {
            border-color: var(--border-hover);
            color: var(--text);
            transform: scale(1.1);
        }

        .rating-btn.active-up {
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--success);
            color: var(--success);
        }

        .rating-btn.active-down {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--error);
            color: var(--error);
        }

        .download-btn {
            padding: 8px 16px;
            border: 1px solid var(--accent);
            border-radius: 8px;
            background: transparent;
            color: var(--accent);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            text-decoration: none;
            margin-left: auto;
            transition: all 0.2s;
        }

        .download-btn:hover {
            background: var(--chip-bg, rgba(168, 85, 247, 0.1));
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .spectrogram {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .spectrogram:hover {
            opacity: 0.85;
            transform: scale(1.01);
        }

        .spectrogram.loading {
            height: 80px;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .quality-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: 8px;
            text-transform: uppercase;
        }

        .quality-badge.good {
            background: var(--chip-bg, rgba(16, 185, 129, 0.2));
            color: var(--accent);
        }

        .quality-badge.medium {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .quality-badge.bad {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        .quality-issues {
            font-size: 0.75rem;
            color: var(--error);
            margin-top: 4px;
        }

        .player-spectrogram {
            margin-top: 16px;
        }

        .player-spectrogram img {
            width: 100%;
            border-radius: 10px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Example Chips */
        .examples {
            margin-top: 16px;
        }

        .examples span {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .example-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .chip {
            padding: 8px 14px;
            background: var(--chip-bg, rgba(168, 85, 247, 0.1));
            border: 1px solid var(--chip-border, rgba(168, 85, 247, 0.3));
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text);
            position: relative;
            overflow: hidden;
        }

        .chip::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--accent-glow);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .chip:active::after {
            width: 200px;
            height: 200px;
            opacity: 0;
        }

        .chip:hover {
            background: var(--chip-bg, rgba(168, 85, 247, 0.2));
            border-color: var(--accent);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .loading-banner {
            background: rgba(255, 193, 7, 0.15);
            border: 1px solid rgba(255, 193, 7, 0.4);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        .loading-banner.ready {
            background: rgba(40, 167, 69, 0.15);
            border-color: rgba(40, 167, 69, 0.4);
        }
        .loading-banner .title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #ffc107;
        }
        .loading-banner.ready .title {
            color: #28a745;
        }
        .model-status {
            display: flex;
            justify-content: center;
            gap: 30px;
            font-size: 14px;
        }
        .model-status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666;
        }
        .status-dot.pending { background: #666; }
        .status-dot.loading { background: #ffc107; animation: pulse 1s infinite; }
        .status-dot.ready { background: #28a745; }
        .status-dot.error { background: #dc3545; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .gpu-status {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 20px;
            font-size: 13px;
        }
        .gpu-icon {
            font-size: 18px;
        }
        #gpu-name {
            color: #888;
            flex: 0 0 auto;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .gpu-bar {
            flex: 1;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
        }
        .gpu-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #ffc107);
            border-radius: 4px;
            transition: width 0.3s;
            width: 0%;
        }
        #gpu-mem {
            color: #888;
            min-width: 40px;
        }
        .gpu-busy {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .gpu-busy.idle {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }
        .gpu-busy.busy {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }
        .job-progress {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
        }
        .job-progress .position {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        .job-progress .progress-text {
            color: #00d4ff;
            font-weight: 500;
        }
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff 0%, #0099cc 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
        .queue-info {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 10px;
        }
        /* Tooltip styles */
        [title] {
            position: relative;
        }
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
            margin-bottom: 5px;
        }
        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }
        .queue-status-banner {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 15px;
            display: none;
        }
        .queue-status-banner.show {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .queue-status-banner .queue-count {
            color: #ffc107;
            font-weight: 600;
        }
        .queue-status-banner .wait-time {
            color: #888;
            font-size: 13px;
        }
        .feedback-toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(40, 167, 69, 0.95);
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            z-index: 10000;
            pointer-events: none;
            max-width: 90%;
            text-align: center;
        }
        .feedback-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }
        .feedback-toast.error {
            background: rgba(220, 53, 69, 0.95);
        }
        .feedback-toast .toast-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }
        .feedback-toast .copy-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            margin-top: 8px;
            pointer-events: auto !important;
            user-select: none;
            transition: background 0.2s;
        }
        .feedback-toast .copy-btn:hover {
            background: rgba(255,255,255,0.4);
        }
        .feedback-toast .copy-btn:active {
            background: rgba(40, 167, 69, 0.6);
            transform: scale(0.98);
        }

        /* ========================================
           RADIO STATION
           ======================================== */
        .radio-card {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(0, 212, 255, 0.05) 100%);
            border: 2px solid var(--accent);
        }

        .radio-card h2 {
            font-size: 1.3rem;
            color: var(--accent);
        }

        .radio-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .radio-controls select,
        .radio-controls input[type="text"] {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--bg-input);
            color: var(--text);
            font-size: 0.9rem;
            font-family: inherit;
        }

        .radio-controls select {
            min-width: 140px;
            cursor: pointer;
        }

        .radio-controls input[type="text"] {
            flex: 1;
            min-width: 150px;
        }

        .radio-controls select:focus,
        .radio-controls input[type="text"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .shuffle-btn {
            padding: 12px 24px;
            background: var(--gradient-accent);
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 700;
            font-family: 'Fredoka', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .shuffle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .radio-filters {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .filter-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .filter-chips {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
        }

        .filter-chip {
            padding: 6px 14px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-dim);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-chip:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(168, 85, 247, 0.1);
        }

        .filter-chip.active {
            border-color: var(--accent);
            background: var(--accent);
            color: white;
            box-shadow: 0 0 12px var(--accent-glow);
        }

        .now-playing {
            display: flex;
            gap: 16px;
            padding: 16px;
            background: var(--bg-input);
            border-radius: 12px;
            align-items: center;
            margin-bottom: 12px;
        }

        .now-playing.hidden {
            display: none;
        }

        .radio-spectrogram {
            width: 80px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--bg-card);
        }

        .now-playing .track-info {
            flex: 1;
            min-width: 0;
        }

        .now-playing .track-title {
            font-weight: 600;
            color: var(--text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .now-playing .track-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            gap: 12px;
            margin-top: 4px;
        }

        .now-playing .playback-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .now-playing .styled-audio audio {
            width: 160px;
        }

        .skip-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }

        .skip-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .radio-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .radio-actions .vote-btn,
        .radio-actions .comments-btn {
            padding: 8px 14px;
        }

        .feedback-menu {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .feedback-menu.hidden {
            display: none;
        }

        .feedback-header {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 12px;
            font-size: 0.95rem;
        }

        .feedback-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .feedback-tag {
            padding: 8px 14px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: transparent;
            color: var(--text-dim);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .feedback-tag:hover {
            border-color: var(--error);
            color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .feedback-tag.positive:hover {
            border-color: var(--success);
            color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .feedback-cancel {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .feedback-cancel:hover {
            border-color: var(--text-dim);
            color: var(--text);
        }

        .radio-queue {
            border-top: 1px solid var(--border);
            padding-top: 12px;
        }

        .radio-queue.hidden {
            display: none;
        }

        .queue-header {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .queue-items {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 150px;
            overflow-y: auto;
        }

        .queue-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-card);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .queue-item .queue-num {
            color: var(--text-muted);
            font-size: 0.75rem;
            min-width: 20px;
        }

        .queue-item .queue-prompt {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ========================================
           LIBRARY VIEW
           ======================================== */
        .library-card {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.08) 0%, rgba(168, 85, 247, 0.05) 100%);
            border: 2px solid var(--cyan);
        }

        .library-card h2 {
            font-size: 1.3rem;
            color: var(--cyan);
        }

        .library-card h2 span {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: normal;
            margin-left: 8px;
        }

        .library-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .library-controls .search-input {
            flex: 1;
            min-width: 200px;
            padding: 10px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--bg-input);
            color: var(--text);
            font-size: 0.9rem;
            font-family: inherit;
        }

        .library-controls .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        .library-controls select {
            padding: 10px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--bg-input);
            color: var(--text);
            font-size: 0.85rem;
            font-family: inherit;
            cursor: pointer;
        }

        .library-controls select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .library-items {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .library-item {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            transition: border-color 0.2s;
        }

        .library-item:hover {
            border-color: var(--border-hover);
        }

        .item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .model-badge {
            font-size: 16px;
        }

        .item-header .prompt {
            flex: 1;
            font-weight: 600;
            color: var(--text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .item-header .duration {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .library-item audio {
            width: 100%;
            margin-bottom: 10px;
        }

        .item-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .vote-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .vote-btn:hover {
            border-color: var(--border-hover);
        }

        .vote-btn.voted-up {
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--success);
            color: var(--success);
        }

        .vote-btn.voted-down {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--error);
            color: var(--error);
        }

        .vote-count {
            font-size: 0.85rem;
        }

        .comments-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .comments-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .item-download {
            margin-left: auto;
            padding: 6px 14px;
            border: 1px solid var(--accent);
            border-radius: 6px;
            background: transparent;
            color: var(--accent);
            text-decoration: none;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .item-download:hover {
            background: var(--chip-bg);
        }

        /* Comments Section */
        .comments-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            display: none;
        }

        .comments-section.show {
            display: block;
        }

        .comment {
            padding: 10px;
            background: var(--bg-card);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .comment-user {
            font-weight: 600;
            color: var(--accent);
            font-size: 0.85rem;
        }

        .comment-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .comment-text {
            font-size: 0.9rem;
            color: var(--text-dim);
        }

        .comment-input-row {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .comment-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text);
            font-size: 0.9rem;
            font-family: inherit;
        }

        .comment-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .comment-submit {
            padding: 10px 16px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .comment-submit:hover {
            opacity: 0.9;
        }

        .comment-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .page-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-btn:hover:not(:disabled) {
            border-color: var(--accent);
            color: var(--accent);
        }

        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .page-info {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* ========================================
           COLLAPSIBLE GENERATOR
           ======================================== */
        .generator-card h2 {
            cursor: pointer;
            user-select: none;
        }

        .generator-card h2 .collapse-icon {
            margin-left: auto;
            transition: transform 0.3s;
            font-size: 0.8rem;
        }

        .generator-card.collapsed h2 .collapse-icon {
            transform: rotate(-90deg);
        }

        .generator-content {
            transition: max-height 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
        }

        .generator-card.collapsed .generator-content {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
        }
    </style>
</head>
<body>
    <div class="widget-bar-top">
        <div id="wallet-widget-container"></div>
    </div>
    <div class="page-header">
        <h1 class="page-title">Sound <span>Box</span></h1>
    </div>

    <div class="container" style="padding: 0 20px 20px;">
        <p class="subtitle">Generate music & sound effects using Meta's AI models ‚Äî <a href="https://ai.meta.com/resources/models-and-libraries/audiocraft/" target="_blank" rel="noopener" style="color: #00d4ff; text-decoration: none;">More information</a></p>

        <div id="loading-banner" class="loading-banner">
            <div class="title">Loading AI Models...</div>
            <div class="model-status">
                <div class="model-status-item">
                    <span class="status-dot" id="music-status-dot"></span>
                    <span>MusicGen</span>
                </div>
                <div class="model-status-item">
                    <span class="status-dot" id="audio-status-dot"></span>
                    <span>AudioGen</span>
                </div>
            </div>
        </div>

        <div id="gpu-status" class="gpu-status" title="GPU memory usage and status">
            <span class="gpu-icon">üñ•Ô∏è</span>
            <span id="gpu-name">GPU</span>
            <div class="gpu-bar">
                <div class="gpu-bar-fill" id="gpu-bar-fill"></div>
            </div>
            <span id="gpu-mem">0%</span>
            <span class="gpu-busy" id="gpu-busy">IDLE</span>
        </div>

        <div id="queue-status-banner" class="queue-status-banner">
            <span><span class="queue-count" id="queue-count">0</span> jobs in queue</span>
            <span class="wait-time" id="estimated-wait">Est. wait: calculating...</span>
        </div>

        <!-- RADIO STATION (Primary Feature) -->
        <div class="card radio-card">
            <h2>üìª Radio Station</h2>

            <div class="radio-controls">
                <select id="radio-model">
                    <option value="music">üéµ Music</option>
                    <option value="audio">üîä Sound Effects</option>
                </select>
                <input type="text" id="radio-keywords" placeholder="Keywords (optional)...">
                <button class="shuffle-btn" id="shuffle-btn" onclick="shuffleRadio()">üîÄ Shuffle Play</button>
            </div>

            <div class="radio-filters" id="radio-filters">
                <span class="filter-label">Quick Filters</span>
                <div class="filter-chips">
                    <button class="filter-chip" onclick="setRadioFilter('chill ambient relaxing', this)">üòå Chill</button>
                    <button class="filter-chip" onclick="setRadioFilter('upbeat energetic', this)">‚ö° Energetic</button>
                    <button class="filter-chip" onclick="setRadioFilter('epic orchestral cinematic', this)">üé¨ Epic</button>
                    <button class="filter-chip" onclick="setRadioFilter('dark moody', this)">üåô Dark</button>
                    <button class="filter-chip" onclick="setRadioFilter('8-bit chiptune retro', this)">üëæ Retro</button>
                    <button class="filter-chip" onclick="setRadioFilter('lo-fi hip hop jazz', this)">üéß Lo-Fi</button>
                    <button class="filter-chip" onclick="setRadioFilter('', this)">‚ú® All</button>
                </div>
            </div>

            <div class="now-playing hidden" id="now-playing">
                <img id="radio-spectrogram" class="radio-spectrogram" src="" alt="Spectrogram">
                <div class="track-info">
                    <div id="radio-prompt" class="track-title">Loading...</div>
                    <div class="track-meta">
                        <span id="radio-duration">0s</span>
                    </div>
                </div>
                <div class="playback-controls">
                    <div class="styled-audio">
                        <audio id="radio-player" controls></audio>
                    </div>
                    <button class="skip-btn" onclick="skipTrack()">‚è≠ Skip</button>
                </div>
                <div class="radio-actions">
                    <button class="vote-btn" id="radio-vote-up" onclick="showPositiveFeedbackMenu()">üëç <span id="radio-upvotes">0</span></button>
                    <button class="vote-btn" id="radio-vote-down" onclick="showFeedbackMenu()">üëé <span id="radio-downvotes">0</span></button>
                </div>
            </div>

            <div class="feedback-menu hidden" id="feedback-menu-positive">
                <div class="feedback-header" style="color: var(--success);">What do you like about this track?</div>
                <div class="feedback-options">
                    <button class="feedback-tag positive" onclick="submitPositiveFeedback('catchy')">üéµ Catchy/memorable</button>
                    <button class="feedback-tag positive" onclick="submitPositiveFeedback('quality')">‚ú® Great quality</button>
                    <button class="feedback-tag positive" onclick="submitPositiveFeedback('creative')">üé® Creative/unique</button>
                    <button class="feedback-tag positive" onclick="submitPositiveFeedback('matches')">‚úÖ Matches prompt well</button>
                    <button class="feedback-tag positive" onclick="submitPositiveFeedback('mood')">üòä Great mood/vibe</button>
                    <button class="feedback-tag positive" onclick="submitPositiveFeedback('useful')">üéÆ Perfect for games</button>
                </div>
                <button class="feedback-cancel" onclick="hidePositiveFeedbackMenu()">Cancel</button>
            </div>

            <div class="feedback-menu hidden" id="feedback-menu">
                <div class="feedback-header">What's wrong with this track?</div>
                <div class="feedback-options">
                    <button class="feedback-tag" onclick="submitFeedback('scratchy')">üîä Too scratchy/noisy</button>
                    <button class="feedback-tag" onclick="submitFeedback('quiet')">üîá Too quiet</button>
                    <button class="feedback-tag" onclick="submitFeedback('repetitive')">üîÅ Too repetitive</button>
                    <button class="feedback-tag" onclick="submitFeedback('mismatch')">‚ùå Doesn't match prompt</button>
                    <button class="feedback-tag" onclick="submitFeedback('boring')">üò¥ Boring/generic</button>
                    <button class="feedback-tag" onclick="submitFeedback('style')">üé® Not my style</button>
                    <button class="feedback-tag" onclick="submitFeedback('other')">‚ùì Other</button>
                </div>
                <button class="feedback-cancel" onclick="hideFeedbackMenu()">Cancel</button>
            </div>

            <div class="radio-queue hidden" id="radio-queue">
                <div class="queue-header">Up Next:</div>
                <div class="queue-items" id="queue-items"></div>
            </div>
        </div>

        <!-- LIBRARY (Browse & Search) -->
        <div class="card library-card">
            <h2>üîç Library <span id="library-total"></span></h2>

            <div class="library-controls">
                <input type="text" class="search-input" id="library-search" placeholder="Search prompts...">
                <select id="library-model">
                    <option value="">All Types</option>
                    <option value="music">üéµ Music</option>
                    <option value="audio">üîä Sound Effects</option>
                </select>
                <select id="library-sort">
                    <option value="recent">Most Recent</option>
                    <option value="popular">Most Popular</option>
                    <option value="rating">Highest Rated</option>
                </select>
            </div>

            <div id="library-items" class="library-items">
                <div style="text-align: center; color: var(--text-muted); padding: 20px;">Loading library...</div>
            </div>

            <div class="pagination" id="pagination">
                <button class="page-btn" id="prev-page" onclick="prevPage()">‚Üê Prev</button>
                <span class="page-info" id="page-info">Page 1 of 1</span>
                <button class="page-btn" id="next-page" onclick="nextPage()">Next ‚Üí</button>
            </div>
        </div>

        <!-- GENERATOR (Secondary - Collapsible) -->
        <div class="card generator-card" id="generator-card">
            <h2 onclick="toggleGenerator()">üéπ Generate New <span class="collapse-icon">‚ñº</span></h2>
            <div class="generator-content">
            <div class="model-tabs">
                <div class="model-tab active" data-model="music" onclick="selectModel('music')">
                    <div class="icon">üéµ</div>
                    <div class="name">MusicGen</div>
                    <div class="desc">Generate music</div>
                </div>
                <div class="model-tab" data-model="audio" onclick="selectModel('audio')">
                    <div class="icon">üîä</div>
                    <div class="name">AudioGen</div>
                    <div class="desc">Generate sound effects</div>
                </div>
            </div>

            <label for="prompt">Describe what you want to generate:</label>
            <textarea id="prompt" placeholder="e.g., upbeat electronic dance music with heavy bass and synth leads"></textarea>

            <div class="examples" id="music-examples">
                <span>Try these:</span>
                <div class="example-chips">
                    <span class="chip" onclick="setPrompt('lo-fi hip hop beat with jazzy piano')">Lo-fi Hip Hop</span>
                    <span class="chip" onclick="setPrompt('epic orchestral music with dramatic strings')">Epic Orchestral</span>
                    <span class="chip" onclick="setPrompt('chill acoustic guitar with soft drums')">Chill Acoustic</span>
                    <span class="chip" onclick="setPrompt('80s synthwave with retro synths and drums')">80s Synthwave</span>
                </div>
            </div>

            <div class="examples" id="audio-examples" style="display: none;">
                <span>Try these:</span>
                <div class="example-chips">
                    <span class="chip" onclick="setPrompt('dog barking in the distance')">Dog Barking</span>
                    <span class="chip" onclick="setPrompt('thunder and heavy rain')">Thunder Storm</span>
                    <span class="chip" onclick="setPrompt('footsteps on wooden floor')">Footsteps</span>
                    <span class="chip" onclick="setPrompt('car engine starting and revving')">Car Engine</span>
                    <span class="chip" onclick="setPrompt('crowd cheering at a sports event')">Crowd Cheering</span>
                    <span class="chip" onclick="setPrompt('glass breaking and shattering')">Glass Breaking</span>
                </div>
            </div>

            <div class="controls">
                <div class="control-box duration-control">
                    <label for="duration">Duration</label>
                    <div class="duration-value"><span id="duration-display">8</span>s</div>
                    <input type="range" id="duration" min="3" max="120" value="8">
                </div>
                <div class="control-box loop-control" id="loop-control" onclick="toggleLoop()" title="Apply crossfade to make the audio loop seamlessly">
                    <span class="toggle-switch"></span>
                    <span class="loop-label">Loop</span>
                    <input type="checkbox" id="loop-checkbox">
                </div>
                <div class="control-box random-control" id="random-btn" onclick="randomPrompt()" title="Generate a random creative prompt">Random</div>
                <button id="generate-btn" class="btn btn-primary" onclick="generate()" title="Generate audio from your prompt">
                    <span>Generate</span>
                </button>
            </div>

            <div id="status" class="status"></div>

            <div id="player" class="player">
                <h2>Generated Audio <span id="quality-badge" class="quality-badge"></span></h2>
                <div class="styled-audio">
                    <audio id="audio" controls></audio>
                </div>
                <div id="player-spectrogram" class="player-spectrogram"></div>
            </div>
            </div> <!-- /generator-content -->
        </div>

        <!-- Legacy History (hidden, kept for backwards compatibility) -->
        <div class="card" id="history-card" style="display: none;">
            <h2>Recent Generations</h2>
            <div id="history" class="history-list"></div>
        </div>
    </div>

    <script>
        const promptEl = document.getElementById('prompt');
        const durationEl = document.getElementById('duration');
        const durationDisplay = document.getElementById('duration-display');
        const statusEl = document.getElementById('status');
        const playerEl = document.getElementById('player');
        const audioEl = document.getElementById('audio');
        const generateBtn = document.getElementById('generate-btn');
        const historyEl = document.getElementById('history');
        const historyCard = document.getElementById('history-card');
        const musicExamples = document.getElementById('music-examples');
        const audioExamples = document.getElementById('audio-examples');
        const loadingBanner = document.getElementById('loading-banner');
        const musicStatusDot = document.getElementById('music-status-dot');
        const audioStatusDot = document.getElementById('audio-status-dot');
        const qualityBadge = document.getElementById('quality-badge');
        const playerSpectrogram = document.getElementById('player-spectrogram');

        let currentModel = 'music';
        let modelStatus = { music: 'pending', audio: 'pending' };
        let currentJobId = null;
        let modelsReady = false;

        // Separate prompts for each model
        let modelPrompts = {
            music: '',
            audio: ''
        };

        // User ID - use Graphlings login OR generate anonymous device ID
        let currentUserId = null;
        let isAdultAccount = false;  // Only true for verified adult Graphlings accounts

        // Generate anonymous device ID for voting without login
        function getDeviceId() {
            let deviceId = localStorage.getItem('soundbox_device_id');
            if (!deviceId) {
                deviceId = 'anon_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
                localStorage.setItem('soundbox_device_id', deviceId);
            }
            return deviceId;
        }

        // Get effective user ID (logged in user OR device ID)
        function getEffectiveUserId() {
            return currentUserId || getDeviceId();
        }

        // Check if user can see comments (adults only)
        function canSeeComments() {
            return isAdultAccount;
        }

        const gpuName = document.getElementById('gpu-name');
        const gpuBarFill = document.getElementById('gpu-bar-fill');
        const gpuMem = document.getElementById('gpu-mem');
        const gpuBusy = document.getElementById('gpu-busy');

        const queueBanner = document.getElementById('queue-status-banner');
        const queueCountEl = document.getElementById('queue-count');
        const estimatedWaitEl = document.getElementById('estimated-wait');

        async function checkStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                modelStatus = data.models;

                // Update model status dots
                musicStatusDot.className = 'status-dot ' + (modelStatus.music.startsWith?.('error') ? 'error' : modelStatus.music);
                audioStatusDot.className = 'status-dot ' + (modelStatus.audio.startsWith?.('error') ? 'error' : modelStatus.audio);

                // Update GPU status
                if (data.gpu && data.gpu.available) {
                    gpuName.textContent = data.gpu.name?.replace('NVIDIA GeForce ', '') || 'GPU';
                    gpuBarFill.style.width = data.gpu.memory_percent + '%';
                    gpuMem.textContent = data.gpu.memory_percent + '%';
                    gpuBusy.textContent = data.gpu.busy ? 'BUSY' : 'IDLE';
                    gpuBusy.className = 'gpu-busy ' + (data.gpu.busy ? 'busy' : 'idle');
                }

                // Check if all ready
                const allReady = modelStatus.music === 'ready' && modelStatus.audio === 'ready';
                if (allReady && !modelsReady) {
                    modelsReady = true;
                    loadingBanner.classList.add('ready');
                    loadingBanner.querySelector('.title').textContent = 'Models Ready!';
                    setTimeout(() => {
                        loadingBanner.style.display = 'none';
                    }, 2000);
                }

                // Update queue status
                if (data.queue_length > 0) {
                    queueBanner.classList.add('show');
                    queueCountEl.textContent = data.queue_length;
                    const waitSeconds = data.estimated_wait || 0;
                    if (waitSeconds > 60) {
                        estimatedWaitEl.textContent = `Est. wait: ${Math.ceil(waitSeconds / 60)} min`;
                    } else if (waitSeconds > 0) {
                        estimatedWaitEl.textContent = `Est. wait: ~${Math.ceil(waitSeconds)}s`;
                    } else {
                        estimatedWaitEl.textContent = 'Processing now...';
                    }
                } else {
                    queueBanner.classList.remove('show');
                }

                updateGenerateButton();
            } catch (err) {
                console.error('Status check failed:', err);
            }

            // Keep polling
            setTimeout(checkStatus, 2000);
        }

        function updateGenerateButton() {
            if (currentJobId) {
                generateBtn.disabled = true;
                return;
            }
            const ready = modelStatus[currentModel] === 'ready';
            generateBtn.disabled = !ready;
            if (!ready && modelStatus[currentModel] === 'loading') {
                generateBtn.textContent = 'Loading Model...';
            } else {
                generateBtn.textContent = 'Generate';
            }
        }

        durationEl.addEventListener('input', () => {
            durationDisplay.textContent = durationEl.value;
        });

        function selectModel(model) {
            // Save current prompt before switching
            modelPrompts[currentModel] = promptEl.value;

            currentModel = model;
            document.querySelectorAll('.model-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.model === model);
            });

            if (model === 'music') {
                musicExamples.style.display = 'block';
                audioExamples.style.display = 'none';
                promptEl.placeholder = 'e.g., upbeat electronic dance music with heavy bass and synth leads';
            } else {
                musicExamples.style.display = 'none';
                audioExamples.style.display = 'block';
                promptEl.placeholder = 'e.g., dog barking loudly, thunder in the background';
            }

            // Restore saved prompt for this model
            promptEl.value = modelPrompts[model] || '';

            updateGenerateButton();

            // Reload history filtered by model
            loadHistory();
        }

        function setPrompt(text) {
            promptEl.value = text;
            promptEl.focus();
        }

        function toggleLoop() {
            const loopControl = document.getElementById('loop-control');
            const checkbox = document.getElementById('loop-checkbox');
            checkbox.checked = !checkbox.checked;
            loopControl.classList.toggle('active', checkbox.checked);
        }

        async function randomPrompt() {
            const randomBtn = document.getElementById('random-btn');
            randomBtn.style.opacity = '0.5';
            randomBtn.style.pointerEvents = 'none';

            try {
                const response = await fetch('/random-prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: currentModel })
                });
                const data = await response.json();

                if (data.success && data.prompt) {
                    promptEl.value = data.prompt;
                    promptEl.focus();
                } else {
                    console.error('Random prompt failed:', data.error);
                }
            } catch (err) {
                console.error('Random prompt error:', err);
            } finally {
                randomBtn.style.opacity = '1';
                randomBtn.style.pointerEvents = 'auto';
            }
        }

        async function generate() {
            const prompt = promptEl.value.trim();
            if (!prompt) {
                statusEl.className = 'status error';
                statusEl.textContent = 'Please enter a description';
                return;
            }

            generateBtn.disabled = true;
            statusEl.className = 'status loading';
            statusEl.innerHTML = `<span class="spinner"></span>Submitting to queue...`;
            playerEl.classList.remove('show');

            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        duration: parseInt(durationEl.value),
                        model: currentModel,
                        loop: document.getElementById('loop-checkbox').checked,
                        priority: 'standard',
                        user_id: currentUserId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    currentJobId = data.job_id;
                    statusEl.innerHTML = `
                        <div class="job-progress">
                            <div class="position">Position in queue: ${data.position}</div>
                            <div class="progress-text"><span class="spinner"></span>Waiting...</div>
                        </div>
                    `;
                    pollJobStatus();
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = 'Error: ' + data.error;
                    generateBtn.disabled = false;
                }
            } catch (err) {
                statusEl.className = 'status error';
                statusEl.textContent = 'Error: ' + err.message;
                generateBtn.disabled = false;
            }
        }

        async function pollJobStatus() {
            if (!currentJobId) return;

            try {
                const response = await fetch(`/job/${currentJobId}`);
                const job = await response.json();

                if (job.status === 'completed') {
                    statusEl.style.display = 'none';
                    audioEl.src = `/audio/${job.filename}`;

                    // Show quality badge
                    if (job.quality) {
                        const score = job.quality.score;
                        qualityBadge.textContent = `${score}%`;
                        qualityBadge.className = 'quality-badge ' +
                            (score >= 80 ? 'good' : score >= 60 ? 'medium' : 'bad');
                    } else {
                        qualityBadge.textContent = '';
                    }

                    // Show spectrogram
                    if (job.spectrogram) {
                        playerSpectrogram.innerHTML = `<img src="/spectrogram/${job.spectrogram}" alt="Spectrogram">`;
                    }

                    playerEl.classList.add('show');
                    loadHistory();
                    currentJobId = null;
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'Generate';
                } else if (job.status === 'failed') {
                    statusEl.className = 'status error';
                    statusEl.textContent = 'Error: ' + (job.error || 'Generation failed');
                    currentJobId = null;
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'Generate';
                } else {
                    // Still processing
                    const posText = job.position > 1 ? `Position in queue: ${job.position}` : '';
                    const pct = job.progress_pct || 0;
                    const showBar = job.status === 'processing' && pct > 0;
                    statusEl.innerHTML = `
                        <div class="job-progress">
                            ${posText ? `<div class="position">${posText}</div>` : ''}
                            ${showBar ? `
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill" style="width: ${pct}%"></div>
                                </div>
                            ` : ''}
                            <div class="progress-text">${!showBar ? '<span class="spinner"></span>' : ''}${job.progress || 'Processing...'}</div>
                        </div>
                    `;
                    setTimeout(pollJobStatus, 300);
                }
            } catch (err) {
                console.error('Job poll failed:', err);
                setTimeout(pollJobStatus, 1000);
            }
        }

        let showAllHistory = true;  // Default to showing all assets

        async function loadHistory() {
            try {
                // Build query params for filtering
                const params = new URLSearchParams();
                if (!showAllHistory) {
                    params.set('model', currentModel);
                }
                if (currentUserId) {
                    params.set('user_id', currentUserId);
                }

                const response = await fetch('/history?' + params.toString());
                const items = await response.json();

                // Update history section title based on filter
                const historyTitle = historyCard.querySelector('h2');
                if (historyTitle) {
                    if (showAllHistory) {
                        historyTitle.innerHTML = 'üìÅ All Generations (' + items.length + ')';
                    } else {
                        historyTitle.innerHTML = currentModel === 'music'
                            ? 'üéµ Music History'
                            : 'üîä Sound Effects History';
                    }
                }

                if (items.length > 0) {
                    historyCard.style.display = 'block';
                    historyEl.innerHTML = items.map(item => {
                        const score = item.quality_score;
                        const qualityClass = score >= 80 ? 'good' : score >= 60 ? 'medium' : 'bad';
                        const specSrc = item.spectrogram ? `/spectrogram/${item.spectrogram}` : '';
                        const promptShort = item.prompt.length > 50 ? item.prompt.substring(0, 50) + '...' : item.prompt;
                        const loopBadge = item.loop ? '<span class="loop-badge">üîÅ</span>' : '';

                        return `
                        <div class="history-item" data-filename="${item.filename}">
                            <div class="history-header" onclick="toggleHistoryItem(this)">
                                <span class="history-expand">‚ñ∂</span>
                                <span class="meta">${item.model === 'music' ? 'üéµ' : 'üîä'}</span>
                                <span class="prompt">${escapeHtml(promptShort)}</span>
                                <span class="meta">${item.duration}s</span>
                                ${score ? `<span class="quality-badge ${qualityClass}">${score}%</span>` : ''}
                            </div>
                            <div class="history-content">
                                <div class="prompt-full">${escapeHtml(item.prompt)}</div>
                                <div class="styled-audio">
                                    <audio src="/audio/${item.filename}" controls></audio>
                                </div>
                                ${specSrc ?
                                    `<img class="spectrogram" src="${specSrc}" alt="Spectrogram" loading="lazy">` :
                                    `<div class="spectrogram loading" onclick="loadSpectrogram(this, '${item.filename}')">Click to load spectrogram</div>`
                                }
                                ${item.quality_issues && item.quality_issues.length > 0 ?
                                    `<div class="quality-issues">‚ö†Ô∏è ${item.quality_issues.join(', ')}</div>` : ''
                                }
                                <div class="history-actions">
                                    <button class="rating-btn ${item.rating === 'up' ? 'active-up' : ''}" onclick="rate('${item.filename}', 'up')">üëç</button>
                                    <button class="rating-btn ${item.rating === 'down' ? 'active-down' : ''}" onclick="rate('${item.filename}', 'down')">üëé</button>
                                    <a href="/download/${item.filename}" class="download-btn">‚¨á Download</a>
                                </div>
                            </div>
                        </div>
                    `}).join('');
                }
            } catch (err) {
                console.error('Failed to load history:', err);
            }

            // Handle empty results
            if (!historyEl.innerHTML || historyEl.innerHTML.trim() === '') {
                historyCard.style.display = 'none';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleHistoryItem(header) {
            const item = header.closest('.history-item');
            item.classList.toggle('expanded');
        }

        async function loadSpectrogram(element, filename) {
            element.textContent = 'Loading...';
            try {
                const response = await fetch(`/generate-spectrogram/${filename}`);
                const data = await response.json();
                if (data.spectrogram) {
                    const img = document.createElement('img');
                    img.className = 'spectrogram';
                    img.src = `/spectrogram/${data.spectrogram}`;
                    img.alt = 'Spectrogram';
                    element.replaceWith(img);
                }
            } catch (err) {
                element.textContent = 'Failed to load';
            }
        }

        async function rate(filename, rating) {
            const item = document.querySelector(`[data-filename="${filename}"]`);
            const upBtn = item.querySelector('.rating-btn:first-child');
            const downBtn = item.querySelector('.rating-btn:nth-child(2)');

            // Toggle: if already active, remove rating
            const currentUp = upBtn.classList.contains('active-up');
            const currentDown = downBtn.classList.contains('active-down');
            let newRating = rating;
            if ((rating === 'up' && currentUp) || (rating === 'down' && currentDown)) {
                newRating = null;
            }

            try {
                await fetch('/rate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename, rating: newRating })
                });

                upBtn.classList.toggle('active-up', newRating === 'up');
                downBtn.classList.toggle('active-down', newRating === 'down');

                // If thumbs down, show feedback message and remove from list
                if (newRating === 'down') {
                    showFeedbackToast('Thanks for your feedback!');
                    item.style.transition = 'opacity 0.5s, transform 0.5s, max-height 0.5s';
                    item.style.opacity = '0.5';

                    setTimeout(() => {
                        item.style.opacity = '0';
                        item.style.transform = 'translateX(-20px)';
                        item.style.maxHeight = '0';
                        item.style.overflow = 'hidden';
                        item.style.paddingTop = '0';
                        item.style.paddingBottom = '0';
                        item.style.marginBottom = '0';

                        setTimeout(() => {
                            item.remove();
                            // Check if history is empty
                            if (historyEl.children.length === 0) {
                                historyCard.style.display = 'none';
                            }
                        }, 500);
                    }, 1200);
                }
            } catch (err) {
                console.error('Failed to rate:', err);
            }
        }

        function showFeedbackToast(message, isError = false) {
            // Remove existing toast if any
            const existingToast = document.querySelector('.feedback-toast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.className = 'feedback-toast' + (isError ? ' error' : '');

            if (isError) {
                // Error toast with copy button
                const content = document.createElement('div');
                content.className = 'toast-content';

                const msgDiv = document.createElement('div');
                msgDiv.className = 'toast-message';
                msgDiv.textContent = message;
                content.appendChild(msgDiv);

                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.textContent = 'üìã Copy Error';
                copyBtn.type = 'button';
                copyBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Copy button clicked, message:', message);

                    // Try modern clipboard API first
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(message).then(() => {
                            copyBtn.textContent = '‚úì Copied!';
                            copyBtn.style.background = 'rgba(40, 167, 69, 0.6)';
                            console.log('Copied via clipboard API');
                        }).catch((err) => {
                            console.log('Clipboard API failed, trying fallback:', err);
                            fallbackCopy();
                        });
                    } else {
                        fallbackCopy();
                    }

                    function fallbackCopy() {
                        const textArea = document.createElement('textarea');
                        textArea.value = message;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-9999px';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        try {
                            const success = document.execCommand('copy');
                            if (success) {
                                copyBtn.textContent = '‚úì Copied!';
                                copyBtn.style.background = 'rgba(40, 167, 69, 0.6)';
                                console.log('Copied via execCommand');
                            } else {
                                copyBtn.textContent = '‚úó Failed';
                                console.log('execCommand returned false');
                            }
                        } catch (err) {
                            copyBtn.textContent = '‚úó Failed';
                            console.error('Copy failed:', err);
                        }
                        document.body.removeChild(textArea);
                    }

                    // Reset button after delay
                    setTimeout(() => {
                        copyBtn.textContent = 'üìã Copy Error';
                        copyBtn.style.background = '';
                    }, 2500);
                });
                content.appendChild(copyBtn);
                toast.appendChild(content);

                // Log error to backend
                logErrorToBackend(message);
            } else {
                toast.textContent = message;
            }

            document.body.appendChild(toast);

            // Trigger animation
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            // Remove after delay (longer for errors)
            const delay = isError ? 10000 : 2500;
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, delay);
        }

        async function logErrorToBackend(message) {
            try {
                await fetch('/api/log-error', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        url: window.location.href,
                        userAgent: navigator.userAgent,
                        timestamp: new Date().toISOString()
                    })
                });
            } catch (e) {
                console.error('Failed to log error to backend:', e);
            }
        }

        function showErrorToast(message) {
            showFeedbackToast(message, true);
        }

        // ========================================
        // RADIO STATION
        // ========================================
        let radioQueue = [];
        let currentRadioTrack = null;
        const radioPlayer = document.getElementById('radio-player');
        const nowPlayingEl = document.getElementById('now-playing');
        const radioQueueEl = document.getElementById('radio-queue');
        const queueItemsEl = document.getElementById('queue-items');

        async function shuffleRadio() {
            const model = document.getElementById('radio-model').value;
            const keywords = document.getElementById('radio-keywords').value.trim();
            const shuffleBtn = document.getElementById('shuffle-btn');

            shuffleBtn.disabled = true;
            shuffleBtn.textContent = 'Loading...';

            try {
                const params = new URLSearchParams({ model, count: 10 });
                if (keywords) params.set('search', keywords);

                const response = await fetch('/api/radio/shuffle?' + params.toString());
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                if (data.tracks && data.tracks.length > 0) {
                    radioQueue = data.tracks;
                    playNextTrack();
                    updateRadioQueue();
                } else {
                    showFeedbackToast('No tracks found with those filters');
                }
            } catch (err) {
                console.error('Radio shuffle failed:', err);
                showErrorToast('Failed to load tracks: ' + err.message);
            } finally {
                shuffleBtn.disabled = false;
                shuffleBtn.textContent = 'üîÄ Shuffle Play';
            }
        }

        function playNextTrack() {
            if (radioQueue.length === 0) {
                nowPlayingEl.classList.add('hidden');
                radioQueueEl.classList.add('hidden');
                currentRadioTrack = null;
                return;
            }

            currentRadioTrack = radioQueue.shift();

            // Skip tracks with missing data
            if (!currentRadioTrack.filename || !currentRadioTrack.prompt) {
                console.warn('Skipping invalid track:', currentRadioTrack);
                playNextTrack();
                return;
            }

            nowPlayingEl.classList.remove('hidden');

            // Update now playing display
            document.getElementById('radio-prompt').textContent = currentRadioTrack.prompt;
            document.getElementById('radio-duration').textContent = currentRadioTrack.duration + 's';
            document.getElementById('radio-upvotes').textContent = currentRadioTrack.upvotes || 0;
            document.getElementById('radio-downvotes').textContent = currentRadioTrack.downvotes || 0;

            // Reset vote button states
            document.getElementById('radio-vote-up').classList.remove('voted-up');
            document.getElementById('radio-vote-down').classList.remove('voted-down');

            // Load user's vote for this track
            loadRadioTrackVote();

            // Update comment count
            document.getElementById('radio-comment-count').textContent = currentRadioTrack.comment_count || 0;

            // Hide comments section when changing tracks
            document.getElementById('radio-comments-section').classList.add('hidden');

            const specImg = document.getElementById('radio-spectrogram');
            if (currentRadioTrack.spectrogram) {
                specImg.src = '/spectrogram/' + currentRadioTrack.spectrogram;
                specImg.style.display = 'block';
            } else {
                specImg.style.display = 'none';
            }

            // Play the audio
            radioPlayer.src = '/audio/' + currentRadioTrack.filename;
            radioPlayer.play();

            updateRadioQueue();
        }

        let currentRadioVote = 0;

        async function loadRadioTrackVote() {
            if (!currentRadioTrack) return;
            const voterId = getEffectiveUserId();
            try {
                const response = await fetch('/api/library/votes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ generation_ids: [currentRadioTrack.id], user_id: voterId })
                });
                const data = await response.json();
                currentRadioVote = data.votes?.[currentRadioTrack.id] || 0;
                document.getElementById('radio-vote-up').classList.toggle('voted-up', currentRadioVote === 1);
                document.getElementById('radio-vote-down').classList.toggle('voted-down', currentRadioVote === -1);
            } catch (err) {
                console.error('Failed to load radio track vote:', err);
            }
        }

        async function voteRadioTrack(voteValue) {
            if (!currentRadioTrack) return;
            const voterId = getEffectiveUserId();

            // Toggle vote if clicking same button
            const newVote = currentRadioVote === voteValue ? 0 : voteValue;

            try {
                const response = await fetch(`/api/library/${currentRadioTrack.id}/vote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vote: newVote, user_id: voterId })
                });
                const data = await response.json();

                currentRadioVote = data.user_vote;
                document.getElementById('radio-upvotes').textContent = data.upvotes;
                document.getElementById('radio-downvotes').textContent = data.downvotes;
                document.getElementById('radio-vote-up').classList.toggle('voted-up', data.user_vote === 1);
                document.getElementById('radio-vote-down').classList.toggle('voted-down', data.user_vote === -1);

                // If downvoted, skip to next track after a moment
                if (newVote === -1) {
                    showFeedbackToast('Skipping...');
                    setTimeout(() => skipTrack(), 800);
                }
            } catch (err) {
                console.error('Radio vote failed:', err);
            }
        }

        function showPositiveFeedbackMenu() {
            document.getElementById('feedback-menu-positive').classList.remove('hidden');
            document.getElementById('feedback-menu').classList.add('hidden');
        }

        function hidePositiveFeedbackMenu() {
            document.getElementById('feedback-menu-positive').classList.add('hidden');
        }

        async function submitPositiveFeedback(reason) {
            if (!currentRadioTrack) return;
            const voterId = getEffectiveUserId();

            try {
                // Submit upvote
                const response = await fetch(`/api/library/${currentRadioTrack.id}/vote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vote: 1, user_id: voterId })
                });
                const data = await response.json();

                // Store positive feedback reason
                await fetch(`/api/library/${currentRadioTrack.id}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: voterId,
                        content: `[POSITIVE:${reason}]`,
                        username: 'System'
                    })
                });

                // Update UI
                currentRadioVote = 1;
                document.getElementById('radio-upvotes').textContent = data.upvotes;
                document.getElementById('radio-downvotes').textContent = data.downvotes;
                document.getElementById('radio-vote-up').classList.add('voted-up');
                document.getElementById('radio-vote-down').classList.remove('voted-down');

                hidePositiveFeedbackMenu();

                const reasons = {
                    'catchy': 'Catchy!',
                    'quality': 'Great quality!',
                    'creative': 'Creative!',
                    'matches': 'Matches well!',
                    'mood': 'Great vibe!',
                    'useful': 'Perfect for games!'
                };
                showFeedbackToast(`üëç ${reasons[reason]}`);

            } catch (err) {
                console.error('Positive feedback failed:', err);
                showErrorToast('Failed to submit feedback: ' + err.message);
            }
        }

        function showFeedbackMenu() {
            document.getElementById('feedback-menu').classList.remove('hidden');
            document.getElementById('feedback-menu-positive').classList.add('hidden');
        }

        function hideFeedbackMenu() {
            document.getElementById('feedback-menu').classList.add('hidden');
        }

        async function submitFeedback(reason) {
            if (!currentRadioTrack) return;
            const voterId = getEffectiveUserId();

            try {
                // Submit downvote with feedback reason as comment
                const response = await fetch(`/api/library/${currentRadioTrack.id}/vote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vote: -1, user_id: voterId })
                });
                const data = await response.json();

                // Also store the feedback reason
                await fetch(`/api/library/${currentRadioTrack.id}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: voterId,
                        content: `[FEEDBACK:${reason}]`,
                        username: 'System'
                    })
                });

                // Update UI
                currentRadioVote = -1;
                document.getElementById('radio-upvotes').textContent = data.upvotes;
                document.getElementById('radio-downvotes').textContent = data.downvotes;
                document.getElementById('radio-vote-up').classList.remove('voted-up');
                document.getElementById('radio-vote-down').classList.add('voted-down');

                hideFeedbackMenu();

                const reasons = {
                    'scratchy': 'Too scratchy',
                    'quiet': 'Too quiet',
                    'repetitive': 'Too repetitive',
                    'mismatch': "Doesn't match",
                    'boring': 'Boring',
                    'style': 'Not my style',
                    'other': 'Other'
                };
                showFeedbackToast(`Feedback: ${reasons[reason]} - Skipping...`);
                setTimeout(() => skipTrack(), 1000);

            } catch (err) {
                console.error('Feedback failed:', err);
                showErrorToast('Failed to submit feedback: ' + err.message);
            }
        }

        function skipTrack() {
            playNextTrack();
        }

        function setRadioFilter(keywords, btn) {
            document.getElementById('radio-keywords').value = keywords;
            // Update active state on chips
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            if (btn) btn.classList.add('active');
            // Auto-shuffle when filter is clicked
            shuffleRadio();
        }

        function updateRadioQueue() {
            if (radioQueue.length === 0) {
                radioQueueEl.classList.add('hidden');
                return;
            }

            radioQueueEl.classList.remove('hidden');
            queueItemsEl.innerHTML = radioQueue.slice(0, 5).map((track, i) => `
                <div class="queue-item">
                    <span class="queue-num">${i + 1}</span>
                    <span class="queue-prompt">${escapeHtml(track.prompt)}</span>
                </div>
            `).join('');
        }

        // Auto-advance when track ends
        if (radioPlayer) {
            radioPlayer.addEventListener('ended', playNextTrack);
        }

        // ========================================
        // LIBRARY VIEW
        // ========================================
        let libraryPage = 1;
        let libraryTotal = 0;
        let libraryPages = 1;
        let userVotes = {};
        let searchDebounceTimer = null;

        const libraryItemsEl = document.getElementById('library-items');
        const librarySearchEl = document.getElementById('library-search');
        const libraryModelEl = document.getElementById('library-model');
        const librarySortEl = document.getElementById('library-sort');
        const paginationEl = document.getElementById('pagination');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const pageInfoEl = document.getElementById('page-info');
        const libraryTotalEl = document.getElementById('library-total');

        async function loadLibrary() {
            const params = new URLSearchParams({
                page: libraryPage,
                per_page: 10,
                sort: librarySortEl.value
            });

            const model = libraryModelEl.value;
            if (model) params.set('model', model);

            const search = librarySearchEl.value.trim();
            if (search) params.set('search', search);

            try {
                const response = await fetch('/api/library?' + params.toString());
                const data = await response.json();

                libraryTotal = data.total;
                libraryPages = data.pages;

                libraryTotalEl.textContent = `(${libraryTotal} total)`;
                pageInfoEl.textContent = `Page ${data.page} of ${libraryPages || 1}`;
                prevPageBtn.disabled = data.page <= 1;
                nextPageBtn.disabled = data.page >= libraryPages;

                if (data.items.length === 0) {
                    libraryItemsEl.innerHTML = `
                        <div style="text-align: center; color: var(--text-muted); padding: 40px;">
                            ${search ? 'No tracks found matching "' + escapeHtml(search) + '"' : 'No tracks yet. Generate some!'}
                        </div>
                    `;
                    return;
                }

                // Get user votes for these items (works for anonymous users too)
                const ids = data.items.map(item => item.id);
                await loadUserVotes(ids);

                libraryItemsEl.innerHTML = data.items.map(item => renderLibraryItem(item)).join('');

            } catch (err) {
                console.error('Library load failed:', err);
                libraryItemsEl.innerHTML = `
                    <div style="text-align: center; color: var(--error); padding: 20px;">
                        Failed to load library
                    </div>
                `;
            }
        }

        async function loadUserVotes(generationIds) {
            const voterId = getEffectiveUserId();
            try {
                const response = await fetch('/api/library/votes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ generation_ids: generationIds, user_id: voterId })
                });
                const data = await response.json();
                userVotes = data.votes || {};
            } catch (err) {
                console.error('Failed to load votes:', err);
            }
        }

        function renderLibraryItem(item) {
            const userVote = userVotes[item.id] || 0;
            const upClass = userVote === 1 ? 'voted-up' : '';
            const downClass = userVote === -1 ? 'voted-down' : '';

            // Only show "View Feedback" button to adult accounts
            const viewFeedbackBtn = isAdultAccount
                ? `<button class="comments-btn" onclick="viewFeedback('${item.id}')">üìã Feedback</button>`
                : '';

            return `
                <div class="library-item" data-id="${item.id}">
                    <div class="item-header">
                        <span class="model-badge">${item.model === 'music' ? 'üéµ' : 'üîä'}</span>
                        <span class="prompt">${escapeHtml(item.prompt)}</span>
                        <span class="duration">${item.duration}s</span>
                    </div>
                    <div class="styled-audio">
                        <audio controls src="/audio/${item.filename}"></audio>
                    </div>
                    <div class="item-actions">
                        <button class="vote-btn ${upClass}" onclick="showLibraryPositiveFeedback('${item.id}')">
                            üëç <span class="vote-count">${item.upvotes || 0}</span>
                        </button>
                        <button class="vote-btn ${downClass}" onclick="showLibraryFeedback('${item.id}')">
                            üëé <span class="vote-count">${item.downvotes || 0}</span>
                        </button>
                        ${viewFeedbackBtn}
                        <a href="/download/${item.filename}" class="item-download">‚¨á Download</a>
                    </div>
                    <div class="feedback-menu hidden" id="feedback-positive-${item.id}">
                        <div class="feedback-header" style="color: var(--success);">What do you like?</div>
                        <div class="feedback-options">
                            <button class="feedback-tag positive" onclick="submitLibraryPositiveFeedback('${item.id}', 'catchy')">üéµ Catchy</button>
                            <button class="feedback-tag positive" onclick="submitLibraryPositiveFeedback('${item.id}', 'quality')">‚ú® Quality</button>
                            <button class="feedback-tag positive" onclick="submitLibraryPositiveFeedback('${item.id}', 'creative')">üé® Creative</button>
                            <button class="feedback-tag positive" onclick="submitLibraryPositiveFeedback('${item.id}', 'matches')">‚úÖ Matches</button>
                            <button class="feedback-tag positive" onclick="submitLibraryPositiveFeedback('${item.id}', 'mood')">üòä Vibe</button>
                        </div>
                        <button class="feedback-cancel" onclick="hideLibraryPositiveFeedback('${item.id}')">Cancel</button>
                    </div>
                    <div class="feedback-menu hidden" id="feedback-${item.id}">
                        <div class="feedback-header">What's wrong?</div>
                        <div class="feedback-options">
                            <button class="feedback-tag" onclick="submitLibraryFeedback('${item.id}', 'scratchy')">üîä Scratchy</button>
                            <button class="feedback-tag" onclick="submitLibraryFeedback('${item.id}', 'quiet')">üîá Quiet</button>
                            <button class="feedback-tag" onclick="submitLibraryFeedback('${item.id}', 'repetitive')">üîÅ Repetitive</button>
                            <button class="feedback-tag" onclick="submitLibraryFeedback('${item.id}', 'mismatch')">‚ùå Wrong</button>
                            <button class="feedback-tag" onclick="submitLibraryFeedback('${item.id}', 'style')">üé® Not my style</button>
                        </div>
                        <button class="feedback-cancel" onclick="hideLibraryFeedback('${item.id}')">Cancel</button>
                    </div>
                    <div class="feedback-view hidden" id="feedback-view-${item.id}"></div>
                </div>
            `;
        }

        async function voteLibrary(genId, voteValue) {
            const voterId = getEffectiveUserId();

            const item = document.querySelector(`[data-id="${genId}"]`);
            const upBtn = item.querySelector('.vote-btn:first-child');
            const downBtn = item.querySelector('.vote-btn:nth-child(2)');

            // Toggle vote if clicking same button
            const currentVote = userVotes[genId] || 0;
            const newVote = currentVote === voteValue ? 0 : voteValue;

            try {
                const response = await fetch(`/api/library/${genId}/vote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vote: newVote, user_id: voterId })
                });
                const data = await response.json();

                userVotes[genId] = data.user_vote;

                // Update UI
                upBtn.classList.toggle('voted-up', data.user_vote === 1);
                downBtn.classList.toggle('voted-down', data.user_vote === -1);
                upBtn.querySelector('.vote-count').textContent = data.upvotes;
                downBtn.querySelector('.vote-count').textContent = data.downvotes;

            } catch (err) {
                console.error('Vote failed:', err);
            }
        }

        function showLibraryPositiveFeedback(genId) {
            // Hide any other open feedback menus
            document.querySelectorAll('.library-item .feedback-menu').forEach(menu => {
                menu.classList.add('hidden');
            });
            document.getElementById('feedback-positive-' + genId).classList.remove('hidden');
        }

        function hideLibraryPositiveFeedback(genId) {
            document.getElementById('feedback-positive-' + genId).classList.add('hidden');
        }

        async function submitLibraryPositiveFeedback(genId, reason) {
            const voterId = getEffectiveUserId();
            const item = document.querySelector(`[data-id="${genId}"]`);
            const upBtn = item.querySelector('.vote-btn:first-child');
            const downBtn = item.querySelector('.vote-btn:nth-child(2)');

            try {
                // Submit upvote
                const response = await fetch(`/api/library/${genId}/vote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vote: 1, user_id: voterId })
                });
                const data = await response.json();

                // Store positive feedback reason
                await fetch(`/api/library/${genId}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: voterId,
                        content: `[POSITIVE:${reason}]`,
                        username: 'System'
                    })
                });

                // Update UI
                userVotes[genId] = 1;
                upBtn.classList.add('voted-up');
                downBtn.classList.remove('voted-down');
                upBtn.querySelector('.vote-count').textContent = data.upvotes;
                downBtn.querySelector('.vote-count').textContent = data.downvotes;

                hideLibraryPositiveFeedback(genId);
                showFeedbackToast('üëç Thanks for your feedback!');

            } catch (err) {
                console.error('Positive feedback failed:', err);
                showErrorToast('Failed to submit feedback: ' + err.message);
            }
        }

        function showLibraryFeedback(genId) {
            // Hide any other open feedback menus
            document.querySelectorAll('.library-item .feedback-menu').forEach(menu => {
                menu.classList.add('hidden');
            });
            document.getElementById('feedback-' + genId).classList.remove('hidden');
        }

        function hideLibraryFeedback(genId) {
            document.getElementById('feedback-' + genId).classList.add('hidden');
        }

        // View feedback - only available to adult accounts
        async function viewFeedback(genId) {
            if (!isAdultAccount) {
                showFeedbackToast('Adult account required to view feedback');
                return;
            }

            const viewEl = document.getElementById('feedback-view-' + genId);

            if (!viewEl.classList.contains('hidden')) {
                viewEl.classList.add('hidden');
                return;
            }

            viewEl.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 10px;">Loading feedback...</div>';
            viewEl.classList.remove('hidden');

            try {
                const response = await fetch(`/api/library/${genId}/comments`);
                const data = await response.json();

                if (!data.comments || data.comments.length === 0) {
                    viewEl.innerHTML = '<div style="color: var(--text-muted); padding: 10px; font-size: 0.85rem;">No feedback yet</div>';
                    return;
                }

                // Parse and summarize feedback
                const positive = {};
                const negative = {};

                data.comments.forEach(c => {
                    const posMatch = c.content.match(/\[POSITIVE:(\w+)\]/);
                    const negMatch = c.content.match(/\[FEEDBACK:(\w+)\]/);

                    if (posMatch) {
                        positive[posMatch[1]] = (positive[posMatch[1]] || 0) + 1;
                    }
                    if (negMatch) {
                        negative[negMatch[1]] = (negative[negMatch[1]] || 0) + 1;
                    }
                });

                let html = '<div style="padding: 12px; font-size: 0.85rem;">';

                if (Object.keys(positive).length > 0) {
                    html += '<div style="color: var(--success); margin-bottom: 8px;"><strong>üëç Positive:</strong> ';
                    html += Object.entries(positive).map(([k, v]) => `${k} (${v})`).join(', ');
                    html += '</div>';
                }

                if (Object.keys(negative).length > 0) {
                    html += '<div style="color: var(--error);"><strong>üëé Issues:</strong> ';
                    html += Object.entries(negative).map(([k, v]) => `${k} (${v})`).join(', ');
                    html += '</div>';
                }

                html += '</div>';
                viewEl.innerHTML = html;

            } catch (err) {
                viewEl.innerHTML = '<div style="color: var(--error); padding: 10px;">Failed to load feedback</div>';
            }
        }

        async function submitLibraryFeedback(genId, reason) {
            const voterId = getEffectiveUserId();
            const item = document.querySelector(`[data-id="${genId}"]`);
            const upBtn = item.querySelector('.vote-btn:first-child');
            const downBtn = item.querySelector('.vote-btn:nth-child(2)');

            try {
                // Submit downvote
                const response = await fetch(`/api/library/${genId}/vote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vote: -1, user_id: voterId })
                });
                const data = await response.json();

                // Store feedback reason
                await fetch(`/api/library/${genId}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: voterId,
                        content: `[FEEDBACK:${reason}]`,
                        username: 'System'
                    })
                });

                // Update UI
                userVotes[genId] = -1;
                upBtn.classList.remove('voted-up');
                downBtn.classList.add('voted-down');
                upBtn.querySelector('.vote-count').textContent = data.upvotes;
                downBtn.querySelector('.vote-count').textContent = data.downvotes;

                hideLibraryFeedback(genId);
                showFeedbackToast('Thanks for your feedback!');

            } catch (err) {
                console.error('Feedback failed:', err);
                showErrorToast('Failed to submit feedback: ' + err.message);
            }
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return 'just now';
            if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
            if (diff < 604800) return Math.floor(diff / 86400) + 'd ago';
            return date.toLocaleDateString();
        }

        function prevPage() {
            if (libraryPage > 1) {
                libraryPage--;
                loadLibrary();
            }
        }

        function nextPage() {
            if (libraryPage < libraryPages) {
                libraryPage++;
                loadLibrary();
            }
        }

        // Search debounce
        if (librarySearchEl) {
            librarySearchEl.addEventListener('input', () => {
                clearTimeout(searchDebounceTimer);
                searchDebounceTimer = setTimeout(() => {
                    libraryPage = 1;
                    loadLibrary();
                }, 300);
            });
        }

        // Filter change handlers
        if (libraryModelEl) {
            libraryModelEl.addEventListener('change', () => {
                libraryPage = 1;
                loadLibrary();
            });
        }

        if (librarySortEl) {
            librarySortEl.addEventListener('change', () => {
                libraryPage = 1;
                loadLibrary();
            });
        }

        // ========================================
        // COLLAPSIBLE GENERATOR
        // ========================================
        function toggleGenerator() {
            const card = document.getElementById('generator-card');
            card.classList.toggle('collapsed');
            // Save preference
            localStorage.setItem('generator_collapsed', card.classList.contains('collapsed'));
        }

        // Restore generator state
        (function() {
            const collapsed = localStorage.getItem('generator_collapsed') === 'true';
            if (collapsed) {
                document.getElementById('generator-card')?.classList.add('collapsed');
            }
        })();

        // Initialize
        loadHistory();
        loadLibrary();
        checkStatus();
        generateBtn.disabled = true;
    </script>

    <!-- Graphlings Widget Integration -->
    <script>
        // Auto-detect environment for Graphlings SDK
        (function() {
            const hostname = window.location.hostname;
            const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
            const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';

            // Check if hostname is a Tailscale IP (100.64.0.0/10 CGNAT range)
            function isTailscaleIP(host) {
                const ipMatch = host.match(/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/);
                if (!ipMatch) return false;
                const [, a, b] = ipMatch.map(Number);
                return a === 100 && b >= 64 && b <= 127;
            }
            const isTailscale = hostname.endsWith('.ts.net') || isTailscaleIP(hostname);

            const SDK_CONFIG = {
                appId: 'sfx-music',
                // Auto-detect: localhost, Tailscale, or production
                accountsUrl: isLocalhost
                    ? 'http://localhost:8002'
                    : isTailscale
                        ? `http://${hostname}:8002`
                        : 'https://accounts.graphlings.net',
                debug: true
            };
            console.log('[SFX-Music] SDK Config:', SDK_CONFIG);

            // Set favicon from accounts server
            const faviconLink = document.getElementById('favicon-link');
            if (faviconLink) {
                faviconLink.href = SDK_CONFIG.accountsUrl + '/static/graphlings/logo-104.png';
            }

            // Dynamically load SDK from accounts server
            const sdkScript = document.createElement('script');
            sdkScript.src = SDK_CONFIG.accountsUrl + '/sdk/graphlings.js';
            document.head.appendChild(sdkScript);

            // Wait for SDK to load and initialize
            function waitForSDK(callback) {
                if (typeof Graphlings !== 'undefined') {
                    callback();
                } else {
                    setTimeout(() => waitForSDK(callback), 50);
                }
            }

            // Theme definitions - 'default' is the original Sound Box purple/cyan theme
            const THEMES = {
                default: {
                    accent: '#a855f7',
                    accentGlow: 'rgba(168, 85, 247, 0.4)',
                    secondary: '#00d4ff',
                    secondaryGlow: 'rgba(0, 212, 255, 0.3)',
                    gradientAccent: 'linear-gradient(135deg, #a855f7 0%, #6366f1 100%)',
                    gradientSecondary: 'linear-gradient(135deg, #00d4ff 0%, #0ea5e9 100%)',
                    success: '#10b981',
                    cardBorder: 'rgba(168, 85, 247, 0.2)',
                    chipBg: 'rgba(168, 85, 247, 0.1)',
                    chipBorder: 'rgba(168, 85, 247, 0.3)'
                },
                graphlings: {
                    accent: '#a855f7',
                    accentGlow: 'rgba(168, 85, 247, 0.4)',
                    secondary: '#f97316',
                    secondaryGlow: 'rgba(249, 115, 22, 0.3)',
                    gradientAccent: 'linear-gradient(135deg, #a855f7 0%, #6366f1 100%)',
                    gradientSecondary: 'linear-gradient(135deg, #f97316 0%, #ea580c 100%)',
                    success: '#10b981',
                    cardBorder: 'rgba(168, 85, 247, 0.2)',
                    chipBg: 'rgba(168, 85, 247, 0.1)',
                    chipBorder: 'rgba(168, 85, 247, 0.3)'
                },
                professional: {
                    accent: '#3b82f6',
                    accentGlow: 'rgba(59, 130, 246, 0.4)',
                    secondary: '#60a5fa',
                    secondaryGlow: 'rgba(96, 165, 250, 0.3)',
                    gradientAccent: 'linear-gradient(135deg, #3b82f6 0%, #1e40af 100%)',
                    gradientSecondary: 'linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%)',
                    success: '#3b82f6',
                    cardBorder: 'rgba(59, 130, 246, 0.2)',
                    chipBg: 'rgba(59, 130, 246, 0.1)',
                    chipBorder: 'rgba(59, 130, 246, 0.3)'
                },
                ocean: {
                    accent: '#06b6d4',
                    accentGlow: 'rgba(6, 182, 212, 0.4)',
                    secondary: '#22d3ee',
                    secondaryGlow: 'rgba(34, 211, 238, 0.3)',
                    gradientAccent: 'linear-gradient(135deg, #06b6d4 0%, #0284c7 100%)',
                    gradientSecondary: 'linear-gradient(135deg, #22d3ee 0%, #06b6d4 100%)',
                    success: '#06b6d4',
                    cardBorder: 'rgba(6, 182, 212, 0.2)',
                    chipBg: 'rgba(6, 182, 212, 0.1)',
                    chipBorder: 'rgba(6, 182, 212, 0.3)'
                },
                forest: {
                    accent: '#22c55e',
                    accentGlow: 'rgba(34, 197, 94, 0.4)',
                    secondary: '#4ade80',
                    secondaryGlow: 'rgba(74, 222, 128, 0.3)',
                    gradientAccent: 'linear-gradient(135deg, #22c55e 0%, #15803d 100%)',
                    gradientSecondary: 'linear-gradient(135deg, #4ade80 0%, #22c55e 100%)',
                    success: '#22c55e',
                    cardBorder: 'rgba(34, 197, 94, 0.2)',
                    chipBg: 'rgba(34, 197, 94, 0.1)',
                    chipBorder: 'rgba(34, 197, 94, 0.3)'
                },
                princess: {
                    accent: '#ec4899',
                    accentGlow: 'rgba(236, 72, 153, 0.4)',
                    secondary: '#f472b6',
                    secondaryGlow: 'rgba(244, 114, 182, 0.3)',
                    gradientAccent: 'linear-gradient(135deg, #ec4899 0%, #db2777 100%)',
                    gradientSecondary: 'linear-gradient(135deg, #f472b6 0%, #ec4899 100%)',
                    success: '#ec4899',
                    cardBorder: 'rgba(236, 72, 153, 0.2)',
                    chipBg: 'rgba(236, 72, 153, 0.1)',
                    chipBorder: 'rgba(236, 72, 153, 0.3)'
                }
            };

            // Apply theme colors to CSS variables
            function applyTheme(themeName) {
                const theme = THEMES[themeName] || THEMES.default;
                const root = document.documentElement;

                // Core accent colors
                root.style.setProperty('--accent', theme.accent);
                root.style.setProperty('--accent-glow', theme.accentGlow);
                root.style.setProperty('--cyan', theme.secondary);
                root.style.setProperty('--cyan-glow', theme.secondaryGlow);
                root.style.setProperty('--gradient-accent', theme.gradientAccent);
                root.style.setProperty('--gradient-cyan', theme.gradientSecondary);
                root.style.setProperty('--success', theme.success);

                // Card and UI element colors
                root.style.setProperty('--card-border-accent', theme.cardBorder);
                root.style.setProperty('--chip-bg', theme.chipBg);
                root.style.setProperty('--chip-border', theme.chipBorder);

                // Save to localStorage for persistence
                localStorage.setItem('soundbox_theme', themeName);
                console.log('[SFX-Music] Theme applied:', themeName);
            }

            // Load saved theme on page load
            function loadSavedTheme() {
                const savedTheme = localStorage.getItem('soundbox_theme');
                if (savedTheme && THEMES[savedTheme]) {
                    applyTheme(savedTheme);
                }
            }

            // Load theme immediately
            loadSavedTheme();

            waitForSDK(function() {
                window.graphlings = new Graphlings(SDK_CONFIG);
                window.graphlings.createWidget({
                    container: '#wallet-widget-container'
                });

                // Listen for theme changes from the widget
                window.graphlings.on('themeChanged', function(data) {
                    applyTheme(data.theme);
                });

                // Listen for login to get user ID
                window.graphlings.on('login', function(data) {
                    if (data.user && data.user.id) {
                        currentUserId = data.user.id;
                        // Check if user is an adult account
                        isAdultAccount = data.user.account_type === 'adult' ||
                                        (data.user.account_type !== 'child' && !data.user.is_child);
                        console.log('[SFX-Music] User logged in:', currentUserId, 'isAdult:', isAdultAccount);
                        // Reload history to show user's personal history
                        loadHistory();
                        loadLibrary();  // Refresh library to show/hide feedback buttons
                    }
                });

                // Listen for logout to clear user ID
                window.graphlings.on('logout', function() {
                    currentUserId = null;
                    isAdultAccount = false;
                    console.log('[SFX-Music] User logged out');
                    // Reload history to show all public history
                    loadHistory();
                    loadLibrary();  // Refresh library to update feedback button visibility
                });

                // Check if user is already logged in and apply their theme
                window.graphlings.on('widgetReady', function(data) {
                    // Apply theme from widget (overrides local storage)
                    if (data.theme && THEMES[data.theme]) {
                        applyTheme(data.theme);
                        console.log('[SFX-Music] Theme synced from widget:', data.theme);
                    }

                    if (data.authenticated && data.user && data.user.id) {
                        currentUserId = data.user.id;
                        // Check if user is an adult account
                        isAdultAccount = data.user.account_type === 'adult' ||
                                        (data.user.account_type !== 'child' && !data.user.is_child);
                        console.log('[SFX-Music] User already logged in:', currentUserId, 'isAdult:', isAdultAccount);
                        loadHistory();
                        loadLibrary();  // Refresh library to show/hide feedback buttons
                    }
                });

                console.log('[SFX-Music] Graphlings widget initialized');
            });
        })();
    </script>
</body>
</html>
