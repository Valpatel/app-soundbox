<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sound Box - Graphlings Apps</title>
    <meta name="description" content="Generate music & sound effects using AI">
    <meta name="theme-color" content="#1a1a2e">
    <link rel="icon" type="image/png" sizes="32x32" id="favicon-link" href="/static/graphlings/logo-104.png">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ========================================
           SOUND BOX - Futuristic Theme
           ======================================== */
        :root {
            --bg-dark: #0a0e17;
            --bg-card: #111827;
            --bg-input: #0d1117;
            --accent: #a855f7;
            --accent-glow: rgba(168, 85, 247, 0.4);
            --cyan: #00d4ff;
            --cyan-glow: rgba(0, 212, 255, 0.3);
            --text: #f1f5f9;
            --text-dim: #94a3b8;
            --text-muted: #64748b;
            --border: rgba(255, 255, 255, 0.08);
            --border-hover: rgba(255, 255, 255, 0.15);
            --success: #10b981;
            --error: #ef4444;
            --gradient-accent: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
            --gradient-cyan: linear-gradient(135deg, #00d4ff 0%, #0ea5e9 100%);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            background-image:
                radial-gradient(ellipse at top, rgba(168, 85, 247, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(0, 212, 255, 0.08) 0%, transparent 50%);
            color: var(--text);
            min-height: 100vh;
        }

        h1, h2, h3 { font-family: 'Fredoka', sans-serif; }

        /* Page Header */
        .page-header {
            position: relative;
            text-align: center;
            padding: 16px 16px 8px;
            background: transparent;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
            color: var(--text);
            text-shadow: 0 0 30px var(--accent-glow);
        }

        .page-title span {
            background: linear-gradient(135deg, var(--accent), var(--cyan), var(--accent));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: titleGradient 4s ease-in-out infinite;
        }

        /* Global Mute Button - in tab bar */
        .global-mute-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .global-mute-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(168, 85, 247, 0.1);
        }

        .global-mute-btn .icon {
            width: 20px;
            height: 20px;
        }

        .global-mute-btn .icon.muted {
            display: none;
            color: var(--error);
        }

        .global-mute-btn.muted .icon.unmuted {
            display: none;
        }

        .global-mute-btn.muted .icon.muted {
            display: block;
        }

        .global-mute-btn.muted {
            border-color: var(--error);
            color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        @keyframes titleGradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .widget-bar-top {
            display: flex;
            justify-content: center;
            padding: 20px 16px 12px;
            min-height: 70px;
            background: linear-gradient(180deg, rgba(168, 85, 247, 0.08) 0%, transparent 100%);
            border-bottom: 1px solid var(--border);
            margin-bottom: 8px;
        }

        /* Dark themed audio player using filter inversion */
        audio {
            width: 100%;
            height: 36px;
            border-radius: 6px;
            outline: none;
        }

        /* Styled audio wrapper - inverts the default light player to dark */
        .styled-audio {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0 4px;
            margin-bottom: 8px;
        }

        .styled-audio audio {
            filter: invert(1) hue-rotate(180deg) brightness(0.9) contrast(1.1);
            background: transparent;
        }

        /* Override for the now-playing smaller player */
        .now-playing .styled-audio {
            padding: 0 4px;
            margin-bottom: 0;
        }

        .now-playing .styled-audio audio {
            height: 32px;
        }

        .container {
            max-width: 720px;
            margin: 0 auto;
        }

        .subtitle {
            text-align: center;
            color: var(--text-dim);
            margin-bottom: 24px;
            font-size: 0.95rem;
        }

        .subtitle a {
            color: var(--cyan);
            text-decoration: none;
            transition: all 0.2s;
        }

        .subtitle a:hover {
            text-shadow: 0 0 10px var(--cyan-glow);
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid var(--card-border-accent, var(--border));
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
            transition: border-color 0.3s, box-shadow 0.3s, transform 0.3s;
            animation: cardFloat 6s ease-in-out infinite;
        }

        @keyframes cardFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }

        .card:hover {
            border-color: var(--accent);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 25px var(--accent-glow);
            animation-play-state: paused;
            transform: translateY(-5px);
        }

        /* Labels */
        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-dim);
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Textarea */
        textarea {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-input);
            color: var(--text);
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 90px;
            transition: all 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow), 0 0 15px var(--accent-glow);
        }

        textarea::placeholder {
            color: var(--text-muted);
        }

        /* Model Tabs */
        .model-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .model-tab {
            flex: 1;
            padding: 16px 12px;
            border: 2px solid var(--border);
            border-radius: 14px;
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.25s;
            text-align: center;
            font-family: inherit;
            position: relative;
            overflow: hidden;
        }

        .model-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .model-tab:hover::before {
            left: 100%;
        }

        .model-tab:hover {
            border-color: var(--accent);
            background: var(--chip-bg, rgba(255, 255, 255, 0.02));
            color: var(--text);
            transform: translateY(-3px);
        }

        .model-tab.active {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--chip-bg, rgba(168, 85, 247, 0.1));
            box-shadow: 0 0 20px var(--accent-glow);
            animation: tabPulse 2s ease-in-out infinite;
        }

        @keyframes tabPulse {
            0%, 100% { box-shadow: 0 0 20px var(--accent-glow); }
            50% { box-shadow: 0 0 30px var(--accent-glow), 0 0 40px var(--accent-glow); }
        }

        .model-tab .icon {
            font-size: 28px;
            margin-bottom: 6px;
            display: block;
        }

        .model-tab .name {
            font-weight: 700;
            font-size: 0.9rem;
        }

        .model-tab .desc {
            font-size: 0.7rem;
            margin-top: 4px;
            opacity: 0.7;
        }

        /* Controls Row */
        .controls {
            display: flex;
            gap: 12px;
            align-items: stretch;
            margin-top: 20px;
        }

        /* Control Box - shared style for duration, loop, random */
        .control-box {
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s;
            cursor: pointer;
            position: relative;
        }

        .control-box:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .control-box:active {
            transform: translateY(0);
        }

        .control-box label {
            font-size: 0.7rem;
            margin: 0 0 4px 0;
            text-align: center;
        }

        /* Duration Control */
        .duration-control {
            flex-direction: column;
            min-width: 100px;
        }

        .duration-value {
            text-align: center;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 4px;
            font-family: 'Fredoka', sans-serif;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            box-shadow: 0 0 10px var(--accent-glow);
            transition: transform 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        /* Loop Toggle Control */
        .loop-control {
            gap: 10px;
        }

        .loop-control.active {
            border-color: var(--accent);
            background: rgba(168, 85, 247, 0.1);
        }

        .loop-control .loop-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text);
            margin: 0;
            text-transform: none;
        }

        /* Custom Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 40px;
            height: 22px;
            background: var(--border);
            border-radius: 11px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 16px;
            height: 16px;
            background: var(--text-dim);
            border-radius: 50%;
            transition: all 0.3s;
        }

        .loop-control.active .toggle-switch {
            background: var(--accent);
        }

        .loop-control.active .toggle-switch::after {
            left: 21px;
            background: white;
        }

        .loop-control input[type="checkbox"] {
            display: none;
        }

        /* Random Control */
        .random-control {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text);
            min-width: 80px;
        }

        .random-control:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Generate Button */
        .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: 2px solid transparent;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 700;
            font-family: 'Fredoka', sans-serif;
            cursor: pointer;
            transition: all 0.25s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            flex: 1;
            background: var(--gradient-accent);
            color: white;
            box-shadow: 0 4px 15px var(--accent-glow);
            animation: generatePulse 2s ease-in-out infinite;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: btnShine 3s ease-in-out infinite;
        }

        @keyframes generatePulse {
            0%, 100% { box-shadow: 0 4px 15px var(--accent-glow); }
            50% { box-shadow: 0 4px 25px var(--accent-glow), 0 0 40px var(--accent-glow); }
        }

        @keyframes btnShine {
            0% { left: -100%; }
            50%, 100% { left: 100%; }
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 30px var(--accent-glow);
            animation: none;
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
            animation: none !important;
        }

        .btn:disabled::before {
            animation: none;
        }

        /* Status Messages */
        .status {
            text-align: center;
            padding: 16px;
            margin-top: 16px;
            border-radius: 12px;
            display: none;
            font-weight: 600;
        }

        .status.loading {
            display: block;
            background: var(--chip-bg, rgba(168, 85, 247, 0.15));
            color: var(--accent);
            border: 1px solid var(--chip-border, rgba(168, 85, 247, 0.3));
            animation: statusPulse 2s ease-in-out infinite;
        }

        @keyframes statusPulse {
            0%, 100% { box-shadow: 0 0 0 0 var(--accent-glow); }
            50% { box-shadow: 0 0 20px 5px var(--accent-glow); }
        }

        .status.error {
            display: block;
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Player Section */
        .player {
            margin-top: 20px;
            display: none;
        }

        .player.show {
            display: block;
        }

        audio {
            width: 100%;
            margin-top: 12px;
            border-radius: 8px;
        }

        h2 {
            font-size: 1.1rem;
            margin: 0 0 16px 0;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        h2::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--accent);
            border-radius: 2px;
            box-shadow: 0 0 8px var(--accent-glow);
        }
        .download-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 24px;
            border: 1px solid var(--accent);
            border-radius: 8px;
            background: transparent;
            color: var(--accent);
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            text-decoration: none;
            margin-left: auto;
            transition: all 0.2s;
            min-width: 120px;
            justify-content: center;
        }

        .download-btn:hover {
            background: var(--accent);
            color: white;
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .download-btn:hover .icon {
            fill: white;
        }

        .tag-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: 1px solid var(--text-muted);
            border-radius: 8px;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.2s;
            min-width: 80px;
            justify-content: center;
        }

        .tag-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            box-shadow: 0 0 15px var(--accent-glow);
        }

        .tag-btn:hover .icon {
            fill: var(--accent);
        }

        .spectrogram {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .spectrogram:hover {
            opacity: 0.85;
            transform: scale(1.01);
        }

        .spectrogram.loading {
            height: 80px;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .quality-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: 8px;
            text-transform: uppercase;
        }

        .quality-badge.good {
            background: var(--chip-bg, rgba(16, 185, 129, 0.2));
            color: var(--accent);
        }

        .quality-badge.medium {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .quality-badge.bad {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        .quality-issues {
            font-size: 0.75rem;
            color: var(--error);
            margin-top: 4px;
        }

        .player-spectrogram {
            margin-top: 16px;
        }

        .player-spectrogram img {
            width: 100%;
            border-radius: 10px;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Example Chips */
        .examples {
            margin-top: 16px;
        }

        .examples span {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .example-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .chip {
            padding: 8px 14px;
            background: var(--chip-bg, rgba(168, 85, 247, 0.1));
            border: 1px solid var(--chip-border, rgba(168, 85, 247, 0.3));
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text);
            position: relative;
            overflow: hidden;
        }

        .chip::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: var(--accent-glow);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }

        .chip:active::after {
            width: 200px;
            height: 200px;
            opacity: 0;
        }

        .chip:hover {
            background: var(--chip-bg, rgba(168, 85, 247, 0.2));
            border-color: var(--accent);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .loading-banner {
            background: rgba(255, 193, 7, 0.15);
            border: 1px solid rgba(255, 193, 7, 0.4);
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        .loading-banner.ready {
            background: rgba(40, 167, 69, 0.15);
            border-color: rgba(40, 167, 69, 0.4);
        }
        .loading-banner .title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #ffc107;
        }
        .loading-banner.ready .title {
            color: #28a745;
        }
        .model-status {
            display: flex;
            justify-content: center;
            gap: 30px;
            font-size: 14px;
        }
        .model-status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666;
        }
        .status-dot.pending { background: #666; }
        .status-dot.loading { background: #ffc107; animation: pulse 1s infinite; }
        .status-dot.ready { background: #28a745; }
        .status-dot.error { background: #dc3545; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .gpu-status {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 20px;
            font-size: 13px;
        }
        .gpu-icon {
            font-size: 18px;
        }
        #gpu-name {
            color: #888;
            flex: 0 0 auto;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .gpu-bar {
            flex: 1;
            height: 8px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
        }
        .gpu-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #ffc107);
            border-radius: 4px;
            transition: width 0.3s;
            width: 0%;
        }
        #gpu-mem {
            color: #888;
            min-width: 40px;
        }
        .gpu-busy {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .gpu-busy.idle {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }
        .gpu-busy.busy {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }
        .job-progress {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
        }
        .job-progress .position {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        .job-progress .progress-text {
            color: #00d4ff;
            font-weight: 500;
        }
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4ff 0%, #0099cc 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }
        .queue-info {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 10px;
        }
        /* Tooltip styles */
        [title] {
            position: relative;
        }
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 1000;
            margin-bottom: 5px;
        }
        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
        }
        .queue-status-banner {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 42px;
        }
        .queue-status-banner .queue-count {
            color: #ffc107;
            font-weight: 600;
        }
        .queue-status-banner .wait-time {
            color: #888;
            font-size: 13px;
        }
        .feedback-toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(40, 167, 69, 0.95);
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            z-index: 10000;
            pointer-events: none;
            max-width: 90%;
            text-align: center;
        }
        .feedback-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }
        .feedback-toast.error {
            background: rgba(220, 53, 69, 0.95);
        }
        .feedback-toast.warning {
            background: rgba(255, 193, 7, 0.95);
            color: #000;
        }
        .feedback-toast .toast-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }
        .feedback-toast .copy-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            margin-top: 8px;
            pointer-events: auto !important;
            user-select: none;
            transition: background 0.2s;
        }
        .feedback-toast .copy-btn:hover {
            background: rgba(255,255,255,0.4);
        }
        .feedback-toast .copy-btn:active {
            background: rgba(40, 167, 69, 0.6);
            transform: scale(0.98);
        }

        /* ========================================
           QUEUE EXPLORER
           ======================================== */
        .queue-explorer-card {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.08) 0%, rgba(168, 85, 247, 0.05) 100%);
        }

        .queue-explorer-card h2 {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 0;
        }

        .queue-explorer-card h2 .collapse-icon {
            margin-left: auto;
            transition: transform 0.3s;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .queue-explorer-card.collapsed h2 .collapse-icon {
            transform: rotate(-90deg);
        }

        .queue-badge {
            background: var(--cyan);
            color: var(--bg-dark);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 700;
            min-width: 20px;
            text-align: center;
        }

        .queue-badge.empty {
            background: var(--text-muted);
            opacity: 0.5;
        }

        .queue-explorer-content {
            transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
            overflow: hidden;
            padding-top: 16px;
        }

        .queue-explorer-card.collapsed .queue-explorer-content {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
        }

        .queue-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .queue-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            border-radius: 10px;
            transition: all 0.2s;
        }

        .queue-item.processing {
            border-color: var(--cyan);
            background: rgba(0, 212, 255, 0.1);
            animation: processingPulse 2s ease-in-out infinite;
        }

        @keyframes processingPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 212, 255, 0.4); }
            50% { box-shadow: 0 0 20px 0 rgba(0, 212, 255, 0.2); }
        }

        .queue-item.own-job {
            border-left: 3px solid var(--accent);
        }

        .queue-item-position {
            font-family: 'Fredoka', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--cyan);
            min-width: 28px;
            text-align: center;
        }

        .queue-item.processing .queue-item-position {
            animation: positionPulse 1s ease-in-out infinite;
        }

        @keyframes positionPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .queue-item-info {
            flex: 1;
            min-width: 0;
        }

        .queue-item-prompt {
            font-size: 0.9rem;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        .queue-item-meta {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .queue-item-meta .model-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: rgba(168, 85, 247, 0.2);
            color: var(--accent);
        }

        .queue-item-meta .model-badge.audio {
            background: rgba(0, 212, 255, 0.2);
            color: var(--cyan);
        }

        .queue-item-meta .duration-badge,
        .queue-item-meta .priority-badge {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .queue-item-meta .priority-badge.admin {
            color: #ff6b6b;
        }

        .queue-item-meta .priority-badge.premium {
            color: #ffd700;
        }

        .queue-item-progress {
            margin-top: 8px;
        }

        .queue-item-progress .progress-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .queue-item-progress .progress-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, var(--cyan), var(--accent));
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .queue-item-progress .progress-text {
            font-size: 0.75rem;
            color: var(--cyan);
        }

        .queue-item .cancel-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .queue-item .cancel-btn:hover {
            background: rgba(239, 68, 68, 0.4);
            transform: scale(1.1);
        }

        .queue-empty {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .queue-empty .icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        /* ========================================
           MAIN TABS
           ======================================== */
        .main-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .main-tab {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-radius: 12px;
            color: var(--text-muted);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .main-tab:hover {
            color: var(--text);
            background: rgba(255, 255, 255, 0.05);
        }

        .main-tab.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .main-tab .icon {
            font-size: 1.1rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========================================
           FAVORITES BUTTON
           ======================================== */
        .favorite-btn {
            background: transparent;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 8px;
            transition: all 0.2s;
            color: var(--text-muted);
        }

        .favorite-btn:hover {
            transform: scale(1.1);
            color: #ff6b6b;
        }

        .favorite-btn.favorited {
            color: #ff6b6b;
        }

        .favorite-btn.favorited .heart {
            animation: heartPop 0.3s ease-out;
        }

        @keyframes heartPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        /* Play Favorites button in radio controls */
        .favorites-btn {
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.2) 0%, rgba(255, 107, 107, 0.1) 100%);
            border: 2px solid rgba(255, 107, 107, 0.4);
            border-radius: 10px;
            color: #ff6b6b;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .favorites-btn:hover {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.3) 0%, rgba(255, 107, 107, 0.2) 100%);
            border-color: #ff6b6b;
            transform: translateY(-2px);
        }

        .favorites-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ========================================
           RADIO STATION - REDESIGNED
           ======================================== */
        .radio-card {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.12) 0%, rgba(0, 212, 255, 0.08) 100%);
            border: 2px solid var(--accent);
            padding: 20px;
        }

        .radio-card h2 {
            display: none; /* Hidden - station presets replace header */
        }

        /* Station Presets - Horizontal Scroll */
        .station-presets {
            margin-bottom: 20px;
        }

        .station-presets-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .station-presets-label::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--border), transparent);
        }

        .station-scroll {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 8px 0 16px;
        }

        .station-card {
            aspect-ratio: 1.3;
            min-height: 70px;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            animation: stationPulse 3s ease-in-out infinite;
            animation-delay: calc(var(--i, 0) * 0.2s);
        }

        .station-card:nth-child(1) { --i: 0; }
        .station-card:nth-child(2) { --i: 1; }
        .station-card:nth-child(3) { --i: 2; }
        .station-card:nth-child(4) { --i: 3; }
        .station-card:nth-child(5) { --i: 4; }
        .station-card:nth-child(6) { --i: 5; }
        .station-card:nth-child(7) { --i: 6; }
        .station-card:nth-child(8) { --i: 7; }

        @keyframes stationPulse {
            0%, 100% { box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
            50% { box-shadow: 0 6px 25px var(--station-glow, rgba(168, 85, 247, 0.3)); }
        }

        .station-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.15) 0%, transparent 50%);
            pointer-events: none;
        }

        .station-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 40%,
                rgba(255,255,255,0.1) 50%,
                transparent 60%
            );
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .station-card:hover::after {
            transform: translateX(100%);
        }

        .station-card:hover {
            transform: translateY(-6px) scale(1.05);
            border-color: rgba(255,255,255,0.4);
            box-shadow: 0 12px 40px var(--station-glow, rgba(168, 85, 247, 0.5));
            animation-play-state: paused;
        }

        .station-card.active {
            border-color: white;
            box-shadow: 0 0 40px var(--station-glow, var(--accent-glow)), inset 0 0 20px rgba(255,255,255,0.1);
            transform: translateY(-3px) scale(1.02);
            animation: activeGlow 1.5s ease-in-out infinite;
        }

        @keyframes activeGlow {
            0%, 100% { box-shadow: 0 0 30px var(--station-glow, var(--accent-glow)), inset 0 0 15px rgba(255,255,255,0.1); }
            50% { box-shadow: 0 0 50px var(--station-glow, var(--accent-glow)), inset 0 0 25px rgba(255,255,255,0.15); }
        }

        .station-card .station-icon {
            width: 2.8rem;
            height: 2.8rem;
            filter: drop-shadow(0 3px 6px rgba(0,0,0,0.4));
            transition: transform 0.3s ease;
            fill: currentColor;
        }

        .station-card:hover .station-icon {
            transform: scale(1.15);
        }

        .station-card .station-name {
            font-size: 1rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.6);
            text-align: center;
            padding: 0 6px;
            letter-spacing: 0.3px;
        }

        /* Station color themes with animated gradients */
        .station-ambient {
            background: linear-gradient(135deg, #1e3a5f 0%, #0d1f3c 50%, #1e3a5f 100%);
            background-size: 200% 200%;
            animation: stationPulse 3s ease-in-out infinite, gradientShift 8s ease infinite;
            --station-glow: rgba(30, 100, 150, 0.6);
        }
        .station-retro {
            background: linear-gradient(135deg, #9333ea 0%, #4f1d8a 50%, #9333ea 100%);
            background-size: 200% 200%;
            animation: stationPulse 3s ease-in-out infinite 0.2s, gradientShift 6s ease infinite;
            --station-glow: rgba(147, 51, 234, 0.6);
        }
        .station-piano {
            background: linear-gradient(135deg, #d97706 0%, #92400e 50%, #d97706 100%);
            background-size: 200% 200%;
            animation: stationPulse 3s ease-in-out infinite 0.4s, gradientShift 7s ease infinite;
            --station-glow: rgba(217, 119, 6, 0.6);
        }
        .station-happy {
            background: linear-gradient(135deg, #f59e0b 0%, #ea580c 50%, #f59e0b 100%);
            background-size: 200% 200%;
            animation: stationPulse 3s ease-in-out infinite 0.6s, gradientShift 5s ease infinite;
            --station-glow: rgba(245, 158, 11, 0.6);
        }
        .station-dreamy {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 50%, #8b5cf6 100%);
            background-size: 200% 200%;
            animation: stationPulse 3s ease-in-out infinite 0.8s, gradientShift 9s ease infinite;
            --station-glow: rgba(139, 92, 246, 0.6);
        }
        .station-lofi {
            background: linear-gradient(135deg, #059669 0%, #047857 50%, #059669 100%);
            background-size: 200% 200%;
            animation: stationPulse 3s ease-in-out infinite 1s, gradientShift 7s ease infinite;
            --station-glow: rgba(5, 150, 105, 0.6);
        }
        .station-favorites {
            background: linear-gradient(135deg, #e11d48 0%, #be123c 50%, #e11d48 100%);
            background-size: 200% 200%;
            animation: stationPulse 3s ease-in-out infinite 1.2s, gradientShift 6s ease infinite;
            --station-glow: rgba(225, 29, 72, 0.6);
        }
        .station-all {
            background: linear-gradient(135deg, var(--accent) 0%, #6366f1 50%, var(--accent) 100%);
            background-size: 200% 200%;
            animation: stationPulse 3s ease-in-out infinite 1.4s, gradientShift 8s ease infinite;
            --station-glow: var(--accent-glow);
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Responsive - 2 rows of 4 on desktop, 4 rows of 2 on mobile */
        @media (max-width: 500px) {
            .station-scroll {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }
            .station-card {
                min-height: 60px;
            }
            .station-card .station-icon {
                width: 1.8rem;
                height: 1.8rem;
            }
            .station-card .station-name {
                font-size: 0.75rem;
            }
        }

        @media (max-width: 360px) {
            .station-scroll {
                grid-template-columns: repeat(4, 1fr);
                gap: 6px;
            }
            .station-card {
                min-height: 55px;
            }
            .station-card .station-icon {
                width: 1.5rem;
                height: 1.5rem;
            }
            .station-card .station-name {
                font-size: 0.7rem;
            }
        }

        /* Start Playing Banner */
        .start-playing-banner {
            margin: 20px 0;
            animation: bannerFadeIn 0.5s ease;
        }

        @keyframes bannerFadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .start-playing-banner.fading {
            animation: bannerFadeOut 0.3s ease forwards;
        }

        @keyframes bannerFadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }

        .start-banner-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            padding: 20px 28px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2) 0%, rgba(0, 212, 255, 0.2) 100%);
            border: 2px solid rgba(168, 85, 247, 0.4);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .start-banner-content::before {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(135deg, var(--accent), var(--cyan), var(--accent));
            background-size: 200% 200%;
            animation: borderGlow 3s ease-in-out infinite;
            z-index: -1;
            border-radius: 18px;
            opacity: 0.5;
        }

        .start-banner-content:hover {
            transform: translateY(-3px);
            border-color: var(--accent);
            box-shadow: 0 8px 30px rgba(168, 85, 247, 0.3), 0 0 40px rgba(168, 85, 247, 0.2);
        }

        .start-banner-content:hover .start-icon {
            transform: scale(1.1);
        }

        .start-icon {
            width: 48px;
            height: 48px;
            color: var(--accent);
            filter: drop-shadow(0 0 10px var(--accent-glow));
            transition: transform 0.3s ease;
        }

        .start-text h3 {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.2rem;
            color: var(--text);
            margin: 0 0 4px;
        }

        .start-text p {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin: 0;
        }

        /* Featured Row */
        .featured-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .featured-btn {
            padding: 14px 16px;
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .featured-btn span:first-child {
            font-size: 1.1rem;
            transition: transform 0.3s ease;
        }

        .featured-btn:hover span:first-child {
            transform: scale(1.2) rotate(5deg);
        }

        .featured-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, transparent 0%, rgba(255,255,255,0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .featured-btn:hover::before {
            opacity: 1;
        }

        .featured-btn:hover {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(168, 85, 247, 0.05) 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(168, 85, 247, 0.2);
        }

        .featured-btn.active {
            border-color: var(--accent);
            background: var(--gradient-accent);
            color: white;
            box-shadow: 0 8px 30px var(--accent-glow);
        }

        /* Now Playing - Enhanced with EQ */
        .now-playing {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 24px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.08) 0%, rgba(0,0,0,0.3) 50%, rgba(0, 212, 255, 0.05) 100%);
            border-radius: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(168, 85, 247, 0.3);
            position: relative;
            overflow: hidden;
            animation: nowPlayingGlow 4s ease-in-out infinite;
        }

        @keyframes nowPlayingGlow {
            0%, 100% { box-shadow: 0 4px 30px rgba(168, 85, 247, 0.15), inset 0 0 60px rgba(168, 85, 247, 0.03); }
            50% { box-shadow: 0 8px 40px rgba(168, 85, 247, 0.25), inset 0 0 80px rgba(168, 85, 247, 0.05); }
        }

        .now-playing::before {
            content: 'NOW PLAYING';
            position: absolute;
            top: 10px;
            left: 20px;
            font-size: 0.6rem;
            color: var(--accent);
            letter-spacing: 3px;
            font-weight: 700;
            animation: nowPlayingLabel 2s ease-in-out infinite;
        }

        @keyframes nowPlayingLabel {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        /* Ambient background animation */
        .now-playing::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(168, 85, 247, 0.1) 0%, transparent 50%);
            animation: ambientRotate 20s linear infinite;
            pointer-events: none;
        }

        @keyframes ambientRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .now-playing.hidden {
            display: none;
        }

        .now-playing .hero-section {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-top: 12px;
            position: relative;
            z-index: 1;
        }

        /* Animated EQ Visualizer - Bigger and more dramatic */
        .eq-visualizer {
            width: 110px;
            height: 80px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 4px;
            background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0.4) 100%);
            border-radius: 14px;
            padding: 12px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3), inset 0 0 20px rgba(168, 85, 247, 0.1);
        }

        .eq-visualizer::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, transparent 0%, rgba(168, 85, 247, 0.15) 100%);
            pointer-events: none;
        }

        .eq-bar {
            width: 8px;
            background: linear-gradient(180deg, #ff6b6b 0%, var(--accent) 40%, var(--cyan) 100%);
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.5);
        }

        @keyframes eqBounce1 { 0%, 100% { height: 15%; } 25% { height: 70%; } 50% { height: 90%; } 75% { height: 45%; } }
        @keyframes eqBounce2 { 0%, 100% { height: 40%; } 25% { height: 20%; } 50% { height: 65%; } 75% { height: 85%; } }
        @keyframes eqBounce3 { 0%, 100% { height: 25%; } 25% { height: 100%; } 50% { height: 50%; } 75% { height: 75%; } }
        @keyframes eqBounce4 { 0%, 100% { height: 55%; } 25% { height: 30%; } 50% { height: 35%; } 75% { height: 90%; } }
        @keyframes eqBounce5 { 0%, 100% { height: 30%; } 25% { height: 80%; } 50% { height: 60%; } 75% { height: 20%; } }
        @keyframes eqBounce6 { 0%, 100% { height: 45%; } 25% { height: 65%; } 50% { height: 20%; } 75% { height: 55%; } }
        @keyframes eqBounce7 { 0%, 100% { height: 20%; } 25% { height: 50%; } 50% { height: 70%; } 75% { height: 35%; } }

        .eq-bar:nth-child(1) { animation: eqBounce1 0.9s ease-in-out infinite; }
        .eq-bar:nth-child(2) { animation: eqBounce2 0.7s ease-in-out infinite 0.05s; }
        .eq-bar:nth-child(3) { animation: eqBounce3 0.8s ease-in-out infinite 0.1s; }
        .eq-bar:nth-child(4) { animation: eqBounce4 0.6s ease-in-out infinite 0.15s; }
        .eq-bar:nth-child(5) { animation: eqBounce5 0.75s ease-in-out infinite 0.2s; }
        .eq-bar:nth-child(6) { animation: eqBounce6 0.65s ease-in-out infinite 0.1s; }
        .eq-bar:nth-child(7) { animation: eqBounce7 0.85s ease-in-out infinite 0.25s; }

        .eq-visualizer.paused .eq-bar {
            animation: none;
            height: 6px;
            opacity: 0.5;
        }

        .now-playing .track-info {
            flex: 1;
            min-width: 0;
        }

        .now-playing .track-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .now-playing .track-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .now-playing .track-meta .duration {
            background: var(--bg-card);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        /* Controls Section */
        .now-playing .controls-section {
            display: flex;
            flex-direction: column;
            gap: 14px;
            position: relative;
            z-index: 1;
        }

        .now-playing .audio-row {
            display: flex;
            align-items: center;
        }

        .now-playing .styled-audio {
            flex: 1;
        }

        .now-playing .styled-audio audio {
            width: 100%;
            height: 40px;
        }

        /* Unified control bar */
        .now-playing .control-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 10px 14px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        /* Playback controls group (prev, next) */
        .playback-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .control-btn:hover {
            background: rgba(168, 85, 247, 0.2);
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .control-btn.primary {
            width: 48px;
            height: 48px;
            background: var(--gradient-accent);
            border: none;
            font-size: 1.3rem;
            box-shadow: 0 4px 15px var(--accent-glow);
        }

        .control-btn.primary:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 25px var(--accent-glow);
        }

        /* Rating controls group */
        .rating-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .rating-btn {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .rating-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--text-muted);
        }

        .rating-btn.voted-up {
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--success);
            color: var(--success);
        }

        .rating-btn.voted-down {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--error);
            color: var(--error);
        }

        .rating-btn .count {
            font-weight: 600;
            min-width: 16px;
            text-align: center;
        }

        /* Favorite button in control bar */
        .control-bar .favorite-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .control-bar .favorite-btn:hover {
            background: rgba(225, 29, 72, 0.2);
            border-color: #e11d48;
            transform: scale(1.1);
        }

        .control-bar .favorite-btn.favorited {
            background: rgba(225, 29, 72, 0.25);
            border-color: #e11d48;
        }

        /* Separator */
        .control-separator {
            width: 1px;
            height: 28px;
            background: var(--border);
            margin: 0 4px;
        }

        /* SVG Icon styling */
        .icon {
            width: 20px;
            height: 20px;
            display: inline-block;
            vertical-align: middle;
        }

        .icon-sm { width: 16px; height: 16px; }
        .icon-md { width: 20px; height: 20px; }
        .icon-lg { width: 24px; height: 24px; }
        .icon-xl { width: 28px; height: 28px; }

        .control-btn .icon {
            width: 22px;
            height: 22px;
        }

        .control-btn.primary .icon {
            width: 26px;
            height: 26px;
        }

        .rating-btn .icon {
            width: 18px;
            height: 18px;
        }

        .control-bar .favorite-btn .icon {
            width: 22px;
            height: 22px;
            transition: transform 0.2s ease;
        }

        .control-bar .favorite-btn:hover .icon {
            transform: scale(1.15);
        }

        .control-bar .favorite-btn.favorited .icon {
            color: #e11d48;
        }

        /* Up Next Queue - Enhanced */
        .radio-queue {
            background: var(--bg-input);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border);
        }

        .radio-queue.hidden {
            display: none;
        }

        .queue-header {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .queue-count {
            background: var(--accent);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        .queue-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .queue-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .queue-item:hover {
            background: rgba(255,255,255,0.06);
        }

        .queue-num {
            width: 24px;
            height: 24px;
            background: var(--bg-card);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        .queue-prompt {
            flex: 1;
            font-size: 0.85rem;
            color: var(--text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .queue-duration {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--bg-card);
            padding: 3px 8px;
            border-radius: 4px;
        }

        .queue-remove {
            width: 24px;
            height: 24px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            opacity: 0;
        }

        .queue-item:hover .queue-remove {
            opacity: 1;
        }

        .queue-remove:hover {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        /* Legacy hidden controls for model select */
        .radio-controls-hidden {
            display: none;
        }

        .feedback-menu {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .feedback-menu.hidden {
            display: none;
        }

        .feedback-header {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 12px;
            font-size: 0.95rem;
        }

        .feedback-options {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .feedback-tag {
            padding: 8px 14px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: transparent;
            color: var(--text-dim);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .feedback-tag:hover {
            border-color: var(--error);
            color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .feedback-tag.positive:hover {
            border-color: var(--success);
            color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .feedback-cancel {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .feedback-cancel:hover {
            border-color: var(--text-dim);
            color: var(--text);
        }

        /* Selected state for multi-select feedback tags */
        .feedback-tag.selected {
            border-color: var(--error);
            color: var(--error);
            background: rgba(239, 68, 68, 0.15);
        }

        .feedback-tag.positive.selected {
            border-color: var(--success);
            color: var(--success);
            background: rgba(16, 185, 129, 0.15);
        }

        /* Feedback action buttons container */
        .feedback-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .feedback-submit {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: var(--gradient-accent);
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
        }

        .feedback-submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--accent-glow);
        }

        .feedback-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .feedback-submit.positive {
            background: var(--success);
        }

        .feedback-submit.positive:hover {
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        /* Reclassification section */
        .feedback-reclassify {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .feedback-reclassify-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: block;
        }

        .feedback-reclassify-options {
            display: flex;
            gap: 8px;
        }

        .reclassify-option {
            padding: 8px 14px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: transparent;
            color: var(--text-dim);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reclassify-option:hover {
            border-color: var(--cyan);
            color: var(--cyan);
            background: rgba(0, 212, 255, 0.1);
        }

        .reclassify-option.selected {
            border-color: var(--cyan);
            color: var(--cyan);
            background: rgba(0, 212, 255, 0.15);
        }

        /* Feedback Modal - Enhanced with Particles & Glow */
        .feedback-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 1;
            transition: opacity 0.3s ease;
            overflow: hidden;
        }

        .feedback-modal-overlay.hidden {
            display: none;
        }

        /* Particle container */
        .feedback-particles {
            position: absolute;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .feedback-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: floatParticle 4s ease-in-out infinite;
        }

        @keyframes floatParticle {
            0%, 100% { transform: translateY(0) rotate(0deg); opacity: 0.6; }
            25% { transform: translateY(-30px) rotate(90deg); opacity: 1; }
            50% { transform: translateY(-60px) rotate(180deg); opacity: 0.8; }
            75% { transform: translateY(-30px) rotate(270deg); opacity: 1; }
        }

        .feedback-modal {
            background: linear-gradient(145deg, rgba(17, 24, 39, 0.98) 0%, rgba(10, 14, 23, 0.98) 100%);
            border: 2px solid transparent;
            border-radius: 24px;
            padding: 28px;
            max-width: 460px;
            width: 92%;
            max-height: 85vh;
            overflow-y: auto;
            position: relative;
            z-index: 1;
            animation: modalGlowIn 0.4s ease-out;
        }

        .feedback-modal::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 26px;
            background: linear-gradient(135deg, var(--accent), var(--cyan), var(--accent));
            background-size: 200% 200%;
            z-index: -1;
            animation: borderGlow 3s ease-in-out infinite;
        }

        .feedback-modal::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 24px;
            background: linear-gradient(145deg, rgba(17, 24, 39, 0.98) 0%, rgba(10, 14, 23, 0.98) 100%);
            z-index: -1;
        }

        .feedback-modal.positive::before {
            background: linear-gradient(135deg, var(--success), #34d399, var(--success));
            background-size: 200% 200%;
        }

        .feedback-modal.negative::before {
            background: linear-gradient(135deg, var(--error), #f97316, var(--error));
            background-size: 200% 200%;
        }

        @keyframes borderGlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes modalGlowIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.9);
                filter: blur(4px);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
                filter: blur(0);
            }
        }

        .feedback-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }

        .feedback-modal-title {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .feedback-modal-title::before {
            content: '';
            display: inline-block;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            animation: iconPulse 2s ease-in-out infinite;
        }

        .feedback-modal-title.positive {
            color: var(--success);
            text-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }

        .feedback-modal-title.positive::before {
            background: radial-gradient(circle, var(--success) 30%, transparent 70%);
            box-shadow: 0 0 20px var(--success), 0 0 40px rgba(16, 185, 129, 0.5);
        }

        .feedback-modal-title.negative {
            color: var(--error);
            text-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }

        .feedback-modal-title.negative::before {
            background: radial-gradient(circle, var(--error) 30%, transparent 70%);
            box-shadow: 0 0 20px var(--error), 0 0 40px rgba(239, 68, 68, 0.5);
        }

        @keyframes iconPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }

        .feedback-modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border);
            border-radius: 50%;
            color: var(--text-muted);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .feedback-modal-close:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--error);
            color: var(--error);
            transform: rotate(90deg);
        }

        .feedback-modal-track {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(0, 212, 255, 0.1) 100%);
            border: 1px solid var(--border);
            border-radius: 14px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .feedback-modal-track::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.05), transparent);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        .feedback-modal-prompt {
            font-size: 0.95rem;
            color: var(--text);
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        .feedback-modal-section {
            margin-bottom: 24px;
        }

        .feedback-modal-label {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 14px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feedback-modal-label::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--border), transparent);
        }

        .feedback-modal-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .feedback-modal-options .feedback-tag {
            padding: 12px 18px;
            border: 2px solid var(--border);
            border-radius: 24px;
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-dim);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .feedback-modal-options .feedback-tag::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, rgba(168, 85, 247, 0.3) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .feedback-modal-options .feedback-tag:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(168, 85, 247, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(168, 85, 247, 0.25);
        }

        .feedback-modal-options .feedback-tag:hover::before {
            opacity: 1;
        }

        .feedback-modal-options .feedback-tag.selected {
            border-color: var(--accent);
            color: white;
            background: linear-gradient(135deg, var(--accent), #7c3aed);
            box-shadow: 0 4px 20px rgba(168, 85, 247, 0.4), inset 0 1px 0 rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .feedback-modal-options .feedback-tag.positive:hover {
            border-color: var(--success);
            color: var(--success);
            background: rgba(16, 185, 129, 0.15);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.25);
        }

        .feedback-modal-options .feedback-tag.positive:hover::before {
            background: radial-gradient(circle at center, rgba(16, 185, 129, 0.3) 0%, transparent 70%);
        }

        .feedback-modal-options .feedback-tag.positive.selected {
            border-color: var(--success);
            color: white;
            background: linear-gradient(135deg, var(--success), #059669);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4), inset 0 1px 0 rgba(255,255,255,0.2);
        }

        .feedback-modal-reclassify {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .feedback-modal-reclassify .reclassify-option {
            padding: 12px 18px;
            border: 2px solid var(--border);
            border-radius: 24px;
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-dim);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .feedback-modal-reclassify .reclassify-option:hover {
            border-color: var(--cyan);
            color: var(--cyan);
            background: rgba(0, 212, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 212, 255, 0.25);
        }

        .feedback-modal-reclassify .reclassify-option.selected {
            border-color: var(--cyan);
            color: white;
            background: linear-gradient(135deg, var(--cyan), #0ea5e9);
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4), inset 0 1px 0 rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .feedback-modal-actions {
            display: flex;
            gap: 14px;
            margin-top: 28px;
            padding-top: 24px;
            border-top: 2px solid var(--border);
        }

        .feedback-modal-cancel {
            flex: 1;
            padding: 14px 24px;
            border: 2px solid var(--border);
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-muted);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .feedback-modal-cancel:hover {
            border-color: var(--text-dim);
            color: var(--text);
            background: rgba(255, 255, 255, 0.08);
        }

        .feedback-modal-submit {
            flex: 2;
            padding: 16px 28px;
            border: none;
            border-radius: 14px;
            background: linear-gradient(135deg, var(--accent), #7c3aed);
            color: white;
            font-size: 1.05rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .feedback-modal-submit::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }

        .feedback-modal-submit:hover:not(:disabled)::before {
            transform: translateX(100%);
        }

        .feedback-modal-submit:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 30px rgba(168, 85, 247, 0.5), 0 0 40px rgba(168, 85, 247, 0.3);
        }

        .feedback-modal-submit:active:not(:disabled) {
            transform: translateY(-1px) scale(0.99);
        }

        .feedback-modal-submit:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            filter: grayscale(0.5);
        }

        .feedback-modal-submit.positive {
            background: linear-gradient(135deg, var(--success), #059669);
        }

        .feedback-modal-submit.positive:hover:not(:disabled) {
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.5), 0 0 40px rgba(16, 185, 129, 0.3);
        }

        /* Success celebration animation */
        @keyframes celebrationBurst {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        .feedback-celebration {
            position: absolute;
            inset: 0;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .celebration-ring {
            position: absolute;
            border: 3px solid var(--success);
            border-radius: 50%;
            width: 100px;
            height: 100px;
            animation: celebrationBurst 0.6s ease-out forwards;
        }

        .radio-queue {
            border-top: 1px solid var(--border);
            padding-top: 12px;
        }

        .radio-queue.hidden {
            display: none;
        }

        .queue-header {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .queue-items {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 150px;
            overflow-y: auto;
        }

        .queue-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: var(--bg-card);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        .queue-item .queue-num {
            color: var(--text-muted);
            font-size: 0.75rem;
            min-width: 20px;
        }

        .queue-item .queue-prompt {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ========================================
           LIBRARY VIEW
           ======================================== */
        /* ========================================
           LIBRARY - REDESIGNED
           ======================================== */
        .library-card {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.08) 0%, rgba(168, 85, 247, 0.05) 100%);
            border: 2px solid var(--cyan);
        }

        .library-card h2 {
            font-size: 1.3rem;
            color: var(--cyan);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .library-card h2 .icon {
            width: 24px;
            height: 24px;
            vertical-align: -4px;
        }

        .library-card h2 span {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: normal;
            margin-left: 8px;
        }

        /* Search Bar with Icon */
        .library-search-wrapper {
            position: relative;
            flex: 1;
            min-width: 200px;
        }

        .library-search-wrapper .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            color: var(--text-muted);
            pointer-events: none;
        }

        .library-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .library-controls .search-input {
            width: 100%;
            padding: 12px 16px 12px 42px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-input);
            color: var(--text);
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.2s;
        }

        .library-controls .search-input:focus {
            outline: none;
            border-color: var(--cyan);
            box-shadow: 0 0 0 3px var(--cyan-glow);
        }

        .library-controls .search-input::placeholder {
            color: var(--text-muted);
        }

        .library-controls select {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-input);
            color: var(--text);
            font-size: 0.9rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .library-controls select:focus {
            outline: none;
            border-color: var(--cyan);
        }

        /* Category Filter Pills */
        .library-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .filter-pill {
            padding: 8px 16px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: transparent;
            color: var(--text-dim);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-pill:hover {
            border-color: var(--cyan);
            color: var(--cyan);
        }

        .filter-pill.active {
            background: var(--cyan);
            border-color: var(--cyan);
            color: white;
        }

        .filter-pill .icon {
            width: 14px;
            height: 14px;
        }

        /* Category Browser - Redesigned */
        .library-layout {
            display: grid;
            grid-template-columns: 220px 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .library-layout {
                grid-template-columns: 1fr;
            }
            .category-sidebar {
                display: none;
            }
            .category-sidebar.mobile-open {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 100;
                background: var(--bg-dark);
                overflow-y: auto;
                padding: 20px;
            }
        }

        .category-sidebar {
            background: transparent;
            padding: 0;
        }

        /* Type Tabs */
        .category-type-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            background: var(--bg-input);
            border-radius: 12px;
            padding: 4px;
            border: 1px solid var(--border);
        }

        .type-tab {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .type-tab:hover {
            color: var(--text);
            background: rgba(255, 255, 255, 0.05);
        }

        .type-tab.active {
            background: var(--accent);
            color: white;
        }

        .type-tab .icon {
            width: 16px;
            height: 16px;
        }

        .type-tab .tab-count {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* Quick Filters */
        .quick-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .quick-filter-btn {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: transparent;
            color: var(--text-dim);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .quick-filter-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .quick-filter-btn.active {
            border-color: var(--accent);
            background: rgba(168, 85, 247, 0.1);
            color: var(--accent);
        }

        .quick-filter-btn .icon {
            width: 20px;
            height: 20px;
        }

        /* Genre List */
        .genre-section {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .genre-section-header {
            padding: 10px 14px;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none;
            transition: all 0.2s;
        }

        .genre-section-header:hover {
            background: rgba(0, 0, 0, 0.3);
            color: var(--text);
        }

        .genre-section-header .chevron {
            width: 14px;
            height: 14px;
            transition: transform 0.2s;
            opacity: 0.5;
        }

        .genre-group.collapsed .genre-section-header .chevron {
            transform: rotate(-90deg);
        }

        .genre-group {
            margin-bottom: 2px;
        }

        .genre-group.collapsed .genre-list {
            display: none;
        }

        .genre-group:not(.collapsed) .genre-section-header {
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent);
        }

        .genre-list {
            padding: 6px;
        }

        .genre-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-dim);
            font-size: 0.9rem;
        }

        .genre-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
        }

        .genre-item.active {
            background: var(--accent);
            color: white;
        }

        .genre-item .icon {
            width: 16px;
            height: 16px;
            opacity: 0.7;
        }

        .genre-item.active .icon {
            opacity: 1;
        }

        .genre-item .genre-name {
            flex: 1;
        }

        .genre-count {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: rgba(255, 255, 255, 0.05);
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 24px;
            text-align: center;
        }

        .genre-item.active .genre-count {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* Genre sections visibility based on type tab */
        .category-sidebar[data-type="music"] .sfx-genres {
            display: none;
        }

        .category-sidebar[data-type="audio"] .music-genres {
            display: none;
        }

        /* Genre section spacing */
        .genre-section {
            margin-bottom: 16px;
        }

        .genre-section:last-of-type {
            margin-bottom: 0;
        }

        /* Clear Filter Button */
        .clear-filter-btn {
            width: 100%;
            padding: 12px;
            margin-top: 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .clear-filter-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--error);
        }

        .clear-filter-btn .icon {
            width: 16px;
            height: 16px;
        }

        .mobile-category-toggle {
            display: none;
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--bg-input);
            color: var(--text);
            font-size: 0.9rem;
            cursor: pointer;
            margin-bottom: 16px;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        @media (max-width: 900px) {
            .mobile-category-toggle {
                display: flex;
            }
        }

        .mobile-category-toggle .icon {
            width: 18px;
            height: 18px;
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 4px;
            margin-left: auto;
            background: var(--bg-input);
            border-radius: 8px;
            padding: 4px;
            border: 1px solid var(--border);
        }

        .view-toggle-btn {
            padding: 8px 10px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }

        .view-toggle-btn:hover {
            color: var(--text);
        }

        .view-toggle-btn.active {
            background: var(--cyan);
            color: white;
        }

        .view-toggle-btn .icon {
            width: 18px;
            height: 18px;
        }

        /* Library Items - List View */
        .library-items {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .library-items.grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        /* Library Item Card - Enhanced */
        .library-item {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .library-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--cyan), var(--accent));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .library-item:hover {
            border-color: var(--cyan);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 212, 255, 0.15);
        }

        .library-item:hover::before {
            opacity: 1;
        }

        .library-item[data-model="music"]::before {
            background: linear-gradient(90deg, var(--accent), #ec4899);
        }

        .library-item[data-model="audio"]::before {
            background: linear-gradient(90deg, var(--cyan), #10b981);
        }

        /* Item Header */
        .item-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
        }

        .model-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--bg-card);
            flex-shrink: 0;
        }

        .model-badge .icon {
            width: 20px;
            height: 20px;
        }

        .model-badge.music {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(236, 72, 153, 0.2));
            color: var(--accent);
        }

        .model-badge.audio {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(16, 185, 129, 0.2));
            color: var(--cyan);
        }

        /* Item Info */
        .item-info {
            flex: 1;
            min-width: 0;
        }

        .item-info .prompt {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text);
            line-height: 1.4;
            margin-bottom: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .item-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .item-meta .duration {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .item-meta .icon {
            width: 14px;
            height: 14px;
        }

        /* Item Favorite Button */
        .item-favorite {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 5;
        }

        .item-favorite:hover {
            background: rgba(225, 29, 72, 0.2);
            color: #e11d48;
            transform: scale(1.1);
        }

        .item-favorite.favorited {
            background: rgba(225, 29, 72, 0.2);
            color: #e11d48;
        }

        .item-favorite .icon {
            width: 18px;
            height: 18px;
        }

        /* Styled Audio Player */
        .styled-audio {
            margin: 12px 0;
        }

        .styled-audio audio {
            width: 100%;
            height: 40px;
            border-radius: 8px;
        }

        /* Item Actions */
        .item-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text-dim);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .action-btn:hover {
            border-color: var(--cyan);
            color: var(--cyan);
            background: rgba(0, 212, 255, 0.1);
        }

        .action-btn .icon {
            width: 16px;
            height: 16px;
        }

        .action-btn.vote-up:hover,
        .action-btn.vote-up.voted {
            border-color: var(--success);
            color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .action-btn.vote-down:hover,
        .action-btn.vote-down.voted {
            border-color: var(--error);
            color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .action-btn.download {
            margin-left: auto;
            border-color: var(--accent);
            color: var(--accent);
        }

        .action-btn.download:hover {
            background: rgba(168, 85, 247, 0.1);
            border-color: var(--accent);
            color: var(--accent);
        }

        .action-btn.suggest-tag {
            border-color: var(--text-muted);
            color: var(--text-muted);
        }

        .action-btn.suggest-tag:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(168, 85, 247, 0.1);
        }

        .action-btn .vote-count {
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Comments/Feedback Button */
        .comments-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text-dim);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .comments-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(168, 85, 247, 0.1);
        }

        .comments-btn .icon {
            width: 16px;
            height: 16px;
        }

        /* Feedback View */
        .feedback-view {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .feedback-view.hidden {
            display: none;
        }

        /* Library Empty State */
        .library-empty {
            text-align: center;
            padding: 60px 20px;
        }

        .library-empty .empty-icon {
            width: 64px;
            height: 64px;
            color: var(--text-muted);
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .library-empty h3 {
            font-family: 'Fredoka', sans-serif;
            font-size: 1.3rem;
            color: var(--text);
            margin: 0 0 8px;
        }

        .library-empty p {
            color: var(--text-muted);
            margin: 0;
        }

        .library-item audio {
            width: 100%;
        }

        .action-btn.play-radio {
            border-color: var(--accent);
            color: var(--accent);
        }

        .action-btn.play-radio:hover {
            background: rgba(168, 85, 247, 0.1);
        }

        /* Pagination - Enhanced */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .page-btn {
            padding: 10px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: transparent;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
            min-width: 44px;
            text-align: center;
            font-weight: 500;
        }

        .page-btn:hover:not(:disabled):not(.active) {
            border-color: var(--cyan);
            color: var(--cyan);
            background: rgba(0, 212, 255, 0.05);
        }

        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .page-btn.active {
            background: var(--cyan);
            border-color: var(--cyan);
            color: white;
        }

        .page-numbers {
            display: flex;
            gap: 4px;
        }

        .page-ellipsis {
            color: var(--text-muted);
            padding: 10px 6px;
        }

        .page-info {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-left: 8px;
        }

        @media (max-width: 640px) {
            .library-items.grid-view {
                grid-template-columns: 1fr;
            }
            .library-filters {
                justify-content: center;
            }
            .item-actions {
                justify-content: center;
            }
            .action-btn.download {
                margin-left: 0;
                width: 100%;
                justify-content: center;
                margin-top: 8px;
            }
        }

        @media (max-width: 480px) {
            .page-numbers {
                display: none;
            }
            .pagination {
                gap: 16px;
            }
        }

        /* ========================================
           COLLAPSIBLE GENERATOR
           ======================================== */
        .generator-card h2 {
            cursor: pointer;
            user-select: none;
        }

        .generator-card h2 .collapse-icon {
            margin-left: auto;
            transition: transform 0.3s;
            font-size: 0.8rem;
        }

        .generator-card.collapsed h2 .collapse-icon {
            transform: rotate(-90deg);
        }

        .generator-content {
            transition: max-height 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
        }

        .generator-card.collapsed .generator-content {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
        }

        /* ========================================
           RESPONSIVE - LARGE MONITORS (1200px+)
           ======================================== */
        @media (min-width: 1200px) {
            .container {
                max-width: 1100px;
            }

            .page-header {
                padding: 24px 24px 12px;
            }

            .page-title {
                font-size: 2.25rem;
            }

            .widget-bar-top {
                padding: 28px 24px 16px;
                min-height: 85px;
            }

            .card {
                padding: 32px;
                border-radius: 20px;
                margin-bottom: 28px;
            }

            .card h2 {
                font-size: 1.4rem;
            }

            /* Generator tabs bigger */
            .model-tab {
                padding: 20px 16px;
                border-radius: 16px;
            }

            .model-tab .icon {
                font-size: 32px;
            }

            .model-tab .name {
                font-size: 1rem;
            }

            .model-tab .desc {
                font-size: 0.8rem;
            }

            /* Larger buttons */
            .btn {
                padding: 14px 28px;
                font-size: 1rem;
            }

            /* Radio stations grid */
            .station-scroll {
                gap: 12px;
            }

            .station-card {
                min-height: 90px;
                border-radius: 14px;
            }

            .station-card .station-icon {
                width: 2.4rem;
                height: 2.4rem;
            }

            .station-card .station-name {
                font-size: 0.95rem;
            }

            /* Library layout expands */
            .library-layout {
                grid-template-columns: 260px 1fr;
                gap: 28px;
            }

            .library-items.grid-view {
                grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
                gap: 20px;
            }

            .library-item {
                padding: 20px;
                border-radius: 16px;
            }

            /* Category sidebar improvements */
            .category-type-tabs {
                padding: 6px;
                border-radius: 14px;
            }

            .type-tab {
                padding: 12px 14px;
                font-size: 0.9rem;
            }

            .genre-section {
                border-radius: 14px;
            }

            .genre-item {
                padding: 12px 14px;
            }
        }

        /* ========================================
           RESPONSIVE - EXTRA LARGE MONITORS (1600px+)
           ======================================== */
        @media (min-width: 1600px) {
            .container {
                max-width: 1400px;
            }

            .page-header {
                padding: 32px 32px 16px;
            }

            .page-title {
                font-size: 2.5rem;
            }

            .widget-bar-top {
                padding: 32px 32px 20px;
                min-height: 95px;
            }

            .card {
                padding: 40px;
                border-radius: 24px;
            }

            .card h2 {
                font-size: 1.5rem;
                margin-bottom: 24px;
            }

            /* Textarea bigger */
            textarea {
                min-height: 110px;
                font-size: 1.05rem;
                padding: 16px 20px;
            }

            /* Model tabs even bigger */
            .model-tab {
                padding: 24px 20px;
            }

            .model-tab .icon {
                font-size: 36px;
            }

            /* Library 3 columns */
            .library-layout {
                grid-template-columns: 300px 1fr;
                gap: 36px;
            }

            .library-items.grid-view {
                grid-template-columns: repeat(3, 1fr);
                gap: 24px;
            }

            .library-item {
                padding: 24px;
            }

            /* Radio 8 stations in single row */
            .station-scroll {
                grid-template-columns: repeat(8, 1fr);
            }

            /* Category sidebar */
            .category-type-tabs {
                padding: 8px;
            }

            .type-tab {
                padding: 14px 16px;
                font-size: 0.95rem;
            }

            .genre-section-header {
                padding: 14px 16px;
            }

            .genre-item {
                padding: 14px 16px;
                font-size: 0.95rem;
            }
        }

        /* ========================================
           RESPONSIVE - ULTRA WIDE MONITORS (2000px+)
           ======================================== */
        @media (min-width: 2000px) {
            .container {
                max-width: 1800px;
            }

            body {
                font-size: 18px;
            }

            .page-header {
                padding: 40px 40px 20px;
            }

            .page-title {
                font-size: 3rem;
            }

            .widget-bar-top {
                padding: 40px 40px 24px;
                min-height: 110px;
            }

            .card {
                padding: 48px;
                border-radius: 28px;
                margin-bottom: 36px;
            }

            .card h2 {
                font-size: 1.75rem;
                margin-bottom: 28px;
            }

            /* Controls and buttons scale up */
            .model-tab {
                padding: 28px 24px;
                border-radius: 20px;
            }

            .model-tab .icon {
                font-size: 42px;
            }

            .model-tab .name {
                font-size: 1.1rem;
            }

            .btn {
                padding: 18px 36px;
                font-size: 1.1rem;
                border-radius: 16px;
            }

            /* Radio stations */
            .station-card {
                min-height: 100px;
                border-radius: 16px;
            }

            .station-card .station-icon {
                width: 3rem;
                height: 3rem;
            }

            .station-card .station-name {
                font-size: 1.1rem;
            }

            /* Library 4 columns on ultra wide */
            .library-items.grid-view {
                grid-template-columns: repeat(4, 1fr);
                gap: 28px;
            }

            .library-layout {
                grid-template-columns: 340px 1fr;
                gap: 44px;
            }

            .library-item {
                padding: 28px;
                border-radius: 20px;
            }

            /* Category sidebar */
            .type-tab {
                padding: 16px 18px;
                font-size: 1rem;
                border-radius: 12px;
            }

            .genre-item {
                padding: 16px 18px;
                font-size: 1rem;
                border-radius: 10px;
            }

            .quick-filter-btn {
                padding: 14px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- SVG Icon Sprite Sheet -->
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <!-- Playback Icons -->
        <symbol id="icon-play" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8 5.14v14l11-7-11-7z"/>
        </symbol>
        <symbol id="icon-pause" viewBox="0 0 24 24" fill="currentColor">
            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
        </symbol>
        <symbol id="icon-skip-next" viewBox="0 0 24 24" fill="currentColor">
            <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
        </symbol>
        <symbol id="icon-skip-prev" viewBox="0 0 24 24" fill="currentColor">
            <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
        </symbol>
        <symbol id="icon-shuffle" viewBox="0 0 24 24" fill="currentColor">
            <path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/>
        </symbol>

        <!-- Rating Icons -->
        <symbol id="icon-thumb-up" viewBox="0 0 24 24" fill="currentColor">
            <path d="M2 20h2c.55 0 1-.45 1-1v-9c0-.55-.45-1-1-1H2v11zm19.83-7.12c.11-.25.17-.52.17-.8V11c0-1.1-.9-2-2-2h-5.5l.92-4.65c.05-.22.02-.46-.08-.66-.23-.45-.52-.86-.88-1.22L14 2 7.59 8.41C7.21 8.79 7 9.3 7 9.83v7.84C7 18.95 8.05 20 9.34 20h8.11c.7 0 1.36-.37 1.72-.97l2.66-6.15z"/>
        </symbol>
        <symbol id="icon-thumb-down" viewBox="0 0 24 24" fill="currentColor">
            <path d="M22 4h-2c-.55 0-1 .45-1 1v9c0 .55.45 1 1 1h2V4zM2.17 11.12c-.11.25-.17.52-.17.8V13c0 1.1.9 2 2 2h5.5l-.92 4.65c-.05.22-.02.46.08.66.23.45.52.86.88 1.22L10 22l6.41-6.41c.38-.38.59-.89.59-1.42V6.34C17 5.05 15.95 4 14.66 4H6.55c-.7 0-1.36.37-1.72.97l-2.66 6.15z"/>
        </symbol>

        <!-- Heart Icons -->
        <symbol id="icon-heart" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
        </symbol>
        <symbol id="icon-heart-outline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
        </symbol>

        <!-- Music Icons -->
        <symbol id="icon-music" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
        </symbol>
        <symbol id="icon-radio" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3.24 6.15C2.51 6.43 2 7.17 2 8v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2H8.3l8.26-3.34L15.88 1 3.24 6.15zM7 20c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm13-8h-2v-2h-2v2H4V8h16v4z"/>
        </symbol>
        <symbol id="icon-library" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 5h-3v5.5c0 1.38-1.12 2.5-2.5 2.5S10 13.88 10 12.5s1.12-2.5 2.5-2.5c.57 0 1.08.19 1.5.51V5h4v2zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6z"/>
        </symbol>
        <symbol id="icon-tag" viewBox="0 0 24 24" fill="currentColor">
            <path d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58s1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41s-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/>
        </symbol>
        <symbol id="icon-chevron" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
        </symbol>
        <symbol id="icon-sparkles" viewBox="0 0 24 24" fill="currentColor">
            <path d="M14.5 2L16 5.5 19.5 7 16 8.5 14.5 12 13 8.5 9.5 7 13 5.5zM4.5 8L6 11.5 9.5 13 6 14.5 4.5 18 3 14.5 -0.5 13 3 11.5zM11.5 14L13 17.5 16.5 19 13 20.5 11.5 24 10 20.5 6.5 19 10 17.5z"/>
        </symbol>

        <!-- UI Icons -->
        <symbol id="icon-fire" viewBox="0 0 24 24" fill="currentColor">
            <path d="M13.5.67s.74 2.65.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l.03-.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5.67zM11.71 19c-1.78 0-3.22-1.4-3.22-3.14 0-1.62 1.05-2.76 2.81-3.12 1.77-.36 3.6-1.21 4.62-2.58.39 1.29.59 2.65.59 4.04 0 2.65-2.15 4.8-4.8 4.8z"/>
        </symbol>
        <symbol id="icon-dice" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM7.5 18c-.83 0-1.5-.67-1.5-1.5S6.67 15 7.5 15s1.5.67 1.5 1.5S8.33 18 7.5 18zm0-9C6.67 9 6 8.33 6 7.5S6.67 6 7.5 6 9 6.67 9 7.5 8.33 9 7.5 9zm4.5 4.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4.5 4.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm0-9c-.83 0-1.5-.67-1.5-1.5S15.67 6 16.5 6s1.5.67 1.5 1.5S17.33 9 16.5 9z"/>
        </symbol>
        <symbol id="icon-close" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </symbol>
        <symbol id="icon-add" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        </symbol>
        <symbol id="icon-settings" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
        </symbol>

        <!-- Station Icons -->
        <symbol id="icon-waves" viewBox="0 0 24 24" fill="currentColor">
            <path d="M17 16.99c-1.35 0-2.2.42-2.95.8-.65.33-1.18.6-2.05.6-.9 0-1.4-.25-2.05-.6-.75-.38-1.57-.8-2.95-.8s-2.2.42-2.95.8c-.65.33-1.17.6-2.05.6v1.95c1.35 0 2.2-.42 2.95-.8.65-.33 1.17-.6 2.05-.6s1.4.25 2.05.6c.75.38 1.57.8 2.95.8s2.2-.42 2.95-.8c.65-.33 1.18-.6 2.05-.6.9 0 1.4.25 2.05.6.75.38 1.58.8 2.95.8v-1.95c-.9 0-1.4-.25-2.05-.6-.75-.38-1.6-.8-2.95-.8zm0-4.45c-1.35 0-2.2.43-2.95.8-.65.32-1.18.6-2.05.6-.9 0-1.4-.25-2.05-.6-.75-.38-1.57-.8-2.95-.8s-2.2.43-2.95.8c-.65.32-1.17.6-2.05.6v1.95c1.35 0 2.2-.43 2.95-.8.65-.35 1.15-.6 2.05-.6s1.4.25 2.05.6c.75.38 1.57.8 2.95.8s2.2-.43 2.95-.8c.65-.35 1.15-.6 2.05-.6s1.4.25 2.05.6c.75.38 1.58.8 2.95.8v-1.95c-.9 0-1.4-.25-2.05-.6-.75-.38-1.6-.8-2.95-.8zm2.95-8.08c-.75-.38-1.58-.8-2.95-.8s-2.2.42-2.95.8c-.65.32-1.18.6-2.05.6-.9 0-1.4-.25-2.05-.6-.75-.37-1.57-.8-2.95-.8s-2.2.42-2.95.8c-.65.33-1.17.6-2.05.6v1.93c1.35 0 2.2-.43 2.95-.8.65-.33 1.17-.6 2.05-.6s1.4.25 2.05.6c.75.38 1.57.8 2.95.8s2.2-.43 2.95-.8c.65-.32 1.18-.6 2.05-.6.9 0 1.4.25 2.05.6.75.38 1.58.8 2.95.8V5.04c-.9 0-1.4-.25-2.05-.58zM17 8.09c-1.35 0-2.2.43-2.95.8-.65.35-1.15.6-2.05.6s-1.4-.25-2.05-.6c-.75-.38-1.57-.8-2.95-.8s-2.2.43-2.95.8c-.65.35-1.15.6-2.05.6v1.95c1.35 0 2.2-.43 2.95-.8.65-.32 1.18-.6 2.05-.6s1.4.25 2.05.6c.75.38 1.57.8 2.95.8s2.2-.43 2.95-.8c.65-.32 1.18-.6 2.05-.6.9 0 1.4.25 2.05.6.75.38 1.58.8 2.95.8V8.49c-.9 0-1.4-.25-2.05-.6-.75-.38-1.6-.8-2.95-.8z"/>
        </symbol>
        <symbol id="icon-gamepad" viewBox="0 0 24 24" fill="currentColor">
            <path d="M15 7.5V2H9v5.5l3 3 3-3zM7.5 9H2v6h5.5l3-3-3-3zM9 16.5V22h6v-5.5l-3-3-3 3zM16.5 9l-3 3 3 3H22V9h-5.5z"/>
        </symbol>
        <symbol id="icon-piano" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-6 16h-2v-5H9v5H7V5h2v6h2V5h2v6h2V5h2v14h-2v-5h-2v5z"/>
        </symbol>
        <symbol id="icon-smile" viewBox="0 0 24 24" fill="currentColor">
            <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/>
        </symbol>
        <symbol id="icon-stars" viewBox="0 0 24 24" fill="currentColor">
            <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zm4.24 16L12 15.45 7.77 18l1.12-4.81-3.73-3.23 4.92-.42L12 5l1.92 4.53 4.92.42-3.73 3.23L16.23 18z"/>
        </symbol>
        <symbol id="icon-headphones" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 1c-4.97 0-9 4.03-9 9v7c0 1.66 1.34 3 3 3h3v-8H5v-2c0-3.87 3.13-7 7-7s7 3.13 7 7v2h-4v8h3c1.66 0 3-1.34 3-3v-7c0-4.97-4.03-9-9-9z"/>
        </symbol>
        <symbol id="icon-search" viewBox="0 0 24 24" fill="currentColor">
            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </symbol>
        <symbol id="icon-chevron" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
        </symbol>

        <!-- Category Icons -->
        <symbol id="icon-ambient" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
        </symbol>
        <symbol id="icon-electronic" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7 5h10v2h2V3H5v4h2V5zm4 14H9v2H5v-4h2v-2H3v6h8v-2zm8-4v2h2v4h-4v-2h-2v2H7v-2h2v-2H5v6h14v-6h-4zm1-6h-2v6h2v-6zm-4 0h-2v6h2v-6zm-4 0H10v6h2v-6zM6 9h2v6H6V9z"/>
        </symbol>
        <symbol id="icon-cinematic" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/>
        </symbol>
        <symbol id="icon-acoustic" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19.59 3H22v2h-1.41L16 9.59V8c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h9c1.1 0 2-.9 2-2v-1.59l4.59 4.59H22v2h-2.41L14 15.41V17c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V7c0-1.1.9-2 2-2h8c1.1 0 2 .9 2 2v1.59l5.59-5.59z"/>
        </symbol>
        <symbol id="icon-upbeat" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
        </symbol>
        <symbol id="icon-retro" viewBox="0 0 24 24" fill="currentColor">
            <path d="M21 6H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-10 7H8v3H6v-3H3v-2h3V8h2v3h3v2zm4.5 2c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4-3c-.83 0-1.5-.67-1.5-1.5S18.67 9 19.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
        </symbol>
        <symbol id="icon-nature" viewBox="0 0 24 24" fill="currentColor">
            <path d="M6.05 8.05c-2.73 2.73-2.73 7.15-.02 9.88a7.02 7.02 0 009.88 0l6.05-6.05c-.33-.18-.64-.39-.92-.63L14 18.29a5.02 5.02 0 01-7.07 0c-1.95-1.95-1.95-5.12 0-7.07L12 6.15a1.5 1.5 0 112.12 2.12l-5.07 5.07c-.39.39-.39 1.02 0 1.41.39.39 1.02.39 1.41 0l5.07-5.07a3.5 3.5 0 00-4.95-4.95L6.05 8.05z"/>
        </symbol>
        <symbol id="icon-mechanical" viewBox="0 0 24 24" fill="currentColor">
            <path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/>
        </symbol>
        <symbol id="icon-human" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </symbol>
        <symbol id="icon-fantasy" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7.5 5.6L10 7 8.6 4.5 10 2 7.5 3.4 5 2l1.4 2.5L5 7zm12 9.8L17 14l1.4 2.5L17 19l2.5-1.4L22 19l-1.4-2.5L22 14zM22 2l-2.5 1.4L17 2l1.4 2.5L17 7l2.5-1.4L22 7l-1.4-2.5zm-7.63 5.29c-.39-.39-1.02-.39-1.41 0L1.29 18.96c-.39.39-.39 1.02 0 1.41l2.34 2.34c.39.39 1.02.39 1.41 0L16.71 11.04c.39-.39.39-1.02 0-1.41l-2.34-2.34zM5.71 21.29L2.71 18.29l1-1L6.71 20.29l-1 1zM19 12l2 2-2 2-2-2 2-2z"/>
        </symbol>
        <symbol id="icon-game" viewBox="0 0 24 24" fill="currentColor">
            <path d="M21 6H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-10 7H8v3H6v-3H3v-2h3V8h2v3h3v2zm4.5 2c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4-3c-.83 0-1.5-.67-1.5-1.5S18.67 9 19.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/>
        </symbol>
        <symbol id="icon-impact" viewBox="0 0 24 24" fill="currentColor">
            <path d="M11 21h-1l1-7H7.5c-.58 0-.57-.32-.38-.66.19-.34.05-.08.07-.12C8.48 10.94 10.42 7.54 13 3h1l-1 7h3.5c.49 0 .56.33.47.51l-.07.15C12.96 17.55 11 21 11 21z"/>
        </symbol>
        <symbol id="icon-whoosh" viewBox="0 0 24 24" fill="currentColor">
            <path d="M14.5 17c0 1.65-1.35 3-3 3s-3-1.35-3-3h2c0 .55.45 1 1 1s1-.45 1-1-.45-1-1-1H2v-2h9.5c1.65 0 3 1.35 3 3zM19 6.5C19 4.57 17.43 3 15.5 3S12 4.57 12 6.5h2c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5S16.33 8 15.5 8H2v2h13.5c1.93 0 3.5-1.57 3.5-3.5zm-.5 4.5H2v2h16.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5v2c1.93 0 3.5-1.57 3.5-3.5S20.43 11 18.5 11z"/>
        </symbol>
        <symbol id="icon-wand" viewBox="0 0 24 24" fill="currentColor">
            <path d="M7.5 5.6L10 7 8.6 4.5 10 2 7.5 3.4 5 2l1.4 2.5L5 7zm12 9.8L17 14l1.4 2.5L17 19l2.5-1.4L22 19l-1.4-2.5L22 14zM22 2l-2.5 1.4L17 2l1.4 2.5L17 7l2.5-1.4L22 7l-1.4-2.5zm-7.63 5.29c-.39-.39-1.02-.39-1.41 0L1.29 18.96c-.39.39-.39 1.02 0 1.41l2.34 2.34c.39.39 1.02.39 1.41 0L16.7 11.05c.39-.39.39-1.02 0-1.41l-2.33-2.35zm-1.03 5.49l-2.12-2.12 2.44-2.44 2.12 2.12-2.44 2.44z"/>
        </symbol>
        <symbol id="icon-volume" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
        </symbol>
        <symbol id="icon-download" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
        </symbol>
        <symbol id="icon-grid" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 3v8h8V3H3zm6 6H5V5h4v4zm-6 4v8h8v-8H3zm6 6H5v-4h4v4zm4-16v8h8V3h-8zm6 6h-4V5h4v4zm-6 4v8h8v-8h-8zm6 6h-4v-4h4v4z"/>
        </symbol>
        <symbol id="icon-list" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
        </symbol>
        <symbol id="icon-filter" viewBox="0 0 24 24" fill="currentColor">
            <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/>
        </symbol>
        <symbol id="icon-clock" viewBox="0 0 24 24" fill="currentColor">
            <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
        </symbol>
        <symbol id="icon-play-circle" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/>
        </symbol>
        <symbol id="icon-add-queue" viewBox="0 0 24 24" fill="currentColor">
            <path d="M15 6H3v2h12V6zm0 4H3v2h12v-2zM3 16h8v-2H3v2zM17 6v8h-4v2h4v4h2v-4h4v-2h-4V6h-2z"/>
        </symbol>
        <symbol id="icon-gpu" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 3H4c-1.1 0-2 .9-2 2v11c0 1.1.9 2 2 2h3l-1 1v2h12v-2l-1-1h3c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 13H4V5h16v11z"/>
        </symbol>
        <symbol id="icon-queue" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 10.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm0-6c-.83 0-1.5.67-1.5 1.5S3.17 7.5 4 7.5 5.5 6.83 5.5 6 4.83 4.5 4 4.5zm0 12c-.83 0-1.5.68-1.5 1.5s.68 1.5 1.5 1.5 1.5-.68 1.5-1.5-.67-1.5-1.5-1.5zM7 19h14v-2H7v2zm0-6h14v-2H7v2zm0-8v2h14V5H7z"/>
        </symbol>
        <symbol id="icon-volume-off" viewBox="0 0 24 24" fill="currentColor">
            <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
        </symbol>
    </svg>

    <div class="widget-bar-top">
        <div id="wallet-widget-container"></div>
    </div>
    <div class="page-header">
        <h1 class="page-title">Sound <span>Box</span></h1>
    </div>

    <div class="container" style="padding: 0 20px 20px;">
        <p class="subtitle">AI-powered music & sound effects generator</p>

        <!-- MAIN TABS -->
        <div class="main-tabs">
            <button class="global-mute-btn" id="global-mute-btn" onclick="toggleGlobalMute()" title="Mute/Unmute all audio">
                <svg class="icon unmuted"><use href="#icon-volume"/></svg>
                <svg class="icon muted"><use href="#icon-volume-off"/></svg>
            </button>
            <button class="main-tab active" onclick="switchTab('radio')" id="tab-radio">
                <svg class="icon icon-md"><use href="#icon-radio"/></svg>
                <span>Radio</span>
            </button>
            <button class="main-tab" onclick="switchTab('library')" id="tab-library">
                <svg class="icon icon-md"><use href="#icon-search"/></svg>
                <span>Library</span>
            </button>
            <button class="main-tab" onclick="switchTab('generate')" id="tab-generate">
                <svg class="icon icon-md"><use href="#icon-wand"/></svg>
                <span>Generate</span>
            </button>
        </div>

        <!-- RADIO TAB -->
        <div class="tab-content active" id="content-radio">
        <!-- RADIO STATION - REDESIGNED -->
        <div class="card radio-card">
            <h2><svg class="icon icon-lg" style="vertical-align: -4px; margin-right: 6px;"><use href="#icon-radio"/></svg>Radio Station</h2>

            <!-- Hidden controls for model selection (used by JS) -->
            <div class="radio-controls-hidden">
                <select id="radio-model">
                    <option value="music">Music</option>
                    <option value="audio">Sound Effects</option>
                </select>
                <input type="text" id="radio-keywords" placeholder="Keywords (optional)...">
            </div>

            <!-- Station Presets -->
            <div class="station-presets">
                <div class="station-presets-label">Station Presets</div>
                <div class="station-scroll">
                    <div class="station-card station-ambient" onclick="startStation('ambient', this)" data-keywords="ambient soundscape" title="Play ambient and soundscape tracks">
                        <svg class="station-icon"><use href="#icon-waves"/></svg>
                        <span class="station-name">Ambient</span>
                    </div>
                    <div class="station-card station-retro" onclick="startStation('retro', this)" data-keywords="chiptune 8-bit retro" title="Play chiptune and 8-bit retro tracks">
                        <svg class="station-icon"><use href="#icon-gamepad"/></svg>
                        <span class="station-name">Retro</span>
                    </div>
                    <div class="station-card station-piano" onclick="startStation('piano', this)" data-keywords="piano gentle keys" title="Play piano and gentle keyboard tracks">
                        <svg class="station-icon"><use href="#icon-piano"/></svg>
                        <span class="station-name">Piano</span>
                    </div>
                    <div class="station-card station-happy" onclick="startStation('happy', this)" data-keywords="happy bouncy cute" title="Play happy, bouncy, and upbeat tracks">
                        <svg class="station-icon"><use href="#icon-smile"/></svg>
                        <span class="station-name">Happy</span>
                    </div>
                    <div class="station-card station-dreamy" onclick="startStation('dreamy', this)" data-keywords="dreamy warm ethereal" title="Play dreamy and ethereal tracks">
                        <svg class="station-icon"><use href="#icon-stars"/></svg>
                        <span class="station-name">Dreamy</span>
                    </div>
                    <div class="station-card station-lofi" onclick="startStation('lofi', this)" data-keywords="lo-fi hip hop" title="Play lo-fi hip hop and chill beats">
                        <svg class="station-icon"><use href="#icon-headphones"/></svg>
                        <span class="station-name">Lo-Fi</span>
                    </div>
                    <div class="station-card station-favorites" onclick="startStation('favorites', this)" data-keywords="" title="Play your favorited tracks">
                        <svg class="station-icon"><use href="#icon-heart"/></svg>
                        <span class="station-name">Favorites</span>
                    </div>
                    <div class="station-card station-all" onclick="startStation('all', this)" data-keywords="" title="Shuffle all music in the library">
                        <svg class="station-icon"><use href="#icon-music"/></svg>
                        <span class="station-name">All Music</span>
                    </div>
                </div>
            </div>

            <!-- Featured Row -->
            <div class="featured-row">
                <button class="featured-btn" onclick="playTopRated(this)" title="Play highest rated tracks by the community">
                    <svg class="icon icon-sm"><use href="#icon-fire"/></svg> Top Rated
                </button>
                <button class="featured-btn" onclick="playNewArrivals(this)" title="Play recently generated tracks">
                    <svg class="icon icon-sm"><use href="#icon-sparkles"/></svg> New Arrivals
                </button>
                <button class="featured-btn" onclick="playSurpriseMe(this)" title="Play random tracks from the library">
                    <svg class="icon icon-sm"><use href="#icon-dice"/></svg> Surprise Me
                </button>
            </div>

            <!-- Now Playing - Enhanced -->
            <div class="now-playing hidden" id="now-playing">
                <div class="hero-section">
                    <!-- Animated EQ Visualizer -->
                    <div class="eq-visualizer" id="eq-visualizer">
                        <div class="eq-bar"></div>
                        <div class="eq-bar"></div>
                        <div class="eq-bar"></div>
                        <div class="eq-bar"></div>
                        <div class="eq-bar"></div>
                        <div class="eq-bar"></div>
                        <div class="eq-bar"></div>
                    </div>
                    <div class="track-info">
                        <div id="radio-prompt" class="track-title">Loading...</div>
                        <div class="track-meta">
                            <span class="duration" id="radio-duration">0s</span>
                        </div>
                    </div>
                </div>

                <div class="controls-section">
                    <!-- Audio Player -->
                    <div class="audio-row">
                        <div class="styled-audio">
                            <audio id="radio-player" controls></audio>
                        </div>
                    </div>

                    <!-- Unified Control Bar -->
                    <div class="control-bar">
                        <!-- Playback Controls -->
                        <div class="playback-controls">
                            <button class="control-btn" onclick="playPreviousTrack()" title="Play previous track">
                                <svg class="icon"><use href="#icon-skip-prev"/></svg>
                            </button>
                            <button class="control-btn" onclick="skipTrack()" title="Skip to next track">
                                <svg class="icon"><use href="#icon-skip-next"/></svg>
                            </button>
                        </div>

                        <div class="control-separator"></div>

                        <!-- Favorite -->
                        <button class="favorite-btn" id="radio-favorite-btn" onclick="toggleRadioFavorite()" title="Add to favorites for quick access">
                            <svg class="icon heart-icon"><use href="#icon-heart-outline"/></svg>
                        </button>

                        <!-- Tag -->
                        <button class="control-btn tag-btn" onclick="tagCurrentTrack()" title="Suggest a category for this track">
                            <svg class="icon"><use href="#icon-tag"/></svg>
                            <span>Tag</span>
                        </button>

                        <!-- Download -->
                        <button class="control-btn download-btn" onclick="downloadCurrentTrack()" title="Download this track">
                            <svg class="icon"><use href="#icon-download"/></svg>
                            <span>Download</span>
                        </button>

                        <div class="control-separator"></div>

                        <!-- Rating Controls -->
                        <div class="rating-controls">
                            <button class="rating-btn" id="radio-vote-up" onclick="showPositiveFeedbackMenu()" title="Like this track - helps improve recommendations">
                                <svg class="icon"><use href="#icon-thumb-up"/></svg>
                                <span class="count" id="radio-upvotes">0</span>
                            </button>
                            <button class="rating-btn" id="radio-vote-down" onclick="showFeedbackMenu()" title="Dislike this track - skip similar content">
                                <svg class="icon"><use href="#icon-thumb-down"/></svg>
                                <span class="count" id="radio-downvotes">0</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Up Next Queue - Enhanced -->
            <div class="radio-queue hidden" id="radio-queue">
                <div class="queue-header">
                    <span>Up Next</span>
                    <span class="queue-count" id="queue-count-badge">0</span>
                </div>
                <div class="queue-items" id="queue-items"></div>
            </div>
        </div>
        </div> <!-- /content-radio -->

        <!-- LIBRARY TAB -->
        <div class="tab-content" id="content-library">
        <!-- LIBRARY (Browse & Search) - REDESIGNED -->
        <div class="card library-card">
            <h2>
                <svg class="icon"><use href="#icon-library"/></svg>
                Library <span id="library-total"></span>
            </h2>

            <!-- Search and Controls Row -->
            <div class="library-controls">
                <div class="library-search-wrapper">
                    <svg class="search-icon"><use href="#icon-search"/></svg>
                    <input type="text" class="search-input" id="library-search" placeholder="Search music, sound effects, prompts..." title="Search by prompt keywords">
                </div>
                <select id="library-model" title="Filter by content type" style="display: none;">
                    <option value="">All Types</option>
                    <option value="music">Music</option>
                    <option value="audio">Sound Effects</option>
                    <option value="favorites">My Favorites</option>
                </select>
                <select id="library-sort" title="Sort order">
                    <option value="recent">Most Recent</option>
                    <option value="popular">Most Popular</option>
                    <option value="rating">Highest Rated</option>
                </select>
                <div class="view-toggle" title="Toggle view mode">
                    <button class="view-toggle-btn active" onclick="setLibraryView('list')" title="List view">
                        <svg class="icon"><use href="#icon-list"/></svg>
                    </button>
                    <button class="view-toggle-btn" onclick="setLibraryView('grid')" title="Grid view">
                        <svg class="icon"><use href="#icon-grid"/></svg>
                    </button>
                </div>
            </div>

            <!-- Mobile Category Toggle -->
            <button class="mobile-category-toggle" onclick="toggleMobileCategories()">
                <svg class="icon"><use href="#icon-filter"/></svg>
                Browse Categories
            </button>

            <!-- Library Layout with Sidebar -->
            <div class="library-layout">
                <!-- Category Sidebar -->
                <div class="category-sidebar" id="category-sidebar">
                    <!-- Quick Filters -->
                    <div class="quick-filters">
                        <button class="quick-filter-btn" onclick="selectQuickFilter('favorites')" data-filter="favorites">
                            <svg class="icon"><use href="#icon-heart"/></svg>
                            <span>Favorites</span>
                        </button>
                        <button class="quick-filter-btn" onclick="selectQuickFilter('recent')" data-filter="recent">
                            <svg class="icon"><use href="#icon-clock"/></svg>
                            <span>Recent</span>
                        </button>
                    </div>

                    <!-- Music Genres - Collapsible Groups -->
                    <div class="genre-section music-genres" id="music-genres">
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Electronic & Dance</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('electronic')" data-genre="electronic"><span class="genre-name">Electronic</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('edm')" data-genre="edm"><span class="genre-name">EDM</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('house')" data-genre="house"><span class="genre-name">House</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('techno')" data-genre="techno"><span class="genre-name">Techno</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('synthwave')" data-genre="synthwave"><span class="genre-name">Synthwave</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Ambient & Chill</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('ambient')" data-genre="ambient"><span class="genre-name">Ambient</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('lofi')" data-genre="lofi"><span class="genre-name">Lo-Fi</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('chill')" data-genre="chill"><span class="genre-name">Chill</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('meditation')" data-genre="meditation"><span class="genre-name">Meditation</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('study')" data-genre="study"><span class="genre-name">Study/Focus</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Cinematic & Epic</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('cinematic')" data-genre="cinematic"><span class="genre-name">Cinematic</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('epic')" data-genre="epic"><span class="genre-name">Epic</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('orchestral')" data-genre="orchestral"><span class="genre-name">Orchestral</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('trailer')" data-genre="trailer"><span class="genre-name">Trailer</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('suspense')" data-genre="suspense"><span class="genre-name">Suspense</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Acoustic & Classical</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('acoustic')" data-genre="acoustic"><span class="genre-name">Acoustic</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('piano')" data-genre="piano"><span class="genre-name">Piano</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('guitar')" data-genre="guitar"><span class="genre-name">Guitar</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('classical')" data-genre="classical"><span class="genre-name">Classical</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('jazz')" data-genre="jazz"><span class="genre-name">Jazz</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Hip Hop & Urban</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('hiphop')" data-genre="hiphop"><span class="genre-name">Hip Hop</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('trap')" data-genre="trap"><span class="genre-name">Trap</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('funk')" data-genre="funk"><span class="genre-name">Funk</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('soul')" data-genre="soul"><span class="genre-name">Soul</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Rock & Alternative</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('rock')" data-genre="rock"><span class="genre-name">Rock</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('indie')" data-genre="indie"><span class="genre-name">Indie</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('metal')" data-genre="metal"><span class="genre-name">Metal</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('punk')" data-genre="punk"><span class="genre-name">Punk</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Moods & Energy</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('upbeat')" data-genre="upbeat"><span class="genre-name">Upbeat</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('happy')" data-genre="happy"><span class="genre-name">Happy</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('sad')" data-genre="sad"><span class="genre-name">Sad</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('relaxing')" data-genre="relaxing"><span class="genre-name">Relaxing</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('scary')" data-genre="scary"><span class="genre-name">Scary</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Retro & Gaming</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('retro')" data-genre="retro"><span class="genre-name">Retro</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('chiptune')" data-genre="chiptune"><span class="genre-name">Chiptune/8-bit</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('arcade')" data-genre="arcade"><span class="genre-name">Arcade</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('game_music')" data-genre="game_music"><span class="genre-name">Game Music</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>World & Cultural</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('world')" data-genre="world"><span class="genre-name">World</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('latin')" data-genre="latin"><span class="genre-name">Latin</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('asian')" data-genre="asian"><span class="genre-name">Asian</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('celtic')" data-genre="celtic"><span class="genre-name">Celtic</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Use Cases</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('corporate')" data-genre="corporate"><span class="genre-name">Corporate</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('youtube')" data-genre="youtube"><span class="genre-name">YouTube</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('podcast')" data-genre="podcast"><span class="genre-name">Podcast</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('workout')" data-genre="workout"><span class="genre-name">Workout</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('kids')" data-genre="kids"><span class="genre-name">Kids</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- SFX Categories - Collapsible Groups -->
                    <div class="genre-section sfx-genres" id="sfx-genres">
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>UI & Interface</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('notification')" data-genre="notification"><span class="genre-name">Notification</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('button')" data-genre="button"><span class="genre-name">Button/Click</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('success')" data-genre="success"><span class="genre-name">Success/Win</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('error')" data-genre="error"><span class="genre-name">Error/Fail</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Actions & Movement</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('whoosh')" data-genre="whoosh"><span class="genre-name">Whoosh</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('impact')" data-genre="impact"><span class="genre-name">Impact/Hit</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('explosion')" data-genre="explosion"><span class="genre-name">Explosion</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('footstep')" data-genre="footstep"><span class="genre-name">Footsteps</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Nature & Weather</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('rain')" data-genre="rain"><span class="genre-name">Rain</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('wind')" data-genre="wind"><span class="genre-name">Wind</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('thunder')" data-genre="thunder"><span class="genre-name">Thunder</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('water')" data-genre="water"><span class="genre-name">Water</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('fire')" data-genre="fire"><span class="genre-name">Fire</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Animals & Creatures</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('bird')" data-genre="bird"><span class="genre-name">Birds</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('dog')" data-genre="dog"><span class="genre-name">Dog</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('cat')" data-genre="cat"><span class="genre-name">Cat</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('monster')" data-genre="monster"><span class="genre-name">Monster</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Human Sounds</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('voice')" data-genre="voice"><span class="genre-name">Voice</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('crowd')" data-genre="crowd"><span class="genre-name">Crowd</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('eating')" data-genre="eating"><span class="genre-name">Eating</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('laugh')" data-genre="laugh"><span class="genre-name">Laugh</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Objects & Materials</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('door')" data-genre="door"><span class="genre-name">Door</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('bell')" data-genre="bell"><span class="genre-name">Bell</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('glass')" data-genre="glass"><span class="genre-name">Glass</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('metal')" data-genre="metal"><span class="genre-name">Metal</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Machines & Tech</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('engine')" data-genre="engine"><span class="genre-name">Engine/Car</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('computer')" data-genre="computer"><span class="genre-name">Computer</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('robot')" data-genre="robot"><span class="genre-name">Robot</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('scifi')" data-genre="scifi"><span class="genre-name">Sci-Fi</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Magic & Fantasy</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('magic')" data-genre="magic"><span class="genre-name">Magic/Spell</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('sparkle')" data-genre="sparkle"><span class="genre-name">Sparkle</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('power_up')" data-genre="power_up"><span class="genre-name">Power Up</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Weapons & Combat</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('gun')" data-genre="gun"><span class="genre-name">Gun/Shoot</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('laser')" data-genre="laser"><span class="genre-name">Laser</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('sword')" data-genre="sword"><span class="genre-name">Sword</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Horror & Tension</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('horror')" data-genre="horror"><span class="genre-name">Horror</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('tension')" data-genre="tension"><span class="genre-name">Tension</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('ghost')" data-genre="ghost"><span class="genre-name">Ghost</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                        <div class="genre-group collapsed">
                            <div class="genre-section-header" onclick="toggleGenreGroup(this)"><span>Cartoon & Comedy</span><svg class="icon chevron"><use href="#icon-chevron"/></svg></div>
                            <div class="genre-list">
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('cartoon')" data-genre="cartoon"><span class="genre-name">Cartoon</span><span class="genre-count">0</span></div>
                                <div class="genre-item" onclick="event.stopPropagation(); selectGenre('funny')" data-genre="funny"><span class="genre-name">Funny</span><span class="genre-count">0</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Clear Filter Button -->
                    <button class="clear-filter-btn" id="clear-filter-btn" onclick="clearAllFilters()" style="display: none;">
                        <svg class="icon"><use href="#icon-close"/></svg>
                        Clear Filters
                    </button>
                </div>

                <!-- Main Content Area -->
                <div class="library-main">
                    <!-- Library Items Container -->
                    <div id="library-items" class="library-items">
                        <div class="library-empty">
                            <svg class="empty-icon"><use href="#icon-music"/></svg>
                            <h3>Loading library...</h3>
                            <p>Fetching your audio collection</p>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination" id="pagination">
                        <button class="page-btn" id="prev-page" onclick="prevPage()" title="Previous page">
                            <svg class="icon icon-sm"><use href="#icon-skip-prev"/></svg>
                        </button>
                        <div class="page-numbers" id="page-numbers"></div>
                        <span class="page-info" id="page-info">Page 1 of 1</span>
                        <button class="page-btn" id="next-page" onclick="nextPage()" title="Next page">
                            <svg class="icon icon-sm"><use href="#icon-skip-next"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        </div> <!-- /content-library -->

        <!-- GENERATE TAB -->
        <div class="tab-content" id="content-generate">

        <div id="loading-banner" class="loading-banner">
            <div class="title">Loading AI Models...</div>
            <div class="model-status">
                <div class="model-status-item">
                    <span class="status-dot" id="music-status-dot"></span>
                    <span>MusicGen</span>
                </div>
                <div class="model-status-item">
                    <span class="status-dot" id="audio-status-dot"></span>
                    <span>AudioGen</span>
                </div>
            </div>
        </div>

        <div id="gpu-status" class="gpu-status" title="GPU memory usage and status">
            <span class="gpu-icon"><svg class="icon icon-sm"><use href="#icon-gpu"/></svg></span>
            <span id="gpu-name">GPU</span>
            <div class="gpu-bar">
                <div class="gpu-bar-fill" id="gpu-bar-fill"></div>
            </div>
            <span id="gpu-mem">0%</span>
            <span class="gpu-busy" id="gpu-busy">IDLE</span>
        </div>

        <div id="queue-status-banner" class="queue-status-banner">
            <span><span class="queue-count" id="queue-count">0</span> jobs in queue</span>
            <span class="wait-time" id="estimated-wait">Est. wait: calculating...</span>
        </div>

        <!-- QUEUE EXPLORER -->
        <div class="card queue-explorer-card collapsed" id="queue-explorer-card">
            <h2 onclick="toggleQueueExplorer()">
                <svg class="icon icon-lg" style="vertical-align: -4px; margin-right: 6px;"><use href="#icon-queue"/></svg>Generation Queue
                <span class="queue-badge empty" id="queue-explorer-badge">0</span>
                <span class="collapse-icon"></span>
            </h2>
            <div class="queue-explorer-content">
                <div class="queue-list" id="queue-explorer-list"></div>
                <div class="queue-empty" id="queue-empty">
                    <div class="icon"><svg class="icon icon-xl"><use href="#icon-sparkles"/></svg></div>
                    <div>No jobs in queue - ready to generate!</div>
                </div>
            </div>
        </div>

        <!-- GENERATOR -->
        <div class="card generator-card" id="generator-card">
            <h2><svg class="icon icon-lg" style="vertical-align: -4px; margin-right: 6px;"><use href="#icon-wand"/></svg>Generate New</h2>
            <div class="generator-content">
            <div class="model-tabs">
                <div class="model-tab active" data-model="music" onclick="selectModel('music')" title="Generate music with AI">
                    <div class="icon"><svg class="icon icon-lg"><use href="#icon-music"/></svg></div>
                    <div class="name">MusicGen</div>
                    <div class="desc">Generate music</div>
                </div>
                <div class="model-tab" data-model="audio" onclick="selectModel('audio')" title="Generate sound effects with AI">
                    <div class="icon"><svg class="icon icon-lg"><use href="#icon-volume"/></svg></div>
                    <div class="name">AudioGen</div>
                    <div class="desc">Generate sound effects</div>
                </div>
            </div>

            <label for="prompt">Describe what you want to generate:</label>
            <textarea id="prompt" placeholder="e.g., upbeat electronic dance music with heavy bass and synth leads"></textarea>

            <div class="examples" id="music-examples">
                <span>Try these:</span>
                <div class="example-chips">
                    <span class="chip" onclick="setPrompt('lo-fi hip hop beat with jazzy piano')">Lo-fi Hip Hop</span>
                    <span class="chip" onclick="setPrompt('epic orchestral music with dramatic strings')">Epic Orchestral</span>
                    <span class="chip" onclick="setPrompt('chill acoustic guitar with soft drums')">Chill Acoustic</span>
                    <span class="chip" onclick="setPrompt('80s synthwave with retro synths and drums')">80s Synthwave</span>
                </div>
            </div>

            <div class="examples" id="audio-examples" style="display: none;">
                <span>Try these:</span>
                <div class="example-chips">
                    <span class="chip" onclick="setPrompt('dog barking in the distance')">Dog Barking</span>
                    <span class="chip" onclick="setPrompt('thunder and heavy rain')">Thunder Storm</span>
                    <span class="chip" onclick="setPrompt('footsteps on wooden floor')">Footsteps</span>
                    <span class="chip" onclick="setPrompt('car engine starting and revving')">Car Engine</span>
                    <span class="chip" onclick="setPrompt('crowd cheering at a sports event')">Crowd Cheering</span>
                    <span class="chip" onclick="setPrompt('glass breaking and shattering')">Glass Breaking</span>
                </div>
            </div>

            <div class="controls">
                <div class="control-box duration-control">
                    <label for="duration">Duration</label>
                    <div class="duration-value"><span id="duration-display">8</span>s</div>
                    <input type="range" id="duration" min="3" max="120" value="8">
                </div>
                <div class="control-box loop-control" id="loop-control" onclick="toggleLoop()" title="Apply crossfade to make the audio loop seamlessly">
                    <span class="toggle-switch"></span>
                    <span class="loop-label">Loop</span>
                    <input type="checkbox" id="loop-checkbox">
                </div>
                <div class="control-box random-control" id="random-btn" onclick="randomPrompt()" title="Generate a random creative prompt">Random</div>
                <button id="generate-btn" class="btn btn-primary" onclick="generate()" title="Generate audio from your prompt">
                    <span>Generate</span>
                </button>
            </div>

            <div id="status" class="status"></div>

            <div id="player" class="player">
                <h2>Generated Audio <span id="quality-badge" class="quality-badge"></span></h2>
                <div class="styled-audio">
                    <audio id="audio" controls></audio>
                </div>
                <div id="player-spectrogram" class="player-spectrogram"></div>
            </div>
            </div> <!-- /generator-content -->
        </div>
        </div> <!-- /content-generate -->

    </div>

    <script>
        const promptEl = document.getElementById('prompt');
        const durationEl = document.getElementById('duration');
        const durationDisplay = document.getElementById('duration-display');
        const statusEl = document.getElementById('status');
        const playerEl = document.getElementById('player');
        const audioEl = document.getElementById('audio');
        const generateBtn = document.getElementById('generate-btn');
        const musicExamples = document.getElementById('music-examples');
        const audioExamples = document.getElementById('audio-examples');
        const loadingBanner = document.getElementById('loading-banner');
        const musicStatusDot = document.getElementById('music-status-dot');
        const audioStatusDot = document.getElementById('audio-status-dot');
        const qualityBadge = document.getElementById('quality-badge');
        const playerSpectrogram = document.getElementById('player-spectrogram');

        let currentModel = 'music';
        let modelStatus = { music: 'pending', audio: 'pending' };
        let currentTab = 'radio';

        // ========================================
        // TAB SWITCHING
        // ========================================
        function switchTab(tabName) {
            currentTab = tabName;

            // Update tab buttons
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.classList.toggle('active', tab.id === `tab-${tabName}`);
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === `content-${tabName}`);
            });

            // Save preference
            localStorage.setItem('soundbox_tab', tabName);

            // Load library if switching to library tab
            if (tabName === 'library') {
                loadLibrary();
            }
        }

        // Restore saved tab on load
        (function() {
            const savedTab = localStorage.getItem('soundbox_tab');
            if (savedTab && ['radio', 'library', 'generate'].includes(savedTab)) {
                // Use setTimeout to ensure DOM is ready
                setTimeout(() => switchTab(savedTab), 0);
            }
        })();
        let currentJobId = null;
        let modelsReady = false;

        // Separate prompts for each model
        let modelPrompts = {
            music: '',
            audio: ''
        };

        // User ID - use Graphlings login OR generate anonymous device ID
        let currentUserId = null;
        let isAdultAccount = false;  // Only true for verified adult Graphlings accounts

        // Generate anonymous device ID for voting without login
        function getDeviceId() {
            let deviceId = localStorage.getItem('soundbox_device_id');
            if (!deviceId) {
                deviceId = 'anon_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
                localStorage.setItem('soundbox_device_id', deviceId);
            }
            return deviceId;
        }

        // Get effective user ID (logged in user OR device ID)
        function getEffectiveUserId() {
            return currentUserId || getDeviceId();
        }

        const gpuName = document.getElementById('gpu-name');
        const gpuBarFill = document.getElementById('gpu-bar-fill');
        const gpuMem = document.getElementById('gpu-mem');
        const gpuBusy = document.getElementById('gpu-busy');

        const queueBanner = document.getElementById('queue-status-banner');
        const queueCountEl = document.getElementById('queue-count');
        const estimatedWaitEl = document.getElementById('estimated-wait');

        async function checkStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                modelStatus = data.models;

                // Update model status dots
                musicStatusDot.className = 'status-dot ' + (modelStatus.music.startsWith?.('error') ? 'error' : modelStatus.music);
                audioStatusDot.className = 'status-dot ' + (modelStatus.audio.startsWith?.('error') ? 'error' : modelStatus.audio);

                // Update GPU status
                if (data.gpu && data.gpu.available) {
                    gpuName.textContent = data.gpu.name?.replace('NVIDIA GeForce ', '') || 'GPU';
                    gpuBarFill.style.width = data.gpu.memory_percent + '%';
                    gpuMem.textContent = data.gpu.memory_percent + '%';
                    gpuBusy.textContent = data.gpu.busy ? 'BUSY' : 'IDLE';
                    gpuBusy.className = 'gpu-busy ' + (data.gpu.busy ? 'busy' : 'idle');
                }

                // Check if all ready
                const allReady = modelStatus.music === 'ready' && modelStatus.audio === 'ready';
                if (allReady && !modelsReady) {
                    modelsReady = true;
                    loadingBanner.classList.add('ready');
                    loadingBanner.querySelector('.title').textContent = 'Models Ready!';
                    setTimeout(() => {
                        loadingBanner.style.display = 'none';
                    }, 2000);
                }

                // Update queue status
                queueCountEl.textContent = data.queue_length;
                if (data.queue_length > 0) {
                    const waitSeconds = data.estimated_wait || 0;
                    if (waitSeconds > 60) {
                        estimatedWaitEl.textContent = `Est. wait: ${Math.ceil(waitSeconds / 60)} min`;
                    } else if (waitSeconds > 0) {
                        estimatedWaitEl.textContent = `Est. wait: ~${Math.ceil(waitSeconds)}s`;
                    } else {
                        estimatedWaitEl.textContent = 'Processing now...';
                    }
                } else {
                    estimatedWaitEl.textContent = 'Ready to generate!';
                }

                updateGenerateButton();
            } catch (err) {
                console.error('Status check failed:', err);
            }

            // Keep polling
            setTimeout(checkStatus, 2000);
        }

        function updateGenerateButton() {
            if (currentJobId) {
                generateBtn.disabled = true;
                return;
            }
            const ready = modelStatus[currentModel] === 'ready';
            generateBtn.disabled = !ready;
            if (!ready && modelStatus[currentModel] === 'loading') {
                generateBtn.textContent = 'Loading Model...';
            } else {
                generateBtn.textContent = 'Generate';
            }
        }

        durationEl.addEventListener('input', () => {
            durationDisplay.textContent = durationEl.value;
        });

        function selectModel(model) {
            // Save current prompt before switching
            modelPrompts[currentModel] = promptEl.value;

            currentModel = model;
            document.querySelectorAll('.model-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.model === model);
            });

            if (model === 'music') {
                musicExamples.style.display = 'block';
                audioExamples.style.display = 'none';
                promptEl.placeholder = 'e.g., upbeat electronic dance music with heavy bass and synth leads';
            } else {
                musicExamples.style.display = 'none';
                audioExamples.style.display = 'block';
                promptEl.placeholder = 'e.g., dog barking loudly, thunder in the background';
            }

            // Restore saved prompt for this model
            promptEl.value = modelPrompts[model] || '';

            updateGenerateButton();

        }

        function setPrompt(text) {
            promptEl.value = text;
            promptEl.focus();
        }

        function toggleLoop() {
            const loopControl = document.getElementById('loop-control');
            const checkbox = document.getElementById('loop-checkbox');
            checkbox.checked = !checkbox.checked;
            loopControl.classList.toggle('active', checkbox.checked);
        }

        async function randomPrompt() {
            const randomBtn = document.getElementById('random-btn');
            randomBtn.style.opacity = '0.5';
            randomBtn.style.pointerEvents = 'none';

            try {
                const response = await fetch('/random-prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: currentModel })
                });
                const data = await response.json();

                if (data.success && data.prompt) {
                    promptEl.value = data.prompt;
                    promptEl.focus();
                } else {
                    console.error('Random prompt failed:', data.error);
                }
            } catch (err) {
                console.error('Random prompt error:', err);
            } finally {
                randomBtn.style.opacity = '1';
                randomBtn.style.pointerEvents = 'auto';
            }
        }

        async function generate() {
            const prompt = promptEl.value.trim();
            if (!prompt) {
                statusEl.className = 'status error';
                statusEl.textContent = 'Please enter a description';
                return;
            }

            generateBtn.disabled = true;
            statusEl.className = 'status loading';
            statusEl.innerHTML = `<span class="spinner"></span>Submitting to queue...`;
            playerEl.classList.remove('show');

            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        duration: parseInt(durationEl.value),
                        model: currentModel,
                        loop: document.getElementById('loop-checkbox').checked,
                        priority: 'standard',
                        user_id: currentUserId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    currentJobId = data.job_id;
                    statusEl.innerHTML = `
                        <div class="job-progress">
                            <div class="position">Position in queue: ${data.position}</div>
                            <div class="progress-text"><span class="spinner"></span>Waiting...</div>
                        </div>
                    `;
                    pollJobStatus();
                } else {
                    statusEl.className = 'status error';
                    statusEl.textContent = 'Error: ' + data.error;
                    generateBtn.disabled = false;
                }
            } catch (err) {
                statusEl.className = 'status error';
                statusEl.textContent = 'Error: ' + err.message;
                generateBtn.disabled = false;
            }
        }

        async function pollJobStatus() {
            if (!currentJobId) return;

            try {
                const response = await fetch(`/job/${currentJobId}`);
                const job = await response.json();

                if (job.status === 'completed') {
                    statusEl.style.display = 'none';
                    audioEl.src = `/audio/${job.filename}`;

                    // Show quality badge
                    if (job.quality) {
                        const score = job.quality.score;
                        qualityBadge.textContent = `${score}%`;
                        qualityBadge.className = 'quality-badge ' +
                            (score >= 80 ? 'good' : score >= 60 ? 'medium' : 'bad');
                    } else {
                        qualityBadge.textContent = '';
                    }

                    // Show spectrogram
                    if (job.spectrogram) {
                        playerSpectrogram.innerHTML = `<img src="/spectrogram/${job.spectrogram}" alt="Spectrogram">`;
                    }

                    playerEl.classList.add('show');
                    loadLibrary();  // Refresh library with new generation
                    currentJobId = null;
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'Generate';
                } else if (job.status === 'failed') {
                    statusEl.className = 'status error';
                    statusEl.textContent = 'Error: ' + (job.error || 'Generation failed');
                    currentJobId = null;
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'Generate';
                } else {
                    // Still processing
                    const posText = job.position > 1 ? `Position in queue: ${job.position}` : '';
                    const pct = job.progress_pct || 0;
                    const showBar = job.status === 'processing' && pct > 0;
                    statusEl.innerHTML = `
                        <div class="job-progress">
                            ${posText ? `<div class="position">${posText}</div>` : ''}
                            ${showBar ? `
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill" style="width: ${pct}%"></div>
                                </div>
                            ` : ''}
                            <div class="progress-text">${!showBar ? '<span class="spinner"></span>' : ''}${job.progress || 'Processing...'}</div>
                        </div>
                    `;
                    setTimeout(pollJobStatus, 300);
                }
            } catch (err) {
                console.error('Job poll failed:', err);
                setTimeout(pollJobStatus, 1000);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showFeedbackToast(message, type = 'success') {
            // type can be: 'success', 'error', 'warning'
            // Remove existing toast if any
            const existingToast = document.querySelector('.feedback-toast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.className = 'feedback-toast' + (type !== 'success' ? ' ' + type : '');
            const isError = (type === 'error');

            if (isError) {
                // Error toast with copy button
                const content = document.createElement('div');
                content.className = 'toast-content';

                const msgDiv = document.createElement('div');
                msgDiv.className = 'toast-message';
                msgDiv.textContent = message;
                content.appendChild(msgDiv);

                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-btn';
                copyBtn.textContent = 'Copy Error';
                copyBtn.type = 'button';
                copyBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Copy button clicked, message:', message);

                    // Try modern clipboard API first
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        navigator.clipboard.writeText(message).then(() => {
                            copyBtn.textContent = ' Copied!';
                            copyBtn.style.background = 'rgba(40, 167, 69, 0.6)';
                            console.log('Copied via clipboard API');
                        }).catch((err) => {
                            console.log('Clipboard API failed, trying fallback:', err);
                            fallbackCopy();
                        });
                    } else {
                        fallbackCopy();
                    }

                    function fallbackCopy() {
                        const textArea = document.createElement('textarea');
                        textArea.value = message;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-9999px';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        try {
                            const success = document.execCommand('copy');
                            if (success) {
                                copyBtn.textContent = ' Copied!';
                                copyBtn.style.background = 'rgba(40, 167, 69, 0.6)';
                                console.log('Copied via execCommand');
                            } else {
                                copyBtn.textContent = ' Failed';
                                console.log('execCommand returned false');
                            }
                        } catch (err) {
                            copyBtn.textContent = ' Failed';
                            console.error('Copy failed:', err);
                        }
                        document.body.removeChild(textArea);
                    }

                    // Reset button after delay
                    setTimeout(() => {
                        copyBtn.textContent = 'Copy Error';
                        copyBtn.style.background = '';
                    }, 2500);
                });
                content.appendChild(copyBtn);
                toast.appendChild(content);

                // Log error to backend
                logErrorToBackend(message);
            } else {
                toast.textContent = message;
            }

            document.body.appendChild(toast);

            // Trigger animation
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            // Remove after delay (longer for errors)
            const delay = isError ? 10000 : 2500;
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, delay);
        }

        async function logErrorToBackend(message) {
            try {
                await fetch('/api/log-error', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        url: window.location.href,
                        userAgent: navigator.userAgent,
                        timestamp: new Date().toISOString()
                    })
                });
            } catch (e) {
                console.error('Failed to log error to backend:', e);
            }
        }

        function showErrorToast(message) {
            showFeedbackToast(message, 'error');
        }

        function showWarningToast(message) {
            showFeedbackToast(message, 'warning');
        }

        // ========================================
        // RADIO STATION
        // ========================================
        let radioQueue = [];
        let currentRadioTrack = null;
        let playHistory = [];  // Track IDs that have been played (to avoid repeats)
        let recentlyPlayed = [];  // Full track objects for "previous" functionality
        const MAX_HISTORY = 50;  // Keep last 50 played tracks
        const MIN_QUEUE_SIZE = 3;  // Auto-fetch when queue drops below this
        let isFetchingMore = false;  // Prevent duplicate fetches
        const radioPlayer = document.getElementById('radio-player');
        const nowPlayingEl = document.getElementById('now-playing');
        const radioQueueEl = document.getElementById('radio-queue');
        const queueItemsEl = document.getElementById('queue-items');

        // Auto-play next track when current ends
        radioPlayer.addEventListener('ended', () => {
            playNextTrack();
        });

        async function shuffleRadio() {
            const model = document.getElementById('radio-model').value;
            const keywords = document.getElementById('radio-keywords').value.trim();

            // Save radio preferences
            localStorage.setItem('soundbox_radio_model', model);
            const shuffleBtn = document.getElementById('shuffle-btn');

            shuffleBtn.disabled = true;
            shuffleBtn.textContent = 'Loading...';

            // Clear history when starting fresh shuffle
            playHistory = [];

            try {
                const params = new URLSearchParams({ model, count: 10 });
                if (keywords) params.set('search', keywords);

                const response = await fetch('/api/radio/shuffle?' + params.toString());
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                if (data.tracks && data.tracks.length > 0) {
                    radioQueue = data.tracks;
                    playNextTrack();
                    updateRadioQueue();
                } else {
                    const radioKeywords = document.getElementById('radio-keywords')?.value;
                    if (radioKeywords) {
                        showWarningToast('No tracks found for "' + radioKeywords + '" (try different keywords)');
                    } else {
                        showWarningToast('No tracks found. Generate some music first!');
                    }
                }
            } catch (err) {
                console.error('Radio shuffle failed:', err);
                showErrorToast('Failed to load tracks: ' + err.message);
            } finally {
                shuffleBtn.disabled = false;
                shuffleBtn.innerHTML = '<svg class="icon icon-sm" style="vertical-align: -2px; margin-right: 4px;"><use href="#icon-shuffle"/></svg>Shuffle Play';
            }
        }

        function playNextTrack() {
            if (radioQueue.length === 0) {
                nowPlayingEl.classList.add('hidden');
                radioQueueEl.classList.add('hidden');
                currentRadioTrack = null;
                return;
            }

            // Save current track to recently played (for "previous" button)
            if (currentRadioTrack) {
                recentlyPlayed.push(currentRadioTrack);
                // Keep only last 20 for previous functionality
                if (recentlyPlayed.length > 20) {
                    recentlyPlayed = recentlyPlayed.slice(-20);
                }
            }

            currentRadioTrack = radioQueue.shift();

            // Skip tracks with missing data
            if (!currentRadioTrack.filename || !currentRadioTrack.prompt) {
                console.warn('Skipping invalid track:', currentRadioTrack);
                playNextTrack();
                return;
            }

            // Add to play history (avoid repeats when fetching more)
            if (currentRadioTrack.id && !playHistory.includes(currentRadioTrack.id)) {
                playHistory.push(currentRadioTrack.id);
                // Trim history if too long
                if (playHistory.length > MAX_HISTORY) {
                    playHistory = playHistory.slice(-MAX_HISTORY);
                }
            }

            nowPlayingEl.classList.remove('hidden');

            // Update now playing display
            document.getElementById('radio-prompt').textContent = currentRadioTrack.prompt;
            document.getElementById('radio-duration').textContent = currentRadioTrack.duration + 's';
            document.getElementById('radio-upvotes').textContent = currentRadioTrack.upvotes || 0;
            document.getElementById('radio-downvotes').textContent = currentRadioTrack.downvotes || 0;

            // Reset vote button states
            document.getElementById('radio-vote-up').classList.remove('voted-up');
            document.getElementById('radio-vote-down').classList.remove('voted-down');

            // Load user's vote and favorite status for this track
            loadRadioTrackVote();
            checkRadioTrackFavorite();

            // Spectrogram element removed in redesign - EQ visualizer used instead
            const specImg = document.getElementById('radio-spectrogram');
            if (specImg) {
                if (currentRadioTrack.spectrogram) {
                    specImg.src = '/spectrogram/' + currentRadioTrack.spectrogram;
                    specImg.style.display = 'block';
                } else {
                    specImg.style.display = 'none';
                }
            }

            // Play the audio (auto-unmute if user had muted)
            autoUnmuteOnPlay();
            radioPlayer.src = '/audio/' + currentRadioTrack.filename;
            radioPlayer.play();

            updateRadioQueue();

            // Auto-fetch more tracks if queue is running low
            if (radioQueue.length < MIN_QUEUE_SIZE) {
                fetchMoreTracks();
            }
        }

        async function fetchMoreTracks() {
            if (isFetchingMore) return;  // Already fetching
            isFetchingMore = true;

            try {
                const model = document.getElementById('radio-model').value;
                const keywords = document.getElementById('radio-keywords').value.trim();

                // Build exclude list from history + current queue
                const excludeIds = [
                    ...playHistory,
                    ...radioQueue.map(t => t.id).filter(Boolean)
                ];

                const params = new URLSearchParams({ model, count: 5 });
                if (keywords) params.set('search', keywords);
                if (excludeIds.length > 0) {
                    params.set('exclude', excludeIds.join(','));
                }

                const response = await fetch('/api/radio/next?' + params.toString());
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                if (data.tracks && data.tracks.length > 0) {
                    // Add new tracks to queue
                    radioQueue.push(...data.tracks);
                    updateRadioQueue();
                    console.log(`[Radio] Added ${data.tracks.length} more tracks to queue`);
                }
            } catch (err) {
                console.error('Failed to fetch more tracks:', err);
            } finally {
                isFetchingMore = false;
            }
        }

        let currentRadioVote = 0;

        async function loadRadioTrackVote() {
            if (!currentRadioTrack) return;
            const voterId = getEffectiveUserId();
            try {
                const response = await fetch('/api/library/votes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ generation_ids: [currentRadioTrack.id], user_id: voterId })
                });
                const data = await response.json();
                currentRadioVote = data.votes?.[currentRadioTrack.id] || 0;
                document.getElementById('radio-vote-up').classList.toggle('voted-up', currentRadioVote === 1);
                document.getElementById('radio-vote-down').classList.toggle('voted-down', currentRadioVote === -1);
            } catch (err) {
                console.error('Failed to load radio track vote:', err);
            }
        }

        async function voteRadioTrack(voteValue) {
            if (!currentRadioTrack) return;
            const voterId = getEffectiveUserId();

            // Toggle vote if clicking same button
            const newVote = currentRadioVote === voteValue ? 0 : voteValue;

            try {
                const response = await fetch(`/api/library/${currentRadioTrack.id}/vote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ vote: newVote, user_id: voterId })
                });
                const data = await response.json();

                currentRadioVote = data.user_vote;
                document.getElementById('radio-upvotes').textContent = data.upvotes;
                document.getElementById('radio-downvotes').textContent = data.downvotes;
                document.getElementById('radio-vote-up').classList.toggle('voted-up', data.user_vote === 1);
                document.getElementById('radio-vote-down').classList.toggle('voted-down', data.user_vote === -1);

                // If downvoted, skip to next track after a moment
                if (newVote === -1) {
                    showFeedbackToast('Skipping...');
                    setTimeout(() => skipTrack(), 800);
                }
            } catch (err) {
                console.error('Radio vote failed:', err);
            }
        }

        // ========================================
        // DOWNLOAD
        // ========================================
        function downloadCurrentTrack() {
            if (!currentRadioTrack) {
                showErrorToast('No track to download');
                return;
            }
            const filename = currentRadioTrack.filename;
            const a = document.createElement('a');
            a.href = `/download/${filename}`;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showFeedbackToast('Downloading...');
        }

        function tagCurrentTrack() {
            if (!currentRadioTrack) {
                showErrorToast('No track to tag');
                return;
            }
            showTagSuggestionModal(currentRadioTrack);
        }

        function downloadTrack(filename) {
            const a = document.createElement('a');
            a.href = `/download/${filename}`;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showFeedbackToast('Downloading...');
        }

        // ========================================
        // FAVORITES
        // ========================================
        let isCurrentTrackFavorited = false;

        async function toggleRadioFavorite() {
            if (!currentRadioTrack) return;
            const userId = getEffectiveUserId();
            const btn = document.getElementById('radio-favorite-btn');

            try {
                const method = isCurrentTrackFavorited ? 'DELETE' : 'POST';
                const response = await fetch(`/api/favorites/${currentRadioTrack.id}`, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });
                const data = await response.json();

                if (data.success) {
                    isCurrentTrackFavorited = data.favorited;
                    updateFavoriteButton();
                    showFeedbackToast(data.favorited ? 'Added to favorites' : 'Removed from favorites');
                }
            } catch (err) {
                console.error('Favorite toggle failed:', err);
                showFeedbackToast('Failed to update favorites', 'error');
            }
        }

        function updateFavoriteButton() {
            const btn = document.getElementById('radio-favorite-btn');
            const iconUse = btn.querySelector('use');
            btn.classList.toggle('favorited', isCurrentTrackFavorited);
            if (iconUse) {
                iconUse.setAttribute('href', isCurrentTrackFavorited ? '#icon-heart' : '#icon-heart-outline');
            }
            btn.title = isCurrentTrackFavorited ? 'Remove from favorites' : 'Add to favorites';
        }

        async function checkRadioTrackFavorite() {
            if (!currentRadioTrack) return;
            const userId = getEffectiveUserId();

            try {
                const response = await fetch('/api/favorites/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        generation_ids: [currentRadioTrack.id]
                    })
                });
                const data = await response.json();
                isCurrentTrackFavorited = data.favorites?.includes(currentRadioTrack.id) || false;
                updateFavoriteButton();
            } catch (err) {
                console.error('Favorite check failed:', err);
            }
        }

        async function playFavorites() {
            const model = document.getElementById('radio-model').value;
            const userId = getEffectiveUserId();

            try {
                const params = new URLSearchParams({
                    user_id: userId,
                    model: model,
                    count: 10
                });

                const response = await fetch('/api/radio/favorites?' + params.toString());
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                if (data.tracks && data.tracks.length > 0) {
                    // Only clear history and start playing if we have tracks
                    playHistory = [];
                    radioQueue = data.tracks;
                    playNextTrack();
                    updateRadioQueue();
                    showFeedbackToast('Playing your favorites');
                } else {
                    // Don't modify anything - just show a message
                    showWarningToast('No favorites yet! Use the heart button to save tracks.');
                }
            } catch (err) {
                console.error('Play favorites failed:', err);
                showFeedbackToast('Failed to load favorites: ' + err.message, 'error');
            }
        }

        // Current active station
        let currentStation = null;

        // Station preset handler
        async function startStation(stationId, element) {
            const model = document.getElementById('radio-model').value;
            const userId = getEffectiveUserId();

            // Update active state
            document.querySelectorAll('.station-card').forEach(card => card.classList.remove('active'));
            if (element) element.classList.add('active');
            currentStation = stationId;

            // Clear featured button states
            document.querySelectorAll('.featured-btn').forEach(btn => btn.classList.remove('active'));

            playHistory = [];

            try {
                let response;

                if (stationId === 'favorites') {
                    // Play favorites
                    const params = new URLSearchParams({
                        user_id: userId,
                        model: model,
                        count: 10
                    });
                    response = await fetch('/api/radio/favorites?' + params.toString());
                } else {
                    // Regular station - use keywords from data attribute
                    const keywords = element ? element.dataset.keywords : '';
                    const params = new URLSearchParams({ model, count: 10 });
                    if (keywords) params.set('search', keywords);

                    // Also update the hidden keywords input
                    document.getElementById('radio-keywords').value = keywords;

                    response = await fetch('/api/radio/shuffle?' + params.toString());
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                if (data.tracks && data.tracks.length > 0) {
                    radioQueue = data.tracks;
                    playNextTrack();
                    updateRadioQueue();
                } else {
                    if (stationId === 'favorites') {
                        showWarningToast('No favorites yet! Use the heart button to save tracks.');
                    } else {
                        showWarningToast('No tracks found for this station');
                    }
                }
            } catch (err) {
                console.error('Station start failed:', err);
                showErrorToast('Failed to load station: ' + err.message);
            }
        }

        // Play top rated tracks
        async function playTopRated(btn) {
            const model = document.getElementById('radio-model').value;

            // Update button states
            document.querySelectorAll('.featured-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.station-card').forEach(card => card.classList.remove('active'));
            if (btn) btn.classList.add('active');
            currentStation = 'top-rated';

            playHistory = [];

            try {
                const params = new URLSearchParams({ model, count: 10 });
                const response = await fetch('/api/radio/top-rated?' + params.toString());

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                if (data.tracks && data.tracks.length > 0) {
                    radioQueue = data.tracks;
                    playNextTrack();
                    updateRadioQueue();
                    showFeedbackToast('Playing top rated tracks');
                } else {
                    showWarningToast('No rated tracks yet. Vote on some tracks first!');
                }
            } catch (err) {
                console.error('Top rated failed:', err);
                showErrorToast('Failed to load top rated: ' + err.message);
            }
        }

        // Play new arrivals
        async function playNewArrivals(btn) {
            const model = document.getElementById('radio-model').value;

            // Update button states
            document.querySelectorAll('.featured-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.station-card').forEach(card => card.classList.remove('active'));
            if (btn) btn.classList.add('active');
            currentStation = 'new';

            playHistory = [];

            try {
                const params = new URLSearchParams({ model, count: 10, hours: 168 }); // Last week
                const response = await fetch('/api/radio/new?' + params.toString());

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                if (data.tracks && data.tracks.length > 0) {
                    radioQueue = data.tracks;
                    playNextTrack();
                    updateRadioQueue();
                    showFeedbackToast('Playing new arrivals');
                } else {
                    showWarningToast('No new tracks this week. Generate some!');
                }
            } catch (err) {
                console.error('New arrivals failed:', err);
                showErrorToast('Failed to load new arrivals: ' + err.message);
            }
        }

        // Surprise me - random shuffle
        async function playSurpriseMe(btn) {
            const model = document.getElementById('radio-model').value;

            // Update button states
            document.querySelectorAll('.featured-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.station-card').forEach(card => card.classList.remove('active'));
            if (btn) btn.classList.add('active');
            currentStation = 'surprise';

            // Clear keywords for true random
            document.getElementById('radio-keywords').value = '';
            playHistory = [];

            try {
                const params = new URLSearchParams({ model, count: 10 });
                const response = await fetch('/api/radio/shuffle?' + params.toString());

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                if (data.tracks && data.tracks.length > 0) {
                    radioQueue = data.tracks;
                    playNextTrack();
                    updateRadioQueue();
                    showFeedbackToast('Surprise!');
                } else {
                    showWarningToast('No tracks found. Generate some music first!');
                }
            } catch (err) {
                console.error('Surprise me failed:', err);
                showErrorToast('Failed to load tracks: ' + err.message);
            }
        }

        // Remove track from queue
        function removeFromQueue(index) {
            if (index >= 0 && index < radioQueue.length) {
                radioQueue.splice(index, 1);
                updateRadioQueue();
            }
        }

        // Model-specific feedback categories
        const FEEDBACK_CATEGORIES = {
            music: {
                positive: [
                    { id: 'catchy', label: 'Catchy/memorable' },
                    { id: 'quality', label: 'Great quality' },
                    { id: 'creative', label: 'Creative/unique' },
                    { id: 'matches', label: 'Matches prompt' },
                    { id: 'mood', label: 'Great vibe' },
                    { id: 'relaxing', label: 'Relaxing/calming' },
                    { id: 'loops_well', label: 'Loops perfectly' },
                    { id: 'useful', label: 'Perfect for games' }
                ],
                negative: [
                    { id: 'wrong_mood', label: 'Wrong mood/tone' },
                    { id: 'too_repetitive', label: 'Too repetitive' },
                    { id: 'bad_loop', label: 'Bad loop point' },
                    { id: 'too_busy', label: 'Too busy/complex' },
                    { id: 'too_simple', label: 'Too simple/boring' },
                    { id: 'jarring', label: 'Jarring transitions' },
                    { id: 'low_quality', label: 'Low quality' }
                ]
            },
            audio: {
                positive: [
                    { id: 'clear', label: 'Clear/crisp' },
                    { id: 'quality', label: 'Great quality' },
                    { id: 'creative', label: 'Creative/unique' },
                    { id: 'matches', label: 'Matches prompt' },
                    { id: 'satisfying', label: 'Satisfying' },
                    { id: 'cute', label: 'Cute/charming' },
                    { id: 'useful', label: 'Perfect for games' }
                ],
                negative: [
                    { id: 'wrong_type', label: 'Wrong sound type' },
                    { id: 'too_long', label: 'Too long' },
                    { id: 'too_short', label: 'Too short' },
                    { id: 'distorted', label: 'Distorted/glitchy' },
                    { id: 'bad_volume', label: 'Too quiet/loud' },
                    { id: 'annoying', label: 'Annoying' },
                    { id: 'low_quality', label: 'Low quality' }
                ]
            }
        };

        // ========================================
        // FEEDBACK MODAL SYSTEM
        // ========================================
        let feedbackModalState = {
            track: null,          // { id, prompt, model }
            isPositive: true,
            selectedReasons: [],
            suggestedModel: null,
            source: 'radio'       // 'radio' or 'library'
        };

        function openFeedbackModal(track, isPositive, source = 'radio') {
            feedbackModalState = {
                track,
                isPositive,
                selectedReasons: [],
                suggestedModel: null,
                source
            };

            const model = track.model || 'music';
            const categories = FEEDBACK_CATEGORIES[model] || FEEDBACK_CATEGORIES.music;
            const options = isPositive ? categories.positive : categories.negative;

            // Update modal container class for positive/negative styling
            const modalContainer = document.getElementById('feedback-modal-container');
            modalContainer.classList.remove('positive', 'negative');
            modalContainer.classList.add(isPositive ? 'positive' : 'negative');

            // Generate floating particles
            generateFeedbackParticles(isPositive);

            // Update modal title
            const titleEl = document.getElementById('feedback-modal-title');
            titleEl.innerHTML = isPositive
                ? '<svg class="icon icon-sm" style="vertical-align: -2px; margin-right: 4px;"><use href="#icon-thumb-up"/></svg>What do you like?'
                : '<svg class="icon icon-sm" style="vertical-align: -2px; margin-right: 4px;"><use href="#icon-thumb-down"/></svg>What\'s wrong?';
            titleEl.className = 'feedback-modal-title ' + (isPositive ? 'positive' : 'negative');

            // Update track info
            document.getElementById('feedback-modal-badge').innerHTML = `<svg class="icon icon-sm" style="vertical-align: -2px;"><use href="${model === 'music' ? '#icon-music' : '#icon-volume'}"/></svg>`;
            document.getElementById('feedback-modal-prompt').textContent = track.prompt;

            // Update label
            document.getElementById('feedback-modal-label').textContent = isPositive
                ? 'Select what you like (can pick multiple):'
                : 'Select issues (can pick multiple):';

            // Populate feedback options
            const optionsContainer = document.getElementById('feedback-modal-options');
            optionsContainer.innerHTML = options.map(opt =>
                `<button class="feedback-tag ${isPositive ? 'positive' : ''}" data-id="${opt.id}" onclick="toggleModalFeedbackTag('${opt.id}')">${opt.label}</button>`
            ).join('');

            // Populate reclassify option
            const reclassifyContainer = document.getElementById('feedback-modal-reclassify');
            const oppositeModel = model === 'music' ? 'audio' : 'music';
            const oppositeIcon = model === 'music' ? '#icon-volume' : '#icon-music';
            const oppositeLabel = `<svg class="icon icon-sm" style="vertical-align: -2px; margin-right: 4px;"><use href="${oppositeIcon}"/></svg>${model === 'music' ? 'This is actually a sound effect' : 'This is actually music'}`;
            reclassifyContainer.innerHTML =
                `<button class="reclassify-option" data-model="${oppositeModel}" onclick="toggleModalReclassify('${oppositeModel}')">${oppositeLabel}</button>`;

            // Update submit button
            const submitBtn = document.getElementById('feedback-modal-submit');
            submitBtn.className = 'feedback-modal-submit' + (isPositive ? ' positive' : '');
            submitBtn.disabled = true;

            // Show modal
            document.getElementById('feedback-modal-overlay').classList.remove('hidden');
        }

        function generateFeedbackParticles(isPositive) {
            const container = document.getElementById('feedback-particles');
            container.innerHTML = '';

            const colors = isPositive
                ? ['#10b981', '#34d399', '#6ee7b7', '#a7f3d0']
                : ['#ef4444', '#f97316', '#fb923c', '#fcd34d'];

            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'feedback-particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.animationDelay = (Math.random() * 4) + 's';
                particle.style.animationDuration = (3 + Math.random() * 3) + 's';
                particle.style.width = (4 + Math.random() * 8) + 'px';
                particle.style.height = particle.style.width;
                particle.style.opacity = 0.4 + Math.random() * 0.4;
                container.appendChild(particle);
            }
        }

        function closeFeedbackModal(event) {
            // If event is passed and it's from overlay click, only close if clicking the overlay itself
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('feedback-modal-overlay').classList.add('hidden');
            feedbackModalState = { track: null, isPositive: true, selectedReasons: [], suggestedModel: null, source: 'radio' };
        }

        function toggleModalFeedbackTag(tagId) {
            const idx = feedbackModalState.selectedReasons.indexOf(tagId);
            if (idx === -1) {
                feedbackModalState.selectedReasons.push(tagId);
            } else {
                feedbackModalState.selectedReasons.splice(idx, 1);
            }

            // Update visual state
            document.querySelectorAll('#feedback-modal-options .feedback-tag').forEach(tag => {
                tag.classList.toggle('selected', feedbackModalState.selectedReasons.includes(tag.dataset.id));
            });

            updateModalSubmitButton();
        }

        function toggleModalReclassify(model) {
            feedbackModalState.suggestedModel = feedbackModalState.suggestedModel === model ? null : model;

            // Update visual state
            document.querySelectorAll('#feedback-modal-reclassify .reclassify-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.model === feedbackModalState.suggestedModel);
            });

            updateModalSubmitButton();
        }

        function updateModalSubmitButton() {
            const hasSelection = feedbackModalState.selectedReasons.length > 0 || feedbackModalState.suggestedModel;
            document.getElementById('feedback-modal-submit').disabled = !hasSelection;
        }

        async function submitFeedbackModal() {
            if (!feedbackModalState.track) return;

            const voterId = getEffectiveUserId();
            const voteValue = feedbackModalState.isPositive ? 1 : -1;
            const genId = feedbackModalState.track.id;

            try {
                const response = await fetch(`/api/library/${genId}/vote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        vote: voteValue,
                        user_id: voterId,
                        feedback_reasons: feedbackModalState.selectedReasons.length > 0 ? feedbackModalState.selectedReasons : null,
                        suggested_model: feedbackModalState.suggestedModel
                    })
                });
                const data = await response.json();

                // Update UI based on source
                if (feedbackModalState.source === 'radio') {
                    currentRadioVote = voteValue;
                    document.getElementById('radio-upvotes').textContent = data.upvotes;
                    document.getElementById('radio-downvotes').textContent = data.downvotes;
                    document.getElementById('radio-vote-up').classList.toggle('voted-up', voteValue === 1);
                    document.getElementById('radio-vote-down').classList.toggle('voted-down', voteValue === -1);
                } else {
                    // Library item
                    userVotes[genId] = voteValue;
                    const item = document.querySelector(`[data-id="${genId}"]`);
                    if (item) {
                        const upBtn = item.querySelector('.vote-btn:first-child');
                        const downBtn = item.querySelector('.vote-btn:nth-child(2)');
                        upBtn.classList.toggle('voted-up', voteValue === 1);
                        downBtn.classList.toggle('voted-down', voteValue === -1);
                        upBtn.querySelector('.vote-count').textContent = data.upvotes;
                        downBtn.querySelector('.vote-count').textContent = data.downvotes;
                    }
                }

                // Show toast
                const reasonCount = feedbackModalState.selectedReasons.length;
                const reclassifyMsg = feedbackModalState.suggestedModel ? ' + reclassify' : '';
                showFeedbackToast(`Thanks for the feedback! (${reasonCount} tag${reasonCount !== 1 ? 's' : ''}${reclassifyMsg})`);

                // Close modal
                closeFeedbackModal();

                // Skip track if downvoted in radio
                if (feedbackModalState.source === 'radio' && !feedbackModalState.isPositive) {
                    setTimeout(() => skipTrack(), 500);
                }

            } catch (err) {
                console.error('Feedback failed:', err);
                showErrorToast('Failed to submit feedback: ' + err.message);
            }
        }

        // Radio feedback shortcuts
        function showPositiveFeedbackMenu() {
            if (!currentRadioTrack) return;
            openFeedbackModal(currentRadioTrack, true, 'radio');
        }

        function showFeedbackMenu() {
            if (!currentRadioTrack) return;
            openFeedbackModal(currentRadioTrack, false, 'radio');
        }

        function skipTrack() {
            playNextTrack();
        }

        function playPreviousTrack() {
            // Need at least one track in history to go back
            if (recentlyPlayed.length === 0) {
                showWarningToast('No previous tracks');
                return;
            }

            // If we have a current track, put it back at the front of the queue
            if (currentRadioTrack) {
                radioQueue.unshift(currentRadioTrack);
            }

            // Get the previous track from history
            const previousTrack = recentlyPlayed.pop();

            // Play it
            currentRadioTrack = previousTrack;

            // Update UI
            document.getElementById('radio-prompt').textContent = currentRadioTrack.prompt;
            document.getElementById('radio-duration').textContent = currentRadioTrack.duration + 's';
            document.getElementById('radio-upvotes').textContent = currentRadioTrack.upvotes || 0;
            document.getElementById('radio-downvotes').textContent = currentRadioTrack.downvotes || 0;

            // Reset vote button states
            document.getElementById('radio-vote-up').classList.remove('voted-up');
            document.getElementById('radio-vote-down').classList.remove('voted-down');

            nowPlayingEl.classList.remove('hidden');

            // Load vote and favorite status
            loadRadioTrackVote();
            checkRadioTrackFavorite();

            // Play the audio (auto-unmute if user had muted)
            autoUnmuteOnPlay();
            radioPlayer.src = '/audio/' + currentRadioTrack.filename;
            radioPlayer.play();

            updateRadioQueue();
        }

        function setRadioFilter(keywords, btn) {
            document.getElementById('radio-keywords').value = keywords;
            // Update active state on chips
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            if (btn) btn.classList.add('active');
            // Auto-shuffle when filter is clicked
            shuffleRadio();
        }

        function updateRadioQueue() {
            const queueCountBadge = document.getElementById('queue-count-badge');

            if (radioQueue.length === 0) {
                radioQueueEl.classList.add('hidden');
                if (queueCountBadge) queueCountBadge.textContent = '0';
                return;
            }

            radioQueueEl.classList.remove('hidden');
            if (queueCountBadge) queueCountBadge.textContent = radioQueue.length;

            queueItemsEl.innerHTML = radioQueue.slice(0, 5).map((track, i) => `
                <div class="queue-item">
                    <span class="queue-num">${i + 1}</span>
                    <span class="queue-prompt">${escapeHtml(track.prompt)}</span>
                    <span class="queue-duration">${track.duration}s</span>
                    <button class="queue-remove" onclick="removeFromQueue(${i})" title="Remove from queue"></button>
                </div>
            `).join('');
        }

        // EQ Visualizer play/pause handler
        function updateEqVisualizer(isPlaying) {
            const eq = document.getElementById('eq-visualizer');
            if (eq) {
                if (isPlaying) {
                    eq.classList.remove('paused');
                } else {
                    eq.classList.add('paused');
                }
            }
        }

        // Auto-advance when track ends
        if (radioPlayer) {
            radioPlayer.addEventListener('ended', playNextTrack);

            // EQ visualizer responds to play/pause
            radioPlayer.addEventListener('play', () => updateEqVisualizer(true));
            radioPlayer.addEventListener('pause', () => updateEqVisualizer(false));
            radioPlayer.addEventListener('ended', () => updateEqVisualizer(false));
        }

        // ========================================
        // LIBRARY VIEW
        // ========================================
        let libraryPage = 1;
        let libraryTotal = 0;
        let libraryPages = 1;
        let userVotes = {};
        let userFavorites = new Set();
        let searchDebounceTimer = null;

        const libraryItemsEl = document.getElementById('library-items');
        const librarySearchEl = document.getElementById('library-search');
        const libraryModelEl = document.getElementById('library-model');
        const librarySortEl = document.getElementById('library-sort');
        const paginationEl = document.getElementById('pagination');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const pageInfoEl = document.getElementById('page-info');
        const pageNumbersEl = document.getElementById('page-numbers');
        const libraryTotalEl = document.getElementById('library-total');

        function renderPageNumbers(currentPage, totalPages) {
            if (!pageNumbersEl || totalPages <= 1) {
                if (pageNumbersEl) pageNumbersEl.innerHTML = '';
                return;
            }

            const pages = [];
            const maxVisible = 5;

            // Always show first page
            pages.push(1);

            // Calculate range around current page
            let start = Math.max(2, currentPage - 1);
            let end = Math.min(totalPages - 1, currentPage + 1);

            // Adjust range if at edges
            if (currentPage <= 3) {
                end = Math.min(totalPages - 1, maxVisible - 1);
            } else if (currentPage >= totalPages - 2) {
                start = Math.max(2, totalPages - maxVisible + 2);
            }

            // Add ellipsis before middle pages if needed
            if (start > 2) pages.push('...');

            // Add middle pages
            for (let i = start; i <= end; i++) {
                pages.push(i);
            }

            // Add ellipsis after middle pages if needed
            if (end < totalPages - 1) pages.push('...');

            // Always show last page if more than 1 page
            if (totalPages > 1) pages.push(totalPages);

            // Render
            pageNumbersEl.innerHTML = pages.map(p => {
                if (p === '...') {
                    return '<span class="page-ellipsis">...</span>';
                }
                const activeClass = p === currentPage ? ' active' : '';
                return `<button class="page-btn${activeClass}" onclick="goToPage(${p})">${p}</button>`;
            }).join('');
        }

        function goToPage(page) {
            libraryPage = page;
            loadLibrary();
            document.querySelector('.library-card')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        async function loadLibrary() {
            const model = libraryModelEl.value;
            const search = librarySearchEl.value.trim();

            // Handle favorites view separately
            if (model === 'favorites' || currentQuickFilter === 'favorites') {
                await loadFavoritesLibrary();
                return;
            }

            const params = new URLSearchParams({
                page: libraryPage,
                per_page: 10,
                sort: librarySortEl.value
            });

            // Use currentCategory if set by type tabs, otherwise use model dropdown
            const effectiveModel = currentCategory || model;
            if (effectiveModel) params.set('model', effectiveModel);
            if (search) params.set('search', search);

            // Add category filter if a genre is selected
            if (currentSubcategory) {
                params.set('category', currentSubcategory);
            }

            try {
                const response = await fetch('/api/library?' + params.toString());
                const data = await response.json();

                libraryTotal = data.total;
                libraryPages = data.pages;

                libraryTotalEl.textContent = `(${libraryTotal} total)`;
                pageInfoEl.textContent = `Page ${data.page} of ${libraryPages || 1}`;
                prevPageBtn.disabled = data.page <= 1;
                nextPageBtn.disabled = data.page >= libraryPages;
                renderPageNumbers(data.page, libraryPages);

                if (data.items.length === 0) {
                    let emptyMessage = '';
                    if (search) {
                        emptyMessage = `
                            <div class="library-empty">
                                <svg class="empty-icon"><use href="#icon-search"/></svg>
                                <h3>No tracks found</h3>
                                <p>No results for "<strong>${escapeHtml(search)}</strong>". Try different keywords.</p>
                            </div>
                        `;
                    } else if (model) {
                        emptyMessage = `
                            <div class="library-empty">
                                <svg class="empty-icon"><use href="${model === 'music' ? '#icon-music' : '#icon-volume'}"/></svg>
                                <h3>No ${model === 'music' ? 'music' : 'sound effects'} yet</h3>
                                <p>Generate some using the Generate tab!</p>
                            </div>
                        `;
                    } else {
                        emptyMessage = `
                            <div class="library-empty">
                                <svg class="empty-icon"><use href="#icon-wand"/></svg>
                                <h3>Welcome to Sound Box!</h3>
                                <p>Generate your first track using the Generate tab</p>
                            </div>
                        `;
                    }
                    libraryItemsEl.innerHTML = `
                        <div style="text-align: center; color: var(--text-muted); padding: 40px;">
                            ${emptyMessage}
                        </div>
                    `;
                    return;
                }

                // Get user votes and favorites for these items
                const ids = data.items.map(item => item.id);
                await Promise.all([loadUserVotes(ids), loadUserFavorites(ids)]);

                libraryItemsEl.innerHTML = data.items.map(item => renderLibraryItem(item)).join('');

            } catch (err) {
                console.error('Library load failed:', err);
                libraryItemsEl.innerHTML = `
                    <div style="text-align: center; color: var(--error); padding: 20px;">
                        Failed to load library
                    </div>
                `;
            }
        }

        async function loadFavoritesLibrary() {
            const userId = getEffectiveUserId();
            const params = new URLSearchParams({
                user_id: userId,
                page: libraryPage,
                per_page: 10
            });

            try {
                const response = await fetch('/api/favorites?' + params.toString());
                const data = await response.json();

                libraryTotal = data.total;
                libraryPages = data.pages;

                libraryTotalEl.textContent = `(${libraryTotal} favorites)`;
                pageInfoEl.textContent = `Page ${data.page} of ${libraryPages || 1}`;
                prevPageBtn.disabled = data.page <= 1;
                nextPageBtn.disabled = data.page >= libraryPages;
                renderPageNumbers(data.page, libraryPages);

                if (data.items.length === 0) {
                    libraryItemsEl.innerHTML = `
                        <div class="library-empty">
                            <svg class="empty-icon"><use href="#icon-heart"/></svg>
                            <h3>No favorites yet</h3>
                            <p>Use the heart button on tracks to save them here</p>
                        </div>
                    `;
                    return;
                }

                // Get user votes for these items
                const ids = data.items.map(item => item.id);
                await loadUserVotes(ids);

                // Mark all items as favorited (since they're from favorites)
                libraryItemsEl.innerHTML = data.items.map(item => renderLibraryItem(item, true)).join('');

            } catch (err) {
                console.error('Favorites load failed:', err);
                libraryItemsEl.innerHTML = `
                    <div style="text-align: center; color: var(--error); padding: 20px;">
                        Failed to load favorites
                    </div>
                `;
            }
        }

        async function loadUserVotes(generationIds) {
            const voterId = getEffectiveUserId();
            try {
                const response = await fetch('/api/library/votes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ generation_ids: generationIds, user_id: voterId })
                });
                const data = await response.json();
                userVotes = data.votes || {};
            } catch (err) {
                console.error('Failed to load votes:', err);
            }
        }

        async function loadUserFavorites(generationIds) {
            const userId = getEffectiveUserId();
            try {
                const response = await fetch('/api/favorites/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, generation_ids: generationIds })
                });
                if (response.ok) {
                    const data = await response.json();
                    userFavorites = new Set(data.favorites || []);
                }
            } catch (err) {
                console.error('Failed to load favorites:', err);
            }
        }

        // Store library items data for modal access
        let libraryItemsData = {};

        // Library view mode
        let libraryViewMode = 'list';

        function setLibraryView(mode) {
            libraryViewMode = mode;
            const container = document.getElementById('library-items');
            const toggleBtns = document.querySelectorAll('.view-toggle-btn');

            toggleBtns.forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.view-toggle-btn[onclick*="${mode}"]`)?.classList.add('active');

            if (mode === 'grid') {
                container.classList.add('grid-view');
            } else {
                container.classList.remove('grid-view');
            }
        }

        // Category state
        let currentCategory = '';
        let currentSubcategory = '';

        function setLibraryFilter(filter) {
            selectCategory(filter, '');
        }

        function selectCategory(category, subcategory) {
            currentCategory = category;
            currentSubcategory = subcategory;

            // Update hidden dropdown for backend compatibility
            const modelSelect = document.getElementById('library-model');
            modelSelect.value = category === 'favorites' ? 'favorites' : (category || '');

            // Update active states in sidebar
            document.querySelectorAll('.category-item').forEach(item => {
                const cat = item.dataset.category;
                const subcat = item.dataset.subcategory;
                item.classList.toggle('active', cat === category && (!subcategory || subcat === subcategory));
            });

            document.querySelectorAll('.subcategory-item').forEach(item => item.classList.remove('active'));

            // Update search placeholder based on category
            const searchInput = document.getElementById('library-search');
            if (category === 'music') {
                searchInput.placeholder = subcategory
                    ? `Search ${subcategory} music...`
                    : 'Search music tracks...';
            } else if (category === 'audio') {
                searchInput.placeholder = subcategory
                    ? `Search ${subcategory} sound effects...`
                    : 'Search sound effects...';
            } else if (category === 'favorites') {
                searchInput.placeholder = 'Search your favorites...';
            } else {
                searchInput.placeholder = 'Search music, sound effects, prompts...';
            }

            // Close mobile sidebar if open
            document.getElementById('category-sidebar')?.classList.remove('mobile-open');

            // Reload library with new filter
            libraryPage = 1;
            loadLibrary();
        }

        function toggleSubcategories(element, subcatId) {
            const subcat = document.getElementById('sub-' + subcatId);
            const expand = element.querySelector('.category-expand');

            if (subcat) {
                subcat.classList.toggle('expanded');
                expand?.classList.toggle('expanded');
            }
        }

        function toggleMobileCategories() {
            const sidebar = document.getElementById('category-sidebar');
            sidebar?.classList.toggle('mobile-open');
        }

        // Current type filter state
        let currentTypeTab = 'all';
        let currentGenre = '';
        let currentQuickFilter = '';

        function selectTypeTab(type) {
            currentTypeTab = type;
            currentGenre = '';
            currentQuickFilter = '';

            // Update tab active states
            document.querySelectorAll('.type-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.type === type);
            });

            // Update sidebar data attribute to control genre visibility
            document.getElementById('category-sidebar').dataset.type = type;

            // Clear genre selection
            document.querySelectorAll('.genre-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.quick-filter-btn').forEach(btn => btn.classList.remove('active'));

            // Update category for filtering
            if (type === 'all') {
                currentCategory = '';
            } else {
                currentCategory = type;
            }
            currentSubcategory = '';

            // Update search placeholder
            updateSearchPlaceholder();
            updateClearFilterButton();

            // Reload library
            libraryPage = 1;
            loadLibrary();
        }

        // Toggle collapsible genre groups
        function toggleGenreGroup(headerEl) {
            const groupEl = headerEl.closest('.genre-group');
            if (groupEl) {
                groupEl.classList.toggle('collapsed');
            }
        }

        function selectGenre(genre) {
            currentGenre = genre;
            currentQuickFilter = '';

            // Update genre active states
            document.querySelectorAll('.genre-item').forEach(item => {
                item.classList.toggle('active', item.dataset.genre === genre);
            });
            document.querySelectorAll('.quick-filter-btn').forEach(btn => btn.classList.remove('active'));

            // Map genre to category/subcategory
            const musicGenres = ['ambient', 'electronic', 'cinematic', 'acoustic', 'lofi', 'upbeat', 'retro'];
            const sfxGenres = ['nature', 'mechanical', 'human', 'fantasy', 'ui', 'impacts', 'whoosh'];

            if (musicGenres.includes(genre)) {
                currentCategory = 'music';
                currentSubcategory = genre;
            } else if (sfxGenres.includes(genre)) {
                currentCategory = 'audio';
                currentSubcategory = genre;
            }

            updateSearchPlaceholder();
            updateClearFilterButton();

            libraryPage = 1;
            loadLibrary();
        }

        function selectQuickFilter(filter) {
            currentQuickFilter = filter;
            currentGenre = '';

            // Update active states
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            document.querySelectorAll('.genre-item').forEach(item => item.classList.remove('active'));

            if (filter === 'favorites') {
                currentCategory = 'favorites';
                currentSubcategory = '';
            } else if (filter === 'recent') {
                currentCategory = '';
                currentSubcategory = '';
                // Recent sorting would be handled in library load
            }

            updateSearchPlaceholder();
            updateClearFilterButton();

            libraryPage = 1;
            loadLibrary();
        }

        function clearAllFilters() {
            currentTypeTab = 'all';
            currentGenre = '';
            currentQuickFilter = '';
            currentCategory = '';
            currentSubcategory = '';

            // Clear search box
            const searchInput = document.getElementById('library-search');
            if (searchInput) searchInput.value = '';

            // Reset all active states
            document.querySelectorAll('.genre-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.quick-filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('category-sidebar').dataset.type = 'all';

            updateSearchPlaceholder();
            updateClearFilterButton();

            libraryPage = 1;
            loadLibrary();
        }

        function updateSearchPlaceholder() {
            const searchInput = document.getElementById('library-search');
            if (currentQuickFilter === 'favorites') {
                searchInput.placeholder = 'Search your favorites...';
            } else if (currentGenre) {
                searchInput.placeholder = `Search ${currentGenre} sounds...`;
            } else if (currentTypeTab === 'music') {
                searchInput.placeholder = 'Search music tracks...';
            } else if (currentTypeTab === 'audio') {
                searchInput.placeholder = 'Search sound effects...';
            } else {
                searchInput.placeholder = 'Search music, sound effects, prompts...';
            }
        }

        function updateClearFilterButton() {
            const btn = document.getElementById('clear-filter-btn');
            const searchInput = document.getElementById('library-search');
            const hasSearch = searchInput && searchInput.value.trim().length > 0;
            const hasFilters = currentGenre || currentQuickFilter || hasSearch;
            btn.style.display = hasFilters ? 'flex' : 'none';
        }

        async function loadCategoryCounts() {
            try {

                // Get per-category/genre counts
                const catResponse = await fetch('/api/library/category-counts');
                if (catResponse.ok) {
                    const counts = await catResponse.json();
                    // Update each genre item count badge
                    document.querySelectorAll('.genre-item').forEach(item => {
                        const genre = item.dataset.genre;
                        const countEl = item.querySelector('.genre-count');
                        if (countEl && counts[genre] !== undefined) {
                            countEl.textContent = counts[genre];
                        }
                    });
                }
            } catch (err) {
                console.error('Failed to load category counts:', err);
            }
        }

        function renderLibraryItem(item) {
            // Store item data for modal access
            libraryItemsData[item.id] = item;

            const userVote = userVotes[item.id] || 0;
            const upClass = userVote === 1 ? 'voted' : '';
            const downClass = userVote === -1 ? 'voted' : '';
            const isFavorited = userFavorites && userFavorites.has ? userFavorites.has(item.id) : false;
            const favClass = isFavorited ? 'favorited' : '';
            const favIcon = isFavorited ? '#icon-heart' : '#icon-heart-outline';

            // Only show "View Feedback" button to adult accounts
            const viewFeedbackBtn = isAdultAccount
                ? `<button class="comments-btn" onclick="viewFeedback('${item.id}')" title="View feedback">
                    <svg class="icon"><use href="#icon-library"/></svg> Feedback
                   </button>`
                : '';

            const modelIcon = item.model === 'music' ? '#icon-music' : '#icon-volume';
            const modelClass = item.model === 'music' ? 'music' : 'audio';

            return `
                <div class="library-item" data-id="${item.id}" data-model="${item.model || 'music'}">
                    <button class="item-favorite ${favClass}" onclick="toggleLibraryFavorite('${item.id}')" title="${isFavorited ? 'Remove from favorites' : 'Add to favorites'}">
                        <svg class="icon"><use href="${favIcon}"/></svg>
                    </button>
                    <div class="item-header">
                        <div class="model-badge ${modelClass}" title="${item.model === 'music' ? 'Music' : 'Sound Effect'}">
                            <svg class="icon"><use href="${modelIcon}"/></svg>
                        </div>
                        <div class="item-info">
                            <div class="prompt" title="${escapeHtml(item.prompt)}">${escapeHtml(item.prompt)}</div>
                            <div class="item-meta">
                                <span class="duration" title="Duration">
                                    <svg class="icon"><use href="#icon-clock"/></svg>
                                    ${item.duration}s
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="styled-audio">
                        <audio controls src="/audio/${item.filename}"></audio>
                    </div>
                    <div class="item-actions">
                        <button class="action-btn vote-up ${upClass}" onclick="showLibraryPositiveFeedback('${item.id}')" title="Like this track">
                            <svg class="icon"><use href="#icon-thumb-up"/></svg>
                            <span class="vote-count">${item.upvotes || 0}</span>
                        </button>
                        <button class="action-btn vote-down ${downClass}" onclick="showLibraryFeedback('${item.id}')" title="Dislike this track">
                            <svg class="icon"><use href="#icon-thumb-down"/></svg>
                            <span class="vote-count">${item.downvotes || 0}</span>
                        </button>
                        <button class="action-btn play-radio" onclick="addToRadioQueue('${item.id}')" title="Add to radio queue">
                            <svg class="icon"><use href="#icon-add-queue"/></svg>
                        </button>
                        <button class="action-btn suggest-tag" onclick="showTagSuggestionModal('${item.id}')" title="Suggest a category for this track">
                            <svg class="icon"><use href="#icon-tag"/></svg>
                            Tag
                        </button>
                        ${viewFeedbackBtn}
                        <a href="/download/${item.filename}" class="action-btn download" title="Download audio file">
                            <svg class="icon"><use href="#icon-download"/></svg>
                            Download
                        </a>
                    </div>
                    <div class="feedback-view hidden" id="feedback-view-${item.id}"></div>
                </div>
            `;
        }

        // Add item to radio queue
        function addToRadioQueue(genId) {
            const item = libraryItemsData[genId];
            if (item) {
                radioQueue.push(item);
                showFeedbackToast('Added to radio queue');
                updateQueueDisplay();
            }
        }

        // Toggle library item favorite
        async function toggleLibraryFavorite(genId) {
            if (!userFavorites) userFavorites = new Set();

            const isFavorited = userFavorites.has(genId);
            const btn = document.querySelector(`.library-item[data-id="${genId}"] .item-favorite`);
            const icon = btn?.querySelector('use');
            const userId = getEffectiveUserId();

            try {
                if (isFavorited) {
                    await fetch(`/api/favorites/${genId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: userId })
                    });
                    userFavorites.delete(genId);
                    btn?.classList.remove('favorited');
                    if (icon) icon.setAttribute('href', '#icon-heart-outline');
                    showFeedbackToast('Removed from favorites');
                } else {
                    await fetch(`/api/favorites/${genId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: userId })
                    });
                    userFavorites.add(genId);
                    btn?.classList.add('favorited');
                    if (icon) icon.setAttribute('href', '#icon-heart');
                    showFeedbackToast('Added to favorites');
                }
            } catch (err) {
                console.error('Failed to toggle favorite:', err);
            }
        }

        // Library feedback shortcuts - open modal
        function showLibraryPositiveFeedback(genId) {
            const item = libraryItemsData[genId];
            if (item) {
                openFeedbackModal(item, true, 'library');
            }
        }

        function showLibraryFeedback(genId) {
            const item = libraryItemsData[genId];
            if (item) {
                openFeedbackModal(item, false, 'library');
            }
        }

        // View feedback - only available to adult accounts
        async function viewFeedback(genId) {
            if (!isAdultAccount) {
                showFeedbackToast('Adult account required to view feedback');
                return;
            }

            const viewEl = document.getElementById('feedback-view-' + genId);

            if (!viewEl.classList.contains('hidden')) {
                viewEl.classList.add('hidden');
                return;
            }

            viewEl.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 10px;">Loading feedback...</div>';
            viewEl.classList.remove('hidden');

            try {
                const response = await fetch(`/api/library/${genId}/feedback`);
                const data = await response.json();

                const { positive, negative, reclassify } = data;

                const hasPositive = Object.keys(positive).length > 0;
                const hasNegative = Object.keys(negative).length > 0;
                const hasReclassify = reclassify && (reclassify.music > 0 || reclassify.audio > 0);

                if (!hasPositive && !hasNegative && !hasReclassify) {
                    viewEl.innerHTML = '<div style="color: var(--text-muted); padding: 10px; font-size: 0.85rem;">No feedback yet</div>';
                    return;
                }

                let html = '<div style="padding: 12px; font-size: 0.85rem;">';

                if (hasPositive) {
                    html += '<div style="color: var(--success); margin-bottom: 8px;"><strong>Positive:</strong> ';
                    html += Object.entries(positive).map(([k, v]) => `${k} (${v})`).join(', ');
                    html += '</div>';
                }

                if (hasNegative) {
                    html += '<div style="color: var(--error); margin-bottom: 8px;"><strong>Issues:</strong> ';
                    html += Object.entries(negative).map(([k, v]) => `${k} (${v})`).join(', ');
                    html += '</div>';
                }

                if (hasReclassify) {
                    html += '<div style="color: var(--cyan);"><strong>Reclassify suggestions:</strong> ';
                    const suggestions = [];
                    if (reclassify.music > 0) suggestions.push(`Music (${reclassify.music})`);
                    if (reclassify.audio > 0) suggestions.push(`Sound Effect (${reclassify.audio})`);
                    html += suggestions.join(', ');
                    html += '</div>';
                }

                html += '</div>';
                viewEl.innerHTML = html;

            } catch (err) {
                viewEl.innerHTML = '<div style="color: var(--error); padding: 10px;">Failed to load feedback</div>';
            }
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return 'just now';
            if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
            if (diff < 604800) return Math.floor(diff / 86400) + 'd ago';
            return date.toLocaleDateString();
        }

        function prevPage() {
            if (libraryPage > 1) {
                libraryPage--;
                loadLibrary();
                // Smooth scroll to library section
                document.querySelector('.library-card')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function nextPage() {
            if (libraryPage < libraryPages) {
                libraryPage++;
                loadLibrary();
                // Smooth scroll to library section
                document.querySelector('.library-card')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Search debounce
        if (librarySearchEl) {
            librarySearchEl.addEventListener('input', () => {
                clearTimeout(searchDebounceTimer);
                // Update clear button visibility immediately
                updateClearFilterButton();
                searchDebounceTimer = setTimeout(() => {
                    libraryPage = 1;
                    loadLibrary();
                }, 300);
            });
        }

        // Filter change handlers with localStorage persistence
        if (libraryModelEl) {
            libraryModelEl.addEventListener('change', () => {
                libraryPage = 1;
                localStorage.setItem('soundbox_library_model', libraryModelEl.value);
                loadLibrary();
            });
        }

        if (librarySortEl) {
            librarySortEl.addEventListener('change', () => {
                libraryPage = 1;
                localStorage.setItem('soundbox_library_sort', librarySortEl.value);
                loadLibrary();
            });
        }

        // Restore saved filter preferences
        (function restoreFilters() {
            const savedModel = localStorage.getItem('soundbox_library_model');
            const savedSort = localStorage.getItem('soundbox_library_sort');
            const savedRadioModel = localStorage.getItem('soundbox_radio_model');

            if (savedModel && libraryModelEl) {
                libraryModelEl.value = savedModel;
            }
            if (savedSort && librarySortEl) {
                librarySortEl.value = savedSort;
            }
            if (savedRadioModel) {
                const radioModelEl = document.getElementById('radio-model');
                if (radioModelEl) radioModelEl.value = savedRadioModel;
            }
        })();

        // ========================================
        // COLLAPSIBLE GENERATOR
        // ========================================
        function toggleGenerator() {
            const card = document.getElementById('generator-card');
            card.classList.toggle('collapsed');
            // Save preference
            localStorage.setItem('generator_collapsed', card.classList.contains('collapsed'));
        }

        // Restore generator state
        (function() {
            const collapsed = localStorage.getItem('generator_collapsed') === 'true';
            if (collapsed) {
                document.getElementById('generator-card')?.classList.add('collapsed');
            }
        })();

        // ========================================
        // QUEUE EXPLORER
        // ========================================
        let queueExplorerInterval = null;

        function toggleQueueExplorer() {
            const card = document.getElementById('queue-explorer-card');
            card.classList.toggle('collapsed');
            const isCollapsed = card.classList.contains('collapsed');
            localStorage.setItem('queue_explorer_collapsed', isCollapsed);

            // Start/stop polling based on visibility
            if (!isCollapsed) {
                loadQueueExplorer();
                startQueuePolling();
            } else {
                stopQueuePolling();
            }
        }

        function startQueuePolling() {
            if (queueExplorerInterval) return;
            queueExplorerInterval = setInterval(loadQueueExplorer, 1500);
        }

        function stopQueuePolling() {
            if (queueExplorerInterval) {
                clearInterval(queueExplorerInterval);
                queueExplorerInterval = null;
            }
        }

        async function loadQueueExplorer() {
            try {
                const response = await fetch('/api/queue');
                const data = await response.json();

                const badge = document.getElementById('queue-explorer-badge');
                const list = document.getElementById('queue-explorer-list');
                const empty = document.getElementById('queue-empty');
                const userId = getEffectiveUserId();

                // Update badge
                badge.textContent = data.total;
                badge.classList.toggle('empty', data.total === 0);

                if (data.jobs.length === 0) {
                    list.innerHTML = '';
                    empty.style.display = 'block';
                    return;
                }

                empty.style.display = 'none';

                // Render queue items
                list.innerHTML = data.jobs.map(job => {
                    const isProcessing = job.status === 'processing';
                    const isOwnJob = job.user_id === userId;
                    const modelBadgeClass = job.model === 'audio' ? 'audio' : '';
                    const priorityClass = job.priority === 'admin' ? 'admin' : job.priority === 'premium' ? 'premium' : '';

                    let progressHtml = '';
                    if (isProcessing && job.progress_pct > 0) {
                        progressHtml = `
                            <div class="queue-item-progress">
                                <div class="progress-bar">
                                    <div class="fill" style="width: ${job.progress_pct}%"></div>
                                </div>
                                <span class="progress-text">${escapeHtml(job.progress || 'Processing...')}</span>
                            </div>
                        `;
                    } else if (isProcessing) {
                        progressHtml = `
                            <div class="queue-item-progress">
                                <span class="progress-text">${escapeHtml(job.progress || 'Starting...')}</span>
                            </div>
                        `;
                    }

                    const cancelBtn = (isOwnJob && !isProcessing) ?
                        `<button class="cancel-btn" onclick="cancelQueueJob('${job.id}')" title="Cancel job"></button>` : '';

                    return `
                        <div class="queue-item ${isProcessing ? 'processing' : ''} ${isOwnJob ? 'own-job' : ''}">
                            <div class="queue-item-position">#${job.position}</div>
                            <div class="queue-item-info">
                                <div class="queue-item-prompt">${escapeHtml(job.prompt)}</div>
                                <div class="queue-item-meta">
                                    <span class="model-badge ${modelBadgeClass}"><svg class="icon icon-sm" style="vertical-align: -2px; margin-right: 2px;"><use href="${job.model === 'music' ? '#icon-music' : '#icon-volume'}"/></svg>${job.model === 'music' ? 'Music' : 'SFX'}</span>
                                    <span class="duration-badge">${job.duration}s</span>
                                    ${job.priority !== 'standard' ? `<span class="priority-badge ${priorityClass}">${job.priority}</span>` : ''}
                                </div>
                                ${progressHtml}
                            </div>
                            ${cancelBtn}
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error('Failed to load queue:', err);
            }
        }

        async function cancelQueueJob(jobId) {
            if (!confirm('Cancel this generation?')) return;

            try {
                const response = await fetch(`/api/queue/${jobId}/cancel`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: getEffectiveUserId() })
                });

                const data = await response.json();

                if (data.success) {
                    showFeedbackToast('Job cancelled');
                    loadQueueExplorer();
                } else {
                    showFeedbackToast(data.error || 'Failed to cancel', 'error');
                }
            } catch (err) {
                showFeedbackToast('Failed to cancel job', 'error');
            }
        }

        // Restore queue explorer state and initialize
        (function() {
            const collapsed = localStorage.getItem('queue_explorer_collapsed');
            // Default to collapsed (true), unless explicitly set to false
            if (collapsed === 'false') {
                const card = document.getElementById('queue-explorer-card');
                if (card) {
                    card.classList.remove('collapsed');
                    loadQueueExplorer();
                    startQueuePolling();
                }
            }
        })();

        // ========================================
        // GLOBAL MUTE FUNCTIONALITY
        // ========================================
        let isGlobalMuted = false;

        function toggleGlobalMute() {
            isGlobalMuted = !isGlobalMuted;
            const btn = document.getElementById('global-mute-btn');
            btn.classList.toggle('muted', isGlobalMuted);

            // Mute/unmute all audio elements on the page
            document.querySelectorAll('audio').forEach(audio => {
                audio.muted = isGlobalMuted;
            });

            // Save preference
            localStorage.setItem('soundbox_muted', isGlobalMuted);
        }

        // Auto-unmute when user explicitly plays audio
        function autoUnmuteOnPlay() {
            if (isGlobalMuted) {
                isGlobalMuted = false;
                const btn = document.getElementById('global-mute-btn');
                if (btn) btn.classList.remove('muted');
                document.querySelectorAll('audio').forEach(audio => {
                    audio.muted = false;
                });
                localStorage.setItem('soundbox_muted', 'false');
            }
        }

        // Restore mute state and apply to new audio elements
        function initMuteState() {
            isGlobalMuted = localStorage.getItem('soundbox_muted') === 'true';
            const btn = document.getElementById('global-mute-btn');
            if (btn) btn.classList.toggle('muted', isGlobalMuted);

            // Watch for new audio elements and apply mute state
            const observer = new MutationObserver(mutations => {
                if (isGlobalMuted) {
                    document.querySelectorAll('audio').forEach(audio => {
                        audio.muted = true;
                    });
                }
            });
            observer.observe(document.body, { childList: true, subtree: true });

            // Auto-unmute when user clicks play on any audio element
            document.addEventListener('play', function(e) {
                if (e.target.tagName === 'AUDIO') {
                    autoUnmuteOnPlay();
                }
            }, true);
        }

        // ========================================
        // AUTO-START RADIO WITH AMBIENT
        // ========================================
        function autoStartRadio() {
            // Pre-select Ambient station visually (always show full UI)
            const ambientCard = document.querySelector('.station-card.station-ambient');
            if (ambientCard) {
                ambientCard.classList.add('active');
                currentStation = 'ambient';
            }

            // Load tracks for queue display (but don't play audio)
            preloadStation('ambient', ambientCard);

            // Show click-to-play banner if we haven't started audio yet
            if (!sessionStorage.getItem('soundbox_started')) {
                setTimeout(() => {
                    showStartPlayingBanner();
                }, 300);
            }
        }

        async function preloadStation(stationId, element) {
            const model = document.getElementById('radio-model').value;
            const keywords = element?.dataset.keywords || '';

            try {
                const params = new URLSearchParams({ model, count: 10 });
                if (keywords) params.set('search', keywords);

                const response = await fetch('/api/radio/shuffle?' + params.toString());
                const data = await response.json();

                if (data.tracks && data.tracks.length > 0) {
                    radioQueue = data.tracks;
                    updateRadioQueue();
                    showNowPlayingPreview(radioQueue[0]);
                }
            } catch (err) {
                console.error('Preload station failed:', err);
            }
        }

        function showNowPlayingPreview(track) {
            // Show now-playing section with track info (but don't play)
            const nowPlaying = document.querySelector('.now-playing');
            const radioQueue = document.getElementById('radio-queue');

            if (nowPlaying) {
                nowPlaying.classList.remove('hidden');

                // Update track info
                const promptEl = document.getElementById('now-prompt');
                if (promptEl) promptEl.textContent = track.prompt || 'Unknown Track';

                // Set audio source but don't play
                const audio = document.getElementById('radio-player');
                if (audio) {
                    audio.src = `/audio/${track.filename}`;
                }

                // Show paused state for EQ visualizer
                const eq = document.querySelector('.eq-visualizer');
                if (eq) eq.classList.add('paused');
            }

            if (radioQueue) {
                radioQueue.classList.remove('hidden');
            }
        }

        function showStartPlayingBanner() {
            // Create overlay for clicking to start
            const banner = document.createElement('div');
            banner.id = 'start-playing-banner';
            banner.innerHTML = `
                <div class="start-banner-content" onclick="startPlayingFromBanner()">
                    <svg class="start-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    <div class="start-text">
                        <h3>Click to Start Radio</h3>
                        <p>Ambient station ready to play</p>
                    </div>
                </div>
            `;
            banner.className = 'start-playing-banner';

            // Insert after the radio stations grid
            const radioStations = document.querySelector('.radio-stations');
            if (radioStations) {
                radioStations.after(banner);
            }
        }

        function startPlayingFromBanner() {
            // Mark as started
            sessionStorage.setItem('soundbox_started', 'true');

            // Remove banner
            const banner = document.getElementById('start-playing-banner');
            if (banner) {
                banner.classList.add('fading');
                setTimeout(() => banner.remove(), 300);
            }

            // Start the Ambient station
            const ambientCard = document.querySelector('.station-card.station-ambient');
            if (ambientCard) {
                startStation('ambient', ambientCard);
            }
        }

        // Initialize
        initMuteState();
        loadLibrary();
        loadCategoryCounts();
        checkStatus();
        generateBtn.disabled = true;

        // Auto-start radio after everything loads
        autoStartRadio();
    </script>

    <!-- Graphlings Widget Integration -->
    <script>
        // Auto-detect environment for Graphlings SDK
        (function() {
            const hostname = window.location.hostname;
            const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
            const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';

            // Check if hostname is a Tailscale IP (100.64.0.0/10 CGNAT range)
            function isTailscaleIP(host) {
                const ipMatch = host.match(/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/);
                if (!ipMatch) return false;
                const [, a, b] = ipMatch.map(Number);
                return a === 100 && b >= 64 && b <= 127;
            }
            const isTailscale = hostname.endsWith('.ts.net') || isTailscaleIP(hostname);

            const SDK_CONFIG = {
                appId: 'sfx-music',
                // Auto-detect: localhost, Tailscale, or production
                accountsUrl: isLocalhost
                    ? 'http://localhost:8002'
                    : isTailscale
                        ? `http://${hostname}:8002`
                        : 'https://accounts.graphlings.net',
                debug: true
            };
            console.log('[SFX-Music] SDK Config:', SDK_CONFIG);

            // Set favicon from accounts server
            const faviconLink = document.getElementById('favicon-link');
            if (faviconLink) {
                faviconLink.href = SDK_CONFIG.accountsUrl + '/static/graphlings/logo-104.png';
            }

            // Dynamically load SDK from accounts server
            const sdkScript = document.createElement('script');
            sdkScript.src = SDK_CONFIG.accountsUrl + '/sdk/graphlings.js';
            document.head.appendChild(sdkScript);

            // Wait for SDK to load and initialize
            function waitForSDK(callback) {
                if (typeof Graphlings !== 'undefined') {
                    callback();
                } else {
                    setTimeout(() => waitForSDK(callback), 50);
                }
            }

            // Theme definitions - 'default' is the original Sound Box purple/cyan theme
            const THEMES = {
                default: {
                    accent: '#a855f7',
                    accentGlow: 'rgba(168, 85, 247, 0.4)',
                    secondary: '#00d4ff',
                    secondaryGlow: 'rgba(0, 212, 255, 0.3)',
                    gradientAccent: 'linear-gradient(135deg, #a855f7 0%, #6366f1 100%)',
                    gradientSecondary: 'linear-gradient(135deg, #00d4ff 0%, #0ea5e9 100%)',
                    success: '#10b981',
                    cardBorder: 'rgba(168, 85, 247, 0.2)',
                    chipBg: 'rgba(168, 85, 247, 0.1)',
                    chipBorder: 'rgba(168, 85, 247, 0.3)'
                },
                graphlings: {
                    accent: '#a855f7',
                    accentGlow: 'rgba(168, 85, 247, 0.4)',
                    secondary: '#f97316',
                    secondaryGlow: 'rgba(249, 115, 22, 0.3)',
                    gradientAccent: 'linear-gradient(135deg, #a855f7 0%, #6366f1 100%)',
                    gradientSecondary: 'linear-gradient(135deg, #f97316 0%, #ea580c 100%)',
                    success: '#10b981',
                    cardBorder: 'rgba(168, 85, 247, 0.2)',
                    chipBg: 'rgba(168, 85, 247, 0.1)',
                    chipBorder: 'rgba(168, 85, 247, 0.3)'
                },
                professional: {
                    accent: '#3b82f6',
                    accentGlow: 'rgba(59, 130, 246, 0.4)',
                    secondary: '#60a5fa',
                    secondaryGlow: 'rgba(96, 165, 250, 0.3)',
                    gradientAccent: 'linear-gradient(135deg, #3b82f6 0%, #1e40af 100%)',
                    gradientSecondary: 'linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%)',
                    success: '#3b82f6',
                    cardBorder: 'rgba(59, 130, 246, 0.2)',
                    chipBg: 'rgba(59, 130, 246, 0.1)',
                    chipBorder: 'rgba(59, 130, 246, 0.3)'
                },
                ocean: {
                    accent: '#06b6d4',
                    accentGlow: 'rgba(6, 182, 212, 0.4)',
                    secondary: '#22d3ee',
                    secondaryGlow: 'rgba(34, 211, 238, 0.3)',
                    gradientAccent: 'linear-gradient(135deg, #06b6d4 0%, #0284c7 100%)',
                    gradientSecondary: 'linear-gradient(135deg, #22d3ee 0%, #06b6d4 100%)',
                    success: '#06b6d4',
                    cardBorder: 'rgba(6, 182, 212, 0.2)',
                    chipBg: 'rgba(6, 182, 212, 0.1)',
                    chipBorder: 'rgba(6, 182, 212, 0.3)'
                },
                forest: {
                    accent: '#22c55e',
                    accentGlow: 'rgba(34, 197, 94, 0.4)',
                    secondary: '#4ade80',
                    secondaryGlow: 'rgba(74, 222, 128, 0.3)',
                    gradientAccent: 'linear-gradient(135deg, #22c55e 0%, #15803d 100%)',
                    gradientSecondary: 'linear-gradient(135deg, #4ade80 0%, #22c55e 100%)',
                    success: '#22c55e',
                    cardBorder: 'rgba(34, 197, 94, 0.2)',
                    chipBg: 'rgba(34, 197, 94, 0.1)',
                    chipBorder: 'rgba(34, 197, 94, 0.3)'
                },
                princess: {
                    accent: '#ec4899',
                    accentGlow: 'rgba(236, 72, 153, 0.4)',
                    secondary: '#f472b6',
                    secondaryGlow: 'rgba(244, 114, 182, 0.3)',
                    gradientAccent: 'linear-gradient(135deg, #ec4899 0%, #db2777 100%)',
                    gradientSecondary: 'linear-gradient(135deg, #f472b6 0%, #ec4899 100%)',
                    success: '#ec4899',
                    cardBorder: 'rgba(236, 72, 153, 0.2)',
                    chipBg: 'rgba(236, 72, 153, 0.1)',
                    chipBorder: 'rgba(236, 72, 153, 0.3)'
                }
            };

            // Apply theme colors to CSS variables
            function applyTheme(themeName) {
                const theme = THEMES[themeName] || THEMES.default;
                const root = document.documentElement;

                // Core accent colors
                root.style.setProperty('--accent', theme.accent);
                root.style.setProperty('--accent-glow', theme.accentGlow);
                root.style.setProperty('--cyan', theme.secondary);
                root.style.setProperty('--cyan-glow', theme.secondaryGlow);
                root.style.setProperty('--gradient-accent', theme.gradientAccent);
                root.style.setProperty('--gradient-cyan', theme.gradientSecondary);
                root.style.setProperty('--success', theme.success);

                // Card and UI element colors
                root.style.setProperty('--card-border-accent', theme.cardBorder);
                root.style.setProperty('--chip-bg', theme.chipBg);
                root.style.setProperty('--chip-border', theme.chipBorder);

                // Save to localStorage for persistence
                localStorage.setItem('soundbox_theme', themeName);
                console.log('[SFX-Music] Theme applied:', themeName);
            }

            // Load saved theme on page load
            function loadSavedTheme() {
                const savedTheme = localStorage.getItem('soundbox_theme');
                if (savedTheme && THEMES[savedTheme]) {
                    applyTheme(savedTheme);
                }
            }

            // Load theme immediately
            loadSavedTheme();

            waitForSDK(function() {
                window.graphlings = new Graphlings(SDK_CONFIG);
                window.graphlings.createWidget({
                    container: '#wallet-widget-container'
                });

                // Listen for theme changes from the widget
                window.graphlings.on('themeChanged', function(data) {
                    applyTheme(data.theme);
                });

                // Listen for login to get user ID
                window.graphlings.on('login', function(data) {
                    if (data.user && data.user.id) {
                        currentUserId = data.user.id;
                        // Check if user is an adult account
                        isAdultAccount = data.user.account_type === 'adult' ||
                                        (data.user.account_type !== 'child' && !data.user.is_child);
                        console.log('[SFX-Music] User logged in:', currentUserId, 'isAdult:', isAdultAccount);
                        loadLibrary();  // Refresh library to show/hide feedback buttons
                    }
                });

                // Listen for logout to clear user ID
                window.graphlings.on('logout', function() {
                    currentUserId = null;
                    isAdultAccount = false;
                    console.log('[SFX-Music] User logged out');
                    loadLibrary();  // Refresh library to update feedback button visibility
                });

                // Check if user is already logged in and apply their theme
                window.graphlings.on('widgetReady', function(data) {
                    // Apply theme from widget (overrides local storage)
                    if (data.theme && THEMES[data.theme]) {
                        applyTheme(data.theme);
                        console.log('[SFX-Music] Theme synced from widget:', data.theme);
                    }

                    if (data.authenticated && data.user && data.user.id) {
                        currentUserId = data.user.id;
                        // Check if user is an adult account
                        isAdultAccount = data.user.account_type === 'adult' ||
                                        (data.user.account_type !== 'child' && !data.user.is_child);
                        console.log('[SFX-Music] User already logged in:', currentUserId, 'isAdult:', isAdultAccount);
                        loadLibrary();  // Refresh library to show/hide feedback buttons
                    }
                });

                console.log('[SFX-Music] Graphlings widget initialized');
            });
        })();
    </script>

    <!-- Feedback Modal Overlay -->
    <div class="feedback-modal-overlay hidden" id="feedback-modal-overlay" onclick="closeFeedbackModal(event)">
        <!-- Floating particles -->
        <div class="feedback-particles" id="feedback-particles"></div>
        <div class="feedback-modal" id="feedback-modal-container" onclick="event.stopPropagation()">
            <div class="feedback-modal-header">
                <span class="feedback-modal-title" id="feedback-modal-title">Rate this track</span>
                <button class="feedback-modal-close" onclick="closeFeedbackModal()">&times;</button>
            </div>
            <div class="feedback-modal-track" id="feedback-modal-track">
                <span class="model-badge" id="feedback-modal-badge"><svg class="icon icon-sm" style="vertical-align: -2px;"><use href="#icon-music"/></svg></span>
                <span class="feedback-modal-prompt" id="feedback-modal-prompt">Loading...</span>
            </div>
            <div class="feedback-modal-section">
                <div class="feedback-modal-label" id="feedback-modal-label">What do you like?</div>
                <div class="feedback-modal-options" id="feedback-modal-options"></div>
            </div>
            <div class="feedback-modal-section">
                <div class="feedback-modal-label">Suggest reclassification:</div>
                <div class="feedback-modal-reclassify" id="feedback-modal-reclassify"></div>
            </div>
            <div class="feedback-modal-actions">
                <button class="feedback-modal-cancel" onclick="closeFeedbackModal()">Cancel</button>
                <button class="feedback-modal-submit" id="feedback-modal-submit" onclick="submitFeedbackModal()" disabled>Submit Feedback</button>
            </div>
        </div>
    </div>

    <!-- Tag Suggestion Modal -->
    <div class="tag-modal-overlay hidden" id="tag-modal-overlay" onclick="closeTagModal(event)">
        <div class="tag-modal" onclick="event.stopPropagation()">
            <div class="tag-modal-header">
                <h3 class="tag-modal-title">
                    <svg class="icon"><use href="#icon-tag"/></svg>
                    Suggest Category
                </h3>
                <button class="tag-modal-close" onclick="closeTagModal()">&times;</button>
            </div>
            <div class="tag-modal-track" id="tag-modal-track">
                <span class="model-badge" id="tag-modal-badge"></span>
                <span class="tag-modal-prompt" id="tag-modal-prompt"></span>
            </div>
            <div class="tag-modal-current">
                <div class="tag-modal-label">Current categories:</div>
                <div class="current-tags" id="tag-modal-current-tags"></div>
            </div>
            <div class="tag-modal-suggestions">
                <div class="tag-modal-label">Pending suggestions (3 votes to apply):</div>
                <div class="pending-tags" id="tag-modal-pending-tags"></div>
            </div>
            <div class="tag-modal-section">
                <div class="tag-modal-label">Select a category to suggest:</div>
                <div class="tag-categories" id="tag-modal-categories"></div>
            </div>
            <div class="tag-modal-status" id="tag-modal-status"></div>
        </div>
    </div>

    <style>
        /* Tag Suggestion Modal Styles */
        .tag-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }

        .tag-modal-overlay.hidden {
            display: none;
        }

        .tag-modal {
            background: var(--bg-card);
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .tag-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.2);
        }

        .tag-modal-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }

        .tag-modal-title .icon {
            width: 20px;
            height: 20px;
            color: var(--accent);
        }

        .tag-modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .tag-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text);
        }

        .tag-modal-track {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.15);
            border-bottom: 1px solid var(--border);
        }

        .tag-modal-prompt {
            font-size: 0.95rem;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tag-modal-current,
        .tag-modal-suggestions,
        .tag-modal-section {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .tag-modal-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 10px;
            font-weight: 500;
        }

        .current-tags,
        .pending-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .current-tag,
        .pending-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .current-tag {
            background: var(--accent);
            color: white;
        }

        .pending-tag {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-muted);
            border: 1px dashed var(--border);
        }

        .pending-tag .vote-count {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
        }

        .tag-categories {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        .tag-category-btn {
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-dim);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .tag-category-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            border-color: var(--cyan);
        }

        .tag-category-btn.suggested {
            border-color: var(--accent);
            background: rgba(139, 92, 246, 0.2);
            color: var(--accent);
        }

        .tag-category-btn.already-applied {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        .tag-modal-status {
            padding: 16px 20px;
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .tag-modal-status.success {
            color: var(--accent);
            background: rgba(139, 92, 246, 0.1);
        }

        .tag-modal-status.error {
            color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .tag-modal-status.consensus {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .no-tags {
            color: var(--text-muted);
            font-style: italic;
            font-size: 0.85rem;
        }

        /* Suggest Tag Button Style */
        .action-btn.suggest-tag {
            border-color: rgba(139, 92, 246, 0.3);
            color: var(--text-muted);
        }

        .action-btn.suggest-tag:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(139, 92, 246, 0.1);
        }
    </style>

    <script>
        // Tag Suggestion Modal Functions
        let currentTagModalGenId = null;

        async function showTagSuggestionModal(genIdOrItem) {
            // Accept either a genId string or an item object
            let item, genId;
            if (typeof genIdOrItem === 'string') {
                genId = genIdOrItem;
                item = libraryItemsData[genId] || currentRadioTrack;
            } else if (typeof genIdOrItem === 'object' && genIdOrItem !== null) {
                item = genIdOrItem;
                genId = item.id;
            }

            if (!item || !genId) {
                showErrorToast('No track selected');
                return;
            }

            currentTagModalGenId = genId;

            // Show modal
            document.getElementById('tag-modal-overlay').classList.remove('hidden');

            // Set track info
            const model = item.model || 'music';
            document.getElementById('tag-modal-badge').innerHTML =
                `<svg class="icon icon-sm" style="vertical-align: -2px;"><use href="${model === 'music' ? '#icon-music' : '#icon-volume'}"/></svg>`;
            document.getElementById('tag-modal-prompt').textContent = item.prompt;

            // Clear status
            const statusEl = document.getElementById('tag-modal-status');
            statusEl.className = 'tag-modal-status';
            statusEl.textContent = 'Loading...';

            try {
                // Fetch current suggestions
                const suggestionsRes = await fetch(`/api/library/${genId}/tag-suggestions`);
                const suggestionsData = await suggestionsRes.json();

                // Fetch available categories
                const categoriesRes = await fetch(`/api/categories/${model}`);
                const categoriesData = await categoriesRes.json();

                // Display current categories
                const currentTagsEl = document.getElementById('tag-modal-current-tags');
                if (suggestionsData.current_categories && suggestionsData.current_categories.length > 0) {
                    currentTagsEl.innerHTML = suggestionsData.current_categories
                        .map(cat => `<span class="current-tag">${cat.replace(/_/g, ' ')}</span>`)
                        .join('');
                } else {
                    currentTagsEl.innerHTML = '<span class="no-tags">No categories yet</span>';
                }

                // Display pending suggestions
                const pendingTagsEl = document.getElementById('tag-modal-pending-tags');
                if (Object.keys(suggestionsData.suggestions).length > 0) {
                    pendingTagsEl.innerHTML = Object.entries(suggestionsData.suggestions)
                        .map(([cat, count]) => `
                            <span class="pending-tag">
                                ${cat.replace(/_/g, ' ')}
                                <span class="vote-count">${count}/${suggestionsData.threshold}</span>
                            </span>
                        `)
                        .join('');
                } else {
                    pendingTagsEl.innerHTML = '<span class="no-tags">No pending suggestions</span>';
                }

                // Display available categories
                const categoriesEl = document.getElementById('tag-modal-categories');
                const userSuggestions = suggestionsData.user_suggestions || [];
                const currentCats = suggestionsData.current_categories || [];

                categoriesEl.innerHTML = Object.entries(categoriesData.categories)
                    .map(([key, display]) => {
                        const isApplied = currentCats.includes(key);
                        const isSuggested = userSuggestions.includes(key);
                        let className = 'tag-category-btn';
                        if (isApplied) className += ' already-applied';
                        else if (isSuggested) className += ' suggested';

                        return `<button class="${className}" onclick="suggestTag('${key}')" ${isApplied ? 'disabled' : ''}>
                            ${display}
                        </button>`;
                    })
                    .join('');

                statusEl.textContent = 'Click a category to suggest it. 3 votes needed to apply.';

            } catch (err) {
                console.error('Failed to load tag suggestions:', err);
                statusEl.className = 'tag-modal-status error';
                statusEl.textContent = 'Failed to load suggestions';
            }
        }

        async function suggestTag(category) {
            if (!currentTagModalGenId) return;

            const statusEl = document.getElementById('tag-modal-status');
            statusEl.className = 'tag-modal-status';
            statusEl.textContent = 'Submitting...';

            try {
                const response = await fetch(`/api/library/${currentTagModalGenId}/suggest-tag`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category })
                });

                const data = await response.json();

                if (data.success) {
                    if (data.consensus_reached) {
                        statusEl.className = 'tag-modal-status consensus';
                        statusEl.textContent = data.message;
                        showFeedbackToast('Category applied! Consensus reached.');
                    } else {
                        statusEl.className = 'tag-modal-status success';
                        statusEl.textContent = data.message;
                        showFeedbackToast('Tag suggestion recorded');
                    }

                    // Refresh the modal
                    setTimeout(() => showTagSuggestionModal(currentTagModalGenId), 500);

                } else {
                    statusEl.className = 'tag-modal-status error';
                    statusEl.textContent = data.message;
                }

            } catch (err) {
                console.error('Failed to suggest tag:', err);
                statusEl.className = 'tag-modal-status error';
                statusEl.textContent = 'Failed to submit suggestion';
            }
        }

        function closeTagModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('tag-modal-overlay').classList.add('hidden');
            currentTagModalGenId = null;
        }

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const tagModal = document.getElementById('tag-modal-overlay');
                if (tagModal && !tagModal.classList.contains('hidden')) {
                    closeTagModal();
                }
            }
        });
    </script>
</body>
</html>
